#-*-coding:utf-8 -*-
'''

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

ë°±í…ŒìŠ¤íŒ…ì€ ë‚´PCì—ì„œ í•´ì•¼ ì„œë²„ ìì›ì„ ì•„ë¼ê³  íˆ¬ì ì„±ê³¼ ê·¸ë˜í”„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì‹œê³  ë‹¤ì–‘í•œ ê¸°ê°„ìœ¼ë¡œ ë°±í…ŒìŠ¤íŒ… í•´ë³´ì„¸ìš”!!!
https://blog.naver.com/zacra/223180500307

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

í•´ë‹¹ ì»¨í…ì¸ ëŠ” ì œê°€ ì§ì ‘ íˆ¬ì í•˜ê¸° ìœ„í•´ ì´ ì „ëµì„ ì¶”ê°€ ê°œì„ í•´ì„œ ë” ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°œì¸ ì „ëµì´ ì¡´ì¬í•©ë‹ˆë‹¤. 

ê²Œë§Œì•„ ì¶”ê°€ ê°œì„  ê°œì¸ ì „ëµë“¤..
https://blog.naver.com/zacra/223196497504

ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ ìœ„ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì„¸ìš”!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



ì½”ë“œ ì´í•´í•˜ëŠ”ë° ë„ì›€ ë˜ëŠ” ì„¤ëª… ì°¸ê³  ì˜ìƒ!
https://youtu.be/IViI5gofQf4?si=Fnqm4_OmVfLnHCWD




ê´€ë ¨ í¬ìŠ¤íŒ…
    
íŒŒì´ì¬ ì—…ë¹„íŠ¸ ìë™ë§¤ë§¤ ì•ŒíŠ¸ ì½”ì¸ë“¤ë¡œ ìˆ˜ìµë‚´ê¸°
https://blog.naver.com/zacra/223122965642

ìœ„ í¬ìŠ¤íŒ…ì„ ê¼­ ì°¸ê³ í•˜ì„¸ìš”!!!

ğŸ“Œ ê²Œë§Œì•„ì˜ ëª¨ë“  ì½”ë“œëŠ” íŠ¹ì • ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ê¶Œìœ ë¥¼ ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.  
ì œì‘ìì˜ ê°œì¸ì ì¸ ê²¬í•´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì„±ëœ êµìœ¡ìš© ì˜ˆì‹œ ì½”ë“œì´ë©°, ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
ì‹¤ì œ íˆ¬ì íŒë‹¨ ë° ì‹¤í–‰ì€ ì „ì ìœ¼ë¡œ ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.

ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!


'''

import pandas as pd
import pprint

import matplotlib.pyplot as plt
import numpy as np
from datetime import datetime



InvestTotalMoney = 10000000 

combined_df = pd.read_csv('./UpbitDataAll.csv', index_col=0)

pprint.pprint(combined_df)

IsBuy = False #ë§¤ìˆ˜ í–ˆëŠ”ì§€ ì—¬ë¶€
BUY_PRICE = 0  #ë§¤ìˆ˜í•œ ê¸ˆì•¡! 

TryCnt = 0      #ë§¤ë§¤íšŸìˆ˜
SuccesCnt = 0   #ìµì ˆ ìˆ«ì
FailCnt = 0     #ì†ì ˆ ìˆ«ì


fee = 0.0015 #ìˆ˜ìˆ˜ë£Œ+ì„¸ê¸ˆ+ìŠ¬ë¦¬í”¼ì§€ë¥¼ ë§¤ìˆ˜ë§¤ë„ë§ˆë‹¤ 0.15%ë¡œ ì„¸íŒ…!
IsFirstDateSet = False
FirstDateStr = ""
FirstDateIndex = 0

ReadyCoinList = list()

NowInvestList = list()


InvestMoney = InvestTotalMoney


DivNum = 20



InvestMoneyCell = InvestMoney / (DivNum +1)

RemainInvestMoney = InvestMoney


ResultList = list()

TotalMoneyList = list()
combined_df.index = pd.DatetimeIndex(combined_df.index).strftime('%Y-%m-%d %H:%M:%S')
i = 0
# Iterate over each date
for date in combined_df.index.unique():
    

    i += 1


    #ë¹„íŠ¸ë‚˜ ì´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì¼“íƒ€ì´ë°ìœ¼ë¡œ í…ŒìŠ¤íŒ…ì„ í• ë•Œ ì•„ë˜ ì½”ë“œë¡œ ë‹¹ì¼ ë¹„íŠ¸ì™€ ì´ë” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
    #btc_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == 'KRW-BTC')]

    #eth_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == 'KRW-ETH')]


    pick_coins_top = combined_df.loc[combined_df.index == date].groupby('ticker')['prevValue'].max().nlargest(30).nsmallest((int(DivNum))) #ê±°ë˜ëŒ€ê¸ˆ ìƒìœ„ 30ê°œ ì¤‘ í•˜ìœ„ 20ê°œ

    pick_coins_top_change = combined_df.loc[combined_df.index == date].groupby('ticker')['prevChange'].max().nlargest(30).nsmallest((int(DivNum))) #ë“±ë½ë¥  ìƒìœ„ 30ê°œ ì¤‘ í•˜ìœ„ 20ê°œ



    items_to_remove = list()

    #íˆ¬ìì¤‘ì¸ í‹°ì»¤!!
    for investData in NowInvestList:
       # pprint.pprint(investData)

        ticker = investData['ticker'] 
        
        if investData['InvestMoney'] > 0:
            stock_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker)]

            if len(stock_data) == 1:


                #if IsTOP10In == True:
                NowOpenPrice = stock_data['open'].values[0] 
                PrevOpenPrice = stock_data['prevOpen'].values[0] 

                investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((NowOpenPrice - PrevOpenPrice) / PrevOpenPrice))

              

                #ì§„ì…(ë§¤ìˆ˜)ê°€ê²© ëŒ€ë¹„ ë³€ë™ë¥ 
                Rate = (NowOpenPrice - investData['BuyPrice']) / investData['BuyPrice']


                RevenueRate = (Rate - fee)*100.0 #ìˆ˜ìµë¥  ê³„ì‚°



                IsSell = False

                #ë§¤ë„ ì¡°ê±´!!!!
                if stock_data['ma5_before2'].values[0] > stock_data['ma5_before'].values[0] and stock_data['prevRSI'].values[0] <= 55: 
                    IsSell = True


                if IsSell == True:

                    ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ, ìŠ¬ë¦¬í”¼ì§€ ë°˜ì˜!


                    TryCnt += 1

                    if RevenueRate > 0: #ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë‹¤ë©´ ìµì ˆí•œ ì…ˆì´ë‹¤!
                        SuccesCnt += 1
                    else:
                        FailCnt += 1
                
                    
                    RemainInvestMoney += ReturnMoney
                    investData['InvestMoney'] = 0


                    #pprint.pprint(NowInvestList)

                    NowInvestMoney = 0
                    for iData in NowInvestList:
                        NowInvestMoney += iData['InvestMoney']

                    InvestMoney = RemainInvestMoney + NowInvestMoney


                    print("(",ticker, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ë„!  ìˆ˜ìµë¥ : ", round(RevenueRate,2) , "%",  " ë§¤ë„ê°€", NowOpenPrice, " ë§¤ìˆ˜ë‚ ì§œ:",str(investData['Date']))
                    print("\n\n")                

                    items_to_remove.append(investData)
            
    #ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
    for item in items_to_remove:
        NowInvestList.remove(item)


    for ticker in pick_coins_top.index:

        if ticker in ['KRW-BTC','KRW-ETH']: #ë¹„íŠ¸ì½”ì¸ê³¼ ì´ë”ë¦¬ì›€ì€ ì œì™¸!
            continue

        
        IsAlReadyInvest = False
        for investData in NowInvestList:
            if ticker == investData['ticker']: 
                IsAlReadyInvest = True
                break

        IsTOPInChange = False
        for ticker_t in pick_coins_top_change.index:
            if ticker_t == ticker:
                coin_top_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker_t)]
                if len(coin_top_data) == 1:
                    IsTOPInChange = True
                    break




        stock_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker)]
        if len(stock_data) == 1 and IsAlReadyInvest == False and IsTOPInChange == True: #and len(btc_data) == 1 and len(eth_data) == 1:

            NowOpenPrice = stock_data['open'].values[0] 
            BuyPrice = NowOpenPrice

            IsBuyGo = False

            #ë§¤ìˆ˜ ì¡°ê±´!!!!
            if stock_data['ma5_rsi_before'].values[0] < stock_data['prevRSI'].values[0] and stock_data['prevChange'].values[0] > 0 and stock_data['ma5_before'].values[0] < stock_data['prevClose'].values[0] and stock_data['ma10_before'].values[0] < stock_data['prevClose'].values[0] and stock_data['ma20_before'].values[0] < stock_data['prevClose'].values[0]:
                IsBuyGo = True


            
            if IsBuyGo == True:

                if len(NowInvestList) < int(DivNum):

                    if IsFirstDateSet == False:
                        FirstDateStr = str(date)
                        FirstDateIndex = i-1
                        IsFirstDateSet = True

                    

                    InvestGoMoney = InvestMoneyCell 
                    
                    #ê±°ë˜ëŒ€ê¸ˆì„ í†µí•œ ì œí•œ!!!
                    #'''
                    if InvestGoMoney > stock_data['value_ma'].values[0] / 2000:
                        InvestGoMoney = stock_data['value_ma'].values[0] / 2000

                    if InvestGoMoney < 10000:
                        InvestGoMoney = 10000
                    #'''



                    BuyAmt = float(InvestGoMoney /  BuyPrice) #ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ êµ¬í•œë‹¤!

                    NowFee = (BuyAmt*BuyPrice) * fee

                    #ë‚¨ì€ ëˆì´ ìˆë‹¤ë©´ ë§¤ìˆ˜ í•œë‹¤!!
                    if RemainInvestMoney >= (BuyAmt*BuyPrice) + NowFee:


                        RealInvestMoney = (BuyAmt*BuyPrice) #ì‹¤ì œ ë“¤ì–´ê°„ íˆ¬ìê¸ˆ

                        RemainInvestMoney -= (BuyAmt*BuyPrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                        RemainInvestMoney -= NowFee


                        InvestData = dict()

                        InvestData['ticker'] = ticker
                        InvestData['InvestMoney'] = RealInvestMoney
                        InvestData['BuyPrice'] = BuyPrice
                        InvestData['Date'] = str(date)

                        NowInvestList.append(InvestData)


                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney


                        print("(",ticker, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ìˆ˜!  ë§¤ìˆ˜ê°€:", BuyPrice)



    NowInvestMoney = 0


    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']

    InvestMoney = RemainInvestMoney + NowInvestMoney


    InvestMoneyCell = InvestMoney / (DivNum +1)

    InvestCoinListStr = ""

    for iData in NowInvestList:
        InvestCoinListStr += iData['ticker'] + " "


    print("\n\n>>>>>>>>>>>>", InvestCoinListStr, "---> íˆ¬ìê°œìˆ˜ : ", len(NowInvestList))
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>--))", str(date), " ì”ê³ :",str(InvestMoney) , "=" , str(RemainInvestMoney) , "+" , str(NowInvestMoney), "\n\n" )
    
    TotalMoneyList.append(InvestMoney)

    #####################################################
    #####################################################
    #####################################################
    #'''
    
   

#ê²°ê³¼ ì •ë¦¬ ë° ë°ì´í„° ë§Œë“¤ê¸°!!
if len(TotalMoneyList) > 0:

    print("TotalMoneyList -> ", len(TotalMoneyList))


    resultData = dict()

    # Create the result DataFrame with matching shapes
    result_df = pd.DataFrame({"Total_Money": TotalMoneyList}, index=combined_df.index.unique())

    result_df['Ror'] = np.nan_to_num(result_df['Total_Money'].pct_change()) + 1
    result_df['Cum_Ror'] = result_df['Ror'].cumprod()
    result_df['Highwatermark'] = result_df['Cum_Ror'].cummax()
    result_df['Drawdown'] = (result_df['Cum_Ror'] / result_df['Highwatermark']) - 1
    result_df['MaxDrawdown'] = result_df['Drawdown'].cummin()

    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    pprint.pprint(result_df)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")

    resultData['DateStr'] = str(FirstDateStr) + " ~ " + str(result_df.iloc[-1].name)

    resultData['OriMoney'] = InvestTotalMoney
    resultData['FinalMoney'] = result_df['Total_Money'].iloc[-1]
    resultData['RevenueRate'] = ((result_df['Cum_Ror'].iloc[-1] -1.0)* 100.0)

    resultData['MDD'] = result_df['MaxDrawdown'].min() * 100.0

    resultData['TryCnt'] = TryCnt
    resultData['SuccesCnt'] = SuccesCnt
    resultData['FailCnt'] = FailCnt

    
    ResultList.append(resultData)

    result_df.index = pd.to_datetime(result_df.index)

    # Create a figure with subplots for the two charts
    fig, axs = plt.subplots(2, 1, figsize=(10, 10))

    # Plot the return chart
    axs[0].plot(result_df['Cum_Ror'] * 100, label='Strategy')
    axs[0].set_ylabel('Cumulative Return (%)')
    axs[0].set_title('Return Comparison Chart')
    axs[0].legend()

    # Plot the MDD and DD chart on the same graph
    axs[1].plot(result_df.index, result_df['MaxDrawdown'] * 100, label='MDD')
    axs[1].plot(result_df.index, result_df['Drawdown'] * 100, label='Drawdown')
    axs[1].set_ylabel('Drawdown (%)')
    axs[1].set_title('Drawdown Comparison Chart')
    axs[1].legend()

    # Show the plot
    plt.tight_layout()
    plt.show()
        

    


    for idx, row in result_df.iterrows():
        print(idx, " " , row['Total_Money'], " "  , row['Cum_Ror'])
        



#ë°ì´í„°ë¥¼ ë³´ê¸°ì¢‹ê²Œ í”„ë¦°íŠ¸ í•´ì£¼ëŠ” ë¡œì§!
print("\n\n--------------------")


for result in ResultList:

    print("--->>>",result['DateStr'].replace("00:00:00",""),"<<<---")


    print("---------- ì´ ê²°ê³¼ ----------")
    print("ìµœì´ˆ ê¸ˆì•¡:", format(int(round(result['OriMoney'],0)), ',') , " ìµœì¢… ê¸ˆì•¡:", format(int(round(result['FinalMoney'],0)), ','), " \nìˆ˜ìµë¥ :", round(((round(result['FinalMoney'],2) - round(result['OriMoney'],2) ) / round(result['OriMoney'],2) ) * 100,2) ,"% MDD:",  round(result['MDD'],2),"%")
    if result['TryCnt'] > 0:
        print("ì„±ê³µ:", result['SuccesCnt'] , " ì‹¤íŒ¨:", result['FailCnt']," -> ìŠ¹ë¥ : ", round(result['SuccesCnt']/result['TryCnt'] * 100.0,2) ," %")

    print("------------------------------")
    print("####################################")



