#-*-coding:utf-8 -*-
'''

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

Î∞±ÌÖåÏä§ÌåÖÏùÄ ÎÇ¥PCÏóêÏÑú Ìï¥Ïïº ÏÑúÎ≤Ñ ÏûêÏõêÏùÑ ÏïÑÎÅºÍ≥† Ìà¨Ïûê ÏÑ±Í≥º Í∑∏ÎûòÌîÑÎèÑ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§!
Ïù¥ Ìè¨Ïä§ÌåÖÏùÑ Ï†ïÎèÖÌïòÏãúÍ≥† Îã§ÏñëÌïú Í∏∞Í∞ÑÏúºÎ°ú Î∞±ÌÖåÏä§ÌåÖ Ìï¥Î≥¥ÏÑ∏Ïöî!!!
https://blog.naver.com/zacra/223180500307

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

Ìï¥Îãπ Ïª®ÌÖêÏ∏†Îäî Ï†úÍ∞Ä ÏßÅÏ†ë Ìà¨Ïûê ÌïòÍ∏∞ ÏúÑÌï¥ Ïù¥ Ï†ÑÎûµÏùÑ Ï∂îÍ∞Ä Í∞úÏÑ†Ìï¥ÏÑú Îçî Ï¢ãÏùÄ ÏÑ±Í≥ºÎ•º Î≥¥Ïó¨Ï£ºÎäî Í∞úÏù∏ Ï†ÑÎûµÏù¥ Ï°¥Ïû¨Ìï©ÎãàÎã§. 

Í≤åÎßåÏïÑ Ï∂îÍ∞Ä Í∞úÏÑ† Í∞úÏù∏ Ï†ÑÎûµÎì§..
https://blog.naver.com/zacra/223196497504

Í¥ÄÏã¨ ÏûàÏúºÏã† Î∂ÑÏùÄ ÏúÑ Ìè¨Ïä§ÌåÖÏùÑ Ï∞∏Í≥†ÌïòÏÑ∏Ïöî!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



ÏΩîÎìú Ïù¥Ìï¥ÌïòÎäîÎç∞ ÎèÑÏõÄ ÎêòÎäî ÏÑ§Î™Ö Ï∞∏Í≥† ÏòÅÏÉÅ!
https://youtu.be/IViI5gofQf4?si=Fnqm4_OmVfLnHCWD



Í¥ÄÎ†® Ìè¨Ïä§ÌåÖ

https://blog.naver.com/zacra/223375538360

ÏúÑ Ìè¨Ïä§ÌåÖÏùÑ Íº≠ Ï∞∏Í≥†ÌïòÏÑ∏Ïöî!!!

üìå Í≤åÎßåÏïÑÏùò Î™®Îì† ÏΩîÎìúÎäî ÌäπÏ†ï Ï¢ÖÎ™© Ï∂îÏ≤úÏù¥ÎÇò Ìà¨Ïûê Í∂åÏú†Î•º ÏúÑÌïú Í≤ÉÏù¥ ÏïÑÎãôÎãàÎã§.  
Ï†úÏûëÏûêÏùò Í∞úÏù∏Ï†ÅÏù∏ Í≤¨Ìï¥Î•º Î∞îÌÉïÏúºÎ°ú Íµ¨ÏÑ±Îêú ÍµêÏú°Ïö© ÏòàÏãú ÏΩîÎìúÏù¥Î©∞, ÏàòÏùµÏùÑ Î≥¥Ïû•ÌïòÏßÄ ÏïäÏäµÎãàÎã§
Ïã§Ï†ú Ìà¨Ïûê ÌåêÎã® Î∞è Ïã§ÌñâÏùÄ Ï†ÑÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Ïùò Ï±ÖÏûÑÏûÖÎãàÎã§.

Ï£ºÏãù/ÏΩîÏù∏ ÏûêÎèôÎß§Îß§ FAQ
https://blog.naver.com/zacra/223203988739

FAQÎ°ú Ìï¥Í≤∞ ÏïàÎêòÎäî Í∏∞Ïà†Ï†ÅÏù∏ Î¨∏Ï†úÎäî ÌÅ¥ÎûòÏä§101 Í∞ïÏùòÏùò ÎåìÍ∏ÄÏù¥ÎÇò ÏúÑ Ìè¨Ïä§ÌåÖÏóê ÎåìÍ∏ÄÎ°ú ÏïåÎ†§Ï£ºÏÑ∏Ïöî.
ÌååÏù¥Ïç¨ ÏΩîÎî©Ïóê ÎåÄÌïú ÎãµÎ≥ÄÎßå Í∞ÄÎä•Ìï©ÎãàÎã§. ÌòÑÌñâÎ≤ï ÏÉÅ Ìà¨Ïûê Í¥ÄÎ†® ÏßàÎ¨∏ÏùÄ ÎãµÎ≥Ä Î∂àÍ∞ÄÌïòÎã§Îäî Ï†ê ÏïåÎ†§ÎìúÎ†§Ïöî!

'''

import pandas as pd
import pprint

import matplotlib.pyplot as plt
import numpy as np
from datetime import datetime



InvestTotalMoney = 100000 

combined_df = pd.read_csv('./BinanceDataAll.csv', index_col=0)

pprint.pprint(combined_df)

IsBuy = False #Îß§Ïàò ÌñàÎäîÏßÄ Ïó¨Î∂Ä
BUY_PRICE = 0  #Îß§ÏàòÌïú Í∏àÏï°! 

TryCnt = 0      #Îß§Îß§ÌöüÏàò
SuccesCnt = 0   #ÏùµÏ†à Ïà´Ïûê
FailCnt = 0     #ÏÜêÏ†à Ïà´Ïûê


fee = 0.0015 #ÏàòÏàòÎ£å+ÏÑ∏Í∏à+Ïä¨Î¶¨ÌîºÏßÄÎ•º Îß§ÏàòÎß§ÎèÑÎßàÎã§ 0.15%Î°ú ÏÑ∏ÌåÖ!
IsFirstDateSet = False
FirstDateStr = ""
FirstDateIndex = 0

ReadyCoinList = list()

NowInvestList = list()


InvestMoney = InvestTotalMoney


DivNum = 30



InvestMoneyCell = InvestMoney / (DivNum +1)

RemainInvestMoney = InvestMoney


ResultList = list()

TotalMoneyList = list()
combined_df.index = pd.DatetimeIndex(combined_df.index).strftime('%Y-%m-%d %H:%M:%S')
i = 0
# Iterate over each date
for date in combined_df.index.unique():
    

    i += 1


    #ÎπÑÌä∏ÎÇò Ïù¥ÎçîÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÎßàÏºìÌÉÄÏù¥Î∞çÏúºÎ°ú ÌÖåÏä§ÌåÖÏùÑ Ìï†Îïå ÏïÑÎûò ÏΩîÎìúÎ°ú ÎãπÏùº ÎπÑÌä∏ÏôÄ Ïù¥Îçî Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏûàÏùå
    #btc_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == 'BTC/USDT:USDT')]

    #eth_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == 'ETH/USDT:USDT')]



    pick_coins_top = combined_df.loc[combined_df.index == date].groupby('ticker')['prevValue'].max().nlargest(60).nsmallest((int(DivNum))) #Í±∞ÎûòÎåÄÍ∏à ÏÉÅÏúÑ 30Í∞ú Ï§ë ÌïòÏúÑ 20Í∞ú

    pick_coins_top_change = combined_df.loc[combined_df.index == date].groupby('ticker')['prevChange'].max().nlargest(60).nsmallest((int(DivNum))) #Îì±ÎùΩÎ•† ÏÉÅÏúÑ 30Í∞ú Ï§ë ÌïòÏúÑ 20Í∞ú



    items_to_remove = list()

    #Ìà¨ÏûêÏ§ëÏù∏ Ìã∞Ïª§!!
    for investData in NowInvestList:
       # pprint.pprint(investData)

        ticker = investData['ticker'] 
        
        if investData['InvestMoney'] > 0:
            stock_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker)]

            if len(stock_data) == 1:


                #if IsTOP10In == True:
                NowOpenPrice = stock_data['open'].values[0] 
                PrevOpenPrice = stock_data['prevOpen'].values[0] 

                investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((NowOpenPrice - PrevOpenPrice) / PrevOpenPrice))

              

                #ÏßÑÏûÖ(Îß§Ïàò)Í∞ÄÍ≤© ÎåÄÎπÑ Î≥ÄÎèôÎ•†
                Rate = (NowOpenPrice - investData['BuyPrice']) / investData['BuyPrice']


                RevenueRate = (Rate - fee)*100.0 #ÏàòÏùµÎ•† Í≥ÑÏÇ∞



                IsSell = False

                #Îß§ÎèÑ Ï°∞Í±¥!!!!
                if stock_data['ma5_before2'].values[0] > stock_data['ma5_before'].values[0] and stock_data['prevRSI'].values[0] <= 55: 
                    IsSell = True


                if IsSell == True:

                    ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ÏàòÏàòÎ£å Î∞è ÏÑ∏Í∏à, Ïä¨Î¶¨ÌîºÏßÄ Î∞òÏòÅ!


                    TryCnt += 1

                    if RevenueRate > 0: #ÏàòÏùµÎ•†Ïù¥ 0Î≥¥Îã§ ÌÅ¨Îã§Î©¥ ÏùµÏ†àÌïú ÏÖàÏù¥Îã§!
                        SuccesCnt += 1
                    else:
                        FailCnt += 1
                
                    
                    RemainInvestMoney += ReturnMoney
                    investData['InvestMoney'] = 0


                    #pprint.pprint(NowInvestList)

                    NowInvestMoney = 0
                    for iData in NowInvestList:
                        NowInvestMoney += iData['InvestMoney']

                    InvestMoney = RemainInvestMoney + NowInvestMoney


                    print("(",ticker, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> Îß§ÎèÑ!  ÏàòÏùµÎ•†: ", round(RevenueRate,2) , "%",  " Îß§ÎèÑÍ∞Ä", NowOpenPrice, " Îß§ÏàòÎÇ†Ïßú:",str(investData['Date']))
                    print("\n\n")                

                    items_to_remove.append(investData)
            
    #Î¶¨Ïä§Ìä∏ÏóêÏÑú Ï†úÍ±∞
    for item in items_to_remove:
        NowInvestList.remove(item)


    for ticker in pick_coins_top.index:

        if ticker in ['BTC/USDT:USDT','ETH/USDT:USDT']: 
            continue

        
        IsAlReadyInvest = False
        for investData in NowInvestList:
            if ticker == investData['ticker']: 
                IsAlReadyInvest = True
                break

        IsTOPInChange = False
        for ticker_t in pick_coins_top_change.index:
            if ticker_t == ticker:
                coin_top_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker_t)]
                if len(coin_top_data) == 1:
                    IsTOPInChange = True
                    break




        stock_data = combined_df[(combined_df.index == date) & (combined_df['ticker'] == ticker)]
        if len(stock_data) == 1 and IsAlReadyInvest == False and IsTOPInChange == True: #and len(btc_data) == 1 and len(eth_data) == 1:

            NowOpenPrice = stock_data['open'].values[0] 
            BuyPrice = NowOpenPrice

            IsBuyGo = False

            #Îß§Ïàò Ï°∞Í±¥!!!!
            if stock_data['ma5_rsi_before'].values[0] < stock_data['prevRSI'].values[0] and stock_data['prevChange'].values[0] > 0 and stock_data['ma5_before'].values[0] < stock_data['prevClose'].values[0] and stock_data['ma10_before'].values[0] < stock_data['prevClose'].values[0] and stock_data['ma20_before'].values[0] < stock_data['prevClose'].values[0]:
                IsBuyGo = True


            
            if IsBuyGo == True:

                if len(NowInvestList) < int(DivNum):

                    if IsFirstDateSet == False:
                        FirstDateStr = str(date)
                        FirstDateIndex = i-1
                        IsFirstDateSet = True

                    

                    InvestGoMoney = InvestMoneyCell 
                    
                    #Í±∞ÎûòÎåÄÍ∏àÏùÑ ÌÜµÌïú Ï†úÌïú!!!
                    #'''
                    if InvestGoMoney > stock_data['value_ma'].values[0] / 2000:
                        InvestGoMoney = stock_data['value_ma'].values[0] / 2000

                    if InvestGoMoney < 10:
                        InvestGoMoney = 10
                    #'''



                    BuyAmt = float(InvestGoMoney /  BuyPrice) #Îß§Ïàò Í∞ÄÎä• ÏàòÎüâÏùÑ Íµ¨ÌïúÎã§!

                    NowFee = (BuyAmt*BuyPrice) * fee

                    #ÎÇ®ÏùÄ ÎèàÏù¥ ÏûàÎã§Î©¥ Îß§Ïàò ÌïúÎã§!!
                    if RemainInvestMoney >= (BuyAmt*BuyPrice) + NowFee:


                        RealInvestMoney = (BuyAmt*BuyPrice) #Ïã§Ï†ú Îì§Ïñ¥Í∞Ñ Ìà¨ÏûêÍ∏à

                        RemainInvestMoney -= (BuyAmt*BuyPrice) #ÎÇ®ÏùÄ Ìà¨ÏûêÍ∏à!
                        RemainInvestMoney -= NowFee


                        InvestData = dict()

                        InvestData['ticker'] = ticker
                        InvestData['InvestMoney'] = RealInvestMoney
                        InvestData['BuyPrice'] = BuyPrice
                        InvestData['Date'] = str(date)

                        NowInvestList.append(InvestData)


                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney


                        print("(",ticker, ") ", str(date), " " ,i, " >>>>>>>>>>>>>>>>> Îß§Ïàò!  Îß§ÏàòÍ∞Ä:", BuyPrice)



    NowInvestMoney = 0


    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']

    InvestMoney = RemainInvestMoney + NowInvestMoney


    InvestMoneyCell = InvestMoney / (DivNum +1)

    InvestCoinListStr = ""

    for iData in NowInvestList:
        InvestCoinListStr += iData['ticker'] + " "


    print("\n\n>>>>>>>>>>>>", InvestCoinListStr, "---> Ìà¨ÏûêÍ∞úÏàò : ", len(NowInvestList))
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>--))", str(date), " ÏûîÍ≥†:",str(InvestMoney) , "=" , str(RemainInvestMoney) , "+" , str(NowInvestMoney), "\n\n" )
    
    TotalMoneyList.append(InvestMoney)

    #####################################################
    #####################################################
    #####################################################
    #'''
    
   

#Í≤∞Í≥º Ï†ïÎ¶¨ Î∞è Îç∞Ïù¥ÌÑ∞ ÎßåÎì§Í∏∞!!
if len(TotalMoneyList) > 0:

    print("TotalMoneyList -> ", len(TotalMoneyList))


    resultData = dict()

    # Create the result DataFrame with matching shapes
    result_df = pd.DataFrame({"Total_Money": TotalMoneyList}, index=combined_df.index.unique())

    result_df['Ror'] = np.nan_to_num(result_df['Total_Money'].pct_change()) + 1
    result_df['Cum_Ror'] = result_df['Ror'].cumprod()
    result_df['Highwatermark'] = result_df['Cum_Ror'].cummax()
    result_df['Drawdown'] = (result_df['Cum_Ror'] / result_df['Highwatermark']) - 1
    result_df['MaxDrawdown'] = result_df['Drawdown'].cummin()

    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    pprint.pprint(result_df)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")

    resultData['DateStr'] = str(FirstDateStr) + " ~ " + str(result_df.iloc[-1].name)

    resultData['OriMoney'] = InvestTotalMoney
    resultData['FinalMoney'] = result_df['Total_Money'].iloc[-1]
    resultData['RevenueRate'] = ((result_df['Cum_Ror'].iloc[-1] -1.0)* 100.0)

    resultData['MDD'] = result_df['MaxDrawdown'].min() * 100.0

    resultData['TryCnt'] = TryCnt
    resultData['SuccesCnt'] = SuccesCnt
    resultData['FailCnt'] = FailCnt

    
    ResultList.append(resultData)

    result_df.index = pd.to_datetime(result_df.index)

    # Create a figure with subplots for the two charts
    fig, axs = plt.subplots(2, 1, figsize=(10, 10))

    # Plot the return chart
    axs[0].plot(result_df['Cum_Ror'] * 100, label='Strategy')
    axs[0].set_ylabel('Cumulative Return (%)')
    axs[0].set_title('Return Comparison Chart')
    axs[0].legend()

    # Plot the MDD and DD chart on the same graph
    axs[1].plot(result_df.index, result_df['MaxDrawdown'] * 100, label='MDD')
    axs[1].plot(result_df.index, result_df['Drawdown'] * 100, label='Drawdown')
    axs[1].set_ylabel('Drawdown (%)')
    axs[1].set_title('Drawdown Comparison Chart')
    axs[1].legend()

    # Show the plot
    plt.tight_layout()
    plt.show()
        

    


    for idx, row in result_df.iterrows():
        print(idx, " " , row['Total_Money'], " "  , row['Cum_Ror'])
        



#Îç∞Ïù¥ÌÑ∞Î•º Î≥¥Í∏∞Ï¢ãÍ≤å ÌîÑÎ¶∞Ìä∏ Ìï¥Ï£ºÎäî Î°úÏßÅ!
print("\n\n--------------------")


for result in ResultList:

    print("--->>>",result['DateStr'].replace("00:00:00",""),"<<<---")


    print("---------- Ï¥ù Í≤∞Í≥º ----------")
    print("ÏµúÏ¥à Í∏àÏï°:", format(int(round(result['OriMoney'],0)), ',') , " ÏµúÏ¢Ö Í∏àÏï°:", format(int(round(result['FinalMoney'],0)), ','), " \nÏàòÏùµÎ•†:", round(((round(result['FinalMoney'],2) - round(result['OriMoney'],2) ) / round(result['OriMoney'],2) ) * 100,2) ,"% MDD:",  round(result['MDD'],2),"%")
    if result['TryCnt'] > 0:
        print("ÏÑ±Í≥µ:", result['SuccesCnt'] , " Ïã§Ìå®:", result['FailCnt']," -> ÏäπÎ•†: ", round(result['SuccesCnt']/result['TryCnt'] * 100.0,2) ," %")

    print("------------------------------")
    print("####################################")



