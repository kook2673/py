'''

Í¥ÄÎ†® Ìè¨Ïä§ÌåÖ

Î¨¥ÌïúÎß§ÏàòÎ≤ï Î≥ÄÌòï Îã®ÏàúÌôîÌïòÍ≥† Î∞±ÌÖåÏä§ÌåÖÏúºÎ°ú Í∞úÏÑ†Ìï¥ÏÑú Ïó∞Î≥µÎ¶¨ 30%ÎÑòÏñ¥Í∞ÄÍ≤å  MDDÎäî Ï†àÎ∞òÏúºÎ°ú Ï§ÑÏó¨Î≥¥Í∏∞!
https://blog.naver.com/zacra/223042245494

ÏúÑ Ìè¨Ïä§ÌåÖÏùÑ Íº≠ Ï∞∏Í≥†ÌïòÏÑ∏Ïöî!!!


üìå Í≤åÎßåÏïÑÏùò Î™®Îì† ÏΩîÎìúÎäî ÌäπÏ†ï Ï¢ÖÎ™© Ï∂îÏ≤úÏù¥ÎÇò Ìà¨Ïûê Í∂åÏú†Î•º ÏúÑÌïú Í≤ÉÏù¥ ÏïÑÎãôÎãàÎã§.  
Ï†úÍ≥µÎêú Ï†ÑÎûµÏùÄ ÌïôÏäµ Î∞è ÌÖåÏä§Ìä∏ Î™©Ï†ÅÏúºÎ°ú Íµ¨ÏÑ±Îêú ÏòàÏãú ÏΩîÎìúÏù¥Î©∞
Ïã§Ï†ú Ìà¨Ïûê ÌåêÎã® Î∞è Ïã§ÌñâÏùÄ Ï†ÑÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Ïùò Ï±ÖÏûÑÏûÖÎãàÎã§.
   

Ï£ºÏãù/ÏΩîÏù∏ ÏûêÎèôÎß§Îß§ FAQ
https://blog.naver.com/zacra/223203988739

FAQÎ°ú Ìï¥Í≤∞ ÏïàÎêòÎäî Í∏∞Ïà†Ï†ÅÏù∏ Î¨∏Ï†úÎäî ÌÅ¥ÎûòÏä§101 Í∞ïÏùòÏùò ÎåìÍ∏ÄÏù¥ÎÇò ÏúÑ Ìè¨Ïä§ÌåÖÏóê ÎåìÍ∏ÄÎ°ú ÏïåÎ†§Ï£ºÏÑ∏Ïöî.
ÌååÏù¥Ïç¨ ÏΩîÎî©Ïóê ÎåÄÌïú ÎãµÎ≥ÄÎßå Í∞ÄÎä•Ìï©ÎãàÎã§. ÌòÑÌñâÎ≤ï ÏÉÅ Ìà¨Ïûê Í¥ÄÎ†® ÏßàÎ¨∏ÏùÄ ÎãµÎ≥Ä Î∂àÍ∞ÄÌïòÎã§Îäî Ï†ê ÏïåÎ†§ÎìúÎ†§Ïöî!
   

'''
import KIS_Common as Common
import KIS_API_Helper_US as KisUS
import json
import pprint
import line_alert

Common.SetChangeMode("VIRTUAL")

#####################################################################################################################################
'''
‚Äª Ï£ºÎ¨∏ Ïã§Ìñâ Ïó¨Î∂Ä ÏÑ§Ï†ï

ENABLE_ORDER_EXECUTION Í∞íÏùÑ TrueÎ°ú Î≥ÄÍ≤ΩÌï† Í≤ΩÏö∞,  
Ï†ÑÎûµÏóê Îî∞Îùº Îß§Îß§Í∞Ä ÏùºÏñ¥ÎÇ©ÎãàÎã§.

‚ö†Ô∏è Í∏∞Î≥∏Í∞íÏùÄ FalseÏù¥Î©∞,  
Ïã§Ìñâ Ïó¨Î∂ÄÎäî ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Ïù¥ ÏΩîÎìúÎ•º ÏàòÏ†ïÌïòÏó¨ Í≤∞Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.
'''

ENABLE_ORDER_EXECUTION = False  # Ï£ºÎ¨∏ Ïã§Ìñâ Ïó¨Î∂Ä ÏÑ§Ï†ï (Í∏∞Î≥∏Í∞í: False)

'''
üìå Î≥∏ Ï†ÑÎûµÏùÄ ÏãúÏä§ÌÖúÏùÑ Íµ¨ÌòÑÌïòÎäî ÏòàÏãú ÏΩîÎìúÏù¥Î©∞,  
Ïã§Ï†ú Ìà¨Ïûê Î∞è Ï£ºÎ¨∏ Ïã§ÌñâÏùÄ ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Ïùò ÏùòÏÇ¨ÏôÄ Ï±ÖÏûÑ ÌïòÏóê ÏàòÌñâÎê©ÎãàÎã§.
'''
#####################################################################################################################################

'''
üìå Ìà¨ÏûêÌï† Ï¢ÖÎ™©ÏùÄ Î≥∏Ïù∏Ïùò ÏÑ†ÌÉùÏúºÎ°ú Î¶¨Ïä§Ìä∏ ÌòïÏãùÏúºÎ°ú ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏÑ∏Ïöî!
'''
#Ìà¨ÏûêÌï† Ï¢ÖÎ™©!
TargetStockList = [] #Ìà¨ÏûêÌï† Ï¢ÖÎ™©ÏùÑ ÏïÑÎûò Ï≤òÎüº ÏßÅÏ†ë ÌåêÎã®ÌûàÏó¨ ÎÑ£ÏúºÏÑ∏Ïöî!
#TargetStockList = ['TQQQ','SOXL'] #ÏòàÏãú Ï¢ÖÎ™©
#####################################################################################################################################

'''
üìå Ìà¨Ïûê ÎπÑÏ§ë ÏÑ§Ï†ï!
Í∏∞Î≥∏ÏùÄ 0ÏúºÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏñ¥Ïöî.
Î≥∏Ïù∏Ïùò Ìà¨Ïûê ÎπÑÏ§ëÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî! 

Ï†ÑÎûµÏóêÏÑú ÌôúÏö©Ìï† Ï£ºÎ¨∏Ïù¥ 
ÏãúÏû•Í∞Ä Ï£ºÎ¨∏Ïù¥ÎùºÎ©¥ 0 ~ 0.75 
ÏßÄÏ†ïÍ∞Ä Ï£ºÎ¨∏Ïù¥ÎùºÎ©¥ 0 ~ 0.98
ÏÇ¨Ïù¥Ïùò Í∞íÏúºÎ°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî! (0.1 = 10% 0.5 = 50%)
'''
InvestRate = 0 #Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°ÏóêÏÑú Ìï¥Îãπ Î¥áÏóêÍ≤å Ìï†ÎãπÌï† Ï¥ù Í∏àÏï°ÎπÑÏú® 0.1 = 10%  0.5 = 50%
#####################################################################################################################################




BOT_NAME = Common.GetNowDist() + "_InfinityUpgradeBot"

#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$#
############# Ìï¥Îãπ Ï†ÑÎûµÏúºÎ°ú Îß§ÏàòÌïú Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§Ìä∏ ####################
InfinityUpgradeDataList = list()
#ÌååÏùº Í≤ΩÎ°úÏûÖÎãàÎã§.
bot_file_path = "/var/autobot/UsStock_" + BOT_NAME + ".json"

try:
    #Ïù¥ Î∂ÄÎ∂ÑÏù¥ ÌååÏùºÏùÑ ÏùΩÏñ¥ÏÑú Î¶¨Ïä§Ìä∏Ïóê ÎÑ£Ïñ¥Ï£ºÎäî Î°úÏßÅÏûÖÎãàÎã§. 
    with open(bot_file_path, 'r') as json_file:
        InfinityUpgradeDataList = json.load(json_file)

except Exception as e:
    print("Exception by First")
################################################################
#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$#
#$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$#


#Í≥ÑÏ¢å ÏûîÍ≥†Î•º Í∞ÄÏßÄÍ≥† Ïò®Îã§!
Balance = KisUS.GetBalance()



print("--------------ÎÇ¥ Î≥¥Ïú† ÏûîÍ≥†---------------------")

pprint.pprint(Balance)

print("--------------------------------------------")


#Í∏∞Ï§ÄÏù¥ ÎêòÎäî ÎÇ¥ Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°ÏóêÏÑú Ìà¨ÏûêÎπÑÏ§ëÏùÑ Í≥±Ìï¥ÏÑú ÎÇòÏò® Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Ïóê Ìï†ÎãπÎêú Îèà!!
TotalMoney = float(Balance['TotalMoney']) * InvestRate

#Í∞Å Ï¢ÖÎ™©Îãπ Ìà¨ÏûêÌï† Í∏àÏï°! Î¶¨Ïä§Ìä∏Ïùò Ï¢ÖÎ™© Í∞úÏàòÎ°ú ÎÇòÎààÎã§!
StockMoney = TotalMoney / len(TargetStockList)
print("TotalMoney:", str(format(round(TotalMoney), ',')))
print("StockMoney:", str(format(round(StockMoney), ',')))





print("--------------ÎÇ¥ Î≥¥Ïú† Ï£ºÏãù---------------------")
#Í∑∏Î¶¨Í≥† ÌòÑÏû¨ Ïù¥ Í≥ÑÏ¢åÏóêÏÑú Î≥¥Ïú†Ìïú Ï£ºÏãù Î¶¨Ïä§Ìä∏Î•º Í∞ÄÏßÄÍ≥† ÏòµÎãàÎã§!
MyStockList = KisUS.GetMyStockList()
pprint.pprint(MyStockList)
print("--------------------------------------------")
    

if ENABLE_ORDER_EXECUTION == True:


    #ÎßàÏºìÏù¥ Ïó¥Î†∏ÎäîÏßÄ Ïó¨Î∂Ä~!
    IsMarketOpen = KisUS.IsMarketOpen()

    #Ïû•Ïù¥ Ïó¥Î†∏ÏùÑ Îïå!
    if IsMarketOpen == True:


        #Ìà¨ÏûêÌï† Ï¢ÖÎ™©ÏùÑ ÏàúÌöåÌïúÎã§!
        for stock_code in TargetStockList:

            #Ï£ºÏãù(ETF) Ï†ïÎ≥¥~
            stock_name = ""
            stock_amt = 0 #ÏàòÎüâ
            stock_avg_price = 0 #ÌèâÎã®
            stock_eval_totalmoney = 0 #Ï¥ùÌèâÍ∞ÄÍ∏àÏï°!
            stock_revenue_rate = 0 #Ï¢ÖÎ™© ÏàòÏùµÎ•†
            stock_revenue_money = 0 #Ï¢ÖÎ™© ÏàòÏùµÍ∏à


            #Îß§ÏàòÎêú ÏÉÅÌÉúÎùºÎ©¥ Ï†ïÎ≥¥Î•º ÎÑ£Ïñ¥Ï§ÄÎã§!!!
            for my_stock in MyStockList:
                if my_stock['StockCode'] == stock_code:
                    stock_name = my_stock['StockName']
                    stock_amt = int(my_stock['StockAmt'])
                    stock_avg_price = float(my_stock['StockAvgPrice'])
                    stock_eval_totalmoney = float(my_stock['StockNowMoney'])
                    stock_revenue_rate = float(my_stock['StockRevenueRate'])
                    stock_revenue_money = float(my_stock['StockRevenueMoney'])

                    break
                    

            #ÌòÑÏû¨Í∞Ä
            CurrentPrice = KisUS.GetCurrentPrice(stock_code)

                
            #Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞
            PickStockInfo = None

            #Ï†ÄÏû•Îêú Ï¢ÖÎ™© Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÎäîÎã§
            for StockInfo in InfinityUpgradeDataList:
                if StockInfo['StockCode'] == stock_code:
                    PickStockInfo = StockInfo
                    break

            #PickStockInfo Ïù¥Í≤å ÏóÜÎã§Î©¥ Îß§ÏàòÎêòÏßÄ ÏïäÏùÄ Ï≤òÏùå ÏÉÅÌÉúÏù¥Í±∞ÎÇò Ïù¥Ï†ÑÏóê ÏÜêÏúºÎ°ú Îß§ÏàòÌïú Ï¢ÖÎ™©Ïù∏Îç∞ Ìï¥Îãπ Î¥áÏúºÎ°ú ÎèåÎ¶¨Í≥†Ïûê Ìï† Îïå!
            if PickStockInfo == None:
                #ÏûîÍ≥†Í∞Ä ÏóÜÎã§ Ï¶â Ï≤òÏùåÏù¥Îã§!!!
                if stock_amt == 0:

                    InfinityDataDict = dict()
                    
                    InfinityDataDict['StockCode'] = stock_code #Ï¢ÖÎ™© ÏΩîÎìú
                    InfinityDataDict['MaxRound'] = 40 #Îß•Ïä§ ÌöåÏ∞®!
                    InfinityDataDict['Round'] = 0    #ÌòÑÏû¨ ÌöåÏ∞®
                    InfinityDataDict['IsReady'] = 'Y' #ÌïòÎ£®Ïóê ÌïúÎ≤à Ï≤¥ÌÅ¨ÌïòÍ≥† Îß§ÏàòÎì±Ïùò Ï≤òÎ¶¨Î•º ÌïòÍ∏∞ ÏúÑÌïú ÌîåÎûòÍ∑∏

                    InfinityUpgradeDataList.append(InfinityDataDict) #Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÍ∞Ä ÌïúÎã§!


                    msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á Ï≤´ ÏãúÏûë!!!!"
                    print(msg) 
                    line_alert.SendMessage(msg) 
                    
                #Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäîÎç∞ ÏûîÍ≥†Í∞Ä ÏûàÎã§? Ïù¥ÎØ∏ Ïù¥ Î¥áÏúºÎ°ú Ìä∏Î†àÏù¥Îî© ÌïòÍ∏∞Ï†ÑÏóê Îß§ÏàòÎêú Ï¢ÖÎ™©!
                else:
                    print("Exist")

                    InfinityDataDict = dict()
                    
                    InfinityDataDict['StockCode'] = stock_code #Ï¢ÖÎ™© ÏΩîÎìú
                    InfinityDataDict['MaxRound'] = 40 #Îß•Ïä§ ÌöåÏ∞®!
                    
                    #Î∂ÑÌï†Îêú Ìà¨ÏûêÍ∏à!
                    StMoney = StockMoney / InfinityDataDict['MaxRound']
                    InfinityDataDict['Round'] = int(stock_eval_totalmoney / StMoney)    #ÌòÑÏû¨ ÌöåÏ∞® - Îß§ÏàòÎêú Í∏àÏï°ÏùÑ Î∂ÑÌï†Îêú Îã®ÏúÑ Í∏àÏï°ÏúºÎ°ú ÎÇòÎàÑÎ©¥ ÌöåÏ∞®Í∞Ä ÎÇòÏò®Îã§!
                    InfinityDataDict['IsReady'] = 'Y' #ÌïòÎ£®Ïóê ÌïúÎ≤à Ï≤¥ÌÅ¨ÌïòÍ≥† Îß§ÏàòÎì±Ïùò Ï≤òÎ¶¨Î•º ÌïòÍ∏∞ ÏúÑÌïú ÌîåÎûòÍ∑∏


                    InfinityUpgradeDataList.append(InfinityDataDict) #Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÍ∞Ä ÌïúÎã§!


                    msg = stock_code + " Í∏∞Ï°¥Ïóê Îß§ÏàòÌïú Ï¢ÖÎ™©ÏùÑ Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥áÏúºÎ°ú Î≥ÄÍ≤ΩÌï¥ÏÑú Ìä∏Î†àÏù¥Îî© Ï≤´ ÏãúÏûë!!!! " + str(InfinityDataDict['Round']) + "ÌöåÏ∞®Î°ú ÏÑ∏ÌåÖ ÏôÑÎ£å!"
                    print(msg) 
                    line_alert.SendMessage(msg) 

                #ÌååÏùºÏóê Ï†ÄÏû•
                with open(bot_file_path, 'w') as outfile:
                    json.dump(InfinityUpgradeDataList, outfile)
                    

            #Ïù¥Ï†ú Îç∞Ïù¥ÌÑ∞(InfinityUpgradeDataList)Îäî ÌôïÏã§Ìûà ÏûàÏùÑ ÌÖåÎãà Î≥∏Í≤©Ï†ÅÏúºÎ°ú Ìä∏Î†àÏù¥Îî©ÏùÑ Ìï©ÎãàÎã§!
            for StockInfo in InfinityUpgradeDataList:

                if StockInfo['StockCode'] == stock_code:
                    

                    #Îß§ÏàòÎäî Ïû•Ïù¥ Ïó¥Î†∏ÏùÑ Îïå 1Î≤àÎßå Ìï¥Ïïº ÎêòÎãàÍπê! ÏïàÏùò Î°úÏßÅÏùÑ Îã§ ÏàòÌñâÌïòÎ©¥ NÏúºÎ°ú Î∞îÍøîÏ§ÄÎã§! 
                    if StockInfo['IsReady'] == 'Y' :


                        #Ï∫îÎì§ Îç∞Ïù¥ÌÑ∞Î•º ÏùΩÎäîÎã§
                        df = Common.GetOhlcv("US",stock_code, 1000)

                        #5Ïùº Ïù¥ÌèâÏÑ†
                        Ma5_before2 = Common.GetMA(df,5,-3)
                        Ma5_before = Common.GetMA(df,5,-2)
                        Ma5 = Common.GetMA(df,5,-1)

                        print("MA5 ", Ma5_before, "-> ",Ma5)

                        #200Ïùº Ïù¥ÌèâÏÑ†
                        Ma200_before2 = Common.GetMA(df,200,-3)
                        Ma200_before = Common.GetMA(df,200,-2)
                        Ma200 = Common.GetMA(df,200,-1)

                        print("MA200 ",Ma200)

                        
                        #RSI14
                        Rsi14= Common.GetRSI(df,14,-2)
                        
                        #107Ïùº Ïù¥ÌèâÏÑ†
                        Ma107_before = Common.GetMA(df,107,-2)
                        
                        Ma100_before = Common.GetMA(df,100,-2)
                        Ma60_before = Common.GetMA(df,60,-2)
                        Ma20_before = Common.GetMA(df,20,-2)
                        
                        #3Ïùº Ïù¥ÌèâÏÑ†
                        Ma3_before2 = Common.GetMA(df,3,-3)
                        Ma3_before = Common.GetMA(df,3,-2)
                        
                    

                        #1ÌöåÏ∞® Ïù¥ÏÉÅ Îß§ÏàòÎêú ÏÉÅÌô©Ïù¥ÎùºÎ©¥ ÏùµÏ†à Ï°∞Í±¥ÏùÑ Ï≤¥ÌÅ¨Ìï¥ÏÑú ÏùµÏ†à Ï≤òÎ¶¨ Ìï¥Ïïº ÌïúÎã§!
                        if StockInfo['Round'] > 0 :
                            


                            #Î™©Ìëú ÏàòÏùµÎ•†ÏùÑ Íµ¨ÌïúÎã§! 
                            TargetRate = 10.0  / 100.0

                            FinalRate = TargetRate 

                            #ÏàòÏùµÌôîÌï† Í∞ÄÍ≤©ÏùÑ Íµ¨ÌïúÎã§!
                            RevenuePrice = stock_avg_price * (1.0 + FinalRate) 
                            
                            if CurrentPrice >= RevenuePrice or StockInfo['Round'] >= StockInfo['MaxRound']:

                                #Î™©ÌëúÌïú ÏàòÏùµÍ∞ÄÍ≤©Î≥¥Îã§ ÌòÑÏû¨Í∞ÄÍ∞Ä ÎÜíÎã§Î©¥ ÏùµÏ†àÏ≤òÎ¶¨Ìï† ÏàúÍ∞ÑÏù¥Îã§!
                                if CurrentPrice >= RevenuePrice:
                                    
            
                                    #ÌòÑÏû¨Í∞ÄÎ≥¥Îã§ ÏïÑÎûòÏóê Îß§ÎèÑ Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏùåÏúºÎ°úÏç® ÏãúÏû•Í∞ÄÎ°ú Îß§ÎèÑÌö®Í≥º!
                                    pprint.pprint(KisUS.MakeSellLimitOrder(stock_code,stock_amt,CurrentPrice*0.99))


                                    msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á Î™®Îëê ÌåîÏïÑÏÑú ÏàòÏùµÌôïÏ†ï!!!!  [" + str(stock_revenue_money) + "] ÏàòÏùµ Ï°∞ÏúºÎã§! (ÌòÑÏû¨ [" + str(StockInfo['Round']) + "] ÎùºÏö¥ÎìúÍπåÏßÄ ÏßÑÌñâÎêòÏóàÍ≥† Î™®Îì† ÏàòÎüâ Îß§ÎèÑ Ï≤òÎ¶¨! )"
                                    print(msg) 
                                    line_alert.SendMessage(msg) 

                                    #Ï†ÑÎüâ Îß§ÎèÑ Î™®Îëê Ï¥àÍ∏∞Ìôî! 
                                    StockInfo['Round'] = 0


                                    #ÌååÏùºÏóê Ï†ÄÏû•
                                    with open(bot_file_path, 'w') as outfile:
                                        json.dump(InfinityUpgradeDataList, outfile)
                                        
                                        
                                else:
                                    
                                    
                                    if StockInfo['Round'] >= StockInfo['MaxRound']: #ÏøºÌÑ∞ ÏÜêÏ†à Îì§Ïñ¥Í∞ÑÎã§!
                                        
                                        StockInfo['Round'] -= int(StockInfo['Round']/4.0)
                                        CutAmt = int(stock_amt / 4.0)

                                        pprint.pprint(KisUS.MakeSellLimitOrder(stock_code,CutAmt,CurrentPrice*0.99))


                                        msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á ÏøºÌÑ∞ ÏÜêÏ†à!!!!  [" + str(stock_revenue_money/4.0) + "] ÏÜêÏùµ ÌôïÏ†ï! (ÌòÑÏû¨ [" + str(StockInfo['Round']) + "] ÎùºÏö¥ÎìúÎ°ú ÏÖã!)"
                                        print(msg) 
                                        line_alert.SendMessage(msg) 


                                        #ÌååÏùºÏóê Ï†ÄÏû•
                                        with open(bot_file_path, 'w') as outfile:
                                            json.dump(InfinityUpgradeDataList, outfile)
                                            
                                            
                            else:
                                


                                if StockInfo['Round'] < StockInfo['MaxRound']:
                                    
                                    #Í∞úÏÑ†Î≥∏ÏùÑ ÏÇ¨Ïö©ÌïúÎã§Î©¥ Ïù¥ Î∂ÄÎ∂Ñ Ï£ºÏÑùÏ≤òÎ¶¨ Ìï¥Ïïº Ìï¥Ïöî!
                                    IsBuyGo = False
                                    
                                    ##########################################################################################
                                    ##########################################################################################
                                    ############### Î∏îÎ°úÍ∑∏ ÎÇ¥Ïö© ÏàòÏ†ï ÏòàÏ†ïÏù¥ÏßÄÎßå Îß§ÏàòÎäî 100ÏùºÏÑ† ÏïÑÎûòÏóêÏÑú 3ÏùºÏÑ†Ïù¥ Ï¶ùÍ∞ÄÎê†ÎïåÎ°ú Î≥ÄÍ≤Ω ÎêòÏóàÏäµÎãàÎã§ ################
                                    ##########################################################################################
                                    ##########################################################################################
                        
                                    if Ma100_before > df['close'].iloc[-2]: #Ïñ¥Ï†ú Ï¢ÖÍ∞ÄÍ∞Ä 100ÏùºÏÑ†Î≥¥Îã§ ÏûëÏùÄ ÌïòÎùΩÏû•!

                                        if Ma3_before2 < Ma3_before: #Ï†ÑÏùºÍπåÏßÄ 3ÏùºÏÑ†Ïù¥ Ï¶ùÍ∞ÄÌñàÎã§Î©¥ Í∑∏ÎïåÎßå Îß§Ïàò!!
                                            IsBuyGo = True

                                    else: #200ÏùºÏÑ† ÏúÑÏóê ÏûàÎäî ÏÉÅÏäπÏû•Ïóî Í∏∞Ï°¥ Ï≤òÎüº Îß§Ïùº Îß§Ïàò!
                                        
                                        IsBuyGo = True
                                    #Ïó¨Í∏∞ÍπåÏßÄ Ï£ºÏÑùÏ≤òÎ¶¨Ïöî!!!!!!!!
                                                    

                                    ############# GMA Í∞úÏÑ†Î≥∏!! ÏãúÏûë #############
                                    ''' #Í∞úÏÑ†Î≥∏ ÏÇ¨Ïö©Ïãú ÏúÑ Î∂ÄÎ∂ÑÏùÄ Ï£ºÏÑùÏ≤òÎ¶¨!!!
                                    IsBuyGo = False
                                    if Ma107_before > df['close'].iloc[-2]: #ÌòÑÏû¨Í∞ÄÍ∞Ä 107ÏùºÏÑ†Î≥¥Îã§ ÏûëÏùÄ ÌïòÎùΩÏû•!

                                        if Ma3_before2 < Ma3_before: #Ï†ÑÏùºÍπåÏßÄ 3ÏùºÏÑ†Ïù¥ Ï¶ùÍ∞ÄÌñàÎã§Î©¥ Í∑∏ÎïåÎßå Îß§Ïàò!!
                                            IsBuyGo = True

                                    else: #107ÏùºÏÑ† ÏúÑÏóê ÏûàÎäî ÏÉÅÏäπÏû•Ïóî Í∏∞Ï°¥ Ï≤òÎüº Îß§Ïùº Îß§Ïàò!
                                        
                                        IsBuyGo = True
                                    '''
                                    ############# GMA Í∞úÏÑ†Î≥∏!! ÎÅù #############
                        
                        
                                    ############# GMA Í∞úÏÑ†Î≥∏!! ÏãúÏûë #############
                                    '''
                                    if Rsi14 >= 80: # Í∞úÏÑ†Îêú Ï†ê GMA #RSI 80Ïù¥ÏÉÅÏùò Í≥ºÎß§ÎèÑ Íµ¨Í∞ÑÏóêÏÑ† ÌöåÏ∞® Îß§Ïàò ÏïàÌï®!!
                                        IsBuyGo = False

                                    '''
                                    ############# GMA Í∞úÏÑ†Î≥∏!! ÎÅù #############
                        
                        
                                    #200ÏùºÏÑ† ÏúÑÏóê ÏûàÎã§Í∞Ä ÏïÑÎûòÎ°ú Ï¢ÖÍ∞ÄÍ∞Ä Îñ®Ïñ¥ÏßÄÎ©¥...
                                    if (Ma200_before2 < df['close'].iloc[-3] and Ma200_before > df['close'].iloc[-2]) :
                                    

                                        #ÌòÑÏû¨Í∞ÄÎ≥¥Îã§ ÏïÑÎûòÏóê Îß§ÎèÑ Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏùåÏúºÎ°úÏç® ÏãúÏû•Í∞ÄÎ°ú Îß§ÎèÑÌö®Í≥º!
                                        pprint.pprint(KisUS.MakeSellLimitOrder(stock_code,stock_amt,CurrentPrice*0.99))


                                        msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á ÌïòÎùΩÏû• ÏßÑÏûÖ!!!!!  [" + str(stock_revenue_money) + "] ÏÜêÏùµ ÌôïÏ†ï!! (ÌòÑÏû¨ [" + str(StockInfo['Round']) + "] ÎùºÏö¥ÎìúÍπåÏßÄ ÏßÑÌñâÎêòÏóàÍ≥† Î™®Îì† ÏàòÎüâ Îß§ÎèÑ Ï≤òÎ¶¨! )"
                                        print(msg) 
                                        line_alert.SendMessage(msg) 

                                        #Ï†ÑÎüâ Îß§ÎèÑ Î™®Îëê Ï¥àÍ∏∞Ìôî! 
                                        StockInfo['Round'] = 0


                                        #ÌååÏùºÏóê Ï†ÄÏû•
                                        with open(bot_file_path, 'w') as outfile:
                                            json.dump(InfinityUpgradeDataList, outfile)
                                            
                                        IsBuyGo = False
                                            
                        

                                    #Ìïú ÌöåÏ∞® Îß§Ïàò ÌïúÎã§!!
                                    if IsBuyGo == True:

                                        StockInfo['Round'] += 1 #ÎùºÏö¥Îìú Ï¶ùÍ∞Ä!

                        
                                        #Î∂ÑÌï†Îêú Ìà¨ÏûêÍ∏à!
                                        StMoney = StockMoney / StockInfo['MaxRound']


                                        BuyAmt = int(StMoney / CurrentPrice)
                                        
                                        #1Ï£ºÎ≥¥Îã§ Ï†ÅÎã§Î©¥ Ìà¨ÏûêÍ∏àÏù¥ÎÇò Ìà¨ÏûêÎπÑÏ§ëÏù¥ ÏûëÏùÄ ÏÉÅÌô©Ïù∏Îç∞ ÏùºÎã® 1Ï£ºÎäî Îß§ÏàòÌïòÍ≤åÎÅî Ï≤òÎ¶¨ ÌïòÏûê!
                                        if BuyAmt < 1:
                                            BuyAmt = 1

                                        #ÏãúÏû•Í∞Ä Ï£ºÎ¨∏ÏùÑ ÎÑ£ÎäîÎã§!
                                        #ÌòÑÏû¨Í∞ÄÎ≥¥Îã§ ÏúÑÏóê Îß§Ïàò Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏùåÏúºÎ°úÏç® ÏãúÏû•Í∞ÄÎ°ú Îß§Ïàò!
                                        pprint.pprint(KisUS.MakeBuyLimitOrder(stock_code,BuyAmt,CurrentPrice*1.01))


                                        msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á " + str(StockInfo['Round']) + "ÌöåÏ∞® Îß§Ïàò ÏôÑÎ£å!"
                                        print(msg) 
                                        line_alert.SendMessage(msg) 

        
                        
                        
                        if StockInfo['Round'] == 0 and Ma5_before < df['close'].iloc[-2] : #Ï†ÑÏùº Ï¢ÖÍ∞ÄÍ∞Ä 5ÏùºÏÑ† ÏúÑÏóê ÏûàÏùÑ ÎïåÎßå 
                            
                            if Ma200_before > df['close'].iloc[-2]: #200ÏùºÏÑ† ÏïÑÎûòÏóê ÏûàÏùÑ Îïê 40Î∂ÑÌï†
                                StockInfo['MaxRound'] = 40
                                
                            else: # 200ÏùºÏÑ† ÏúÑÏóê ÏûàÏùÑ Îïê 30Î∂ÑÌï†
                                StockInfo['MaxRound'] = 30 
                                
                                ############# GMA Í∞úÏÑ†Î≥∏!! ÏãúÏûë #############
                                '''
                                StockInfo['MaxRound'] = 55

                                
                                if Ma100_before <= df['close'].iloc[-2]:
                                    StockInfo['MaxRound'] -= 15


                                if Ma60_before <= df['close'].iloc[-2]:
                                    StockInfo['MaxRound'] -= 8


                                if Ma20_before <= df['close'].iloc[-2]:
                                    StockInfo['MaxRound'] -= 7     
                                '''    
                                ############# GMA Í∞úÏÑ†Î≥∏!! ÎÅù #############
                    
                            
                            StockInfo['Round'] += 1 #ÎùºÏö¥Îìú Ï¶ùÍ∞Ä!

            
                            #Î∂ÑÌï†Îêú Ìà¨ÏûêÍ∏à!
                            StMoney = StockMoney / StockInfo['MaxRound']


                            BuyAmt = int(StMoney / CurrentPrice)
                            
                            #1Ï£ºÎ≥¥Îã§ Ï†ÅÎã§Î©¥ Ìà¨ÏûêÍ∏àÏù¥ÎÇò Ìà¨ÏûêÎπÑÏ§ëÏù¥ ÏûëÏùÄ ÏÉÅÌô©Ïù∏Îç∞ ÏùºÎã® 1Ï£ºÎäî Îß§ÏàòÌïòÍ≤åÎÅî Ï≤òÎ¶¨ ÌïòÏûê!
                            if BuyAmt < 1:
                                BuyAmt = 1

                            #ÏãúÏû•Í∞Ä Ï£ºÎ¨∏ÏùÑ ÎÑ£ÎäîÎã§!
                            #ÌòÑÏû¨Í∞ÄÎ≥¥Îã§ ÏúÑÏóê Îß§Ïàò Ï£ºÎ¨∏ÏùÑ ÎÑ£ÏùåÏúºÎ°úÏç® ÏãúÏû•Í∞ÄÎ°ú Îß§Ïàò!
                            pprint.pprint(KisUS.MakeBuyLimitOrder(stock_code,BuyAmt,CurrentPrice*1.01))


                            msg = stock_code + " Í∞úÏÑ†Î¨¥ÌïúÎß§ÏàòÎ¥á " + str(StockInfo['Round']) + "ÌöåÏ∞® Îß§Ïàò ÏôÑÎ£å!"
                            print(msg) 
                            line_alert.SendMessage(msg) 
                                    
                                    
                                    
                                
                        #ÏúÑ Î°úÏßÅ ÏôÑÎ£åÌïòÎ©¥ NÏúºÎ°ú Î∞îÍøîÏÑú Ïò§Îäò Îß§ÏàòÎäî ÏïàÎêòÍ≤å Ï≤òÎ¶¨!
                        StockInfo['IsReady'] = 'N' 

                        #ÌååÏùºÏóê Ï†ÄÏû•
                        with open(bot_file_path, 'w') as outfile:
                            json.dump(InfinityUpgradeDataList, outfile) 
                            
                    break

    else:

            
        #Ïû•Ïù¥ ÎÅùÎÇòÍ≥† Îã§ÏùåÎÇ† Îã§Ïãú Îß§ÏàòÏãúÎèÑ Ìï†Ïàò ÏûàÍ≤å YÎ°ú Î∞îÍøîÏ§çÎãàÎãπ!
        for StockInfo in InfinityUpgradeDataList:
            StockInfo['IsReady'] = 'Y'


        #ÌååÏùºÏóê Ï†ÄÏû•
        with open(bot_file_path, 'w') as outfile:
            json.dump(InfinityUpgradeDataList, outfile)
            
            
    pprint.pprint(InfinityUpgradeDataList)

    
else:
    print("ÏΩîÎìú Îß® Ï≤´ Î∂ÄÎ∂ÑÏóê ENABLE_ORDER_EXECUTION Í∞íÏùÑ TrueÎ°ú Î≥ÄÍ≤ΩÌï¥Ïïº Îß§ÏàòÎß§ÎèÑÍ∞Ä ÏßÑÌñâÎê©ÎãàÎã§!")