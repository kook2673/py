# -*- coding: utf-8 -*-
'''


$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

í•´ë‹¹ ì»¨í…ì¸ ëŠ” ì œê°€ ì§ì ‘ íˆ¬ì í•˜ê¸° ìœ„í•´ ì´ ì „ëµì„ ì¶”ê°€ ê°œì„ í•´ì„œ ë” ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°œì¸ ì „ëµì´ ì¡´ì¬í•©ë‹ˆë‹¤. 

í•´ë‹¹ ì „ëµ ì¶”ê°€ ê°œì„ í•œ ë²„ì „ ì•ˆë‚´
https://blog.naver.com/zacra/223577385295

ê²Œë§Œì•„ ì¶”ê°€ ê°œì„  ê°œì¸ ì „ëµë“¤..
https://blog.naver.com/zacra/223196497504


ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ ìœ„ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì„¸ìš”!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



ê´€ë ¨ í¬ìŠ¤íŒ…
https://blog.naver.com/zacra/223559959653

ìœ„ í¬ìŠ¤íŒ…ì„ ê¼­ ì°¸ê³ í•˜ì„¸ìš”!!!


ğŸ“Œ [ì½”ë“œ ì œê³µ ëª©ì ]

ì´ ì½”ë“œëŠ” í´ë˜ìŠ¤101 ê²Œë§Œì•„ <íŒŒì´ì¬ ìë™ë§¤ë§¤ ë´‡ ë§Œë“¤ê¸°> ê°•ì˜ì˜ ë³´ì¡° ìë£Œë¡œ ì œê³µë˜ë©°,  
ê°•ì˜ ìˆ˜ê°•ìƒì˜ **í•™ìŠµ ë° ì‹¤ìŠµì„ ìœ„í•œ ì°¸ê³ ìš© ì˜ˆì‹œ ì½”ë“œ**ì…ë‹ˆë‹¤.  
**íˆ¬ì ê¶Œìœ , ì¢…ëª© ì¶”ì²œ, ìë¬¸ ë˜ëŠ” ì¼ì„ì„ ìœ„í•œ ëª©ì ì€ ì „í˜€ ì—†ìŠµë‹ˆë‹¤.**

ğŸ“Œ [ê¸°ìˆ  êµ¬í˜„ ê´€ë ¨ ì•ˆë‚´]

- ë³¸ ì½”ë“œëŠ” **ì¦ê¶Œì‚¬ì—ì„œ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•œ API** ë°  
  **ê³µì‹ ê°œë°œì ê°€ì´ë“œ ë¬¸ì„œ**ì— ë”°ë¼ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.
- í•´ë‹¹ APIëŠ” ì¼ë°˜ íˆ¬ìì ëˆ„êµ¬ë‚˜ ì´ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ì´ë©°,  
  ë³¸ ì½”ë“œëŠ” ê·¸ê²ƒì„ êµ¬í˜„í•œ ì˜ˆì‹œë¥¼ í™œìš©í•´ ì „ëµì„ êµ¬í˜„í•´ë³´ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œ í™œìš©í•œ ê²ƒì…ë‹ˆë‹¤.

ğŸ“Œ [ì „ëµ ì‹¤í–‰ ì¡°ê±´]

- ë³¸ ì½”ë“œëŠ” ìë™ ë°˜ë³µ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ ì‹¤í–‰í•´ì•¼ 1íšŒ ë™ì‘í•©ë‹ˆë‹¤.
- ë°˜ë³µ ì‹¤í–‰ì„ ì›í•  ê²½ìš°, ì‚¬ìš©ìê°€ ë³„ë„ë¡œ ì„œë²„ ë° ìŠ¤ì¼€ì¤„ëŸ¬ êµ¬ì„±ì„ í•´ì•¼ í•©ë‹ˆë‹¤.


- ë³¸ ì½”ë“œì—ëŠ” ì¦ê¶Œì‚¬ ì œê³µ APIë¥¼ í™œìš©í•œ ë§¤ë§¤ ê¸°ëŠ¥ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë‚˜,  
  **ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ì„ ë³€ê²½í•˜ì§€ ì•ŠëŠ” í•œ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
  

- ì „ëµ ì‹¤í–‰ì„ ìœ„í•´ì„œëŠ” ë‹¤ìŒì˜ ê³¼ì •ì„ **ì‚¬ìš©ìê°€ ì§ì ‘** ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

  1. `ENABLE_ORDER_EXECUTION` ê°’ì„ `True`ë¡œ ë³€ê²½  
  2. `InvestRate` ë¹„ì¤‘ì„ ì„¤ì • (ê¸°ë³¸ê°’: 0)  
  3. ë§¤ìˆ˜í•  ì¢…ëª©ì„ ëª…ì‹œ (ê¸°ë³¸ê°’: ë¹ˆ ë¦¬ìŠ¤íŠ¸)  
  4. AWS ë˜ëŠ” ê°œì¸ ì„œë²„ êµ¬ì¶• ë° `crontab` ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡

- ì œê³µìëŠ” ì„œë²„ êµ¬ì¶•, ì„¤ì •, ì‹¤í–‰ ëŒ€í–‰ ë“±ì„ ì „í˜€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ğŸ“Œ [ë²•ì  ì±…ì„ ê³ ì§€]

- ì œê³µë˜ëŠ” ì½”ë“œëŠ” ê¸°ìˆ  í•™ìŠµ ë° í…ŒìŠ¤íŠ¸ ëª©ì ì˜ ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.  
- **ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì´ë©°, ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

- ë³¸ ì½”ë“œì˜ ì‚¬ìš©, ìˆ˜ì •, ì‹¤í–‰ì— ë”°ë¥¸ ëª¨ë“  ê²°ê³¼ì™€ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°,  
  **ì œê³µìëŠ” ë²•ì Â·ê¸ˆì „ì  ì±…ì„ì„ ì¼ì ˆ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.**

ğŸ“Œ [ì €ì‘ê¶Œ ì•ˆë‚´]

- ì´ ì½”ë“œëŠ” ì €ì‘ê¶Œë²• ë° ë¶€ì •ê²½ìŸë°©ì§€ë²•ì˜ ë³´í˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.  
- ë¬´ë‹¨ ë³µì œ, ê³µìœ , ì¬íŒë§¤, ë°°í¬ ì‹œ ë¯¼Â·í˜•ì‚¬ìƒ ì±…ì„ì´ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ“Œ [í•™ìŠµ ê¶Œì¥ ì‚¬í•­]

- ë³¸ ì˜ˆì‹œ ì½”ë“œëŠ” ì „ëµ êµ¬í˜„ì„ ì´í•´í•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ì…ë‹ˆë‹¤.  
- ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì‹ ë§Œì˜ ì „ëµì„ ê°œë°œí•´ë³´ì‹œê¸¸ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤ :)



ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!



'''
import KIS_Common as Common
import KIS_API_Helper_KR as KisKR

import pprint

import line_alert


#ê³„ì¢Œ ì„ íƒ.. "VIRTUAL" ëŠ” ëª¨ì˜ ê³„ì¢Œ!
Common.SetChangeMode("VIRTUAL") #REAL or VIRTUAL


#í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„
PortfolioName = "ì´ë™í‰ê· ìì‚°ë°°ë¶„ì „ëµ_KR"

#####################################################################################################################################
'''
â€» ì£¼ë¬¸ ì‹¤í–‰ ì—¬ë¶€ ì„¤ì •

ENABLE_ORDER_EXECUTION ê°’ì„ Trueë¡œ ë³€ê²½í•  ê²½ìš°,  
ì „ëµì— ë”°ë¼ ë§¤ë§¤ê°€ ì¼ì–´ë‚©ë‹ˆë‹¤.

âš ï¸ ê¸°ë³¸ê°’ì€ Falseì´ë©°,  
ì‹¤í–‰ ì—¬ë¶€ëŠ” ì‚¬ìš©ì ë³¸ì¸ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
'''

ENABLE_ORDER_EXECUTION = False  # ì£¼ë¬¸ ì‹¤í–‰ ì—¬ë¶€ ì„¤ì • (ê¸°ë³¸ê°’: False)

'''
ğŸ“Œ ë³¸ ì „ëµì€ ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ëŠ” ì˜ˆì‹œ ì½”ë“œì´ë©°,  
ì‹¤ì œ íˆ¬ì ë° ì£¼ë¬¸ ì‹¤í–‰ì€ ì‚¬ìš©ì ë³¸ì¸ì˜ ì˜ì‚¬ì™€ ì±…ì„ í•˜ì— ìˆ˜í–‰ë©ë‹ˆë‹¤.
'''
#####################################################################################################################################

'''
ğŸ“Œ íˆ¬ìí•  ì¢…ëª©ì€ ë³¸ì¸ì˜ ì„ íƒìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”!
'''

InvestStockList = list() #íˆ¬ìí•  ì¢…ëª©ì„ ì§ì ‘ íŒë‹¨í•˜ì—¬ ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ ë„£ìœ¼ì„¸ìš”!
#InvestStockList.append({"stock_code":"133690", "small_ma":5 , "big_ma":34, "invest_rate":0.4}) #TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100
#InvestStockList.append({"stock_code":"069500", "small_ma":3 , "big_ma":103, "invest_rate":0.2}) #KODEX 200
#InvestStockList.append({"stock_code":"148070", "small_ma":8 , "big_ma":71, "invest_rate":0.1}) #KOSEF êµ­ê³ ì±„10ë…„
#InvestStockList.append({"stock_code":"305080", "small_ma":20 , "big_ma":61, "invest_rate":0.1}) #TIGER ë¯¸êµ­ì±„10ë…„ì„ ë¬¼
#InvestStockList.append({"stock_code":"132030", "small_ma":15 , "big_ma":89, "invest_rate":0.2}) #KODEX ê³¨ë“œì„ ë¬¼(H)

#####################################################################################################################################

'''
ğŸ“Œ íˆ¬ì ë¹„ì¤‘ ì„¤ì •!
ê¸°ë³¸ì€ 0ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ìš”.
ë³¸ì¸ì˜ íˆ¬ì ë¹„ì¤‘ì„ ì„¤ì •í•˜ì„¸ìš”! 

ì „ëµì—ì„œ í™œìš©í•  ì£¼ë¬¸ì´ 
ì‹œì¥ê°€ ì£¼ë¬¸ì´ë¼ë©´ 0 ~ 0.75 
ì§€ì •ê°€ ì£¼ë¬¸ì´ë¼ë©´ 0 ~ 0.98
ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”! (0.1 = 10% 0.5 = 50%)
'''
InvestRate = 0 #ì´ í‰ê°€ê¸ˆì•¡ì—ì„œ í•´ë‹¹ ë´‡ì—ê²Œ í• ë‹¹í•  ì´ ê¸ˆì•¡ë¹„ìœ¨ 0.1 = 10%  0.5 = 50%
#####################################################################################################################################



#ë§ˆì¼“ì´ ì—´ë ¸ëŠ”ì§€ ì—¬ë¶€~!
IsMarketOpen = KisKR.IsMarketOpen()


#ê³„ì¢Œ ì”ê³ ë¥¼ ê°€ì§€ê³  ì˜¨ë‹¤!
Balance = KisKR.GetBalance()


print("--------------ë‚´ ë³´ìœ  ì”ê³ ---------------------")

pprint.pprint(Balance)

print("--------------------------------------------")


#ê¸°ì¤€ì´ ë˜ëŠ” ë‚´ ì´ í‰ê°€ê¸ˆì•¡ì—ì„œ íˆ¬ìë¹„ì¤‘ì„ ê³±í•´ì„œ ë‚˜ì˜¨ í¬íŠ¸í´ë¦¬ì˜¤ì— í• ë‹¹ëœ ëˆ!!
TotalMoney = float(Balance['TotalMoney']) * InvestRate

print("ì´ í¬íŠ¸í´ë¦¬ì˜¤ì— í• ë‹¹ëœ íˆ¬ì ê°€ëŠ¥ ê¸ˆì•¡ : ", TotalMoney)


##########################################################




##########################################################

print("--------------ë‚´ ë³´ìœ  ì£¼ì‹---------------------")
#ê·¸ë¦¬ê³  í˜„ì¬ ì´ ê³„ì¢Œì—ì„œ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì§€ê³  ì˜µë‹ˆë‹¤!
MyStockList = KisKR.GetMyStockList()
#pprint.pprint(MyStockList)
print("--------------------------------------------")
##########################################################

if ENABLE_ORDER_EXECUTION == True:


    for stock_info in InvestStockList:
        
        stock_code = stock_info['stock_code']
        
        small_ma = stock_info['small_ma']
        big_ma = stock_info['big_ma']
        
        stock_target_rate = stock_info['invest_rate']
        


        stock_name = KisKR.GetStockName(stock_code)
        stock_amt = 0 #ìˆ˜ëŸ‰
        stock_avg_price = 0 #í‰ë‹¨
        stock_eval_totalmoney = 0 #ì´í‰ê°€ê¸ˆì•¡!
        stock_revenue_rate = 0 #ì¢…ëª© ìˆ˜ìµë¥ 
        stock_revenue_money = 0 #ì¢…ëª© ìˆ˜ìµê¸ˆ


        #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
        for my_stock in MyStockList:
            if my_stock['StockCode'] == stock_code:
                stock_name = my_stock['StockName']
                stock_amt = int(my_stock['StockAmt'])
                stock_avg_price = float(my_stock['StockAvgPrice'])
                stock_eval_totalmoney = float(my_stock['StockNowMoney'])
                stock_revenue_rate = float(my_stock['StockRevenueRate'])
                stock_revenue_money = float(my_stock['StockRevenueMoney'])

                break


        
        
        df = Common.GetOhlcv("KR", stock_code,250)

        df['prevOpen'] = df['open'].shift(1)
        df['prevClose'] = df['close'].shift(1)
        
        ############# ì´ë™í‰ê· ì„ ! ###############

        df[str(small_ma) + 'ma'] = df['close'].rolling(small_ma).mean()
        df[str(big_ma)+ 'ma'] = df['close'].rolling(big_ma).mean()
            
        ########################################

        df.dropna(inplace=True) #ë°ì´í„° ì—†ëŠ”ê±´ ë‚ ë¦°ë‹¤!
        
        
        print("---stock_code---", stock_code , " len ",len(df))
        #pprint.pprint(df)
        
        #ë³´ìœ ì¤‘ì´ ì•„ë‹ˆë‹¤
        if stock_amt == 0:
            
            msg = stock_name + "("+stock_code + ") í˜„ì¬ ë§¤ìˆ˜í•˜ì§€ ì•Šê³  í˜„ê¸ˆ ë³´ìœ  ìƒíƒœ! ëª©í‘œí• ë‹¹ë¹„ì¤‘:" + str(stock_target_rate*100) + "%"
            print(msg) 
            
            if df[str(small_ma) + 'ma'].iloc[-2] > df[str(big_ma) + 'ma'].iloc[-2] and df[str(small_ma) + 'ma'].iloc[-3] < df[str(small_ma) + 'ma'].iloc[-2]:
                print("ë¹„ì¤‘ ë§Œí¼ ë§¤ìˆ˜!!")
                if IsMarketOpen == True:
                    
                    msg = stock_name + "("+stock_code + ") ìƒìŠ¹ì¶”ì„¸ê°€ í™•ì¸ë˜ì—ˆëŠ”ë° ë³´ìœ ìˆ˜ëŸ‰ì´ ì—†ì–´ ë¹„ì¤‘ë§Œí¼ ë§¤ìˆ˜!!!!"
                    print(msg) 
                    line_alert.SendMessage(msg)
                                        
                    BuyMoney = TotalMoney * stock_target_rate

                    CurrentPrice = KisKR.GetCurrentPrice(stock_code)
                    
                    #ë§¤ìˆ˜í•  ìˆ˜ëŸ‰ì„ ê³„ì‚°í•œë‹¤!
                    BuyAmt = int(BuyMoney / CurrentPrice)
                    
                    
                    CurrentPrice *= 1.01 #í˜„ì¬ê°€ì˜ 1%ìœ„ì˜ ê°€ê²©ìœ¼ë¡œ ì§€ì •ê°€ ë§¤ìˆ˜.. (ê·¸ëŸ¼ 1% ìœ„ ê°€ê²©ë³´ë‹¤ ì‘ì€ ê°€ê²©ì˜ í˜¸ê°€ë“¤ì€ ëª¨ë‘ ì²´ê²°ë˜ê¸°ì— ì œí•œìˆëŠ” ì‹œì¥ê°€ ë§¤ìˆ˜ íš¨ê³¼)
                    pprint.pprint(KisKR.MakeBuyLimitOrder(stock_code,BuyAmt,CurrentPrice))
                    
                    
                    
                    
        #ë³´ìœ ì¤‘ì´ë‹¤
        else:
            
            
            msg = stock_name + "("+stock_code + ") í˜„ì¬ ë§¤ìˆ˜í•˜ì—¬ ë³´ìœ  ìƒíƒœ! ëª©í‘œí• ë‹¹ë¹„ì¤‘:" + str(stock_target_rate*100) + "%"
            print(msg) 
            
            if df[str(small_ma) + 'ma'].iloc[-2] < df[str(big_ma) + 'ma'].iloc[-2] and df[str(small_ma) + 'ma'].iloc[-3] > df[str(small_ma) + 'ma'].iloc[-2]:
                print("ë³´ìœ  ìˆ˜ëŸ‰ ë§Œí¼ ë§¤ë„!!")
                if IsMarketOpen == True:
                    
                    msg = stock_name + "("+stock_code + ") í•˜ë½ì„¸ê°€ í™•ì¸ë˜ì—ˆëŠ”ë° ë³´ìœ ìˆ˜ëŸ‰ì´ ìˆì–´ ë§¤ë„!!!!"
                    print(msg) 
                    line_alert.SendMessage(msg)


                    CurrentPrice = KisKR.GetCurrentPrice(stock_code)
                    CurrentPrice *= 0.99 #í˜„ì¬ê°€ì˜ 1%ì•„ë˜ì˜ ê°€ê²©ìœ¼ë¡œ ì§€ì •ê°€ ë§¤ë„.. (ê·¸ëŸ¼ 1%ì•„ë˜ ê°€ê²©ë³´ë‹¤ í° ê°€ê²©ì˜ í˜¸ê°€ë“¤ì€ ëª¨ë‘ ì²´ê²°ë˜ê¸°ì— ì œí•œìˆëŠ” ì‹œì¥ê°€ ë§¤ë„ íš¨ê³¼)
                    pprint.pprint(KisKR.MakeSellLimitOrder(stock_code,abs(stock_amt),CurrentPrice))
                    
else:
    print("ì½”ë“œ ë§¨ ì²« ë¶€ë¶„ì— ENABLE_ORDER_EXECUTION ê°’ì„ Trueë¡œ ë³€ê²½í•´ì•¼ ë§¤ìˆ˜ë§¤ë„ê°€ ì§„í–‰ë©ë‹ˆë‹¤!")