'''

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

í•´ë‹¹ ì»¨í…ì¸ ëŠ” ì œê°€ ì§ì ‘ íˆ¬ì í•˜ê¸° ìœ„í•´ ì´ ì „ëµì„ ì¶”ê°€ ê°œì„ í•´ì„œ ë” ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°œì¸ ì „ëµì´ ì¡´ì¬í•©ë‹ˆë‹¤. 


ê²Œë§Œì•„ ì¶”ê°€ ê°œì„  ê°œì¸ ì „ëµë“¤..
https://blog.naver.com/zacra/223196497504


ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ ìœ„ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì„¸ìš”!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

 



$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

ë°±í…ŒìŠ¤íŒ…ì€ ë‚´PCì—ì„œ í•´ì•¼ ì„œë²„ ìì›ì„ ì•„ë¼ê³  íˆ¬ì ì„±ê³¼ ê·¸ë˜í”„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì‹œê³  ë‹¤ì–‘í•œ ê¸°ê°„ìœ¼ë¡œ ë°±í…ŒìŠ¤íŒ… í•´ë³´ì„¸ìš”!!!
https://blog.naver.com/zacra/223180500307

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$




ê´€ë ¨ í¬ìŠ¤íŒ…
https://blog.naver.com/zacra/223597500754
ìœ„ í¬ìŠ¤íŒ…ì„ ê¼­ ì°¸ê³ í•˜ì„¸ìš”!!!


ğŸ“Œ ê²Œë§Œì•„ì˜ ëª¨ë“  ì½”ë“œëŠ” íŠ¹ì • ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ê¶Œìœ ë¥¼ ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.  
ì œê³µëœ ì „ëµì€ í•™ìŠµ ë° í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ êµ¬ì„±ëœ ì˜ˆì‹œ ì½”ë“œì´ë©°
ì‹¤ì œ íˆ¬ì íŒë‹¨ ë° ì‹¤í–‰ì€ ì „ì ìœ¼ë¡œ ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
   

ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!
   

  
'''

import KIS_Common as Common
import KIS_API_Helper_KR as KisKR
import pandas as pd
import pprint
import numpy as np
import matplotlib.pyplot as plt
import json

from datetime import datetime


Common.SetChangeMode("VIRTUAL") 

##################################################################

###############################################################################################################################################################
#í…ŒìŠ¤íŠ¸í•  ì¢…ëª©ì„ ì§ì ‘ íŒë‹¨í•˜ì—¬ ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ ë„£ìœ¼ì„¸ìš”!
InvestStockList = list()

#InvestStockList.append({"stock_code":"QQQ", "small_ma":3 , "big_ma":132, "invest_rate":0.5}) 
#InvestStockList.append({"stock_code":"TLT", "small_ma":13 , "big_ma":53, "invest_rate":0.25}) 
#InvestStockList.append({"stock_code":"GLD", "small_ma":17 , "big_ma":78, "invest_rate":0.25}) 

#InvestStockList.append({"stock_code":"133690", "small_ma":5 , "big_ma":34, "invest_rate":0.4}) #TIGER ë¯¸êµ­ë‚˜ìŠ¤ë‹¥100
#InvestStockList.append({"stock_code":"069500", "small_ma":3 , "big_ma":103, "invest_rate":0.2}) #KODEX 200
#InvestStockList.append({"stock_code":"148070", "small_ma":8 , "big_ma":71, "invest_rate":0.1}) #KOSEF êµ­ê³ ì±„10ë…„
#InvestStockList.append({"stock_code":"305080", "small_ma":20 , "big_ma":61, "invest_rate":0.1}) #TIGER ë¯¸êµ­ì±„10ë…„ì„ ë¬¼
#InvestStockList.append({"stock_code":"132030", "small_ma":15 , "big_ma":89, "invest_rate":0.2}) #KODEX ê³¨ë“œì„ ë¬¼(H)
###############################################################################################################################################################


#####################################################
TestArea = "US" #í•œêµ­ì´ë¼ë©´ KR ë¯¸êµ­ì´ë¼ë©´ USë¡œ ë³€ê²½í•˜ì„¸ìš” ^^
#####################################################

#################################################################
FixRate = 0.1 #ê° ìì‚°ë³„ í• ë‹¹ ê¸ˆì•¡ì˜ 10%ë¥¼ ê³ ì •ë¹„ì¤‘ìœ¼ë¡œ íˆ¬ìí•¨!
DynamicRate = 0.6 #ê° ìì‚°ë³„ í• ë‹¹ ê¸ˆì•¡ì˜ 60%ì˜ íˆ¬ì ë¹„ì¤‘ì€ ëª¨ë©˜í…€ì— ì˜í•´ ì •í•´ì§!
#ìœ„ì˜ ê²½ìš° FixRate + DynamicRate = 0.7 ì¦‰ 70%ì´ë‹ˆê¹ ë§¤ë„ì‹ í˜¸ ì‹œ 30%ë¹„ì¤‘ì€ ë¬´ì¡°ê±´ íŒ”ë„ë¡ ë˜ì–´ ìˆë‹¤.
#ìœ„ ë‘ ê°’ì´ ëª¨ë‘ 0ì´ë¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ ë§¤ë„ì‹ í˜¸ì‹œ ëª¨ë‘ íŒë‹¤!!


GetCount = 700  #ì–¼ë§ˆí¼ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì¸ì§€
CutCount = 0     #ìµœê·¼ ë°ì´í„° ì‚­ì œ! 200ìœ¼ë¡œ ì„¸íŒ…í•˜ë©´ 200ê°œì˜ ìµœê·¼ ë°ì´í„°ê°€ ì‚¬ë¼ì§„ë‹¤

  
TotalMoney = 10000000 #í•œêµ­ ê³„ì¢Œì˜ ê²½ìš° ì‹œì‘ íˆ¬ìê¸ˆ 1000ë§Œì›ìœ¼ë¡œ ê°€ì •!

TaxAdd = False #ì–‘ë„ì„¸ ë°˜ì˜ ì—¬ë¶€! 
MoneyForTaxCalc = 0 #ì–‘ë„ì„¸ ê³„ì‚°ì„ ìœ„í•œ ì†ìµì„ ì €ì¥í•  ë³€ìˆ˜ - ë¯¸êµ­ë§Œ í•´ë‹¹
FreeTax = 2100 #í™˜ìœ¨ì„ 1200ì›ìœ¼ë¡œ í‰ì³ì„œ $2100 ê°€ ë©´ì„¸ ê¸°ì¤€! - ë¯¸êµ­ë§Œ í•´ë‹¹


if TestArea == "US": #ë¯¸êµ­ì˜ ê²½ìš°ëŠ”
    TotalMoney = 10000 #ì‹œì‘ íˆ¬ìê¸ˆ $10000ë¡œ ê°€ì •!
    TaxAdd = True #ë¯¸êµ­ì˜ ê²½ìš° ì–‘ë„ì„¸ ë°˜ì˜!!!


FirstInvestMoney = TotalMoney

fee = 0.0025 #ìˆ˜ìˆ˜ë£Œë¥¼ ë§¤ìˆ˜ë§¤ë„ë§ˆë‹¤ 0.25%ë¡œ ì„¸íŒ…!

print("í…ŒìŠ¤íŠ¸í•˜ëŠ” ì´ ê¸ˆì•¡: ", format(round(TotalMoney), ','))






#################################################################


    
RebalanceSt = "%Y%m" 
    


StockDataList = list()

for stock_info in InvestStockList:
    print("..",stock_info,"..")
    stock_data = dict()
    stock_data['stock_code'] = stock_info['stock_code']
    
    if TestArea == "KR":
        stock_data['stock_name'] = KisKR.GetStockName(stock_info['stock_code'])
    else:
        stock_data['stock_name'] = stock_info['stock_code']
        
    stock_data['invest_rate'] = stock_info['invest_rate']
    stock_data['InvestDayCnt'] = 0
    StockDataList.append(stock_data)

pprint.pprint(StockDataList)


def IncreaseInvestDayCnt(stock_code, StockDataList):
    for stock_data in StockDataList:
        if stock_code == stock_data['stock_code']:
            stock_data['InvestDayCnt'] += 1
            break


def GetDefaultInvestRate(stock_code, StockDataList):
    invest_rate = 0
    for stock_data in StockDataList:
        if stock_code == stock_data['stock_code']:
            invest_rate = stock_data['invest_rate']
            break

    return invest_rate


#ì‚¬ì‹¤ ë¯¸êµ­ì—ì„  ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í•œêµ­ì—ì„  ì‚¬ìš©
def GetStockName(stock_code, StockDataList):
    result_str = stock_code
    for stock_data in StockDataList:
        if stock_code == stock_data['stock_code']:
            result_str = stock_data['stock_name']
            break

    return result_str

NowInvestList = list() #íˆ¬ìì¤‘ì¸ í•­ëª©ì˜ ë¦¬ìŠ¤íŠ¸



stock_df_list = []

for stock_info in InvestStockList:
    
    stock_code = stock_info['stock_code']
    #################################################################
    #################################################################
    df = Common.GetOhlcv(TestArea, stock_code, GetCount) 
    #################################################################
    #################################################################


    df['prevClose'] = df['close'].shift(1)
 
    
    ############# ì´ë™í‰ê· ì„ ! ###############
    ma_dfs = []

    # ì´ë™ í‰ê·  ê³„ì‚°
    for ma in range(3, 201):
        ma_df = df['close'].rolling(ma).mean().rename(str(ma) + 'ma_before').shift(1)
        ma_dfs.append(ma_df)
        
        ma_df = df['close'].rolling(ma).mean().rename(str(ma) + 'ma_before2').shift(2)
        ma_dfs.append(ma_df)
    # ì´ë™ í‰ê·  ë°ì´í„° í”„ë ˆì„ì„ í•˜ë‚˜ë¡œ ê²°í•©
    ma_df_combined = pd.concat(ma_dfs, axis=1)

    # ì›ë³¸ ë°ì´í„° í”„ë ˆì„ê³¼ ê²°í•©
    df = pd.concat([df, ma_df_combined], axis=1)

    ########################################

    #200ê±°ë˜ì¼ í‰ê·  ëª¨ë©˜í…€
    specific_days = list()

    for i in range(1,11):
        st = i * 20
        specific_days.append(st)

    for day in specific_days:
        column_name = f'Momentum_{day}'
        df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)

    df['Average_Momentum'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10


    df.dropna(inplace=True) #ë°ì´í„° ì—†ëŠ”ê±´ ë‚ ë¦°ë‹¤!

    df = df[:len(df)- CutCount]
    data_dict = {stock_code: df}


    stock_df_list.append(data_dict)
        
    print("---stock_code---", stock_code , " len ",len(df))
    
    pprint.pprint(df)

    #ëª¨ë“  í•­ëª©ì˜ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ ë†“ëŠ”ë‹¤!
    InvestData = dict()

    InvestData['stock_code'] = stock_code
    InvestData['InvestMoney'] = 0
    InvestData['InvestRate'] = stock_info['invest_rate']
    InvestData['small_ma'] = stock_info['small_ma']
    InvestData['big_ma'] =  stock_info['big_ma']
    InvestData['RebalanceAmt'] = 0
    InvestData['EntryMonth'] = 0
    InvestData['AvgPrice'] = 0
    InvestData['TotAmt'] = 0
    InvestData['Investing'] = False
    InvestData['IsRebalanceGo'] = False


    NowInvestList.append(InvestData)



combined_df = pd.concat([list(data_dict.values())[0].assign(stock_code=stock_code) for data_dict in stock_df_list for stock_code in data_dict])
combined_df.sort_index(inplace=True)
pprint.pprint(combined_df)
print(" len(combined_df) ", len(combined_df))



IsFirstDateSet = False
FirstDateStr = ""


NowInvestCode = ""
InvestMoney = TotalMoney
RemainInvestMoney = InvestMoney



ResultList = list()

TotalMoneyList = list()


i = 0
# Iterate over each date
for date in combined_df.index.unique():
 

    #ë‚ ì§œ ì •ë³´ë¥¼ íšë“
    date_format = "%Y-%m-%d %H:%M:%S"
    date_object = None

    try:
        date_object = datetime.strptime(str(date), date_format)
    
    except Exception as e:
        try:
            date_format = "%Y%m%d"
            date_object = datetime.strptime(str(date), date_format)

        except Exception as e2:
            date_format = "%Y-%m-%d"
            date_object = datetime.strptime(str(date), date_format)
            

    i += 1


    IsRebalnceDayforTax = False


    #íˆ¬ìì¤‘ì¸ ì¢…ëª©ì„ ìˆœíšŒí•˜ë©° ì²˜ë¦¬!
    for investData in NowInvestList:

        stock_code = investData['stock_code'] 
        
    

        stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)] 


        if len(stock_data) == 1:
    
            #################################################################################################################
            #ë§¤ì¼ë§¤ì¼ì˜ ë“±ë½ë¥ ì„ ë°˜ì˜í•œë‹¤!
            NowClosePrice = 0
            PrevClosePrice = 0

            NowClosePrice = stock_data['close'].values[0]
            PrevClosePrice = stock_data['prevClose'].values[0] 


            if investData['InvestMoney'] > 0:
                investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((NowClosePrice - PrevClosePrice ) / PrevClosePrice))
                IncreaseInvestDayCnt(stock_code, StockDataList)
            #################################################################################################################



            ma1 = investData['small_ma']
            ma2 = investData['big_ma']
            
                
            small_ma = int(ma1)
            big_ma = int(ma2)
            
            

            IsReblanceDay = False
            
            if investData['EntryMonth'] != date_object.strftime(RebalanceSt):
                investData['EntryMonth'] = date_object.strftime(RebalanceSt)

                IsRebalnceDayforTax = True #ë¯¸êµ­ ì–‘ë„ì„¸ ê´€ë ¨..



            

            #ì´í‰ì„ ì— ì˜í•´ ë§¤ë„ì²˜ë¦¬ í•´ì•¼ ëœë‹¤!!! 
            if investData['Investing'] == True and stock_data[str(small_ma)+'ma_before'].values[0] < stock_data[str(big_ma)+'ma_before'].values[0] and stock_data[str(small_ma)+'ma_before2'].values[0] > stock_data[str(small_ma)+'ma_before'].values[0]:
                IsReblanceDay = True
                
                SellRate = FixRate + (stock_data['Average_Momentum'].values[0] * DynamicRate) 
                
                investData['InvestRate'] = GetDefaultInvestRate(stock_code, StockDataList) * SellRate
                
            

            if investData['Investing'] == False and stock_data[str(small_ma)+'ma_before'].values[0] > stock_data[str(big_ma)+'ma_before'].values[0] and stock_data[str(small_ma)+'ma_before2'].values[0] < stock_data[str(small_ma)+'ma_before'].values[0]:
                IsReblanceDay = True
                investData['InvestRate'] = GetDefaultInvestRate(stock_code, StockDataList)
                    
                
            if IsReblanceDay == True: 
                
                
                investData['IsRebalanceGo'] = True
                investData['RebalanceAmt'] = 0

    
    if IsRebalnceDayforTax == True:

        if TaxAdd == True:
            #ë¦¬ë°¸ëŸ°ì‹± í•˜ëŠ” ë‚ ì´ 1ì›” ì´ë¼ë©´ ì–‘ë„ì„¸ë¥¼ ë°˜ì˜í•˜ê³  ì´ˆê¸°í™” ì‹œì¼œì¤€ë‹¤!
            if int(date_object.strftime("%m")) == 1:
                MoneyForTaxCalc -= FreeTax
                
                print("ì§€ë‚œ í•œí•´ ë™ì•ˆ $", MoneyForTaxCalc," ì†ìµí™•ì •ì„ í–ˆì–´ìš”!")
                
                
                #ê³µì œí›„ì—ë„ ë‚¨ì€ ìˆ˜ìµì— ëŒ€í•´ì„  ì–‘ë„ì„¸22ë¥¼ ê³„ì‚°í•´ ê°ì‚°í•˜ì!!
                if MoneyForTaxCalc > 0:
                    OMG_Tax = MoneyForTaxCalc * 0.22
                    RemainInvestMoney -= OMG_Tax #ë‚¨ì€ íˆ¬ìê¸ˆì—ì„œ ê°ì‚°!!!
                    print(str(date), "--ì–‘ë„ì„¸ $",OMG_Tax , "ì°¨ê° ë˜ì—ˆì–´ìš” ã… .ã…œ")
                else:
                    print(str(date), "--ì–‘ë„ì„¸ ì—†ì–´ìš”! ë¶ˆí–‰ì¸ì§€ ë‹¤í–‰ì¸ì§€...^^")
                    
                    
                MoneyForTaxCalc = 0 #ìƒˆí•´ê°€ ë˜ì—ˆìœ¼ë‹ˆ ì´ˆê¸°í™”!!
                
            

    #################################################################################################################
    ##################### ë¦¬ë°¸ëŸ°ì‹± í• ë•Œ íˆ¬ì ë¹„ì¤‘ì„ ë§ì¶°ì£¼ëŠ” ì‘ì—… #############################



    NowInvestMoney = 0

    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']

    
    InvestMoney = RemainInvestMoney + NowInvestMoney


    #ë¦¬ë°¸ëŸ°ì‹± ìˆ˜ëŸ‰ì„ í™•ì •í•œë‹¤!
    for investData in NowInvestList:

        if investData['IsRebalanceGo'] == True:

            stock_code = investData['stock_code']

            stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)] 

            
            if len(stock_data) == 1:
                

                NowClosePrice = stock_data['close'].values[0]


                GapInvest = (InvestMoney * investData['InvestRate']) - investData['InvestMoney'] #ëª©í‘œ ê¸ˆì•¡ì—ì„œ í˜„ì¬ í‰ê°€ê¸ˆì•¡ì„ ë¹¼ì„œ ê°­ì„ êµ¬í•œë‹¤!
                investData['RebalanceAmt'] += int(GapInvest / NowClosePrice)




    #ì‹¤ì œ ë§¤ë„!!
    for investData in NowInvestList:


        if investData['IsRebalanceGo'] == True:


            stock_code = investData['stock_code']
            
            stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)] 

            if len(stock_data) == 1:

                NowClosePrice = stock_data['close'].values[0]

                if investData['RebalanceAmt'] < 0:


                    SellAmt = abs(investData['RebalanceAmt'])

                    RealSellMoney = SellAmt * NowClosePrice


                    RevenueRate = (NowClosePrice - investData['AvgPrice']) / investData['AvgPrice'] #ì†ìµë¥ ì„ êµ¬í•œë‹¤!

                    #íŒ”ì•„ì•¼í•  ê¸ˆì•¡ì´ í˜„ì¬ íˆ¬ìê¸ˆë³´ë‹¤ í¬ë‹¤ë©´!!! ëª¨ë‘ íŒë‹¤! í˜¹ì€ ì‹¤ì œ íŒ”ì•„ì•¼í•  ê³„ì‚°ëœ ê¸ˆì•¡ì´ íˆ¬ìê¸ˆë³´ë‹¤ í¬ë‹¤ë©´ ëª¨ë‘ íŒë‹¤!!
                    if RealSellMoney > investData['InvestMoney']:
                        RealSellMoney = investData['InvestMoney']

                        ReturnMoney = RealSellMoney

                        investData['InvestMoney'] = 0

                        RemainInvestMoney += (ReturnMoney * (1.0 - fee))

                        investData['IsRebalanceGo'] = False

                        investData['AvgPrice'] = 0
                        investData['TotAmt'] = 0
                        
                        #ëª¨ë‘ íŒ”ë•ŒëŠ” ë§¤ë„ ê¸ˆì•¡ x ìˆ˜ìµë¥ ì´ ì†ìµê¸ˆ
                        if TaxAdd == True:
                            MoneyForTaxCalc += RealSellMoney * RevenueRate
                        
                        print(investData['stock_code'], str(date), " " ,i, " >>>>>>>>>>>>>>>>> ëª¨ë‘ ë§¤ë„!(ë¦¬ë°¸ëŸ°ì‹±) ë§¤ë„ê¸ˆì•¡:", round(RealSellMoney,2) ,  " ë§¤ë„ê°€:",NowClosePrice)
                        
                        
                    else:

                        if SellAmt > 0 :

                            ReturnMoney = RealSellMoney

                            investData['InvestMoney'] -= RealSellMoney

                            RemainInvestMoney += (ReturnMoney * (1.0 - fee))

                            investData['IsRebalanceGo'] = False
                            
                            investData['TotAmt'] -= SellAmt
                            
                            #ì¼ë¶€ íŒ”ë•ŒëŠ” (ë§¤ë„ê¸ˆì•¡ x ë§¤ë„ìˆ˜ëŸ‰) - (í‰ê· ë§¤ì…ë‹¨ê°€ x ë§¤ë„ìˆ˜ëŸ‰)
                            if TaxAdd == True:
                                MoneyForTaxCalc += (RealSellMoney - (investData['AvgPrice']*SellAmt))
                                
                            print(investData['stock_code'], str(date), " " ,i, " >>>>>>>>>>>>>>>>> ì¼ë¶€ ë§¤ë„!(ë¦¬ë°¸ëŸ°ì‹±) ë§¤ë„ê¸ˆì•¡:", round(RealSellMoney,2) ,  " ë§¤ë„ê°€:",NowClosePrice)

                    
                    investData['Investing'] = False

                    investData['EntryMonth'] = date_object.strftime(RebalanceSt)
                    investData['IsRebalanceGo'] = False

            

    #ì‹¤ì œ ë§¤ìˆ˜!!
    for investData in NowInvestList:


        if investData['IsRebalanceGo'] == True:


            stock_code = investData['stock_code']
            
            stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)] 

            if len(stock_data) == 1:

                NowClosePrice = stock_data['close'].values[0]

                if investData['RebalanceAmt'] > 0:


                    if IsFirstDateSet == False:
                        FirstDateStr = str(date)
                        IsFirstDateSet = True


                    BuyAmt = investData['RebalanceAmt']


                    NowFee = (BuyAmt*NowClosePrice) * fee

                    #ë§¤ìˆ˜í•´ì•¼ ë˜ëŠ”ë° ë‚¨ì€ëˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ìˆ˜ëŸ‰ì„ í•˜ë‚˜ì”© ê°ì†Œì‹œì¼œ ë§Œì¡±í•  ë•Œ ë§¤ìˆ˜í•œë‹¤!!
                    while RemainInvestMoney < (BuyAmt*NowClosePrice) + NowFee:
                        if RemainInvestMoney > NowClosePrice:
                            BuyAmt -= 1
                            NowFee = (BuyAmt*NowClosePrice) * fee
                        else:
                            break
                    
                    if BuyAmt > 0 and RemainInvestMoney > NowClosePrice:
                        RealBuyMoney = BuyAmt * NowClosePrice

                        investData['InvestMoney'] += RealBuyMoney

                        RemainInvestMoney -= (BuyAmt*NowClosePrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                        RemainInvestMoney -= NowFee

                        print('GOGO!!!')
                        if investData['TotAmt'] == 0:
                            investData['AvgPrice'] = NowClosePrice
                            investData['TotAmt'] = BuyAmt
                            

                        else:

                            investData['TotAmt'] += BuyAmt
                            investData['AvgPrice'] = ((investData['AvgPrice'] * (investData['TotAmt']-BuyAmt)) + (BuyAmt*NowClosePrice)) / investData['TotAmt']

                        print(investData['stock_code'], str(date), " " ,i, " >>>>>>>>>>>>>>>>> ë§¤ìˆ˜!(ë¦¬ë°¸ëŸ°ì‹±) ë§¤ìˆ˜ê¸ˆì•¡:", round(RealBuyMoney,2) ,  " ë§¤ìˆ˜ê°€:",NowClosePrice)
                        investData['Investing'] = True
            

                    investData['EntryMonth'] = date_object.strftime(RebalanceSt)
                    investData['IsRebalanceGo'] = False


    #í˜¹ì‹œë‚˜ ìœ„ì—ì„œ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ê²Œ ìˆë‹¤ë©´...            
    for investData in NowInvestList:


        if investData['IsRebalanceGo'] == True:

            investData['EntryMonth'] = date_object.strftime(RebalanceSt)
            investData['IsRebalanceGo'] = False



    
    NowInvestMoney = 0

    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']

    
    InvestMoney = RemainInvestMoney + NowInvestMoney



    InvestCoinListStr = ""
    print("\n\n------------------------------------\n")
    for iData in NowInvestList:
        InvestCoinListStr += (">>>" + GetStockName(iData['stock_code'], StockDataList)  + "-> ëª©í‘œíˆ¬ìë¹„ì¤‘:" + str(iData['InvestRate']*100) + "%-> ì‹¤ì œíˆ¬ìë¹„ì¤‘:" + str(iData['InvestMoney']/InvestMoney*100)  +"%\n -->ì‹¤ì œíˆ¬ìê¸ˆ:" + str(format(int(round(iData['InvestMoney'],0)), ',')) +"\n\n")
    print("------------------------------------")

    print(InvestCoinListStr, "---> íˆ¬ìëŒ€ìƒ : ", len(NowInvestList))
    #pprint.pprint(NowInvestList)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>--))", str(date), " ì”ê³ :",str(InvestMoney) , "=" , str(RemainInvestMoney) , "+" , str(NowInvestMoney), "\n\n" )
    print("MoneyForTaxCalc : ", MoneyForTaxCalc)

    TotalMoneyList.append(InvestMoney)

    #####################################################
    #####################################################
    #####################################################
    #'''
    
   


#ê²°ê³¼ ì •ë¦¬ ë° ë°ì´í„° ë§Œë“¤ê¸°!!
if len(TotalMoneyList) > 0:

    print("TotalMoneyList -> ", len(TotalMoneyList))


    resultData = dict()

    # Create the result DataFrame with matching shapes
    result_df = pd.DataFrame({"Total_Money": TotalMoneyList}, index=combined_df.index.unique())

    result_df['Ror'] = np.nan_to_num(result_df['Total_Money'].pct_change()) + 1
    result_df['Cum_Ror'] = result_df['Ror'].cumprod()
    result_df['Highwatermark'] = result_df['Cum_Ror'].cummax()
    result_df['Drawdown'] = (result_df['Cum_Ror'] / result_df['Highwatermark']) - 1
    result_df['MaxDrawdown'] = result_df['Drawdown'].cummin()

    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    pprint.pprint(result_df)
    print(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")

    resultData['DateStr'] = str(FirstDateStr) + " ~ " + str(result_df.iloc[-1].name)

    resultData['OriMoney'] = FirstInvestMoney
    resultData['FinalMoney'] = result_df['Total_Money'].iloc[-1]
    resultData['RevenueRate'] = ((result_df['Cum_Ror'].iloc[-1] -1.0)* 100.0)

    resultData['MDD'] = result_df['MaxDrawdown'].min() * 100.0


    ResultList.append(resultData)

    result_df.index = pd.to_datetime(result_df.index)


    # Create a figure with subplots for the two charts
    fig, axs = plt.subplots(2, 1, figsize=(10, 10))

    # Plot the return chart
    axs[0].plot(result_df['Cum_Ror'] * 100, label='Strategy')
    axs[0].set_ylabel('Cumulative Return (%)')
    axs[0].set_title('Return Comparison Chart')
    axs[0].legend()

    # Plot the MDD and DD chart on the same graph
    axs[1].plot(result_df.index, result_df['MaxDrawdown'] * 100, label='MDD')
    axs[1].plot(result_df.index, result_df['Drawdown'] * 100, label='Drawdown')
    axs[1].set_ylabel('Drawdown (%)')
    axs[1].set_title('Drawdown Comparison Chart')
    axs[1].legend()

    # Show the plot
    plt.tight_layout()
    plt.show()
        

    


    for idx, row in result_df.iterrows():
        print(idx, " " , row['Total_Money'], " "  , row['Cum_Ror'])
        



#ë°ì´í„°ë¥¼ ë³´ê¸°ì¢‹ê²Œ í”„ë¦°íŠ¸ í•´ì£¼ëŠ” ë¡œì§!
print("\n\n--------------------")


for result in ResultList:

    print("--->>>",result['DateStr'].replace("00:00:00",""),"<<<---")

    for stock_data in StockDataList:
        print(stock_data['stock_name'] , " (", stock_data['stock_code'],") íˆ¬ìì¼ìˆ˜: ",stock_data['InvestDayCnt'])

    print("---------- ì´ ê²°ê³¼ ----------")
    print("ìµœì´ˆ ê¸ˆì•¡:", format(int(round(result['OriMoney'],0)), ',') , " ìµœì¢… ê¸ˆì•¡:", format(int(round(result['FinalMoney'],0)), ','), " \nìˆ˜ìµë¥ :", round(((round(result['FinalMoney'],2) - round(result['OriMoney'],2) ) / round(result['OriMoney'],2) ) * 100,2) ,"% MDD:",  round(result['MDD'],2),"%")

    print("------------------------------")
    print("####################################")
