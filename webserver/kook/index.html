<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïä§ÏºÄÏ§ÑÎü¨ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-right: 0;
            padding-right: 0;
        }
        
        .main-container {
            padding: 0;
            margin-right: 0;
            padding-right: 0;
        }
        
        /* Î†àÏù¥ÏïÑÏõÉ: Î∂àÌïÑÏöîÌïú Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ Î∞è Ïò§Î•∏Ï™Ω Ïó¨Î∞± Ï†úÍ±∞ */
        html, body { overflow-x: hidden; }
        /* ÏµúÏÉÅÏúÑ ÌñâÎßå Í∞ÄÌÑ∞ Ï†úÍ±∞ (Ïπ¥Îìú ÎÇ¥Î∂Ä ÌñâÎì§ÏùÄ Í∏∞Î≥∏ Í∞ÄÌÑ∞ Ïú†ÏßÄ) */
        .main-container > .row { margin-left: 0; margin-right: 0; --bs-gutter-x: 0; }
        .row.portfolio-grid { --bs-gutter-x: 0 !important; margin-left: 0 !important; margin-right: 0 !important; }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
            margin-bottom: 0.5rem;
        }
        
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-running {
            background-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }
        
        .status-stopped {
            background-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        
        .btn-action {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 0 4px;
        }
        
        .btn-start {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            border: none;
            color: white;
        }
        
        .btn-report {
            background: linear-gradient(45deg, #007bff, #6610f2);
            border: none;
            color: white;
        }
        
        .btn-restart {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border: none;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .process-card {
            transition: all 0.3s ease;
        }
        
        .process-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .task-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .task-card.registered {
            border-color: #28a745;
        }
        
        .task-card.not-registered {
            border-color: #6c757d;
        }
        
        .task-status {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .task-status.registered {
            color: #28a745;
        }
        
        .task-status.not-registered {
            color: #6c757d;
        }
        
        .stats-item {
            text-align: center;
            padding: 0.5rem;
        }
        
        .stats-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .script-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .script-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .script-card.registered {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
        }
        
        .script-card.not-registered {
            border-color: #6c757d;
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.05));
            opacity: 0.7;
        }
        
        .script-card.not-registered:hover {
            opacity: 1;
        }
        
        .script-status {
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .script-status.registered {
            color: #28a745;
        }
        
        .script-status.not-registered {
            color: #6c757d;
        }

        /* Bot card compact spacing */
        .bot-card .card-body { padding-bottom: 0.5rem; }
        .bot-card .collapse { margin-bottom: 0 !important; }
        .bot-card .table { margin-bottom: 0.25rem; }
        .bot-card .mt-3 { margin-top: 0.75rem !important; }

        /* Period summary box theme */
        .period-box {
            background: linear-gradient(180deg, rgba(102,126,234,0.12), rgba(118,75,162,0.10));
            border: 1px solid rgba(102,126,234,0.18);
            border-radius: 12px;
            /* ÌïòÎã® Ïó¨Î∞± ÏµúÏÜåÌôî */
            padding: 0.25rem 0.5rem 0rem;
        }
        .period-box .card-body {
            padding: 1rem 0.5rem !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .period-title { margin-bottom: 0.15rem !important; }
        .period-box:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        /* Custom gutter for summary rows */
        .period-row {
            --bs-gutter-x: 1rem;
            margin-top: 0.5rem;
            /* margin-bottom: 0.75rem; */
        }

        /* White outline transparent icon button (for dark headers) */
        .btn-icon-white {
            background-color: transparent !important;
            color: #ffffff !important;
            border: 1.5px solid rgba(255,255,255,0.85) !important;
            width: 32px; height: 32px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 8px;
            box-shadow: none;
            padding: 0;
        }
        .btn-icon-white:hover {
            background-color: rgba(255,255,255,0.12) !important;
            color: #ffffff !important;
            border-color: #ffffff !important;
            box-shadow: none;
        }
        .btn-icon-white i { font-size: 14px; line-height: 1; color:#ffffff !important; }
        
        /* Python ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .process-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .process-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .process-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
        }
        
        .process-card .card-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .process-card .text-info {
            color: #17a2b8 !important;
        }
        
        .process-card .text-warning {
            color: #ffc107 !important;
        }
        
        .process-card .text-break {
            word-break: break-all;
            font-size: 0.85rem;
        }
        /* Î≥¥Ïú†Ï¢ÖÎ™© Ìëú: ÏπºÎüº Í∑†Îì± Î∞∞Î∂Ñ, Í∏¥ Ï¢ÖÎ™©Î™ÖÏùÄ Ï§ÑÎ∞îÍøà */
        .holdings-table {
            table-layout: fixed;
            width: 100%;
        }
        .holdings-table th,
        .holdings-table td {
            vertical-align: middle;
            white-space: normal; /* Ï§ÑÎ∞îÍøà ÌóàÏö© */
            word-break: break-word;
        }
        /* Î™®Îì† ÏπºÎüº Í∑†Îì± Ìè≠ Î∞∞Î∂Ñ */
        .holdings-table thead th,
        .holdings-table tbody td {
            width: calc(100% / 7); /* Ï¢ÖÎ™©/ÏàòÎüâ/ÌèâÎã®/ÌòÑÏû¨Í∞Ä/ÌèâÍ∞ÄÍ∏àÏï°/ÏÜêÏùµ/ÏàòÏùµÎ•† = 7Í∞ú */
        }
        
        /* ÏïîÌò∏ÌôîÌèê ÌÖåÏù¥Î∏î: Ïª¨Îüº Í∑†Îì± Î∞∞Î∂Ñ, ÏùºÏ†ïÌïú ÌÅ¨Í∏∞ */
        .crypto-table {
            table-layout: fixed;
            width: 100%;
        }
        
        .crypto-table th,
        .crypto-table td {
            vertical-align: middle;
            white-space: normal;
            word-break: break-word;
            padding: 8px;
        }
        
        /* ÏïîÌò∏ÌôîÌèê ÌÖåÏù¥Î∏î Ïª¨Îüº ÎÑàÎπÑ ÏÑ§Ï†ï */
        .crypto-table th:nth-child(1) { /* ÏΩîÏù∏ Ïª¨Îüº */
            width: 10%;
            min-width: 80px;
        }
        
        .crypto-table th:nth-child(2) { /* ÌòÑÏû¨Í∞Ä Ïª¨Îüº */
            width: 12%;
            min-width: 90px;
        }
        
        .crypto-table th:nth-child(3) { /* Î≥¥Ïú†ÏàòÎüâ Ïª¨Îüº */
            width: 10%;
            min-width: 80px;
        }
        
        .crypto-table th:nth-child(4) { /* ÌèâÍ∞ÄÍ∏àÏï° Ïª¨Îüº */
            width: 12%;
            min-width: 90px;
        }
        
        .crypto-table th:nth-child(5) { /* ÌèâÍ∑†Îß§ÏàòÍ∞Ä Ïª¨Îüº */
            width: 12%;
            min-width: 90px;
        }
        
        .crypto-table th:nth-child(6) { /* ÏÜêÏùµ Ïª¨Îüº */
            width: 10%;
            min-width: 80px;
        }
        
        .crypto-table th:nth-child(7) { /* ÏàòÏùµÎ•† Ïª¨Îüº */
            width: 10%;
            min-width: 70px;
        }
        
        .crypto-table th:nth-child(8) { /* MDD Ïª¨Îüº */
            width: 10%;
            min-width: 70px;
        }
        
        .crypto-table th:nth-child(9) { /* ÏÉÅÌÉú Ïª¨Îüº */
            width: 8%;
            min-width: 60px;
        }
        
        .table th:nth-child(1) { /* PID Ïª¨Îüº */
            width: 120px;
            min-width: 80px;
        }
        
        .table th:nth-child(2) { /* ÌîÑÎ°úÏÑ∏Ïä§Î™Ö Ïª¨Îüº */
            width: 120px;
            min-width: 100px;
            max-width: 300px;
        }
        
        .table th:nth-child(3) { /* Î©îÎ™®Î¶¨ Ïª¨Îüº */
            width: 120px;
            min-width: 100px;
        }
        
        .table th:nth-child(4) { /* CPU Ïª¨Îüº */
            width: 120px;
            min-width: 80px;
        }
        
        .table th:nth-child(5) { /* ÏÉÅÌÉú Ïª¨Îüº */
            width: 120px;
            min-width: 100px;
        }
        
        .table th:nth-child(6) { /* ÎèôÏûë Ïª¨Îüº */
            width: 120px;
            min-width: 100px;
        }
        
        .table td:nth-child(2) { /* ÌîÑÎ°úÏÑ∏Ïä§Î™Ö ÏÖÄ */
            word-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            max-width: 300px;
            line-height: 1.2;
        }
        
                 /* Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Î†àÏù¥ÏïÑÏõÉ Í∞ïÏ†ú Ï†ÅÏö© */
         .portfolio-grid {
             display: flex !important;
             flex-wrap: wrap !important;
             --bs-gutter-x: 0 !important;
             margin-right: 0 !important;
             margin-left: 0 !important;
         }
         
         /* PCÏóêÏÑúÎäî 2x2 Í∑∏Î¶¨Îìú (lg Ïù¥ÏÉÅÏóêÏÑú 2Ïó¥) */
         @media (min-width: 992px) {
             .portfolio-grid > div {
                 flex: 0 0 50% !important;
                 max-width: 50% !important;
                 padding-right: 0.5rem !important;
                 padding-left: 0.5rem !important;
             }
         }
         
         /* Î™®Î∞îÏùºÏóêÏÑúÎäî 1Ïó¥ ÏàòÏßÅ Î∞∞Ïπò */
         @media (max-width: 991.98px) {
             .portfolio-grid > div {
                 flex: 0 0 100% !important;
                 max-width: 100% !important;
                 padding-right: 0 !important;
                 padding-left: 0 !important;
             }
         }
         
         /* Í∞Å Ïπ¥Îìú ÎÇ¥Î∂ÄÏùò Îç∞Ïù¥ÌÑ∞ Î∞∞Ïπò */
         .portfolio-grid .bot-card {
             height: 100% !important;
             margin-bottom: 0;
         }
         
         /* Í∑∏Î¶¨Îìú ÎÇ¥ Ïπ¥Îìú Ïª®ÌÖåÏù¥ÎÑà Í∞ÑÍ≤© Ï°∞Ï†ï */
         .portfolio-grid > div {
             margin-bottom: 1rem;
         }
         
         /* Ïπ¥Îìú ÎÇ¥ ÎÜíÏù¥ Ï°∞Ï†ï */
         .portfolio-grid .card-body {
             display: flex;
             flex-direction: column;
         }
         
         /* Ï∞®Ìä∏ ÏòÅÏó≠ ÎÜíÏù¥ Ï°∞Ï†ï */
         .chart-container {
             height: 200px;
             max-height: 200px;
             position: relative;
             margin-top: 0.75rem !important;
             overflow: hidden;
         }
         
         /* Ï∞®Ìä∏ Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ï†úÌïú */
         .chart-container canvas {
             max-height: 100%;
             width: 100% !important;
             height: 100% !important;
         }
    </style>
</head>
<body>
    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-12">

                        <!-- Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-pie me-2"></i>
                                            ÌïúÍµ≠Ìà¨ÏûêÏ¶ùÍ∂å Ìà¨ÏûêÌòÑÌô©
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="portfolio-container">
                                            <!-- Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÏóÖÎπÑÌä∏ Ìà¨ÏûêÌòÑÌô© ÏÑπÏÖò -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-pie me-2"></i>
                                            ÏóÖÎπÑÌä∏ Ìà¨ÏûêÌòÑÌô©
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="upbit-container">
                                            <!-- ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏòµÏÖò Î™®Îã¨ -->
                        <div class="modal fade" id="portfolioOptionsModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏòµÏÖò</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="portfolioOptionsForm">
                                            <div class="mb-3">
                                                <label class="form-label">Ï¥àÍ∏∞ Í∏àÏï°</label>
                                                <input type="number" step="1" class="form-control" id="opt_initial_investment" />
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Ï¥àÍ∏∞ Í∏àÏï°(Ïã§Ï†úÌà¨ÏûÖÍ∏àÏï°)</label>
                                                <input type="number" step="1" class="form-control" id="opt_initial_investment_old" />
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Î∞∞ÎãπÍ∏à</label>
                                                <input type="number" step="1" class="form-control" id="opt_dividend_income" />
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Ìà¨Ïûê ÏãúÏûëÏùº</label>
                                                <input type="date" class="form-control" id="opt_investment_date" />
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                                        <button type="button" class="btn btn-primary" onclick="savePortfolioOptions()">Ï†ÄÏû•</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Python ÌîÑÎ°úÏÑ∏Ïä§ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>
                                            Python ÌîÑÎ°úÏÑ∏Ïä§ Í¥ÄÎ¶¨
                                        </h5>
                                        <button class="btn btn-sm btn-outline-light" onclick="getPythonProcesses()">
                                            <i class="fas fa-sync me-1"></i>
                                            ÏÉàÎ°úÍ≥†Ïπ®
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="python-processes-container">
                                            <!-- Python ÌîÑÎ°úÏÑ∏Ïä§ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏ ÏÑπÏÖò -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-list me-2"></i>
                                            Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="trade-logs-container">
                                            <!-- Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                        

                        

                                    </div>
                                </div>
                            </div>
                        </div>
                        
                
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="fas fa-file-alt me-2"></i>
                                            Î≥¥Í≥†ÏÑú Í¥ÄÎ¶¨
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex flex-column gap-3">
                                            <button class="btn btn-report btn-action w-100" onclick="sendDailyReport()">
                                                <i class="fas fa-calendar-day me-2"></i>
                                                ÏùºÏùº Î≥¥Í≥†ÏÑú Ï†ÑÏÜ°
                                            </button>
                                            <button class="btn btn-report btn-action w-100" onclick="sendMonthlyReport()">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                ÏõîÍ∞Ñ Î≥¥Í≥†ÏÑú Ï†ÑÏÜ°
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshStatus()" id="refresh-btn">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStatus = {};
        let portfolioData = {};
        
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                if (toastElement.parentNode) {
                    toastElement.parentNode.removeChild(toastElement);
                }
            }, 5000);
        }
        
        // function updateProcessCards(processes) { // processes-containerÍ∞Ä ÏÇ≠Ï†úÎêòÏñ¥ Ï£ºÏÑù Ï≤òÎ¶¨
        //     const container = document.getElementById('processes-container');
        //     container.innerHTML = '';
        //     
        //     let runningCount = 0;
        //     let stoppedCount = 0;
        //     
        //     Object.entries(processes).forEach(([name, status]) => {
        //         if (status.running) runningCount++;
        //         else stoppedCount++;
        //         
        //                                  const cardHtml = `
        //                      <div class="col-md-6 mb-3">
        //                          <div class="card process-card h-100">
        //                              <div class="card-body d-flex flex-column">
        //                                  <div class="d-flex justify-content-between align-items-center mb-3">
        //                                      <h6 class="card-title mb-0">
        //                                          <span class="status-indicator ${status.running ? 'status-running' : 'status-stopped'}"></span>
        //                                          ${name}
        //                                      </h6>
        //                                      <span class="badge bg-${status.running ? 'success' : 'danger'}">
        //                                          ${status.running ? 'Ïã§Ìñâ Ï§ë' : 'Ï§ëÏßÄÎê®'}
        //                                      </span>
        //                                  </div>
        //                                  
        //                                  <div class="row text-center mb-3 flex-grow-1">
        //                                      <div class="div class="col-4">
        //                                          <small class="text-muted">PID</small>
        //                                          <div class="fw-bold">${status.pid || '-'}</div>
        //                                      </div>
        //                                      <div class="col-4">
        //                                          <small class="text-muted">Î©îÎ™®Î¶¨</small>
        //                                          <div class="fw-bold">${status.memory.toFixed(1)} MB</div>
        //                                      </div>
        //                                      <div class="col-4">
        //                                          <small class="text-muted">CPU</small>
        //                                          <div class="fw-bold">${status.cpu_percent.toFixed(1)}%</div>
        //                                      </div>
        //                                  </div>
        //                                  
        //                                  <div class="d-flex gap-3 mt-auto">
        //                                      <button class="btn btn-start btn-action flex-fill" 
        //                                              onclick="startProcess('${getProcessKey(name)}')"
        //                                              ${status.running ? 'disabled' : ''}>
        //                                          <i class="fas fa-play me-1"></i> ÏãúÏûë
        //                                      </button>
        //                                      <button class="btn btn-stop btn-action flex-fill" 
        //                                              onclick="div class="btn btn-warning btn-action flex-fill" 
        //                                              onclick="restartProcess('${getProcessKey(name)}')"
        //                                              ${!status.running ? 'disabled' : ''}>
        //                                          <i class="fas fa-redo me-1"></i> Ïû¨ÏãúÏûë
        //                                      </button>
        //                                  </div>
        //                              </div>
        //                          </div>
        //                      </div>
        //                  `;
        //                 
        //                 container.insertAdjacentHTML('beforeend', cardHtml);
        //             });
        //             
        //             
        //         }
        
        // function getProcessKey(name) { // updateProcessCardsÍ∞Ä Ï£ºÏÑù Ï≤òÎ¶¨ÎêòÏñ¥ Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
        //     const keyMap = {
        //         'Kosdaqpi_Bot': 'kosdaqpi_bot',
        //         'XAA_Kr_Bot': 'xaa_kr_bot',
        //         'KIS_KR_SplitTrader_System': 'kis_kr_split_trader',
        //         'scheduler': 'scheduler',
        //         'web_server': 'web_server'
        //     };
        //     return keyMap[name] || name.toLowerCase().replace(/\s+/g, '_');
        // }
        

        

        

            

            

            

            

            

        

        

        
        function updatePortfolioInfo(portfolio, overview) {
            const container = document.getElementById('portfolio-container');
            
            // Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ï†ÄÏû• (Ï∞®Ìä∏ÏóêÏÑú ÏÇ¨Ïö©)
            window.currentPortfolioData = portfolio;
            
            if (!portfolio) {
                container.innerHTML = '<p class="text-muted">Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            const performance = portfolio.performance || {};
            const bots = portfolio.bots || {};
            
            // ÏàòÏùµÎ•† Í≥ÑÏÇ∞
            const totalProfitRate = performance.total_profit_rate || 0;
            const profitColor = totalProfitRate >= 0 ? 'danger' : 'primary';
            const profitIcon = totalProfitRate >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
                         // Î¥áÎ≥Ñ Î∞ïÏä§ ÏÉùÏÑ±
             const botConfigs = {
                 'Portfolio_Summary': { color: 'primary', icon: 'fa-coins', description: 'Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ', isPortfolio: true },
                 'Kosdaqpi_Bot': { color: 'info', icon: 'fa-chart-line', description: 'ÏΩîÏä§Îã• ÏñëÎ∞©Ìñ• Ï†ÑÎûµ' },
                 'MA_Strategy_KR_Bot_v3': { color: 'warning', icon: 'fa-chart-area', description: 'Ïù¥ÎèôÌèâÍ∑†ÏûêÏÇ∞Î∞∞Î∂ÑÏ†ÑÎûµ_KR' },
                 'MA_Kosdaqpi100_Bot_v1': { color: 'primary', icon: 'fa-chart-bar', description: 'ÏΩîÏä§Ìîº100, ÏΩîÏä§Îã•100 Ïù¥ÎèôÌèâÍ∑†ÏûêÏÇ∞Î∞∞Î∂ÑÏ†ÑÎûµ_KR' }
             };
             
             // 2x2 Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ ÏãúÏûë
             let portfolioHtml = `<div class="row portfolio-grid">`;
             
             // Î™®Îì† Î¥á Ï≤òÎ¶¨ (Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ Ìè¨Ìï®)
             Object.entries(botConfigs).forEach(([botName, botConfig], index) => {
                 // Î¥áÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                 const botCfg = portfolio.bots && portfolio.bots[botName];
                 const botHoldings = (botCfg && botCfg.holdings) ? botCfg.holdings : [];
                 const botProfit = (overview && overview.bots && overview.bots[botName]) ? overview.bots[botName] : (portfolio.bot_profits && portfolio.bot_profits[botName]);
                 const chartId = botName === 'Kosdaqpi_Bot' ? 'kosdaqpi-profit-chart' : (botName === 'MA_Strategy_KR_Bot_v3' ? 'ma-v3-profit-chart' : 'ma-v4-profit-chart');
                 const collapseId = `holdings-${botName}`;
                 
                 // Î™®Î∞îÏùºÏóêÏÑúÎäî 100%, PCÏóêÏÑúÎäî 50%Î°ú ÏÑ§Ï†ï
                 portfolioHtml += `
                     <div class="col-12 col-lg-6 mb-3">
                         <div class="card border-0 bg-primary bg-opacity-10 h-100 bot-card">
                             <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center p-3">
                                 <div>
                                     <h6 class="card-title fw-bold text-white mb-0">
                                         <i class="fas ${botConfig.icon} me-2"></i>${botConfig.isPortfolio ? 'Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ' : botName}
                                     </h6>
                                     ${!botConfig.isPortfolio ? `<small class="text-white-50">${botConfig.description}</small>` : ''}
                                 </div>
                                 <div class="d-flex gap-2">
                                     ${!botConfig.isPortfolio ? `
                                     <button type="button" class="btn btn-sm btn-outline-light" onclick="openBotLogModal('${botName}')" title="Î°úÍ∑∏ Î≥¥Í∏∞">
                                         <i class="fas fa-file-alt"></i>
                                     </button>
                                     <button type="button" class="btn btn-sm btn-icon-white" onclick="openBotSettings('${botName}')" title="ÏÑ§Ï†ï Í¥ÄÎ¶¨">
                                         <i class="fas fa-cog" style="color:#ffffff"></i>
                                     </button>
                                     ` : `
                                     <button type="button" class="btn btn-sm btn-icon-white" onclick="openPortfolioOptions()" title="ÏÑ§Ï†ï Í¥ÄÎ¶¨">
                                         <i class="fas fa-cog" style="color:#ffffff"></i>
                                     </button>
                                     `}
                                 </div>
                             </div>
                             <div class="card-body p-3">
                             ${botConfig.isPortfolio ? `
                                 <div class="mt-3">
                                     <div class="row text-center">
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ Ï¥àÍ∏∞ Ìà¨ÏûêÍ∏à</small>
                                             <div class="fw-bold">${formatNumber((overview && overview.initial_investment) || portfolio.initial_investment || 0)}Ïõê</div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°</small>
                                             <div class="fw-bold">${formatNumber((overview && overview.current_value) || performance.total_value || 0)}Ïõê</div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ Ï¥ù ÏàòÏùµÍ∏à</small>
                                             <div class="fw-bold text-${profitColor}">
                                                 <i class="fas ${profitIcon} me-1"></i>
                                                 ${formatNumber((overview && overview.total_profit) || performance.total_profit || 0)}Ïõê
                                             </div>
                                         </div>
                                     </div>
                                     <div class="row text-center mt-2">
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üìà ÏàòÏùµÎ•†</small>
                                             <div class="fw-bold text-${profitColor}">
                                                 ${((overview && overview.total_profit_rate) || totalProfitRate || 0).toFixed(2)}%
                                             </div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üíµ Î∞∞ÎãπÍ∏à</small>
                                             <div class="fw-bold text-info">${formatNumber((overview && overview.dividend_income) || portfolio.dividend_income || 0)}Ïõê</div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üìÖ Ìà¨Ïûê ÏãúÏûëÏùº</small>
                                             <div class="fw-bold">${(overview && overview.investment_date) || portfolio.investment_date || '-'}</div>
                                         </div>
                                     </div>
                                 </div>
                                 ${overview ? buildOverviewStatsRow(overview) : ''}
                                 
                                 <!-- KOSPI Ï†ïÎ≥¥ ÏÑπÏÖò Ï∂îÍ∞Ä -->
                                 <div class="mt-3" id="kospi-info-section">
                                     <div class="row text-center">
                                         <div class="col-12 mb-2">
                                             <small class="text-muted">üìä KOSPI ÏßÄÏàò Ï†ïÎ≥¥</small>
                                         </div>
                                     </div>
                                     <div class="row text-center" id="kospi-data">
                                         <div class="col-6 col-md-3 mb-2">
                                             <small class="text-muted">ÌòÑÏû¨ ÏßÄÏàò</small>
                                             <div class="fw-bold text-primary" id="current-kospi">-</div>
                                         </div>
                                         <div class="col-6 col-md-3 mb-2">
                                             <small class="text-muted">Î≥ÄÎèôÎ•†</small>
                                             <div class="fw-bold" id="kospi-change">-</div>
                                         </div>
                                         <div class="col-6 col-md-3 mb-2">
                                             <small class="text-muted">ÏµúÍ≥†Ï†ê</small>
                                             <div class="fw-bold text-success" id="max-kospi">-</div>
                                         </div>
                                         <div class="col-6 col-md-3 mb-2">
                                             <small class="text-muted">ÏµúÍ≥†Ï†ê ÎÇ†Ïßú</small>
                                             <div class="fw-bold text-info" id="max-date">-</div>
                                         </div>
                                     </div>
                                     <div class="row text-center mt-2">
                                         <div class="col-12">
                                             <small class="text-muted">Î∂ÑÏÑù ÏÉÅÌÉú: </small>
                                             <span class="badge" id="kospi-status">-</span>
                                         </div>
                                     </div>
                                     <div class="row text-center mt-2">
                                         <div class="col-12">
                                             <small class="text-muted">ÎßàÏßÄÎßâ Î∂ÑÏÑù: </small>
                                             <span class="text-info" id="last-analysis-time">-</span>
                                         </div>
                                     </div>
                                 </div>
                             ` : `
                                 <div class="mt-3">
                                     <div class="row text-center">
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ Ï¥àÍ∏∞ Î∂ÑÎ∞∞Í∏à</small>
                                             <div class="fw-bold">${formatNumber(portfolio.bots && portfolio.bots[botName] ? (portfolio.bots[botName].initial_allocation || 0) : 0)}Ïõê</div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ ÌòÑÏû¨ Î∂ÑÎ∞∞Í∏à</small>
                                             <div class="fw-bold">${formatNumber(portfolio.bots && portfolio.bots[botName] ? (portfolio.bots[botName].current_allocation || 0) : 0)}Ïõê</div>
                                         </div>
                                         <div class="col-6 col-md-4 mb-2">
                                             <small class="text-muted">üí∞ Ï¥ù Î≥¥Ïú†Í∞ÄÏπò</small>
                                             <div class="fw-bold">${formatNumber(portfolio.bots && portfolio.bots[botName] ? (portfolio.bots[botName].total_holding_value || 0) : 0)}Ïõê</div>
                                         </div>
                                     </div>
                                 </div>
                                 ${buildBotPeriodRow(overview, botName)}
                                 <div class="mt-3 chart-container"><canvas id="${botName}-chart"></canvas></div>
                                 ${botHoldings.length > 0 ? `
                                     <div class="d-flex justify-content-end gap-2 mt-2">
                                         <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                             <i class="fas fa-list me-1"></i> Î≥¥Ïú†Ï¢ÖÎ™© Î≥¥Í∏∞
                                         </button>
                                     </div>
                                     <div class="collapse mt-2" id="${collapseId}">
                                         <div class="table-responsive" style="overflow-x: auto;">
                                             <table class="table table-sm table-hover holdings-table">
                                                 <thead>
                                                     <tr class="table-light">
                                                         <th>Ï¢ÖÎ™©</th>
                                                         <th class="text-end">ÏàòÎüâ</th>
                                                         <th class="text-end">ÌèâÎã®</th>
                                                         <th class="text-end">ÌòÑÏû¨Í∞Ä</th>
                                                         <th class="text-end">ÌèâÍ∞ÄÍ∏àÏï°</th>
                                                         <th class="text-end">ÏÜêÏùµ</th>
                                                         <th class="text-end">ÏàòÏùµÎ•†</th>
                                                     </tr>
                                                 </thead>
                                                 <tbody>
                                                     ${botHoldings.map(h => `
                                                         <tr>
                                                             <td>${h.stock_name || h.stock_code}</td>
                                                             <td class="text-end">${formatNumber(h.quantity || 0)}</td>
                                                             <td class="text-end">${formatInteger(h.purchase_price || 0)}</td>
                                                             <td class="text-end">${formatInteger(h.current_price || 0)}</td>
                                                             <td class="text-end">${formatNumber(h.current_value || 0)}</td>
                                                             <td class="text-end ${((h.profit_loss||0)>=0)?'text-danger':'text-primary'}">${formatNumber(h.profit_loss || 0)}</td>
                                                             <td class="text-end ${((h.profit_rate||0)>=0)?'text-danger':'text-primary'}">${(parseFloat(h.profit_rate||0)).toFixed(2)}%</td>
                                                         </tr>
                                                     `).join('')}
                                                 </tbody>
                                             </table>
                                         </div>
                                     </div>
                                 ` : ''}
                             `}
                             </div>
                         </div>
                     </div>
                 `;
             });
             
             // Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ Ï¢ÖÎ£å
             portfolioHtml += `</div>`;
            
        function buildBotPeriodRow(overview, botName) {
            if (!overview || !overview.bots || !overview.bots[botName] || !overview.bots[botName].periods) return '';
            const p = overview.bots[botName].periods;
            const iconForTitle = (t) => {
                if (!t) return 'fa-calendar';
                if (t.includes('ÏùºÍ∞Ñ')) return 'fa-calendar-day';
                if (t.includes('ÏõîÍ∞Ñ')) return 'fa-calendar-days';
                return 'fa-trophy';
            };
            const box = (title, obj) => {
                const rate = (obj && obj.profit_rate) || 0;
                const amt = (obj && obj.profit) || 0;
                const r = Number(rate || 0);
                const isUp = r >= 0;
                const cls = isUp ? 'text-danger' : 'text-primary';
                const icon = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
                const sign = r >= 0 ? '+' : '';
                return `
                    <div class="col-md-3 col-6 mt-2 mb-3">
                        <div class="card h-100 border-0 period-box">
                            <div class="card-body text-center py-0">
                                <div class="small text-muted"><i class="fas ${iconForTitle(title)} me-1"></i>${title}</div>
                                <div class="fw-bold ${cls}" style="font-size:0.9rem; line-height:1.0; white-space: nowrap;">
                                    <i class="fas ${icon} me-1"></i>${formatNumber(amt)}Ïõê
                                </div>
                                <div class="${cls}" style="font-size:0.85rem; line-height:1.0; white-space: nowrap;">${sign}${r.toFixed(2)}%</div>
                            </div>
                        </div>
                    </div>`;
            };
            return `
                <div class="row mt-2 period-row">
                    ${box('ÏùºÍ∞ÑÏàòÏùµ', p.daily)}
                    ${box('ÏõîÍ∞ÑÏàòÏùµ', p.monthly)}
                    ${box('Ïó∞Í∞ÑÏàòÏùµ', p.yearly)}
                    ${box('ÌåêÎß§ÏàòÏùµ', p.total)}
                </div>`;
        }

        // === Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏòµÏÖò Ìé∏Ïßë ===
        function formatDateForInput(value) {
            try {
                if (!value) return '';
                if (typeof value === 'string') {
                    // YYYY-MM-DD ÎòêÎäî ISO Î¨∏ÏûêÏó¥Ïùº Í≤ΩÏö∞ Ïïû 10ÏûêÎ¶¨ ÏÇ¨Ïö©
                    return value.slice(0, 10);
                }
                // Date Í∞ùÏ≤¥ ÎòêÎäî Ïà´Ïûê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÎåÄÏùë
                const dt = value instanceof Date ? value : new Date(value);
                if (isNaN(dt.getTime())) return '';
                return new Date(dt.getTime() - dt.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 10);
            } catch { return ''; }
        }
        let portfolioOverviewCache = null;
        window.openPortfolioOptions = async function() {
            // Î™®Îã¨ÏùÄ Î®ºÏ†Ä Î≥¥Ïó¨Ï£ºÍ≥†, Îç∞Ïù¥ÌÑ∞Îäî ÎπÑÎèôÍ∏∞Î°ú Ï±ÑÏõÄ
            const modalEl = document.getElementById('portfolioOptionsModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            try {
                const resp = await fetch('/api/portfolio_overview');
                const data = await resp.json();
                if (data && data.success) {
                    portfolioOverviewCache = data.overview || {};
                }
                const cfgResp = await fetch('/api/portfolio_config');
                const cfg = await cfgResp.json();

                document.getElementById('opt_initial_investment').value = (cfg && cfg.initial_investment != null) ? cfg.initial_investment : (portfolioOverviewCache?.initial_investment ?? '');
                document.getElementById('opt_initial_investment_old').value = (cfg && cfg.initial_investment_old != null) ? cfg.initial_investment_old : '';
                document.getElementById('opt_dividend_income').value = (cfg && cfg.dividend_income != null) ? cfg.dividend_income : 0;
                const elTotalDiv = document.getElementById('opt_total_dividend_income');
                if (elTotalDiv) {
                    elTotalDiv.value = (cfg && cfg.total_dividend_income != null) ? cfg.total_dividend_income : 0;
                }
                const investmentDate = (cfg && cfg.investment_date) || (portfolioOverviewCache && portfolioOverviewCache.investment_date) || '';
                document.getElementById('opt_investment_date').value = formatDateForInput(investmentDate);
            } catch (e) {
                // Ïã§Ìå®Ìï¥ÎèÑ Î™®Îã¨ÏùÄ Ïó¥Î¶∞ ÏÉÅÌÉú Ïú†ÏßÄ
                console.warn('ÏòµÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
                showToast('ÏòµÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®. ÏàòÎèôÏúºÎ°ú ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'warning');
            }
        }

        window.savePortfolioOptions = async function() {
            try {
                const payload = { portfolio: {
                        initial_investment: toNumber(document.getElementById('opt_initial_investment').value),
                        initial_investment_old: toNumberOrNull(document.getElementById('opt_initial_investment_old').value),
                        dividend_income: toNumber(document.getElementById('opt_dividend_income').value),
                        investment_date: (document.getElementById('opt_investment_date').value || '').trim()
                    }};
                const elTotalDiv2 = document.getElementById('opt_total_dividend_income');
                if (elTotalDiv2) {
                    payload.portfolio.total_dividend_income = toNumber(elTotalDiv2.value);
                }

                const res = await fetch('/api/portfolio_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();

                if (result.success) {
                    showToast('Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('portfolioOptionsModal')).hide();
                    refreshPortfolioOverview();
                } else {
                    showToast(result.message || 'Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'danger');
                }
            } catch (e) {
                showToast('Ï†ÄÏû• Ï§ë Ïò§Î•ò: ' + e.message, 'danger');
            }
        }

        function toNumber(v) {
            if (v === null || v === undefined || v === '') return 0;
            const n = Number(v);
            return isNaN(n) ? 0 : n;
        }
        function toNumberOrNull(v) {
            if (v === null || v === undefined || v === '') return null;
            const n = Number(v);
            return isNaN(n) ? null : n;
        }

        async function refreshPortfolioOverview() {
            try {
                const res = await fetch('/api/portfolio');
                const json = await res.json();
                if (json.success) {
                    const ov = await (await fetch('/api/portfolio_overview')).json();
                    updatePortfolioInfo(json.portfolio, ov.overview);
                }
            } catch (e) {
                // no-op
            }
        }
            
            container.innerHTML = portfolioHtml;
            
            // DOMÏù¥ ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌõÑ Ï∞®Ìä∏Î•º Î°úÎìúÌïòÍ∏∞ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ Ï∂îÍ∞Ä
            setTimeout(() => {
                // Î≥¥Ïú† Ï¢ÖÎ™© Ï∞®Ìä∏Îäî Î≥¥Ïú† Îç∞Ïù¥ÌÑ∞ Ïú†Î¨¥Ïóê Îî∞Îùº ÎÇ¥Î∂ÄÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Î¨¥Ï°∞Í±¥ Ìò∏Ï∂ú
                loadKosdaqpiProfitChart();
                loadMaV3ProfitChart();
                loadMaV4ProfitChart();
            }, 100);
        }

        function buildOverviewStatsRow(overview) {
            const periods = overview.periods || {};
            const daily = periods.daily || { profit: 0, profit_rate: 0 };
            const monthly = periods.monthly || { profit: 0, profit_rate: 0 };
            const yearly = periods.yearly || { profit: 0, profit_rate: 0 };
            const total = periods.total || { profit: 0, profit_rate: 0 };

            const iconForTitle = (t) => {
                if (!t) return 'fa-calendar';
                if (t.includes('ÏùºÍ∞Ñ')) return 'fa-calendar-day';
                if (t.includes('ÏõîÍ∞Ñ')) return 'fa-calendar-days';
                return 'fa-trophy';
            };
            const box = (title, amount, rate) => {
                const r = Number(rate || 0);
                const isUp = r >= 0;
                const cls = isUp ? 'text-danger' : 'text-primary';
                const icon = isUp ? 'fa-arrow-up' : 'fa-arrow-down';
                const sign = r >= 0 ? '+' : '';
                return `
                    <div class="col-md-3 col-6 mt-2 mb-3">
                        <div class="card h-100 border-0 period-box">
                            <div class="card-body text-center py-0">
                                <div class="mb-1"><i class="fas ${iconForTitle(title)} me-1"></i>${title}</div>
                                <div class="fw-bold ${cls}" style="font-size:0.9rem; line-height:1.0; white-space: nowrap;">
                                    <i class="fas ${icon} me-1"></i>${formatNumber(amount || 0)}Ïõê
                                </div>
                                <div class="${cls}" style="font-size:0.85rem; line-height:1.0; white-space: nowrap;">${sign}${r.toFixed(2)}%</div>
                            </div>
                        </div>
                    </div>`;
            };

            return `
                <div class="row mt-2 period-row">
                    ${box('ÏùºÍ∞ÑÏàòÏùµ', daily.profit, daily.profit_rate)}
                    ${box('ÏõîÍ∞ÑÏàòÏùµ', monthly.profit, monthly.profit_rate)}
                    ${box('Ïó∞Í∞ÑÏàòÏùµ', yearly.profit, yearly.profit_rate)}
                    ${box('ÌåêÎß§ÏàòÏùµ', total.profit, total.profit_rate)}
                </div>`;
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }
        function formatInteger(num) {
            const n = Number(num);
            if (!isFinite(n)) return '0';
            return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(Math.round(n));
        }
        
        function loadKosdaqpiProfitChart() {
            // Kosdaqpi_BotÏùò Î≥¥Ïú† Ï£ºÏãù ÏàòÏùµÎ•† Î∂ÑÌè¨ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            fetch('/api/bot_holdings')
                .then(response => response.json())
                .then(data => {
                    if (data.bot_holdings && data.bot_holdings.Kosdaqpi_Bot && data.bot_holdings.Kosdaqpi_Bot.holdings) {
                        const holdings = data.bot_holdings.Kosdaqpi_Bot.holdings;
                        createProfitDistributionChart('Kosdaqpi_Bot', holdings);
                    }
                })
                .catch(error => {
                    console.error('Kosdaqpi_Bot Î≥¥Ïú† Ï£ºÏãù Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                });
        }
        
        function createProfitDistributionChart(botName, holdings) {
            const chartId = `${botName}-chart`;
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.warn(`Ï∞®Ìä∏ Ï∫îÎ≤ÑÏä§ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${chartId}`);
                return;
            }
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (window.chartInstances && window.chartInstances[chartId]) {
                window.chartInstances[chartId].destroy();
            }
            
            // Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•ÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
            if (!window.chartInstances) {
                window.chartInstances = {};
            }
            
            // Î≥¥Ïú† Ï£ºÏãùÏù¥ ÏóÜÏúºÎ©¥ Î©îÏãúÏßÄ ÌëúÏãú
            if (!holdings || holdings.length === 0) {
                ctx.style.display = 'none';
                const container = ctx.parentElement;
                container.innerHTML = '<div class="text-center text-muted py-5"><small>Î≥¥Ïú† Ï£ºÏãùÏù¥ ÏóÜÏäµÎãàÎã§.</small></div>';
                return;
            }
            
            ctx.style.display = 'block';
            
            // ÏàòÏùµÎ•† Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const labels = holdings.map(holding => holding.stock_name || holding.stock_code);
            const profitRates = holdings.map(holding => {
                const profitRate = holding.profit_rate || 0;
                return parseFloat(profitRate);
            });
            
            // ÏÉâÏÉÅ ÏÑ§Ï†ï (ÏàòÏùµÎ•†Ïóê Îî∞Îùº)
            const colors = profitRates.map(rate => {
                return rate >= 0 ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 123, 255, 0.8)';
            });
            
            // ÏÉà Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ± Î∞è Ï†ÄÏû•
            window.chartInstances[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÏàòÏùµÎ•† (%)',
                        data: profitRates,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ÏàòÏùµÎ•† Î∂ÑÌè¨',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ÏàòÏùµÎ•† (%)',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ï¢ÖÎ™©',
                                font: {
                                    size: 10
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 9
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function loadMaV3ProfitChart() {
            // MA_Strategy_KR_Bot_v3Ïùò Î≥¥Ïú† Ï£ºÏãù ÏàòÏùµÎ•† Î∂ÑÌè¨ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            const botName = 'MA_Strategy_KR_Bot_v3';
            console.log(`${botName} Ï∞®Ìä∏ Î°úÎî© ÏãúÏûë`);
            
            // Î®ºÏ†Ä Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌôïÏù∏
            if (window.currentPortfolioData && window.currentPortfolioData.bots && window.currentPortfolioData.bots[botName]) {
                const portfolioHoldings = window.currentPortfolioData.bots[botName].holdings;
                if (portfolioHoldings && portfolioHoldings.length > 0) {
                    console.log(`Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ÏóêÏÑú ${botName} Î≥¥Ïú†Ï£ºÏãù Î∞úÍ≤¨:`, portfolioHoldings);
                    createProfitDistributionChart(botName, portfolioHoldings);
                    return;
                }
            }
            
            // APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch('/api/bot_holdings')
                .then(response => response.json())
                .then(data => {
                    console.log(`${botName} API ÏùëÎãµ:`, data);
                    if (data.bot_holdings && data.bot_holdings[botName] && data.bot_holdings[botName].holdings) {
                        const holdings = data.bot_holdings[botName].holdings;
                        console.log(`${botName} Î≥¥Ïú†Ï£ºÏãù:`, holdings);
                        if (holdings && holdings.length > 0) {
                            createProfitDistributionChart(botName, holdings);
                        } else {
                            console.log(`${botName} Î≥¥Ïú†Ï£ºÏãùÏù¥ ÎπÑÏñ¥ÏûàÏùå`);
                            showEmptyHoldingsMessage(botName);
                        }
                    } else {
                        console.log(`${botName} Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏:`, data);
                        showEmptyHoldingsMessage(botName);
                    }
                })
                .catch(error => {
                    console.error(`${botName} Î≥¥Ïú† Ï£ºÏãù Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:`, error);
                    showEmptyHoldingsMessage(botName);
                });
        }
        
        function showEmptyHoldingsMessage(botName) {
            const chartId = `${botName}-chart`;
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.warn(`Ï∞®Ìä∏ Ï∫îÎ≤ÑÏä§ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${chartId}`);
                return;
            }
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (window.chartInstances && window.chartInstances[chartId]) {
                window.chartInstances[chartId].destroy();
                delete window.chartInstances[chartId];
            }
            
            ctx.style.display = 'none';
            const container = ctx.parentElement;
            container.innerHTML = '<div class="text-center text-muted py-5"><small>Î≥¥Ïú† Ï£ºÏãùÏù¥ ÏóÜÏäµÎãàÎã§.</small></div>';
        }
        
        // createMaV3ProfitDistributionChart Ìï®ÏàòÎäî Îçî Ïù¥ÏÉÅ ÌïÑÏöîÌïòÏßÄ ÏïäÏùå - createProfitDistributionChartÎ°ú ÌÜµÌï©

        function loadMaV4ProfitChart() {
            // MA_Kosdaqpi100_Bot_v1Ïùò Î≥¥Ïú† Ï£ºÏãù ÏàòÏùµÎ•† Î∂ÑÌè¨ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
            const botName = 'MA_Kosdaqpi100_Bot_v1';
            console.log(`${botName} Ï∞®Ìä∏ Î°úÎî© ÏãúÏûë`);
            
            // Î®ºÏ†Ä Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌôïÏù∏
            if (window.currentPortfolioData && window.currentPortfolioData.bots && window.currentPortfolioData.bots[botName]) {
                const portfolioHoldings = window.currentPortfolioData.bots[botName].holdings;
                if (portfolioHoldings && portfolioHoldings.length > 0) {
                    console.log(`Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ÏóêÏÑú ${botName} Î≥¥Ïú†Ï£ºÏãù Î∞úÍ≤¨:`, portfolioHoldings);
                    createProfitDistributionChart(botName, portfolioHoldings);
                    return;
                }
            }
            
            // APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            fetch('/api/bot_holdings')
                .then(response => response.json())
                .then(data => {
                    console.log(`${botName} API ÏùëÎãµ:`, data);
                    if (data.bot_holdings && data.bot_holdings[botName] && data.bot_holdings[botName].holdings) {
                        const holdings = data.bot_holdings[botName].holdings;
                        console.log(`${botName} Î≥¥Ïú†Ï£ºÏãù:`, holdings);
                        if (holdings && holdings.length > 0) {
                            createProfitDistributionChart(botName, holdings);
                        } else {
                            console.log(`${botName} Î≥¥Ïú†Ï£ºÏãùÏù¥ ÎπÑÏñ¥ÏûàÏùå`);
                            showEmptyHoldingsMessage(botName);
                        }
                    } else {
                        console.log(`${botName} Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏:`, data);
                        showEmptyHoldingsMessage(botName);
                    }
                })
                .catch(error => {
                    console.error(`${botName} Î≥¥Ïú† Ï£ºÏãù Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:`, error);
                    showEmptyHoldingsMessage(botName);
                });
        }

        // createMaV4ProfitDistributionChart Ìï®ÏàòÎäî Îçî Ïù¥ÏÉÅ ÌïÑÏöîÌïòÏßÄ ÏïäÏùå - createProfitDistributionChartÎ°ú ÌÜµÌï©
        
        function openBotSettings(botName) {
            // Î¥áÎ≥Ñ ÏÑ§Ï†ï Î™®Îã¨ Ïó¥Í∏∞
            const modal = new bootstrap.Modal(document.getElementById('botSettingsModal'));
            document.getElementById('botSettingsModalLabel').textContent = `${botName} ÏÑ§Ï†ï`;
            
            // Î¥áÎ≥Ñ ÏÑ§Ï†ï Î°úÎìú
            loadBotSettings(botName);
            
            modal.show();
        }
        
        function loadBotSettings(botName) {
            // Î¥áÎ≥Ñ ÏÑ§Ï†ïÏùÑ Î°úÎìúÌïòÎäî Ìï®Ïàò
            if (botName === 'MA_Kosdaqpi100_Bot_v1') {
                // MA_Kosdaqpi100_Bot_v1 ÏÑ§Ï†ï Î°úÎìú
                loadBotV4Settings();
            } else if (botName === 'MA_Strategy_KR_Bot_v3') {
                // MA_Strategy_KR_Bot_v3 ÏÑ§Ï†ï Î°úÎìú
                loadBotV3Settings();
            } else if (botName === 'Kosdaqpi_Bot') {
                // Kosdaqpi_Bot ÏÑ§Ï†ï Î°úÎìú
                loadKosdaqpiBotSettings();
            }
        }
        
        function loadBotV3Settings() {
            // MA_Strategy_KR_Bot_v3 ÏÑ§Ï†ï Î°úÎìú
            fetch('/api/portfolio_config')
                .then(response => response.json())
                .then(data => {
                    if (data.bots && data.bots.MA_Strategy_KR_Bot_v3) {
                        const botV3Config = data.bots.MA_Strategy_KR_Bot_v3;
                        showBotV3Settings(botV3Config);
                    } else {
                        console.error('MA_Strategy_KR_Bot_v3 ÏÑ§Ï†ïÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showBotV3Settings({});
                    }
                })
                .catch(error => {
                    console.error('Î¥á ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error);
                    showBotV3Settings({});
                });
        }
        
        function loadKosdaqpiBotSettings() {
            // Kosdaqpi_Bot ÏÑ§Ï†ï Î°úÎìú
            fetch('/api/portfolio_config')
                .then(response => response.json())
                .then(data => {
                    if (data.bots && data.bots.Kosdaqpi_Bot) {
                        const kosdaqpiConfig = data.bots.Kosdaqpi_Bot;
                        showKosdaqpiBotSettings(kosdaqpiConfig);
                    } else {
                        console.error('Kosdaqpi_Bot ÏÑ§Ï†ïÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showKosdaqpiBotSettings({});
                    }
                })
                .catch(error => {
                    console.error('Î¥á ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error);
                    showKosdaqpiBotSettings({});
                });
        }
        
        function loadBotV4Settings() {
            // MA_Kosdaqpi100_Bot_v1 ÏÑ§Ï†ï Î°úÎìú
            fetch('/api/portfolio_config')
                .then(response => response.json())
                .then(data => {
                    if (data.bots && data.bots.MA_Kosdaqpi100_Bot_v1) {
                        const botV4Config = data.bots.MA_Kosdaqpi100_Bot_v1;
                        showBotV4Settings(botV4Config);
                    } else {
                        console.error('MA_Kosdaqpi100_Bot_v1 ÏÑ§Ï†ïÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showBotV4Settings({});
                    }
                })
                .catch(error => {
                    console.error('Î¥á ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error);
                    showBotV4Settings({});
                });
        }
        
        function showBotV3Settings(config) {
            const modalBody = document.getElementById('botSettingsModalBody');
            // invest_stock_listÍ∞Ä {stock_code, stock_name, ...} ÌòïÌÉúÏù∏ Í≤ÉÏùÑ
            // generateStockListHtmlÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî {code: name} ÌòïÌÉúÎ°ú Î≥ÄÌôò
            const v3DisplayStocks = (config.invest_stock_list || []).map(item => {
                if (item && typeof item === 'object') {
                    const code = item.stock_code ?? '';
                    const name = item.stock_name ?? '';
                    if (code) return { [code]: name || `Ï¢ÖÎ™©${code}` };
                }
                // Ïù¥ÎØ∏ {code: name} ÌòïÌÉúÏù¥Í±∞ÎÇò ÏòàÏô∏Ïù∏ Í≤ΩÏö∞ ÏµúÎåÄÌïú Ïú†ÏßÄ
                const firstKey = Object.keys(item || {})[0];
                return firstKey ? { [firstKey]: item[firstKey] } : {};
            }).filter(obj => Object.keys(obj).length > 0);
            modalBody.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">ÏÑ§Î™Ö</label>
                    <input type="text" class="form-control" value="${config.description || ''}" id="botV3Description">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ìï†Îãπ ÎπÑÏú® (%)</label>
                    <input type="number" class="form-control" value="${(config.allocation_rate * 100) || 0}" id="botV3AllocationRate" min="0" max="100" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Í≥†Ï†ï ÎπÑÏú® (%)</label>
                    <input type="number" class="form-control" value="${(config.fix_rate * 100) || 0}" id="botV3FixRate" min="0" max="100" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">ÎèôÏ†Å ÎπÑÏú® (%)</label>
                    <input type="number" class="form-control" value="${(config.dynamic_rate * 100) || 0}" id="botV3DynamicRate" min="0" max="100" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ï¥àÍ∏∞ Î∞∞Ï†ï Í∏àÏï°</label>
                    <input type="number" class="form-control" value="${config.initial_allocation ?? 0}" id="botV3InitialAllocation" step="1" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label">ÎàÑÏ†Å Ïã§ÌòÑÏÜêÏùµ</label>
                    <input type="number" class="form-control" value="${config.cumulative_profit_if_sold ?? 0}" id="botV3CumulativeProfit" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ìà¨Ïûê Ï¢ÖÎ™© Î™©Î°ù</label>
                    <div id="botV3StockList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                        ${generateStockListHtml(v3DisplayStocks)}
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" onclick="saveBotV3Settings()">Ï†ÄÏû•</button>
                </div>
            `;
        }
        
        function showKosdaqpiBotSettings(config) {
            const modalBody = document.getElementById('botSettingsModalBody');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">ÏÑ§Î™Ö</label>
                    <input type="text" class="form-control" value="${config.description || ''}" id="kosdaqpiDescription">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ìï†Îãπ ÎπÑÏú® (%)</label>
                    <input type="number" class="form-control" value="${(config.allocation_rate * 100) || 0}" id="kosdaqpiAllocationRate" min="0" max="100" step="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ï¥àÍ∏∞ Î∞∞Ï†ï Í∏àÏï°</label>
                    <input type="number" class="form-control" value="${config.initial_allocation ?? 0}" id="kosdaqpiInitialAllocation" step="1" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label">ÎàÑÏ†Å Ïã§ÌòÑÏÜêÏùµ</label>
                    <input type="number" class="form-control" value="${config.cumulative_profit_if_sold ?? 0}" id="kosdaqpiCumulativeProfit" step="1">
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" onclick="saveKosdaqpiBotSettings()">Ï†ÄÏû•</button>
                </div>
            `;
        }
        
        function showBotV4Settings(config) {
            const modalBody = document.getElementById('botSettingsModalBody');
            
            // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            const defaultConfig = {
                description: config.description || 'ÏΩîÏä§Ìîº100, ÏΩîÏä§Îã•100 Ïù¥ÎèôÌèâÍ∑†ÏûêÏÇ∞Î∞∞Î∂ÑÏ†ÑÎûµ_KR',
                allocation_rate: config.allocation_rate || 0.33,
                fix_rate: config.fix_rate || 0,
                dynamic_rate: config.dynamic_rate || 0,
                initial_allocation: config.initial_allocation ?? 0,
                cumulative_profit_if_sold: config.cumulative_profit_if_sold ?? 0,
                my_stock_list: config.my_stock_list || [],
                invest_stock_list: config.invest_stock_list || [],
                exclude_stock_list: config.exclude_stock_list || []
            };
            
            modalBody.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">ÏÑ§Î™Ö</label>
                    <input type="text" class="form-control" value="${defaultConfig.description}" id="botV4Description">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ìï†Îãπ ÎπÑÏú® (%)</label>
                    <input type="number" class="form-control" value="${(defaultConfig.allocation_rate * 100)}" id="botV4AllocationRate" min="0" max="100" step="1">
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Í≥†Ï†ï ÎπÑÏú® (%)</label>
                            <input type="number" class="form-control" value="${(defaultConfig.fix_rate * 100)}" id="botV4FixRate" min="0" max="100" step="1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ÎèôÏ†Å ÎπÑÏú® (%)</label>
                            <input type="number" class="form-control" value="${(defaultConfig.dynamic_rate * 100)}" id="botV4DynamicRate" min="0" max="100" step="1">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Ï¥àÍ∏∞ Î∞∞Ï†ï Í∏àÏï°</label>
                            <input type="number" class="form-control" value="${defaultConfig.initial_allocation}" id="botV4InitialAllocation" min="0" step="1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ÎàÑÏ†Å Ïã§ÌòÑÏÜêÏùµ</label>
                            <input type="number" class="form-control" value="${defaultConfig.cumulative_profit_if_sold}" id="botV4CumulativeProfit" step="1">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ÎÇ¥ Ï¢ÖÎ™© Î™©Î°ù</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newMyStockCode" placeholder="Ï¢ÖÎ™© ÏΩîÎìú (Ïòà: 005930)">
                                <button class="btn btn-success" type="button" onclick="addMyStock()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="myStockList" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                ${generateStockListHtml(defaultConfig.my_stock_list)}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Ï†úÏô∏ Ï¢ÖÎ™© Î™©Î°ù</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="newExcludeStockCode" placeholder="Ï¢ÖÎ™© ÏΩîÎìú (Ïòà: 005930)">
                                <button class="btn btn-danger" type="button" onclick="addExcludeStock()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="exclude_stock_list" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                ${generateStockListHtml(defaultConfig.exclude_stock_list)}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary" onclick="saveBotV4Settings()">Ï†ÄÏû•</button>
                </div>
            `;
        }
        
        function saveBotV3Settings() {
            const description = document.getElementById('botV3Description').value;
            const allocationRate = parseFloat(document.getElementById('botV3AllocationRate').value) / 100;
            const fixRate = parseFloat(document.getElementById('botV3FixRate').value) / 100;
            const dynamicRate = parseFloat(document.getElementById('botV3DynamicRate').value) / 100;
            const initialAllocation = parseInt(document.getElementById('botV3InitialAllocation').value || '0', 10);
            const cumulativeProfit = parseInt(document.getElementById('botV3CumulativeProfit').value || '0', 10);
            
            const config = {
                description: description,
                allocation_rate: allocationRate,
                fix_rate: fixRate,
                dynamic_rate: dynamicRate,
                initial_allocation: initialAllocation,
                cumulative_profit_if_sold: cumulativeProfit
            };
            
            // ÏÑ§Ï†ï Ï†ÄÏû•
            fetch('/api/portfolio_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bot_name: 'MA_Strategy_KR_Bot_v3',
                    config: config
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    bootstrap.Modal.getInstance(document.getElementById('botSettingsModal')).hide();
                } else {
                    alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }
        
        function saveKosdaqpiBotSettings() {
            const description = document.getElementById('kosdaqpiDescription').value;
            const allocationRate = parseFloat(document.getElementById('kosdaqpiAllocationRate').value) / 100;
            const initialAllocation = parseInt(document.getElementById('kosdaqpiInitialAllocation').value || '0', 10);
            const cumulativeProfit = parseInt(document.getElementById('kosdaqpiCumulativeProfit').value || '0', 10);
            
            const config = {
                description: description,
                allocation_rate: allocationRate,
                initial_allocation: initialAllocation,
                cumulative_profit_if_sold: cumulativeProfit
            };
            
            // ÏÑ§Ï†ï Ï†ÄÏû•
            fetch('/api/portfolio_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bot_name: 'Kosdaqpi_Bot',
                    config: config
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    bootstrap.Modal.getInstance(document.getElementById('botSettingsModal')).hide();
                } else {
                    alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }
        
        function saveBotV4Settings() {
            const description = document.getElementById('botV4Description').value;
            const allocationRate = parseFloat(document.getElementById('botV4AllocationRate').value) / 100;
            const fixRate = parseFloat(document.getElementById('botV4FixRate').value) / 100;
            const dynamicRate = parseFloat(document.getElementById('botV4DynamicRate').value) / 100;
            const initialAllocation = parseInt(document.getElementById('botV4InitialAllocation').value || '0', 10);
            const cumulativeProfit = parseInt(document.getElementById('botV4CumulativeProfit').value || '0', 10);
            
            // ÌòÑÏû¨ ÌëúÏãúÎêú Ï¢ÖÎ™© Î™©Î°ùÎì§ Í∞ÄÏ†∏Ïò§Í∏∞
            const myStockList = getCurrentStockList('myStockList');
            const excludeStockList = getCurrentStockList('exclude_stock_list');
            
            const config = {
                description: description,
                allocation_rate: allocationRate,
                fix_rate: fixRate,
                dynamic_rate: dynamicRate,
                initial_allocation: initialAllocation,
                cumulative_profit_if_sold: cumulativeProfit,
                my_stock_list: myStockList,
                exclude_stock_list: excludeStockList
            };
            
            // ÏÑ§Ï†ï Ï†ÄÏû•
            fetch('/api/portfolio_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bot_name: 'MA_Kosdaqpi100_Bot_v1',
                    config: config
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                    bootstrap.Modal.getInstance(document.getElementById('botSettingsModal')).hide();
                } else {
                    alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÏÑ§Ï†ï Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            });
        }
        
        async function refreshStatus() {
            console.log('ÏÉÅÌÉú Í∞±Ïã† ÏãúÏûë:', new Date().toLocaleTimeString());
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('loading');
            
            try {
                // 1Îã®Í≥Ñ: ÌôîÎ©¥Ïóê ÌïÑÏöîÌïú ÌïµÏã¨ Îç∞Ïù¥ÌÑ∞Îßå Î®ºÏ†Ä Î°úÎìú (ÏÉÅÌÉú, Ìè¨Ìä∏Ìè¥Î¶¨Ïò§, Ïò§Î≤ÑÎ∑∞)
                const [statusRes, portfolioRes, overviewRes] = await Promise.all([
                    fetch('/api/status'),
                    fetch('/api/portfolio'),
                    fetch('/api/portfolio_overview')
                ]);

                const [statusData, portfolioJson, overviewJson] = await Promise.all([
                    statusRes.json(),
                    portfolioRes.json(),
                    overviewRes.json()
                ]);

                currentStatus = statusData;
                // updateProcessCards(statusData.status.processes); // processes-containerÍ∞Ä ÏÇ≠Ï†úÎêòÏñ¥ Ï£ºÏÑù Ï≤òÎ¶¨

                // Python ÌîÑÎ°úÏÑ∏Ïä§ Î™©Î°ùÏùÑ 1Îã®Í≥ÑÏóêÏÑú Î∞îÎ°ú Î°úÎìú
                try {
                    const pyRes = await fetch('/api/python_processes');
                    const pyJson = await pyRes.json();
                    if (pyJson.success) updatePythonProcessesList(pyJson.processes);
                } catch (e) {
                    console.warn('python process Î™©Î°ù Î°úÎìú Ïã§Ìå®:', e.message);
                }

                // 2Îã®Í≥Ñ: Î∂ÄÍ∞Ä Îç∞Ïù¥ÌÑ∞Îäî ÎπÑÎèôÍ∏∞ ÌõÑÏÜç Î°úÎìú ÌõÑ, ÎèÑÏ∞© Ïãú UIÎßå Î∂ÄÎ∂Ñ Í∞±Ïã†
                ;(async () => {
                    try {
                        // Python ÌîÑÎ°úÏÑ∏Ïä§ Î™©Î°ùÏùÄ Ïù¥ÎØ∏ Î°úÎìúÌñàÏúºÎØÄÎ°ú Í±¥ÎÑàÎúÄ
                    } catch (e) {
                        console.warn('Î∂ÄÍ∞Ä Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e.message);
                    }
                })();

                if (portfolioJson.success) {
                    updatePortfolioInfo(portfolioJson.portfolio, overviewJson.success ? overviewJson.overview : null);
                } else {
                    console.log('Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', portfolioJson.message);
                }

                // ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥ÎèÑ Ìï®Íªò Î°úÎìú
                await refreshUpbitStatus();

                // KOSPI Ï†ïÎ≥¥ÎèÑ Ìï®Íªò Î°úÎìú
                await refreshKospiInfo();

            } catch (error) {
                showToast('ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ' + error.message, 'danger');
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }
        
        // ÏóÖÎπÑÌä∏ ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshUpbitStatus() {
            try {
                const response = await fetch('/api/upbit_status');
                const data = await response.json();
                
                if (data.success) {
                    updateUpbitInfo(data.upbit_data);
                } else {
                    console.log('ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', data.message);
                    showEmptyUpbitMessage();
                }
            } catch (error) {
                console.error('ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                showEmptyUpbitMessage();
            }
        }
        
        // ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateUpbitInfo(upbitData) {
            const container = document.getElementById('upbit-container');
            
            if (!upbitData) {
                showEmptyUpbitMessage();
                return;
            }
            
            console.log('ÏóÖÎπÑÌä∏ Îç∞Ïù¥ÌÑ∞:', upbitData); // ÎîîÎ≤ÑÍπÖÏö©
            
            const portfolioSummary = upbitData.portfolio_summary || {};
            const coinDetails = upbitData.coin_details || {};
            const tradingHistory = upbitData.trading_history || {};
            
            // Ï†ÑÏ≤¥ ÏàòÏùµÎ•† Í≥ÑÏÇ∞ (JSON Íµ¨Ï°∞Ïóê ÎßûÍ≤å ÏàòÏ†ï)
            const totalProfitRate = upbitData.profit_rate || 0;
            const profitColor = totalProfitRate >= 0 ? 'danger' : 'primary';
            const profitIcon = totalProfitRate >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            // Ï¥ù Ìà¨ÏûêÍ∏àÏï°Í≥º ÌòÑÏû¨ Í∞ÄÏπò Í≥ÑÏÇ∞
            const totalInvested = portfolioSummary.total_invested || 0;
            const totalCurrentValue = portfolioSummary.total_current_value || 0;
            const totalProfitLoss = portfolioSummary.total_profit_loss || 0;
            
            let upbitHtml = `
                <div class="row portfolio-grid">
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="card border-0 bg-primary bg-opacity-10 h-100 bot-card">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center p-3">
                                <div>
                                    <h6 class="card-title fw-bold text-white mb-0">
                                        <i class="fas fa-coins me-2"></i>Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ
                                    </h6>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-light" onclick="refreshUpbitStatus()" title="ÏÉàÎ°úÍ≥†Ïπ®">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="mt-3">
                                    <div class="row text-center">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üí∞ Ï¥àÍ∏∞ ÏûêÎ≥∏</small>
                                            <div class="fw-bold">${formatNumber(upbitData.initial_capital || 0)}Ïõê</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üí∞ ÌòÑÏû¨ ÏûêÎ≥∏</small>
                                            <div class="fw-bold">${formatNumber(upbitData.current_capital || 0)}Ïõê</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üí∞ Ï¥ù Ìà¨ÏûêÍ∏àÏï°</small>
                                            <div class="fw-bold">${formatNumber(totalInvested)}Ïõê</div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üí∞ Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°</small>
                                            <div class="fw-bold">${formatNumber(totalCurrentValue)}Ïõê</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üí∞ Ï¥ù ÏàòÏùµÍ∏à</small>
                                            <div class="fw-bold text-${profitColor}">
                                                <i class="fas ${profitIcon} me-1"></i>
                                                ${formatNumber(totalProfitLoss)}Ïõê
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üìà ÏàòÏùµÎ•†</small>
                                            <div class="fw-bold text-${profitColor}">
                                                ${totalProfitRate.toFixed(2)}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üìÖ Ìà¨Ïûê ÏãúÏûëÏùº</small>
                                            <div class="fw-bold">${upbitData.additional_info?.investment_start_date || '-'}</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">‚è±Ô∏è Ìà¨Ïûê Í∏∞Í∞Ñ</small>
                                            <div class="fw-bold">${upbitData.additional_info?.investment_period_days || 0}Ïùº</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üîÑ ÎßàÏßÄÎßâ Î¶¨Î∞∏Îü∞Ïã±</small>
                                            <div class="fw-bold">${portfolioSummary.last_rebalance || '-'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="card border-0 bg-primary bg-opacity-10 h-100 bot-card">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center p-3">
                                <div>
                                    <h6 class="card-title fw-bold text-white mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>Í±∞Îûò ÌÜµÍ≥Ñ
                                    </h6>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="mt-3">
                                    <div class="row text-center">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üî¢ Ï¥ù Í±∞Îûò</small>
                                            <div class="fw-bold">${tradingHistory.total_trades || 0}Í±¥</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üèÜ ÏäπÎ•†</small>
                                            <div class="fw-bold text-success">${(tradingHistory.win_rate || 0).toFixed(1)}%</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üìà ÏµúÎåÄ ÏàòÏùµ</small>
                                            <div class="fw-bold text-success">${formatNumber(tradingHistory.largest_gain || 0)}Ïõê</div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üìâ ÏµúÎåÄ ÏÜêÏã§</small>
                                            <div class="fw-bold text-danger">${formatNumber(tradingHistory.largest_loss || 0)}Ïõê</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">‚öñÔ∏è ÌèâÍ∑† ÏàòÏùµ</small>
                                            <div class="fw-bold text-info">${formatNumber(tradingHistory.avg_profit_per_trade || 0)}Ïõê</div>
                                        </div>
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üïí ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏</small>
                                            <div class="fw-bold">${upbitData.last_updated || '-'}</div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-2">
                                        <div class="col-6 col-md-4 mb-2">
                                            <small class="text-muted">üìä Ï†ÑÎûµ</small>
                                            <div class="fw-bold">${upbitData.additional_info?.strategy || '-'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ÏΩîÏù∏Î≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
            if (Object.keys(coinDetails).length > 0) {
                upbitHtml += `
                    <div class="col-12 mb-3">
                        <div class="card border-0 bg-primary bg-opacity-10 h-100 bot-card">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center p-3">
                                <div>
                                    <h6 class="card-title fw-bold text-white mb-0">
                                        <i class="fas fa-coins me-2"></i>ÏΩîÏù∏Î≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                                    </h6>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 crypto-table">
                                        <thead class="table-primary bg-opacity-25">
                                            <tr>
                                                <th class="text-center">ÏΩîÏù∏</th>
                                                <th class="text-center">ÌòÑÏû¨Í∞Ä</th>
                                                <th class="text-center">Î≥¥Ïú†ÏàòÎüâ</th>
                                                <th class="text-center">ÌèâÍ∞ÄÍ∏àÏï°</th>
                                                <th class="text-center">ÌèâÍ∑†Îß§ÏàòÍ∞Ä</th>
                                                <th class="text-center">ÏÜêÏùµ</th>
                                                <th class="text-center">ÏàòÏùµÎ•†</th>
                                                <th class="text-center">MDD</th>
                                                <th class="text-center">ÏÉÅÌÉú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(coinDetails).map(([ticker, detail]) => {
                                                const profitColor = (detail.profit_rate || 0) >= 0 ? 'text-danger' : 'text-primary';
                                                const profitIcon = (detail.profit_rate || 0) >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                                                const mddColor = (detail.mdd || 0) <= -10 ? 'text-danger' : (detail.mdd || 0) <= -5 ? 'text-warning' : 'text-success';
                                                const statusColor = detail.status === 'Î≥¥Ïú†Ï§ë' ? 'text-success' : 'text-warning';
                                                
                                                return `
                                                    <tr>
                                                        <td><strong>${ticker}</strong></td>
                                                        <td class="text-end">${formatNumber(detail.current_price || 0)}Ïõê</td>
                                                        <td class="text-end">${detail.quantity || 0}</td>
                                                        <td class="text-end">${formatInteger(detail.total_value || 0)}Ïõê</td>
                                                        <td class="text-end">${formatInteger(detail.avg_buy_price || 0)}Ïõê</td>
                                                        <td class="text-end ${profitColor}">
                                                            <i class="fas ${profitIcon} me-1"></i>
                                                            ${formatInteger(detail.profit_loss || 0)}Ïõê
                                                        </td>
                                                        <td class="text-end ${profitColor}">
                                                            ${(detail.profit_rate || 0).toFixed(2)}%
                                                        </td>
                                                        <td class="text-end ${mddColor}">
                                                            ${(detail.mdd || 0).toFixed(2)}%
                                                        </td>
                                                        <td class="text-end">
                                                            <span class="badge bg-${detail.status === 'Î≥¥Ïú†Ï§ë' ? 'success' : 'warning'}">${detail.status || '-'}</span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = upbitHtml;
        }
        
        // Îπà ÏóÖÎπÑÌä∏ Î©îÏãúÏßÄ ÌëúÏãú
        function showEmptyUpbitMessage() {
            const container = document.getElementById('upbit-container');
            container.innerHTML = `
                <div class="row portfolio-grid">
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="card border-0 bg-primary bg-opacity-10 h-100 bot-card">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center p-3">
                                <div>
                                    <h6 class="card-title fw-bold text-white mb-0">
                                        <i class="fas fa-coins me-2"></i>Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ
                                    </h6>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-light" onclick="refreshUpbitStatus()" title="ÏÉàÎ°úÍ≥†Ïπ®">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                    <p class="mb-2">ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                                    <small class="text-muted">JSON ÌååÏùºÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÍ±∞ÎÇò ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.</small>
                                    <div class="mt-3">
                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshUpbitStatus()">
                                            <i class="fas fa-sync me-1"></i>Îã§Ïãú ÏãúÎèÑ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // async function startProcess(processName) { // processes-containerÍ∞Ä ÏÇ≠Ï†úÎêòÏñ¥ Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
        //     try {
        //         const response = await fetch(`/api/start/${processName}`);
        //         const result = await response.json();
        //         
        //         if (result.success) {
        //         showToast(result.message, 'success');
        //         } else {
        //         showToast(result.message, 'danger');
        //         }
        //         
        //         // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        //         setTimeout(refreshStatus, 1000);
        //         
        //         } catch (error) {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë Ïã§Ìå®: ' + error.message, 'danger');
        //         }
        //     }
        //     
        //     async function stopProcess(processName) { // processes-containerÍ∞Ä ÏÇ≠Ï†úÎêòÏñ¥ Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
        //     try {
        //         const response = await fetch(`/api/stop/${processName}`);
        //         const result = await response.json();
        //         
        //         if (result.success) {
        //         showToast(result.message, 'success');
        //         } else {
        //         showToast(result.message, 'danger');
        //         }
        //         
        //         // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        //         setTimeout(refreshStatus, 1000);
        //         
        //         } catch (error) {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ï§ëÏßÄ Ïã§Ìå®: ' + error.message, 'danger');
        //         }
        //     }
        //     
        //     async function restartProcess(processName) { // processes-containerÍ∞Ä ÏÇ≠Ï†úÎêòÏñ¥ Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
        //     try {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ïû¨ÏãúÏûë Ï§ë...', 'info');
        //         
        //         // Î®ºÏ†Ä Ï§ëÏßÄ
        //         const stopResponse = await fetch(`/api/stop/${processName}`);
        //         const result = await stopResponse.json();
        //         
        //         if (result.success) {
        //         // 2Ï¥à ÎåÄÍ∏∞ ÌõÑ ÏãúÏûë
        //         setTimeout(async () => {
        //             const startResponse = await fetch(`/api/start/${processName}`);
        //             const startResult = await startResponse.json();
        //             
        //             if (startResult.success) {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ïû¨ÏãúÏûë ÏôÑÎ£å', 'success');
        //         } else {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë Ïã§Ìå®: ' + startResult.message, 'danger');
        //         }
        //         
        //         // ÏÉÅÌÉú ÏÉàÎ°úÍ≥†Ïπ®
        //         setTimeout(refreshStatus, 1000);
        //         }, 2000);
        //         } else {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ï§ëÏßÄ Ïã§Ìå®: ' + stopResult.message, 'danger');
        //         }
        //         
        //         } catch (error) {
        //         showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ïû¨ÏãúÏûë Ïã§Ìå®: ' + error.message, 'danger');
        //         }
        //     }
        
        async function sendDailyReport() {
            try {
                const response = await fetch('/api/send_daily_report');
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏùºÏùº Î≥¥Í≥†ÏÑú Ï†ÑÏÜ° Ïã§Ìå®: ' + error.message, 'danger');
            }
        }
        
        async function sendMonthlyReport() {
            try {
                const response = await fetch('/api/send_monthly_report');
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏõîÍ∞Ñ Î≥¥Í≥†ÏÑú Ï†ÑÏÜ° Ïã§Ìå®: ' + error.message, 'danger');
            }
        }
        
        async function getPythonProcesses() {
            try {
                const response = await fetch('/api/python_processes');
                const result = await response.json();
                
                if (result.success) {
                    updatePythonProcessesList(result.processes);
                    showToast('Python ÌîÑÎ°úÏÑ∏Ïä§ Î™©Î°ùÏùÑ Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.', 'success');
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('Python ÌîÑÎ°úÏÑ∏Ïä§ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: ' + error.message, 'danger');
            }
        }
        
        function updatePythonProcessesList(processes) {
            const container = document.getElementById('python-processes-container');
            
            if (!processes || processes.length === 0) {
                container.innerHTML = '<p class="text-muted">Ïã§Ìñâ Ï§ëÏù∏ Python ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            let processesHtml = '';
            
            processes.forEach(process => {
                const scriptName = process.cmd ? process.cmd.split('/').pop() : 'Unknown';
                const memoryMB = parseFloat(process.memory).toFixed(1);
                const cpuPercent = parseFloat(process.cpu).toFixed(1);
                
                processesHtml += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 process-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-play-circle text-success me-2"></i>
                                    ${scriptName}
                                </h6>
                                <span class="badge bg-success">Ïã§Ìñâ Ï§ë</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">PID</small>
                                        <div class="fw-bold">${process.pid}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">ÌîÑÎ°úÏÑ∏Ïä§Î™Ö</small>
                                        <div class="fw-bold">${process.name}</div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <small class="text-muted">Î©îÎ™®Î¶¨</small>
                                        <div class="fw-bold text-info">${memoryMB} MB</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">CPU</small>
                                        <div class="fw-bold text-warning">${cpuPercent}%</div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Ïã§Ìñâ Ïä§ÌÅ¨Î¶ΩÌä∏</small>
                                        <div class="fw-bold text-break">${process.cmd || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-danger w-100" onclick="killPid(${process.pid})">
                                    <i class="fas fa-times me-1"></i> ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = processesHtml;
        }

        async function killPid(pid) {
            if (!confirm(`PID ${pid} ÌîÑÎ°úÏÑ∏Ïä§Î•º Ï¢ÖÎ£åÌï†ÍπåÏöî?`)) return;
            try {
                const res = await fetch(`/api/kill/${pid}`, { method: 'POST' });
                const json = await res.json();
                if (json.success) {
                    showToast(json.message, 'success');
                    // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    setTimeout(() => { getPythonProcesses(); refreshStatus(); }, 500);
                } else {
                    showToast(json.message, 'danger');
                }
            } catch (e) {
                showToast('ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å Ïã§Ìå®: ' + e.message, 'danger');
            }
        }
        
        async function loadTradeLogs() {
            try {
                const response = await fetch('/api/trade_logs');
                const result = await response.json();
                
                if (result.success) {
                    updateTradeLogsList(result.logs);
                    showToast(`Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏ ${result.total_count}Í±¥ÏùÑ Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.`, 'success');
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: ' + error.message, 'danger');
            }
        }
        
        function updateTradeLogsList(logs) {
            const container = document.getElementById('trade-logs-container');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<p class="text-muted">Îß§Ïàò/Îß§ÎèÑ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            let logsHtml = '<div class="table-responsive"><table class="table table-striped table-hover">';
            logsHtml += '<thead class="table-dark"><tr><th>ÎÇ†Ïßú</th><th>ÏãúÍ∞Ñ</th><th>Íµ¨Î∂Ñ</th><th>Ï¢ÖÎ™©Î™Ö</th><th>Ï¢ÖÎ™©ÏΩîÎìú</th><th>ÎùºÏö¥Îìú</th><th>Í∞ÄÍ≤©Ï†ïÎ≥¥</th><th>ÏàòÏùµÎ•†</th><th>Î°úÍ∑∏ÌååÏùº</th></tr></thead><tbody>';
            
            logs.forEach(log => {
                let priceInfo = '';
                let profitRate = '';
                
                if (log.action === 'Îß§Ïàò') {
                    priceInfo = `Îß§ÏàòÍ∏àÏï°: ${log.amount.toLocaleString()}Ïõê<br>ÎèåÌååÍ∞ÄÍ≤©: ${log.break_price.toLocaleString()}Ïõê<br>ÏãúÍ∞Ä: ${log.open_price.toLocaleString()}Ïõê`;
                } else if (log.action === 'Îß§ÎèÑ') {
                    priceInfo = `Îß§ÏàòÍ∞Ä: ${log.buy_price.toLocaleString()}Ïõê<br>Îß§ÏàòÍ∏à: ${log.buy_amount.toLocaleString()}Ïõê<br>Îß§ÎèÑÍ∞Ä: ${log.sell_price.toLocaleString()}Ïõê<br>ÌöåÏàòÍ∏à: ${log.return_amount.toLocaleString()}Ïõê`;
                    profitRate = `${log.profit_rate > 0 ? '+' : ''}${log.profit_rate.toFixed(2)}%`;
                }
                
                const actionBadge = log.action === 'Îß§Ïàò' ? 'bg-primary' : 'bg-success';
                const profitBadge = log.profit_rate > 0 ? 'bg-success' : log.profit_rate < 0 ? 'bg-danger' : 'bg-secondary';
                
                logsHtml += `
                    <tr>
                        <td><strong>${log.date}</strong></td>
                        <td>${log.timestamp.split(' ')[1]}</td>
                        <td><span class="badge ${actionBadge}">${log.action}</span></td>
                        <td>${log.stock_name}</td>
                        <td><code>${log.stock_code}</code></td>
                        <td>${log.round}</td>
                        <td>${priceInfo}</td>
                        <td>${log.action === 'Îß§ÎèÑ' ? `<span class="badge ${profitBadge}">${profitRate}</span>` : '-'}</td>
                        <td><small class="text-muted">${log.log_file}</small></td>
                    </tr>
                `;
            });
            
            logsHtml += '</tbody></table></div>';
            container.innerHTML = logsHtml;
        }

        // -------------------------
        // Bot Î°úÍ∑∏ Î≥¥Í∏∞
        // -------------------------
        let botLogModalInstance = null;
        function ensureBotLogModal() {
            if (document.getElementById('botLogModal')) return;
            const modalHtml = `
            <div class="modal fade" id="botLogModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="botLogModalTitle">Î¥á Î°úÍ∑∏</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <select id="botLogLines" class="form-select form-select-sm" style="width:auto; display:inline-block;">
                          <option value="200">ÏµúÍ∑º 200Ï§Ñ</option>
                          <option value="500" selected>ÏµúÍ∑º 500Ï§Ñ</option>
                          <option value="1000">ÏµúÍ∑º 1000Ï§Ñ</option>
                          <option value="2000">ÏµúÍ∑º 2000Ï§Ñ</option>
                        </select>
                        <button id="botLogReload" class="btn btn-sm btn-outline-secondary ms-2"><i class="fas fa-sync"></i> ÏÉàÎ°úÍ≥†Ïπ®</button>
                      </div>
                    </div>
                    <pre id="botLogContent" style="white-space: pre-wrap; word-break: break-word; background:#111; color:#eee; padding:12px; border-radius:8px; height:60vh; overflow:auto;"></pre>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                  </div>
                </div>
              </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modalEl = document.getElementById('botLogModal');
            botLogModalInstance = new bootstrap.Modal(modalEl);
        }

        async function openBotLogModal(botName) {
            ensureBotLogModal();
            const title = document.getElementById('botLogModalTitle');
            const contentEl = document.getElementById('botLogContent');
            const linesSel = document.getElementById('botLogLines');
            const reloadBtn = document.getElementById('botLogReload');

            title.textContent = `${botName} Î°úÍ∑∏`;
            contentEl.textContent = 'Î∂àÎü¨Ïò§Îäî Ï§ë...';

            async function loadLog() {
                const lines = linesSel.value || '500';
                try {
                    const res = await fetch(`/api/bot_log/${encodeURIComponent(botName)}?lines=${lines}`);
                    const json = await res.json();
                    if (json.success) {
                        contentEl.textContent = json.log || '(Î°úÍ∑∏Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§)';
                    } else {
                        contentEl.textContent = json.message || 'Î°úÍ∑∏Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§';
                    }
                } catch (e) {
                    contentEl.textContent = 'Î°úÍ∑∏ Î°úÎìú Ïã§Ìå®: ' + e.message;
                }
            }

            linesSel.onchange = loadLog;
            reloadBtn.onclick = loadLog;
            await loadLog();
            botLogModalInstance.show();
        }
        

        
        function generateStockListHtml(stockList) {
            if (!stockList || stockList.length === 0) {
                return '<p class="text-muted">Îì±Î°ùÎêú Ï¢ÖÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
            }
            
            let html = '<div class="list-group">';
            stockList.forEach((stock, index) => {
                const stockCode = Object.keys(stock)[0];
                const stockName = stock[stockCode];
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${stockCode}</strong>
                            <small class="text-muted ms-2">${stockName}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeStock('${stockCode}', ${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }
        
        function addMyStock() {
            const stockCode = document.getElementById('newMyStockCode').value.trim();
            if (!stockCode) {
                alert('Ï¢ÖÎ™© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (stockCode.length !== 6) {
                alert('Ï¢ÖÎ™© ÏΩîÎìúÎäî 6ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            const stockList = getCurrentStockList('myStockList');
            const newStock = { [stockCode]: `Ï¢ÖÎ™©${stockCode}` };
            stockList.push(newStock);
            
            updateStockList('myStockList', stockList);
            document.getElementById('newMyStockCode').value = '';
        }
        
        function addExcludeStock() {
            const stockCode = document.getElementById('newExcludeStockCode').value.trim();
            if (!stockCode) {
                alert('Ï¢ÖÎ™© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (stockCode.length !== 6) {
                alert('Ï¢ÖÎ™© ÏΩîÎìúÎäî 6ÏûêÎ¶¨Ïó¨Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            const stockList = getCurrentStockList('exclude_stock_list');
            const newStock = { [stockCode]: `Ï¢ÖÎ™©${stockCode}` };
            stockList.push(newStock);
            
            updateStockList('exclude_stock_list', stockList);
            document.getElementById('newExcludeStockCode').value = '';
        }
        
        function removeStock(stockCode, index) {
            // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Î™®Îã¨ÏóêÏÑú Ï¢ÖÎ™© Î™©Î°ù Ï∞æÍ∏∞
            const myStockList = getCurrentStockList('myStockList');
            const excludeStockList = getCurrentStockList('exclude_stock_list');
            
            // myStockListÏóêÏÑú Ï†úÍ±∞
            const myIndex = myStockList.findIndex(stock => Object.keys(stock)[0] === stockCode);
            if (myIndex !== -1) {
                myStockList.splice(myIndex, 1);
                updateStockList('myStockList', myStockList);
                return;
            }
            
            // excludeStockListÏóêÏÑú Ï†úÍ±∞
            const excludeIndex = excludeStockList.findIndex(stock => Object.keys(stock)[0] === stockCode);
            if (excludeIndex !== -1) {
                excludeStockList.splice(excludeIndex, 1);
                updateStockList('exclude_stock_list', excludeStockList);
                return;
            }
        }
        
        function getCurrentStockList(listId) {
            const container = document.getElementById(listId);
            if (!container) return [];
            
            const stockItems = container.querySelectorAll('.list-group-item');
            const stockList = [];
            
            stockItems.forEach(item => {
                const stockCode = item.querySelector('strong').textContent;
                const stockName = item.textContent.split(' - ')[1] || `Ï¢ÖÎ™©${stockCode}`;
                stockList.push({ [stockCode]: stockName });
            });
            
            return stockList;
        }
        
        function updateStockList(listId, stockList) {
            const container = document.getElementById(listId);
            if (container) {
                container.innerHTML = generateStockListHtml(stockList);
            }
        }

        function showCreateTaskModal() {
            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('createTaskForm').reset();
            document.getElementById('scheduleTime').value = '09:00';
            document.getElementById('scheduleType').value = 'daily';
            document.getElementById('scriptPath').value = '';
            
            // Python Ïã§Ìñâ ÌååÏùº Í≤ΩÎ°ú ÎèôÏ†Å Í∞êÏßÄ
            fetch('/api/python_executable')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('executablePath').value = data.python_path;
                    } else {
                        // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                        document.getElementById('executablePath').value = 'C:/Users/kook-minipc/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0/python.exe';
                        console.warn('Python Í≤ΩÎ°ú ÏûêÎèô Í∞êÏßÄ Ïã§Ìå®:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Python Í≤ΩÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                    // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                    document.getElementById('executablePath').value = 'C:/Users/kook-minipc/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0/python.exe';
                });
            
            // Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
            toggleScheduleConfig();
            
            // Î™®Îã¨ ÌëúÏãú
            const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
            modal.show();
        }

        function toggleScheduleConfig() {
            const scheduleType = document.getElementById('scheduleType').value;
            const configContainer = document.getElementById('scheduleConfigContainer');
            const configContent = document.getElementById('scheduleConfigContent');
            
            if (scheduleType === 'daily') {
                configContainer.style.display = 'none';
            } else {
                configContainer.style.display = 'block';
                
                let html = '';
                if (scheduleType === 'weekly') {
                    html = `
                        <label for="weekday" class="form-label">ÏöîÏùº</label>
                        <select class="form-control" id="weekday">
                            <option value="1">ÏùºÏöîÏùº</option>
                            <option value="2">ÏõîÏöîÏùº</option>
                            <option value="3">ÌôîÏöîÏùº</option>
                            <option value="4">ÏàòÏöîÏùº</option>
                            <option value="5">Î™©ÏöîÏùº</option>
                            <option value="6">Í∏àÏöîÏùº</option>
                            <option value="7">ÌÜ†ÏöîÏùº</option>
                        </select>
                    `;
                } else if (scheduleType === 'monthly') {
                    html = `
                        <label for="day" class="form-label">Ïùº</label>
                        <select class="form-control" id="day">
                            ${Array.from({length: 31}, (_, i) => i + 1).map(day => `<option value="${day}">${day}Ïùº</option>`).join('')}
                        </select>
                    `;
                } else if (scheduleType === 'yearly') {
                    html = `
                        <label for="yearlyMonth" class="form-label">Ïõî</label>
                        <select class="form-control" id="yearlyMonth">
                            ${Array.from({length: 12}, (_, i) => i + 1).map(month => `<option value="${month}">${month}Ïõî</option>`).join('')}
                        </select>
                        <label for="yearlyDay" class="form-label mt-2">Ïùº</label>
                        <select class="form-control" id="yearlyDay">
                            ${Array.from({length: 31}, (_, i) => i + 1).map(day => `<option value="${day}">${day}Ïùº</option>`).join('')}
                        </select>
                    `;
                } else if (scheduleType === 'cron') {
                    html = `
                        <label for="cronExpression" class="form-label">ÌÅ¨Î°† ÌëúÌòÑÏãù</label>
                        <input type="text" class="form-control" id="cronExpression" placeholder="0 9 * * *" value="0 9 * * *">
                        <small class="form-text text-muted">ÌòïÏãù: Î∂Ñ Ïãú Ïùº Ïõî ÏöîÏùº (Ïòà: 0 9 * * * = Îß§Ïùº Ïò§Ï†Ñ 9Ïãú)</small>
                    `;
                }
                configContent.innerHTML = html;
            }
        }

        function toggleEditScheduleConfig() {
            const scheduleType = document.getElementById('editScheduleType').value;
            const configContainer = document.getElementById('editScheduleConfigContainer');
            const configContent = document.getElementById('editScheduleConfigContent');
            
            if (scheduleType === 'daily') {
                configContainer.style.display = 'none';
            } else {
                configContainer.style.display = 'block';
                
                let html = '';
                if (scheduleType === 'weekly') {
                    html = `
                        <label for="editWeekday" class="form-label">ÏöîÏùº</label>
                        <select class="form-control" id="editWeekday">
                            <option value="1">ÏùºÏöîÏùº</option>
                            <option value="2">ÏõîÏöîÏùº</option>
                            <option value="3">ÌôîÏöîÏùº</option>
                            <option value="4">ÏàòÏöîÏùº</option>
                            <option value="5">Î™©ÏöîÏùº</option>
                            <option value="6">Í∏àÏöîÏùº</option>
                            <option value="7">ÌÜ†ÏöîÏùº</option>
                        </select>
                    `;
                } else if (scheduleType === 'monthly') {
                    html = `
                        <label for="editDay" class="form-label">Ïùº</label>
                        <select class="form-control" id="editDay">
                            ${Array.from({length: 31}, (_, i) => i + 1).map(day => `<option value="${day}">${day}Ïùº</option>`).join('')}
                        </select>
                    `;
                } else if (scheduleType === 'yearly') {
                    html = `
                        <label for="editYearlyMonth" class="form-label">Ïõî</label>
                        <select class="form-control" id="editYearlyMonth">
                            ${Array.from({length: 12}, (_, i) => i + 1).map(month => `<option value="${month}">${month}Ïõî</option>`).join('')}
                        </select>
                        <label for="editYearlyDay" class="form-label mt-2">Ïùº</label>
                        <select class="form-control" id="editYearlyDay">
                            ${Array.from({length: 31}, (_, i) => i + 1).map(day => `<option value="${day}">${day}Ïùº</option>`).join('')}
                        </select>
                    `;
                } else if (scheduleType === 'cron') {
                    html = `
                        <label for="editCronExpression" class="form-label">ÌÅ¨Î°† ÌëúÌòÑÏãù</label>
                        <input type="text" class="form-control" id="editCronExpression" placeholder="0 9 * * *" value="0 9 * * *">
                        <small class="form-text text-muted">ÌòïÏãù: Î∂Ñ Ïãú Ïùº Ïõî ÏöîÏùº (Ïòà: 0 9 * * * = Îß§Ïùº Ïò§Ï†Ñ 9Ïãú)</small>
                    `;
                }
                configContent.innerHTML = html;
            }
        }



        async function editWindowsTask(taskName) {
            try {
                const response = await fetch(`/api/windows_tasks/${encodeURIComponent(taskName)}`);
                const result = await response.json();
                
                if (result.success) {
                    const task = result.task;
                    
                    // ÏàòÏ†ï ÌèºÏóê Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
                    document.getElementById('editTaskName').value = taskName;
                    document.getElementById('editScheduleType').value = task.schedule_type || 'daily';
                    
                    // Í∏∞Ï°¥ Ïä§ÏºÄÏ§Ñ ÏãúÍ∞Ñ ÏÑ§Ï†ï (schedule_configÏóêÏÑú Ï∂îÏ∂ú)
                    let scheduleTime = '09:00'; // Í∏∞Î≥∏Í∞í
                    if (task.schedule_config) {
                        if (task.schedule_config.schedule_time) {
                            scheduleTime = task.schedule_config.schedule_time;
                        } else if (task.schedule_config.time) {
                            // ISO ÌòïÏãùÏóêÏÑú ÏãúÍ∞ÑÎßå Ï∂îÏ∂ú (Ïòà: "2025-08-07T14:30:00" -> "14:30")
                            const timeMatch = task.schedule_config.time.match(/T(\d{2}:\d{2})/);
                            if (timeMatch) {
                                scheduleTime = timeMatch[1];
                            }
                        }
                    }
                    document.getElementById('editScheduleTime').value = scheduleTime;
                    
                    document.getElementById('editScriptPath').value = task.script_path || '';
                    document.getElementById('editTaskDescription').value = task.description || '';
                    
                    // Python Ïã§Ìñâ ÌååÏùº Í≤ΩÎ°ú ÏÑ§Ï†ï (Í∏∞Ï°¥ Í∞íÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÎèôÏ†Å Í∞êÏßÄ)
                    if (task.executable_path) {
                        document.getElementById('editExecutablePath').value = task.executable_path;
                    } else {
                        // Python Ïã§Ìñâ ÌååÏùº Í≤ΩÎ°ú ÎèôÏ†Å Í∞êÏßÄ
                        fetch('/api/python_executable')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    document.getElementById('editExecutablePath').value = data.python_path;
                                } else {
                                    // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                                    document.getElementById('editExecutablePath').value = 'C:/Users/kook-minipc/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0/python.exe';
                                    console.warn('Python Í≤ΩÎ°ú ÏûêÎèô Í∞êÏßÄ Ïã§Ìå®:', data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Python Í≤ΩÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                                // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                                document.getElementById('editExecutablePath').value = 'C:/Users/kook-minipc/AppData/Local/Microsoft/WindowsApps/PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0/python.exe';
                            });
                    }
                    
                    // Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
                    toggleEditScheduleConfig();
                    
                    // Í∏∞Ï°¥ ÏÑ§Ï†ïÍ∞í Î≥µÏõê
                    if (task.schedule_config) {
                        setTimeout(() => {
                            if (task.schedule_type === 'weekly' && task.schedule_config.weekday) {
                                const weekdaySelect = document.getElementById('editWeekday');
                                if (weekdaySelect) weekdaySelect.value = task.schedule_config.weekday;
                            } else if (task.schedule_type === 'monthly' && task.schedule_config.day) {
                                const daySelect = document.getElementById('editDay');
                                if (daySelect) daySelect.value = task.schedule_config.day;
                            } else if (task.schedule_type === 'yearly') {
                                if (task.schedule_config.month) {
                                    const monthSelect = document.getElementById('editYearlyMonth');
                                    if (monthSelect) monthSelect.value = task.schedule_config.month;
                                }
                                if (task.schedule_config.day) {
                                    const daySelect = document.getElementById('editYearlyDay');
                                    if (daySelect) daySelect.value = task.schedule_config.day;
                                }
                            } else if (task.schedule_type === 'cron' && task.schedule_config.cron_expression) {
                                const cronInput = document.getElementById('editCronExpression');
                                if (cronInput) cronInput.value = task.schedule_config.cron_expression;
                            }
                        }, 100);
                    }
                    
                    // Î™®Îã¨ ÌëúÏãú
                    const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                    modal.show();
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏûëÏóÖ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®: ' + error.message, 'danger');
            }
        }

        async function updateWindowsTask() {
            const taskName = document.getElementById('editTaskName').value;
            const scheduleType = document.getElementById('editScheduleType').value;
            const scheduleTime = document.getElementById('editScheduleTime').value;
            const executablePath = document.getElementById('editExecutablePath').value.trim();
            const scriptPath = document.getElementById('editScriptPath').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();

            if (!scheduleTime || !executablePath || !scriptPath) {
                showToast('Î™®Îì† ÌïÑÏàò ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            // ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
            let requestData = {
                executable_path: executablePath,
                script_path: scriptPath,
                schedule_type: scheduleType,
                description: description
            };
            
            // Ïä§ÏºÄÏ§Ñ ÌÉÄÏûÖÏóê Îî∞Î•∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            if (scheduleType === 'daily') {
                requestData.schedule_time = scheduleTime;
            } else if (scheduleType === 'weekly') {
                const weekday = document.getElementById('editWeekday')?.value || 1;
                requestData.schedule_time = scheduleTime;
                requestData.weekday = parseInt(weekday);
            } else if (scheduleType === 'monthly') {
                const day = document.getElementById('editDay')?.value || 1;
                requestData.schedule_time = scheduleTime;
                requestData.day = parseInt(day);
            } else if (scheduleType === 'yearly') {
                const month = document.getElementById('editYearlyMonth')?.value || 1;
                const day = document.getElementById('editYearlyDay')?.value || 1;
                requestData.schedule_time = scheduleTime;
                requestData.month = parseInt(month);
                requestData.day = parseInt(day);
            } else if (scheduleType === 'cron') {
                const cronExpression = document.getElementById('editCronExpression')?.value || '0 9 * * *';
                requestData.cron_expression = cronExpression;
            }

            try {
                const response = await fetch(`/api/windows_tasks/${encodeURIComponent(taskName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                    loadWindowsTasks(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏûëÏóÖ ÏàòÏ†ï Ïã§Ìå®: ' + error.message, 'danger');
            }
        }

        async function deleteWindowsTask(taskName) {
            if (!confirm(`‚ö†Ô∏è Ïä§ÏºÄÏ§ÑÎü¨ ÏûëÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏûëÏóÖÎ™Ö: "${taskName}"\n\nÏÇ≠Ï†úÌïòÎ©¥ Îã§ÏùåÏù¥ Ï†úÍ±∞Îê©ÎãàÎã§:\n‚Ä¢ Windows Ïä§ÏºÄÏ§ÑÎü¨ÏóêÏÑú ÏûëÏóÖ ÏÇ≠Ï†ú\n‚Ä¢ ÏÇ¨Ïö©Ïûê ÏûëÏóÖ Î™©Î°ùÏóêÏÑú Ï†úÍ±∞\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/windows_tasks/${encodeURIComponent(taskName)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    loadWindowsTasks(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏûëÏóÖ ÏÇ≠Ï†ú Ïã§Ìå®: ' + error.message, 'danger');
            }
        }

        async function runWindowsTask(taskName) {
            try {
                const response = await fetch(`/api/windows_tasks/${encodeURIComponent(taskName)}/run`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏûëÏóÖ Ïã§Ìñâ Ïã§Ìå®: ' + error.message, 'danger');
            }
        }

        async function toggleWindowsTask(taskName, enabled) {
            try {
                const response = await fetch(`/api/windows_tasks/${encodeURIComponent(taskName)}/enable`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        enabled: enabled
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    loadWindowsTasks(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                } else {
                    showToast(result.message, 'danger');
                }
                
            } catch (error) {
                showToast('ÏûëÏóÖ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®: ' + error.message, 'danger');
            }
        }
        

        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ ÏÉÅÌÉú Î°úÎìú
        document.addEventListener('DOMContentLoaded', function() {
            // Ï¶âÏãú ÏÉÅÌÉú Í∞±Ïã†
            refreshStatus();
            
            // Python Í≤ΩÎ°ú Í∞êÏßÄ Î∞è placeholder ÏóÖÎç∞Ïù¥Ìä∏
            detectPythonPath();
            
            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
            //loadAvailableScripts();
            // ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÎπÑÌôúÏÑ±Ìôî (ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠)
            
            // ÏóÖÎπÑÌä∏ Ï†ïÎ≥¥ÎèÑ ÏûêÎèôÏúºÎ°ú Î°úÎìú
            setTimeout(() => {
                refreshUpbitStatus();
            }, 1000);
            
            // KOSPI Ï†ïÎ≥¥ÎèÑ ÏûêÎèôÏúºÎ°ú Î°úÎìú
            setTimeout(() => {
                refreshKospiInfo();
            }, 1500);
        });
        
        // KOSPI Ï†ïÎ≥¥ ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshKospiInfo() {
            try {
                const response = await fetch('/api/kospi_check');
                const data = await response.json();
                
                if (data.success) {
                    updateKospiInfo(data.kospi_data);
                } else {
                    console.log('KOSPI Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', data.message);
                    showEmptyKospiMessage();
                }
            } catch (error) {
                console.error('KOSPI Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
                showEmptyKospiMessage();
            }
        }
        
        // KOSPI Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateKospiInfo(kospiData) {
            if (!kospiData) {
                showEmptyKospiMessage();
                return;
            }
            
            console.log('KOSPI Îç∞Ïù¥ÌÑ∞:', kospiData);
            
            // ÌòÑÏû¨ KOSPI ÏßÄÏàò
            const currentKospi = document.getElementById('current-kospi');
            if (currentKospi) {
                currentKospi.textContent = kospiData.current_kospi?.toFixed(2) || '-';
            }
            
            // Î≥ÄÎèôÎ•†
            const kospiChange = document.getElementById('kospi-change');
            if (kospiChange) {
                const changePercent = kospiData.change_percentage || 0;
                const changeColor = changePercent >= 0 ? 'text-danger' : 'text-primary';
                const changeIcon = changePercent >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const sign = changePercent >= 0 ? '+' : '';
                
                kospiChange.className = `fw-bold ${changeColor}`;
                kospiChange.innerHTML = `<i class="fas ${changeIcon} me-1"></i>${sign}${changePercent.toFixed(2)}%`;
            }
            
            // ÏµúÍ≥†Ï†ê
            const maxKospi = document.getElementById('max-kospi');
            if (maxKospi) {
                maxKospi.textContent = kospiData.max_kospi?.toFixed(2) || '-';
            }
            
            // ÏµúÍ≥†Ï†ê ÎÇ†Ïßú
            const maxDate = document.getElementById('max-date');
            if (maxDate) {
                maxDate.textContent = kospiData.max_date || '-';
            }
            
            // Î∂ÑÏÑù ÏÉÅÌÉú
            const kospiStatus = document.getElementById('kospi-status');
            if (kospiStatus) {
                const status = kospiData.analysis_summary?.status || 'Ïïå Ïàò ÏóÜÏùå';
                const level = kospiData.analysis_summary?.level || 'Ïïå Ïàò ÏóÜÏùå';
                
                let badgeClass = 'bg-secondary';
                if (status === 'ÏÉÅÏäπ') {
                    badgeClass = 'bg-success';
                } else if (status === 'ÌïòÎùΩ') {
                    badgeClass = 'bg-danger';
                } else if (status === 'Ìö°Î≥¥') {
                    badgeClass = 'bg-warning';
                }
                
                kospiStatus.className = `badge ${badgeClass}`;
                kospiStatus.textContent = `${status} (${level})`;
            }
            
            // ÎßàÏßÄÎßâ Î∂ÑÏÑù ÏãúÍ∞Ñ ÌëúÏãú
            const lastAnalysis = document.getElementById('last-analysis-time');
            if (lastAnalysis && kospiData.last_analysis_date && kospiData.last_analysis_time) {
                lastAnalysis.textContent = `${kospiData.last_analysis_date} ${kospiData.last_analysis_time}`;
            }
        }
        
        // Îπà KOSPI Î©îÏãúÏßÄ ÌëúÏãú
        function showEmptyKospiMessage() {
            const currentKospi = document.getElementById('current-kospi');
            const kospiChange = document.getElementById('kospi-change');
            const maxKospi = document.getElementById('max-kospi');
            const maxDate = document.getElementById('max-date');
            const kospiStatus = document.getElementById('kospi-status');
            
            if (currentKospi) currentKospi.textContent = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            if (kospiChange) {
                kospiChange.className = 'fw-bold text-muted';
                kospiChange.innerHTML = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            }
            if (maxKospi) maxKospi.textContent = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            if (maxDate) maxDate.textContent = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            if (kospiStatus) {
                kospiStatus.className = 'badge bg-secondary';
                kospiStatus.textContent = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            }
        }
        
        // Python Í≤ΩÎ°ú Í∞êÏßÄ Ìï®Ïàò
        function detectPythonPath() {
            fetch('/api/python_executable')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // placeholder ÏóÖÎç∞Ïù¥Ìä∏
                        const executablePathInput = document.getElementById('executablePath');
                        const editExecutablePathInput = document.getElementById('editExecutablePath');
                        
                        if (executablePathInput) {
                            executablePathInput.placeholder = `Í∞êÏßÄÎêú Python Í≤ΩÎ°ú: ${data.python_path}`;
                        }
                        if (editExecutablePathInput) {
                            editExecutablePathInput.placeholder = `Í∞êÏßÄÎêú Python Í≤ΩÎ°ú: ${data.python_path}`;
                        }
                        
                        console.log('Python Í≤ΩÎ°ú Í∞êÏßÄ ÏôÑÎ£å:', data.python_path);
                    } else {
                        console.warn('Python Í≤ΩÎ°ú Í∞êÏßÄ Ïã§Ìå®:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Python Í≤ΩÎ°ú Í∞êÏßÄ Ï§ë Ïò§Î•ò:', error);
                });
        }
    </script>
    
    <!-- Î¥á ÏÑ§Ï†ï Î™®Îã¨ -->
    <div class="modal fade" id="botSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="botSettingsModalLabel">Î¥á ÏÑ§Ï†ï</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="botSettingsModalBody">
                    <!-- Î¥áÎ≥Ñ ÏÑ§Ï†ï ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê Î°úÎìúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>
    </div>




</body>
</html> 