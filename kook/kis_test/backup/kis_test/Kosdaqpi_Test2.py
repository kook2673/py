'''

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
ì½”ë“œ ì°¸ê³  ì˜ìƒ!
https://youtu.be/YdEdM-oC0kc
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

ë°±í…ŒìŠ¤íŒ…ì€ ë‚´PCì—ì„œ í•´ì•¼ ì„œë²„ ìì›ì„ ì•„ë¼ê³  íˆ¬ì ì„±ê³¼ ê·¸ë˜í”„ë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì‹œê³  ë‹¤ì–‘í•œ ê¸°ê°„ìœ¼ë¡œ ë°±í…ŒìŠ¤íŒ… í•´ë³´ì„¸ìš”!!!
https://blog.naver.com/zacra/223180500307

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$




$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
 
í•´ë‹¹ ì»¨í…ì¸ ëŠ” ì œê°€ ì§ì ‘ íˆ¬ì í•˜ê¸° ìœ„í•´ ì´ ì „ëµì„ ì¶”ê°€ ê°œì„ í•´ì„œ ë” ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°œì¸ ì „ëµì´ ì¡´ì¬í•©ë‹ˆë‹¤. 

ê²Œë§Œì•„ ì¶”ê°€ ê°œì„  ê°œì¸ ì „ëµë“¤..
https://blog.naver.com/zacra/223196497504

ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ ìœ„ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì„¸ìš”!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



ê´€ë ¨ í¬ìŠ¤íŒ…


ì½”ìŠ¤ë‹¥ ì½”ìŠ¤í”¼ ì–‘ë°©í–¥ìœ¼ë¡œ íˆ¬ìí•˜ëŠ” ì „ëµ! ì´ˆì „ë„ì²´ LK99ì— ë²„ê¸ˆê°€ëŠ” ë°œê²¬!!
https://blog.naver.com/zacra/223177598281

ìœ„ í¬ìŠ¤íŒ…ì„ ê¼­ ì°¸ê³ í•˜ì„¸ìš”!!!

ğŸ“Œ ê²Œë§Œì•„ì˜ ëª¨ë“  ì½”ë“œëŠ” íŠ¹ì • ì¢…ëª© ì¶”ì²œì´ë‚˜ íˆ¬ì ê¶Œìœ ë¥¼ ìœ„í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.  
ì œê³µëœ ì „ëµì€ í•™ìŠµ ë° í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ êµ¬ì„±ëœ ì˜ˆì‹œ ì½”ë“œì´ë©°
ì‹¤ì œ íˆ¬ì íŒë‹¨ ë° ì‹¤í–‰ì€ ì „ì ìœ¼ë¡œ ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
   

ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!
   

  
'''

# =============================================================================
# ì½”ìŠ¤í”¼/ì½”ìŠ¤ë‹¥ ì–‘ë°©í–¥ íˆ¬ì ì „ëµ ë°±í…ŒìŠ¤íŒ… í”„ë¡œê·¸ë¨
# =============================================================================
# 
# ì „ëµ ê°œìš”:
# - ì½”ìŠ¤í”¼ ìŒ: KODEX ë ˆë²„ë¦¬ì§€(122630) + KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X(252670)
# - ì½”ìŠ¤ë‹¥ ìŒ: KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€(233740) + KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤(251340)
# - ìµœëŒ€ 2ê°œ ì¢…ëª© ë™ì‹œ ë³´ìœ , ì‹œì¥ ìƒí™©ì— ë”°ë¥¸ ë™ì  ë¹„ì¤‘ ì¡°ì ˆ
# - ìƒìŠ¹/í•˜ë½ ëª¨ë‘ì—ì„œ ìˆ˜ìµ ì¶”êµ¬í•˜ëŠ” ì–‘ë°©í–¥ íˆ¬ì ì „ëµ
#
# ì£¼ìš” íŠ¹ì§•:
# 1. ì½”ìŠ¤í”¼ ì¢…ëª©: ê¸°ìˆ ì  ì§€í‘œ ê¸°ë°˜ ë§¤ë§¤
# 2. ì½”ìŠ¤ë‹¥ ì¢…ëª©: ë³€ë™ì„± ëŒíŒŒ ì „ëµ
# 3. ëª¨ë©˜í…€ ê¸°ë°˜ ë¹„ì¤‘ ì¡°ì ˆ
# 4. íš¡ë³´ì¥ ëŒ€ì‘ ë¡œì§
# =============================================================================

# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
import KIS_Common as Common          # KIS API ê³µí†µ ëª¨ë“ˆ
import KIS_API_Helper_KR as KisKR    # KIS í•œêµ­ API í—¬í¼
import pandas as pd                   # ë°ì´í„° ì²˜ë¦¬
import pprint                         # ë°ì´í„° ì¶œë ¥
import numpy as np                    # ìˆ˜ì¹˜ ê³„ì‚°
import matplotlib.pyplot as plt       # ì°¨íŠ¸ ìƒì„±
from datetime import datetime         # ë‚ ì§œ ì²˜ë¦¬
import os                             # íŒŒì¼ ì‹œìŠ¤í…œ
import logging                        # ë¡œê¹…

# =============================================================================
# ë¡œê¹… ì„¤ì •
# =============================================================================
# ë¡œê·¸ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ì„¤ì •
script_dir = os.path.dirname(os.path.abspath(__file__))  # í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬
log_dir = os.path.join(script_dir, "logs")              # ë¡œê·¸ ë””ë ‰í† ë¦¬
if not os.path.exists(log_dir):
    os.makedirs(log_dir)                                # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
log_filename = os.path.join(log_dir, "Kosdaqpi_Test2.log")  # ë¡œê·¸ íŒŒì¼ëª…

# ë¡œê¹… ì„¤ì • (íŒŒì¼ + ì½˜ì†” ì¶œë ¥)
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(log_filename, mode='w', encoding='utf-8'),  # íŒŒì¼ ì¶œë ¥
        logging.StreamHandler()                                          # ì½˜ì†” ì¶œë ¥
    ]
)

# =============================================================================
# ê³„ì¢Œ ì„¤ì •
# =============================================================================
#ê³„ì¢Œ ì„ íƒ.. "VIRTUAL" ëŠ” ëª¨ì˜ ê³„ì¢Œ!
Common.SetChangeMode("VIRTUAL") #REAL or VIRTUAL

# =============================================================================
# íˆ¬ì ì„¤ì •
# =============================================================================
##############################################################################
#íˆ¬ìí•  ì¢…ëª©!
#InvestStockList = [] #í…ŒìŠ¤íŠ¸í•  ì¢…ëª©ì„ ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ ì§ì ‘ íŒë‹¨í•˜ì—¬ ë„£ìœ¼ì„¸ìš”!
# 122630 : KODEX ë ˆë²„ë¦¬ì§€ (ì½”ìŠ¤í”¼ ìƒìŠ¹ ì¶”ì¢…)
# 252670 : KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X (ì½”ìŠ¤í”¼ í•˜ë½ ì¶”ì¢…)
# 233740 : KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€ (ì½”ìŠ¤ë‹¥ ìƒìŠ¹ ì¶”ì¢…)
# 251340 : KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤ (ì½”ìŠ¤ë‹¥ í•˜ë½ ì¶”ì¢…)
InvestStockList = ["122630","252670","233740","251340"]
##############################################################################

# =============================================================================
# íˆ¬ì íŒŒë¼ë¯¸í„° ì„¤ì •
# =============================================================================
#ì´ë ‡ê²Œ ì§ì ‘ ê¸ˆì•¡ì„ ì§€ì •
TotalMoney = 15000000  # ì´ íˆ¬ì ê¸ˆì•¡ (1,500ë§Œì›)

# ê¸°ì¡´ printë¥¼ logging.infoë¡œ ë³€ê²½ (í…ŒìŠ¤íŠ¸ ê¸ˆì•¡ ì¶œë ¥)
logging.info(f"í…ŒìŠ¤íŠ¸í•˜ëŠ” ì´ ê¸ˆì•¡: {format(round(TotalMoney), ',')}")

# ìˆ˜ìˆ˜ë£Œ ì„¤ì • (ë§¤ìˆ˜/ë§¤ë„ ì‹œ 0.15% ìˆ˜ìˆ˜ë£Œ + ì„¸ê¸ˆ + ìŠ¬ë¦¬í”¼ì§€)
fee = 0.0015 

#ì „ëµ ë°±í…ŒìŠ¤íŒ… ì‹œì‘ ë…„ë„ ì§€ì •!!!
StartYear = 2017  # 2017ë…„ë¶€í„° ë°±í…ŒìŠ¤íŒ… ì‹œì‘

# =============================================================================
# ì¢…ëª©ë³„ ì„±ê³¼ ì¶”ì ì„ ìœ„í•œ ë°ì´í„° êµ¬ì¡° ì´ˆê¸°í™”
# =============================================================================
StockDataList = list()

for stock_code in InvestStockList:
    stock_name = KisKR.GetStockName(stock_code)  # ì¢…ëª©ëª… ì¡°íšŒ
    logging.info(f"{stock_name} ({stock_code})")
    
    # ê° ì¢…ëª©ë³„ ì„±ê³¼ ì¶”ì ìš© ë”•ì…”ë„ˆë¦¬ ìƒì„±
    stock_data = dict()
    stock_data['stock_code'] = stock_code      # ì¢…ëª© ì½”ë“œ
    stock_data['stock_name'] = stock_name      # ì¢…ëª©ëª…
    stock_data['try'] = 0                      # ë§¤ë§¤ ì‹œë„ íšŸìˆ˜
    stock_data['success'] = 0                  # ì„±ê³µ íšŸìˆ˜
    stock_data['fail'] = 0                     # ì‹¤íŒ¨ íšŸìˆ˜
    stock_data['accRev'] = 0                   # ëˆ„ì  ìˆ˜ìµë¥ 

    StockDataList.append(stock_data)

pprint.pprint(StockDataList)

# =============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# =============================================================================
def GetStockName(stock_code, StockDataList):
    """
    ì¢…ëª© ì½”ë“œë¡œë¶€í„° ì¢…ëª©ëª…ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        stock_code (str): ì¢…ëª© ì½”ë“œ
        StockDataList (list): ì¢…ëª© ì •ë³´ ë¦¬ìŠ¤íŠ¸
    
    Returns:
        str: ì¢…ëª©ëª… (ì°¾ì§€ ëª»í•˜ë©´ ì¢…ëª© ì½”ë“œ ë°˜í™˜)
    """
    result_str = stock_code
    for stock_data in StockDataList:
        if stock_code == stock_data['stock_code']:
            result_str = stock_data['stock_name']
            break

    return result_str
    

# =============================================================================
# ë°ì´í„° ì „ì²˜ë¦¬ ë° ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚°
# =============================================================================
stock_df_list = []  # ê° ì¢…ëª©ë³„ ë°ì´í„°í”„ë ˆì„ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸

gugan_lenth = 7  # êµ¬ê°„ ê¸¸ì´ (ê³ ê°€/ì €ê°€ ê³„ì‚°ìš©)

for stock_code in InvestStockList:
    # KIS APIë¥¼ í†µí•´ OHLCV ë°ì´í„° ìˆ˜ì§‘ (ìµœê·¼ 2200ì¼)
    df = Common.GetOhlcv("KR", stock_code,2200)

    # =============================================================================
    # RSI (Relative Strength Index) ê³„ì‚°
    # =============================================================================
    period = 14  # RSI ê³„ì‚° ê¸°ê°„

    # ê°€ê²© ë³€í™”ëŸ‰ ê³„ì‚°
    delta = df["close"].diff()
    up, down = delta.copy(), delta.copy()
    up[up < 0] = 0      # ìƒìŠ¹ë¶„ë§Œ ì¶”ì¶œ
    down[down > 0] = 0  # í•˜ë½ë¶„ë§Œ ì¶”ì¶œ (ì ˆëŒ“ê°’)
    
    # ì§€ìˆ˜ì´ë™í‰ê· ìœ¼ë¡œ í‰ê·  ìƒìŠ¹/í•˜ë½ ê³„ì‚°
    _gain = up.ewm(com=(period - 1), min_periods=period).mean()
    _loss = down.abs().ewm(com=(period - 1), min_periods=period).mean()
    RS = _gain / _loss  # ìƒëŒ€ê°•ë„ ê³„ì‚°

    # RSI ê³„ì‚° (0-100 ë²”ìœ„)
    df['RSI'] = pd.Series(100 - (100 / (1 + RS)), name="RSI")

    # ì´ì „ RSI ê°’ë“¤ (ë§¤ë§¤ ì¡°ê±´ì—ì„œ ì‚¬ìš©)
    df['prevRSI'] = df['RSI'].shift(1)   # 1ì¼ ì „ RSI
    df['prevRSI2'] = df['RSI'].shift(2)  # 2ì¼ ì „ RSI
    
    # =============================================================================
    # ê³ ê°€/ì €ê°€ êµ¬ê°„ ê³„ì‚° (ì¶”ê°€ í•„í„°ë§ìš©)
    # =============================================================================
    df['high_'+str(gugan_lenth)+'_max'] = df['high'].rolling(window=gugan_lenth).max().shift(1)
    df['low_'+str(gugan_lenth)+'_min'] = df['low'].rolling(window=gugan_lenth).min().shift(1)
    
    

    # =============================================================================
    # ì´ì „ ë°ì´í„° ê³„ì‚° (ë§¤ë§¤ ì¡°ê±´ì—ì„œ ì‚¬ìš©)
    # =============================================================================
    # ì´ì „ ê±°ë˜ëŸ‰ ë°ì´í„°
    df['prevVolume'] = df['volume'].shift(1)   # 1ì¼ ì „ ê±°ë˜ëŸ‰
    df['prevVolume2'] = df['volume'].shift(2)  # 2ì¼ ì „ ê±°ë˜ëŸ‰
    df['prevVolume3'] = df['volume'].shift(3)  # 3ì¼ ì „ ê±°ë˜ëŸ‰

    # ì´ì „ ê°€ê²© ë°ì´í„°
    df['prevClose'] = df['close'].shift(1)     # 1ì¼ ì „ ì¢…ê°€
    df['prevOpen'] = df['open'].shift(1)       # 1ì¼ ì „ ì‹œê°€

    # ì´ì „ ê³ ê°€/ì €ê°€ ë°ì´í„°
    df['prevHigh'] = df['high'].shift(1)       # 1ì¼ ì „ ê³ ê°€
    df['prevHigh2'] = df['high'].shift(2)      # 2ì¼ ì „ ê³ ê°€
    df['prevLow'] = df['low'].shift(1)         # 1ì¼ ì „ ì €ê°€
    df['prevLow2'] = df['low'].shift(2)        # 2ì¼ ì „ ì €ê°€

    # =============================================================================
    # ì´ê²©ë„ ê³„ì‚° (ê°€ê²©ê³¼ ì´ë™í‰ê· ì˜ ê´´ë¦¬ìœ¨)
    # =============================================================================
    # 20ì¼ ì´ê²©ë„ (í˜„ì¬ê°€ / 20ì¼ ì´ë™í‰ê·  * 100)
    df['Disparity20'] = df['prevClose'] / df['prevClose'].rolling(window=20).mean() * 100.0
    
    # 11ì¼ ì´ê²©ë„ (í˜„ì¬ê°€ / 11ì¼ ì´ë™í‰ê·  * 100)
    df['Disparity11'] = df['prevClose'] / df['prevClose'].rolling(window=11).mean() * 100.0


    # =============================================================================
    # ì´ë™í‰ê·  ê³„ì‚° (ë§¤ë§¤ ì¡°ê±´ì—ì„œ ì‚¬ìš©)
    # =============================================================================
    # ë‹¨ê¸° ì´ë™í‰ê· 
    df['ma3_before'] = df['close'].rolling(3).mean().shift(1)   # 3ì¼ ì´ë™í‰ê· 
    df['ma6_before'] = df['close'].rolling(6).mean().shift(1)   # 6ì¼ ì´ë™í‰ê· 
    df['ma19_before'] = df['close'].rolling(19).mean().shift(1) # 19ì¼ ì´ë™í‰ê· 

    # ì¤‘ê¸° ì´ë™í‰ê· 
    df['ma10_before'] = df['close'].rolling(10).mean().shift(1) # 10ì¼ ì´ë™í‰ê· 
    df['ma20_before'] = df['close'].rolling(20).mean().shift(1) # 20ì¼ ì´ë™í‰ê· 
    df['ma20_before2'] = df['close'].rolling(20).mean().shift(2) # 2ì¼ ì „ 20ì¼ ì´ë™í‰ê· 

    # ì¥ê¸° ì´ë™í‰ê· 
    df['ma60_before'] = df['close'].rolling(60).mean().shift(1) # 60ì¼ ì´ë™í‰ê· 
    df['ma60_before2'] = df['close'].rolling(60).mean().shift(2) # 2ì¼ ì „ 60ì¼ ì´ë™í‰ê· 
    df['ma120_before'] = df['close'].rolling(120).mean().shift(1) # 120ì¼ ì´ë™í‰ê· 

    # =============================================================================
    # ë³€í™”ìœ¨ ì´ë™í‰ê·  (íš¡ë³´ì¥ íŒë‹¨ìš©)
    # =============================================================================
    # 20ì¼ ë³€í™”ìœ¨ ì´ë™í‰ê· 
    df['prevChangeMa'] = df['change'].shift(1).rolling(window=20).mean()
    
    # 10ì¼ ë³€í™”ìœ¨ ì´ë™í‰ê·  (ë‹¨ê¸° íš¡ë³´ì¥ íŒë‹¨)
    df['prevChangeMa_S'] = df['change'].shift(1).rolling(window=10).mean()

    # =============================================================================
    # ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ ê³„ì‚° (10ì¼ë§ˆë‹¤ ì´ 100ì¼ í‰ê· ëª¨ë©˜í…€ìŠ¤ì½”ì–´)
    # =============================================================================
    specific_days = list()

    # 10ì¼, 20ì¼, 30ì¼... 100ì¼ ì „ ê°€ê²©ê³¼ ë¹„êµ
    for i in range(1,11):
        st = i * 10
        specific_days.append(st)

    # ê° ê¸°ê°„ë³„ ëª¨ë©˜í…€ ê³„ì‚° (í˜„ì¬ê°€ > ê³¼ê±°ê°€ê²©ì´ë©´ 1, ì•„ë‹ˆë©´ 0)
    for day in specific_days:
        column_name = f'Momentum_{day}'
        df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)
        
    # í‰ê·  ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ (0-1 ë²”ìœ„, ë†’ì„ìˆ˜ë¡ ìƒìŠ¹ ëª¨ë©˜í…€)
    df['Average_Momentum'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10


    # =============================================================================
    # ë‹¨ê¸° ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ ê³„ì‚° (3ì¼ë§ˆë‹¤ ì´ 30ì¼)
    # =============================================================================
    # Define the list of specific trading days to compare
    specific_days = list()

    # 3ì¼, 6ì¼, 9ì¼... 30ì¼ ì „ ê°€ê²©ê³¼ ë¹„êµ
    for i in range(1,11):
        st = i * 3
        specific_days.append(st)

    # Iterate over the specific trading days and compare the current market price with the corresponding closing prices
    for day in specific_days:
        # Create a column name for each specific trading day
        column_name = f'Momentum_{day}'
        
        # Compare current market price with the closing price of the specific trading day
        df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)

    # Calculate the average momentum score (ë‹¨ê¸° ëª¨ë©˜í…€)
    df['Average_Momentum3'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10

    # =============================================================================
    # ë°ì´í„° ì •ë¦¬ ë° ì €ì¥
    # =============================================================================
    df.dropna(inplace=True) #ë°ì´í„° ì—†ëŠ”ê±´ ë‚ ë¦°ë‹¤!

    # ì¢…ëª©ë³„ ë°ì´í„°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ì €ì¥
    data_dict = {stock_code: df}
    stock_df_list.append(data_dict)
    print("---stock_code---", stock_code , " len ",len(df))
    pprint.pprint(df)





# =============================================================================
# ë°ì´í„° ê²°í•© ë° ì •ë ¬
# =============================================================================
# Combine the OHLCV data into a single DataFrame
# ëª¨ë“  ì¢…ëª©ì˜ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ê²°í•©
combined_df = pd.concat([list(data_dict.values())[0].assign(stock_code=stock_code) for data_dict in stock_df_list for stock_code in data_dict])

# Sort the combined DataFrame by date
# ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬
combined_df.sort_index(inplace=True)

pprint.pprint(combined_df)
print(" len(combined_df) ", len(combined_df))

# =============================================================================
# ë°±í…ŒìŠ¤íŒ… ë³€ìˆ˜ ì´ˆê¸°í™”
# =============================================================================
# ë§¤ë§¤ ìƒíƒœ ë³€ìˆ˜
IsBuy = False #ë§¤ìˆ˜ í–ˆëŠ”ì§€ ì—¬ë¶€
BUY_PRICE = 0  #ë§¤ìˆ˜í•œ ê¸ˆì•¡! 

# ì„±ê³¼ ì¶”ì  ë³€ìˆ˜
TryCnt = 0      #ë§¤ë§¤íšŸìˆ˜
SuccesCnt = 0   #ìµì ˆ ìˆ«ì
FailCnt = 0     #ì†ì ˆ ìˆ«ì

# ë‚ ì§œ ì¶”ì  ë³€ìˆ˜
IsFirstDateSet = False
FirstDateStr = ""
FirstDateIndex = 0

# íˆ¬ì ê´€ë¦¬ ë³€ìˆ˜
NowInvestCode = ""
InvestMoney = TotalMoney
DivNum = len(InvestStockList)  # íˆ¬ì ì¢…ëª© ìˆ˜
MaxInvestCount = 2  # ìµœëŒ€ íˆ¬ì ì¢…ëª© ìˆ˜ (2ê°œë¡œ ì œí•œ)
RemainInvestMoney = InvestMoney # ë‚¨ì€ íˆ¬ìê¸ˆ

# ê²°ê³¼ ì €ì¥ ë¦¬ìŠ¤íŠ¸
ResultList = list()      # ìµœì¢… ê²°ê³¼ ì €ì¥
TotalMoneyList = list()  # ì¼ë³„ ì´ ìì‚° ë³€í™”
NowInvestList = list()   # í˜„ì¬ íˆ¬ìì¤‘ì¸ ì¢…ëª©ë“¤

# ì†ì ˆ ê´€ë¦¬ ë³€ìˆ˜
IsCut = False   # ì†ì ˆ ë°œìƒ ì—¬ë¶€
IsCutCnt = 0    # ì—°ì† ì†ì ˆ íšŸìˆ˜


# =============================================================================
# ë©”ì¸ ë°±í…ŒìŠ¤íŒ… ë£¨í”„ ì‹œì‘
# =============================================================================
i = 0
# Iterate over each date
# ê° ë‚ ì§œë³„ë¡œ ë°±í…ŒìŠ¤íŒ… ì‹¤í–‰
for date in combined_df.index.unique():
 
    #ë‚ ì§œ ì •ë³´ë¥¼ íšë“
    # ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ì— ëŒ€ì‘
    date_format = "%Y-%m-%d %H:%M:%S"
    date_object = None

    try:
        date_object = datetime.strptime(str(date), date_format)
    
    except Exception as e:
        try:
            date_format = "%Y%m%d"
            date_object = datetime.strptime(str(date), date_format)

        except Exception as e2:
            date_format = "%Y-%m-%d"
            date_object = datetime.strptime(str(date), date_format)

    # =============================================================================
    # í˜„ì¬ ë‚ ì§œì˜ ì¢…ëª©ë³„ ë°ì´í„° ì¶”ì¶œ
    # =============================================================================
    # í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì¢…ëª© ì¤‘ ì¢…ê°€ê°€ ë†’ì€ ìˆœìœ¼ë¡œ DivNumê°œ ì„ íƒ
    all_stocks = combined_df.loc[combined_df.index == date].groupby('stock_code')['close'].max().nlargest(DivNum)
    
    # =============================================================================
    # íš¡ë³´ì¥ íŒë‹¨ ë¡œì§
    # =============================================================================
    #íš¡ë³´ì¥ì„ ì •ì˜í•˜ê¸° ìœ„í•œ ë¡œì§!!
    # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì„¸ìš”!!!
    
    # í˜„ì¬ ë‚ ì§œì˜ ê° ì¢…ëª© ë°ì´í„° ì¶”ì¶œ
    Kosdaq_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "233740")]  # ì½”ìŠ¤ë‹¥ ë ˆë²„ë¦¬ì§€
    Kosdaq_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "251340")] # ì½”ìŠ¤ë‹¥ ì¸ë²„ìŠ¤
    Kospi_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "122630")]  # ì½”ìŠ¤í”¼ ë ˆë²„ë¦¬ì§€
    Kospi_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "252670")] # ì½”ìŠ¤í”¼ ì¸ë²„ìŠ¤
    
    # íš¡ë³´ì¥ íŒë‹¨: ëª¨ë“  ì¢…ëª©ì´ ê°™ì€ ë°©í–¥ìœ¼ë¡œ ì›€ì§ì´ë©´ íš¡ë³´ì¥ìœ¼ë¡œ íŒë‹¨
    IsNoWay = False
    if len(Kosdaq_Long_Data) == 1 and len(Kosdaq_Short_Data) == 1 and len(Kospi_Long_Data) == 1 and len(Kospi_Short_Data) == 1:
        # ì½”ìŠ¤í”¼ ìŒì´ë‚˜ ì½”ìŠ¤ë‹¥ ìŒì´ ëª¨ë‘ ê°™ì€ ë°©í–¥(ìƒìŠ¹ ë˜ëŠ” í•˜ë½)ìœ¼ë¡œ ì›€ì§ì´ë©´ íš¡ë³´ì¥
        if  (Kospi_Long_Data['prevChangeMa_S'].values[0] > 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kospi_Long_Data['prevChangeMa_S'].values[0] < 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] < 0)  or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] > 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] < 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] < 0) :
            IsNoWay = True
    #######################################################################################################################################



    # =============================================================================
    # ë§¤ë„ ë¡œì§ ì‹œì‘
    # =============================================================================
    i += 1

    # ì˜¤ëŠ˜ ë§¤ë„ëœ ì¢…ëª©ë“¤ì„ ì¶”ì 
    today_sell_code = list()

    # ë§¤ë„ í›„ ì œê±°í•  íˆ¬ì ë°ì´í„° ë¦¬ìŠ¤íŠ¸
    items_to_remove = list()

    # ì½”ìŠ¤ë‹¥ ë§¤ë„ ê´€ë ¨ ë³€ìˆ˜
    Kosdaq_sell_cnt = 0              # ì½”ìŠ¤ë‹¥ ë§¤ë„ ë°œìƒ íšŸìˆ˜
    Kosdaq_sell_money_furture = 0    # ì½”ìŠ¤ë‹¥ ë§¤ë„ë¡œ ì¸í•œ ë¯¸ë˜ íˆ¬ìê¸ˆ

    # =============================================================================
    # í˜„ì¬ íˆ¬ìì¤‘ì¸ ì¢…ëª©ë“¤ì˜ ë§¤ë„ ì¡°ê±´ ì²´í¬
    # =============================================================================
    #íˆ¬ìì¤‘ì¸ ì¢…ëª©ë“¤!!
    for investData in NowInvestList:

        stock_code = investData['stock_code'] 
        
        if investData['InvestMoney'] > 0:
            stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

            if len(stock_data) == 1:
                
                # =============================================================================
                # ì½”ìŠ¤ë‹¥ ì¢…ëª© ë§¤ë„ ì „ëµ (ë³€ë™ì„± ëŒíŒŒ ì „ëµì˜ ì†ì ˆ)
                # =============================================================================
                ####!!!!ì½”ìŠ¤ë‹¥ ì „ëµ!!!####
                #ì¡°ê±´ ë§Œì¡±ì‹œ ë§¤ë„ í•œë‹¤!
                if stock_code in ["233740","251340"]:
                    
                    # =============================================================================
                    # í˜„ì¬ ê°€ê²© ì •ë³´ ì¶”ì¶œ
                    # =============================================================================
                    NowOpenPrice = stock_data['open'].values[0]      # í˜„ì¬ ì‹œê°€
                    PrevOpenPrice = stock_data['prevOpen'].values[0] # ì „ì¼ ì‹œê°€
                    PrevClosePrice = stock_data['prevClose'].values[0] # ì „ì¼ ì¢…ê°€

                    # =============================================================================
                    # ì†ì ˆ ë¹„ìœ¨ ì„¤ì • (ì¢…ëª©ë³„ë¡œ ë‹¤ë¦„)
                    # =============================================================================
                    CutRate = 0.4

                    # KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤ (ì¸ë²„ìŠ¤ ì¢…ëª©)
                    if stock_code == "251340":
                        CutRate = 0.4  # ê³ ì • 0.4

                    # KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€ (ë ˆë²„ë¦¬ì§€ ì¢…ëª©)
                    else:
                        # 60ì¼ ì´ë™í‰ê·  ê¸°ì¤€ìœ¼ë¡œ ì†ì ˆ ë¹„ìœ¨ ì¡°ì •
                        if PrevClosePrice > stock_data['ma60_before'].values[0]:
                            CutRate = 0.4  # ìƒìŠ¹ì¥ì—ì„œëŠ” 0.4
                        else:
                            CutRate = 0.3  # í•˜ë½ì¥ì—ì„œëŠ” 0.3 (ë” ë³´ìˆ˜ì )



                    # =============================================================================
                    # ì†ì ˆ ê°€ê²© ê³„ì‚° ë° ë§¤ë„ ì¡°ê±´ ì²´í¬
                    # =============================================================================
                    #ëª©í‘œì»· ë§¤ë„ê°€! ì‹œê°€ - (ì „ì¼ê³ ê°€ - ì „ì¼ì €ê°€) x CutRate 
                    # ë³€ë™ì„± ëŒíŒŒ ì „ëµì˜ ë°˜ëŒ€: í•˜í–¥ ëŒíŒŒ ì‹œ ì†ì ˆ
                    CutPrice = stock_data['open'].values[0] - ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * CutRate)

                    # ê¸°ë³¸ ë§¤ë„ê°€ê²©ì€ í˜„ì¬ ì‹œê°€
                    SellPrice = NowOpenPrice

                    # ë§¤ë„ ì‹¤í–‰ ì—¬ë¶€
                    IsSellGo = False

                    # =============================================================================
                    # í•˜í–¥ ëŒíŒŒ í™•ì¸ ë° ë§¤ë„ ì‹¤í–‰
                    # =============================================================================
                    #í•˜í–¥ ëŒíŒŒí–ˆë‹¤ë©´ ë§¤ë„ ê³ ê³ !!
                    # ì†ì ˆê°€ê°€ í˜„ì¬ ì €ê°€ë³´ë‹¤ ë†’ìœ¼ë©´ í•˜í–¥ ëŒíŒŒ ë°œìƒ
                    if CutPrice >= stock_data['low'].values[0] :
                        IsSellGo = True
                        SellPrice = CutPrice  # ì†ì ˆê°€ë¡œ ë§¤ë„


                    # =============================================================================
                    # íˆ¬ìê¸ˆ ë°˜ì˜ ë° ìˆ˜ìµë¥  ê³„ì‚°
                    # =============================================================================
                    #ë§¤ì¼ ë§¤ì¼ íˆ¬ìê¸ˆ ë°˜ì˜!
                    # ì²« ë²ˆì§¸ ë§¤ë„ì¸ì§€ ì—¬ë¶€ì— ë”°ë¼ íˆ¬ìê¸ˆ ê³„ì‚° ë°©ì‹ì´ ë‹¤ë¦„
                    if investData['DolPaCheck'] == False:
                        # ì²« ë²ˆì§¸ ë§¤ë„: ë§¤ìˆ˜ê°€ ëŒ€ë¹„ ìˆ˜ìµë¥ ë¡œ íˆ¬ìê¸ˆ ì¡°ì •
                        investData['DolPaCheck'] = True
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - investData['BuyPrice'] ) / investData['BuyPrice'] ))
                    else:
                        # ë‘ ë²ˆì§¸ ì´í›„ ë§¤ë„: ì „ì¼ ì‹œê°€ ëŒ€ë¹„ ìˆ˜ìµë¥ ë¡œ íˆ¬ìê¸ˆ ì¡°ì •
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - PrevOpenPrice ) / PrevOpenPrice))

                    # =============================================================================
                    # ìˆ˜ìµë¥  ê³„ì‚°
                    # =============================================================================
                    #ì§„ì…(ë§¤ìˆ˜)ê°€ê²© ëŒ€ë¹„ ë³€ë™ë¥  (ìˆ˜ìˆ˜ë£Œ í¬í•¨)
                    Rate = (SellPrice* (1.0 - fee) - investData['BuyPrice']) / investData['BuyPrice']

                    # ìµœì¢… ìˆ˜ìµë¥  ê³„ì‚° (ìˆ˜ìˆ˜ë£Œ ì œì™¸)
                    RevenueRate = (Rate - fee)*100.0 #ìˆ˜ìµë¥  ê³„ì‚°

                    # =============================================================================
                    # ì½”ìŠ¤ë‹¥ ë§¤ë„ ì‹¤í–‰ ë° ê²°ê³¼ ì²˜ë¦¬
                    # =============================================================================
                    if IsSellGo == True :

                        Kosdaq_sell_cnt += 1 #ì½”ìŠ¤ë‹¥ ëŒíŒŒ ë§¤ë„ê°€ ì¼ì–´ë‚œ ë‚ !
                        
                        # =============================================================================
                        # ì†ì ˆ ê´€ë¦¬ ë¡œì§
                        # =============================================================================
                        if RevenueRate < 0:
                            IsCut = True      # ì†ì ˆ ë°œìƒ
                            IsCutCnt += 1     # ì—°ì† ì†ì ˆ íšŸìˆ˜ ì¦ê°€
                        else:
                            IsCut = False     # ìµì ˆ ë°œìƒ
                            IsCutCnt -= 1     # ì—°ì† ì†ì ˆ íšŸìˆ˜ ê°ì†Œ
                            if IsCutCnt < 0:
                                IsCutCnt = 0   # ìŒìˆ˜ê°€ ë˜ì§€ ì•Šë„ë¡ ë³´ì •

                        # =============================================================================
                        # íšŒìˆ˜ ê¸ˆì•¡ ê³„ì‚°
                        # =============================================================================
                        ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ, ìŠ¬ë¦¬í”¼ì§€ ë°˜ì˜!

                        # ì‹œê°€ê°€ ì†ì ˆê°€ë³´ë‹¤ ë†’ìœ¼ë©´ ë¯¸ë˜ íˆ¬ìê¸ˆì— ì¶”ê°€
                        if NowOpenPrice > CutPrice:
                            Kosdaq_sell_money_furture += ReturnMoney

                        # =============================================================================
                        # ì„±ê³¼ í†µê³„ ì—…ë°ì´íŠ¸
                        # =============================================================================
                        TryCnt += 1

                        if RevenueRate > 0: #ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë‹¤ë©´ ìµì ˆí•œ ì…ˆì´ë‹¤!
                            SuccesCnt += 1
                        else:
                            FailCnt += 1
            
                        #ì¢…ëª©ë³„ ì„±ê³¼ë¥¼ ê¸°ë¡í•œë‹¤.
                        for stock_data in StockDataList:
                            if stock_code == stock_data['stock_code']:
                                stock_data['try'] += 1
                                if RevenueRate > 0:
                                    stock_data['success'] += 1
                                else:
                                    stock_data['fail'] +=1
                                stock_data['accRev'] += RevenueRate


                        
                        RemainInvestMoney += ReturnMoney
                        investData['InvestMoney'] = 0


                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney

                        logging.info(f"{str(date)} {GetStockName(stock_code, StockDataList)} ({stock_code}) {i} >>\n ë§¤ë„! ë§¤ìˆ˜ì¼:{investData['Date']}, ë§¤ìˆ˜ê°€:{investData['BuyPrice']} , ë§¤ìˆ˜ê¸ˆ:{investData['FirstMoney']}, ìˆ˜ìµë¥ : {round(RevenueRate,2)} %, íšŒìˆ˜ê¸ˆ:{round(ReturnMoney,2)}  , ë§¤ë„ê°€:{SellPrice * (1.0 - fee)}")
                                
                        items_to_remove.append(investData)

                        today_sell_code.append(stock_code)

                # =============================================================================
                # ì½”ìŠ¤í”¼ ì¢…ëª© ë§¤ë„ ì „ëµ (ê¸°ìˆ ì  ì§€í‘œ ê¸°ë°˜)
                # =============================================================================
                ####!!!!ì½”ìŠ¤í”¼ ì „ëµ!!!####
                #ì¡°ê±´ ë§Œì¡±ì‹œ ë§¤ë„ í•œë‹¤!
                else:
                    
                    # =============================================================================
                    # í˜„ì¬ ê°€ê²© ì •ë³´ ì¶”ì¶œ
                    # =============================================================================
                    NowOpenPrice = stock_data['open'].values[0]      # í˜„ì¬ ì‹œê°€
                    PrevOpenPrice = stock_data['prevOpen'].values[0] # ì „ì¼ ì‹œê°€
                    PrevClosePrice = stock_data['prevClose'].values[0] # ì „ì¼ ì¢…ê°€

                    # ê¸°ë³¸ ë§¤ë„ê°€ê²©ì€ í˜„ì¬ ì‹œê°€
                    SellPrice = NowOpenPrice

                    # ë§¤ë„ ì‹¤í–‰ ì—¬ë¶€
                    IsSellGo = False

                    # =============================================================================
                    # íˆ¬ìê¸ˆ ë°˜ì˜ ë° ìˆ˜ìµë¥  ê³„ì‚°
                    # =============================================================================
                    #ë§¤ì¼ ë§¤ì¼ íˆ¬ìê¸ˆ ë°˜ì˜!
                    if investData['DolPaCheck'] == False:
                        investData['DolPaCheck'] = True
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - investData['BuyPrice'] ) / investData['BuyPrice'] ))
                    else:
                        investData['InvestMoney'] = investData['InvestMoney'] *  (1.0 + ((SellPrice - PrevOpenPrice ) / PrevOpenPrice))

                    #ì§„ì…(ë§¤ìˆ˜)ê°€ê²© ëŒ€ë¹„ ë³€ë™ë¥ 
                    Rate = (SellPrice* (1.0 - fee) - investData['BuyPrice']) / investData['BuyPrice']

                    RevenueRate = (Rate - fee)*100.0 #ìˆ˜ìµë¥  ê³„ì‚°
                    
                    # =============================================================================
                    # ì½”ìŠ¤í”¼ ì¢…ëª©ë³„ ë§¤ë„ ì¡°ê±´
                    # =============================================================================
                    # KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X (ì½”ìŠ¤í”¼ í•˜ë½ ì¶”ì¢…)
                    if stock_code == "252670":
                        
                        # 11ì¼ ì´ê²©ë„ê°€ 105% ì´ìƒì¼ ë•Œ (ê³¼ë§¤ìˆ˜ êµ¬ê°„)
                        if stock_data['Disparity11'].values[0] > 105:
                            # 3ì¼ ì´ë™í‰ê·  í•˜í–¥ ëŒíŒŒ ì‹œ ë§¤ë„
                            if  PrevClosePrice < stock_data['ma3_before'].values[0]: 
                                IsSellGo = True

                        else:
                            # ì¼ë°˜ì ì¸ ê²½ìš°: 6ì¼, 19ì¼ ì´ë™í‰ê·  ëª¨ë‘ í•˜í–¥ ëŒíŒŒ ì‹œ ë§¤ë„
                            if PrevClosePrice < stock_data['ma6_before'].values[0] and PrevClosePrice < stock_data['ma19_before'].values[0] : 
                                IsSellGo = True

                    # KODEX ë ˆë²„ë¦¬ì§€ (ì½”ìŠ¤í”¼ ìƒìŠ¹ ì¶”ì¢…)
                    else:
                        # í‰ê·  ê±°ë˜ëŸ‰ ê³„ì‚° (ìµœê·¼ 3ì¼)
                        total_volume = (stock_data['prevVolume'].values[0]+ stock_data['prevVolume2'].values[0] +stock_data['prevVolume3'].values[0]) / 3.0

                        # 20ì¼ ì´ê²©ë„
                        Disparity = stock_data['Disparity20'].values[0] 

                        # ë§¤ë„ ì¡°ê±´: 
                        # 1. ì €ê°€ê°€ ìƒìŠ¹í•˜ê±°ë‚˜ ê±°ë˜ëŸ‰ì´ í‰ê· ë³´ë‹¤ ë‚®ê³ 
                        # 2. ì´ê²©ë„ê°€ 98% ë¯¸ë§Œì´ê±°ë‚˜ 105% ì´ˆê³¼ì¼ ë•Œ
                        # â†’ í™€ë”© (ë§¤ë„í•˜ì§€ ì•ŠìŒ)
                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0] or stock_data['prevVolume'].values[0] < total_volume) and (Disparity < 98 or Disparity > 105):
                            logging.info("hold..")
                        else:
                            # ê·¸ ì™¸ì˜ ê²½ìš° ë§¤ë„
                            IsSellGo = True
                    

             
             

                    # =============================================================================
                    # ì½”ìŠ¤í”¼ ë§¤ë„ ì‹¤í–‰ ë° ê²°ê³¼ ì²˜ë¦¬
                    # =============================================================================
                    #ì¡°ê±´ ë§Œì¡± í–ˆë‹¤ë©´ ë§¤ë„ ê³ ê³ !
                    if IsSellGo == True :

                        # =============================================================================
                        # íšŒìˆ˜ ê¸ˆì•¡ ê³„ì‚°
                        # =============================================================================
                        ReturnMoney = (investData['InvestMoney'] * (1.0 - fee))  #ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ, ìŠ¬ë¦¬í”¼ì§€ ë°˜ì˜!

                        # =============================================================================
                        # ì„±ê³¼ í†µê³„ ì—…ë°ì´íŠ¸
                        # =============================================================================
                        TryCnt += 1

                        if RevenueRate > 0: #ìˆ˜ìµë¥ ì´ 0ë³´ë‹¤ í¬ë‹¤ë©´ ìµì ˆí•œ ì…ˆì´ë‹¤!
                            SuccesCnt += 1
                        else:
                            FailCnt += 1
            
                        #ì¢…ëª©ë³„ ì„±ê³¼ë¥¼ ê¸°ë¡í•œë‹¤.
                        for stock_data in StockDataList:
                            if stock_code == stock_data['stock_code']:
                                stock_data['try'] += 1
                                if RevenueRate > 0:
                                    stock_data['success'] += 1
                                else:
                                    stock_data['fail'] +=1
                                stock_data['accRev'] += RevenueRate


                        
                        RemainInvestMoney += ReturnMoney
                        investData['InvestMoney'] = 0


                        #pprint.pprint(NowInvestList)

                        NowInvestMoney = 0
                        for iData in NowInvestList:
                            NowInvestMoney += iData['InvestMoney']

                        InvestMoney = RemainInvestMoney + NowInvestMoney

                        logging.info(f"{str(date)} {GetStockName(stock_code, StockDataList)} ({stock_code}) {i} >>\n ë§¤ë„! ë§¤ìˆ˜ì¼:{investData['Date']}, ë§¤ìˆ˜ê°€:{investData['BuyPrice']} , ë§¤ìˆ˜ê¸ˆ:{investData['FirstMoney']}, ìˆ˜ìµë¥ : {round(RevenueRate,2)} %, íšŒìˆ˜ê¸ˆ:{round(ReturnMoney,2)}  , ë§¤ë„ê°€:{SellPrice * (1.0 - fee)}")
                                
                        items_to_remove.append(investData)

                        today_sell_code.append(stock_code)


    # =============================================================================
    # ë§¤ë„ ì™„ë£Œ í›„ íˆ¬ì ë¦¬ìŠ¤íŠ¸ ì •ë¦¬
    # =============================================================================
    #ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
    for item in items_to_remove:
        NowInvestList.remove(item)

    # =============================================================================
    # ì½”ìŠ¤í”¼ ì¢…ëª© ë§¤ìˆ˜ ë¡œì§
    # =============================================================================
    #ìµœëŒ€ 2ê°œ ì¢…ëª©ë§Œ íˆ¬ì ê°€ëŠ¥í•¨! ì½”ìŠ¤í”¼ ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬!
    #ì¦‰ ì½”ìŠ¤í”¼ ë¨¼ì € ë§¤ìˆ˜ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ì—¬ ë§¤ìˆ˜í•œë‹¤!
    if len(NowInvestList) < MaxInvestCount and int(date_object.strftime("%Y")) >= StartYear:

        if IsFirstDateSet == False:
            FirstDateStr = str(date)
            FirstDateIndex = i-1
            IsFirstDateSet = True


        for stock_code in all_stocks.index:

            IsAlReadyInvest = False
            for investData in NowInvestList:
                if stock_code == investData['stock_code']: 
                    IsAlReadyInvest = True
                    break    
            
            if stock_code not in today_sell_code and IsAlReadyInvest == False:

                # =============================================================================
                # í˜„ì¬ ì¢…ëª© ë°ì´í„° ì¶”ì¶œ
                # =============================================================================
                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]
                
                # =============================================================================
                # ì½”ìŠ¤í”¼ ì¢…ëª© ë§¤ìˆ˜ ì „ëµ (ê¸°ìˆ ì  ì§€í‘œ ê¸°ë°˜)
                # =============================================================================
                ####!!!!ì½”ìŠ¤í”¼ ì „ëµ!!!####
                if stock_code in ["122630","252670"]:
                    
                    # =============================================================================
                    # ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
                    # =============================================================================
                    PrevClosePrice = stock_data['prevClose'].values[0]  # ì „ì¼ ì¢…ê°€
                    DolPaPrice = stock_data['open'].values[0]          # ë§¤ìˆ˜ ê°€ê²© (ì‹œê°€)
                    IsBuyGo = False                                    # ë§¤ìˆ˜ ì‹¤í–‰ ì—¬ë¶€
                    
                    # =============================================================================
                    # KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X ë§¤ìˆ˜ ì¡°ê±´ (ì½”ìŠ¤í”¼ í•˜ë½ ì¶”ì¢…)
                    # =============================================================================
                    # KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X
                    if stock_code == "252670":
                        # ê¸°ë³¸ ì¡°ê±´: ëª¨ë“  ë‹¨ê¸° ì´ë™í‰ê·  ìƒí–¥ ëŒíŒŒ + RSI ì¡°ê±´
                        if PrevClosePrice > stock_data['ma3_before'].values[0]  and PrevClosePrice > stock_data['ma6_before'].values[0]  and PrevClosePrice > stock_data['ma19_before'].values[0] and stock_data['prevRSI'].values[0] < 70 and stock_data['prevRSI2'].values[0] < stock_data['prevRSI'].values[0]:
                            # ì¶”ê°€ ì¡°ê±´: ê±°ë˜ëŸ‰ ì¦ê°€ + ì €ê°€ ìƒìŠ¹ + ì¥ê¸° ì´ë™í‰ê·  ìƒí–¥ + ë‹¨ê¸° ì´ë™í‰ê·  ì •ë ¬
                            if (stock_data['prevVolume2'].values[0] < stock_data['prevVolume'].values[0]) and (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and PrevClosePrice > stock_data['ma60_before'].values[0] and stock_data['ma60_before2'].values[0] < stock_data['ma60_before'].values[0]  and stock_data['ma3_before'].values[0]  > stock_data['ma6_before'].values[0]  > stock_data['ma19_before'].values[0]  :
                                IsBuyGo = True

                    # =============================================================================
                    # KODEX ë ˆë²„ë¦¬ì§€ ë§¤ìˆ˜ ì¡°ê±´ (ì½”ìŠ¤í”¼ ìƒìŠ¹ ì¶”ì¢…)
                    # =============================================================================
                    # KODEX ë ˆë²„ë¦¬ì§€
                    else:
                        Disparity = stock_data['Disparity20'].values[0] 
                        
                        # ë§¤ìˆ˜ ì¡°ê±´: ì €ê°€ ìƒìŠ¹ + ì´ê²©ë„ ì¡°ê±´ + RSI ì¡°ê±´
                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and (Disparity < 98 or Disparity > 106) and stock_data['prevRSI'].values[0] < 80 :
                            IsBuyGo = True

        
                    #ì¡°ê±´ì„ ë§Œì¡±í–ˆë‹¤ë©´ ë§¤ìˆ˜ ê³ ê³ !
                    if IsBuyGo == True :



                        Rate = 1.0


                        # =============================================================================
                        # ìƒˆë¡œìš´ íˆ¬ì ë¹„ìœ¨ ì‹œìŠ¤í…œ ì ìš©
                        # =============================================================================
                        #InvestGoMoney = (InvestMoney / len(InvestStockList)) * Rate
                        InvestGoMoney = 0

                        # í˜„ì¬ íˆ¬ìì¤‘ì¸ ì¢…ëª© ìˆ˜ ê³„ì‚°
                        current_invest_count = len(NowInvestList)
                        
                        # ìƒˆë¡œìš´ íˆ¬ì ë¹„ìœ¨ ì‹œìŠ¤í…œ
                        if IsNoWay == True:
                            # íš¡ë³´ì¥ì¸ ê²½ìš°: ê· ë“± ë¶„ë°°
                            InvestGoMoney = ((RemainInvestMoney - Kosdaq_sell_money_furture) / len(InvestStockList))
                        else:
                            # ìƒˆë¡œìš´ íˆ¬ì ë¹„ìœ¨ ë¡œì§
                            if current_invest_count == 0:
                                # ì²« ë²ˆì§¸ ì¢…ëª©: 100% íˆ¬ì
                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture)
                            elif current_invest_count == 1:
                                # ë‘ ë²ˆì§¸ ì¢…ëª©: ê¸°ì¡´ ì¢…ëª© ë§¤ë„ í›„ 50:50 ë¶„ë°°
                                # ê¸°ì¡´ íˆ¬ìê¸ˆì˜ ì ˆë°˜ì„ ë§¤ë„í•˜ê³  ìƒˆë¡œìš´ ì¢…ëª©ì— íˆ¬ì
                                existing_invest = NowInvestList[0]['InvestMoney']
                                sell_amount = existing_invest * 0.5  # ê¸°ì¡´ íˆ¬ìê¸ˆì˜ ì ˆë°˜ ë§¤ë„
                                
                                # ê¸°ì¡´ íˆ¬ìê¸ˆ ì¡°ì •
                                NowInvestList[0]['InvestMoney'] = existing_invest * 0.5
                                RemainInvestMoney += sell_amount * (1.0 - fee)  # ìˆ˜ìˆ˜ë£Œ ì°¨ê° í›„ í˜„ê¸ˆ ì¶”ê°€
                                
                                new_total = (RemainInvestMoney - Kosdaq_sell_money_furture)
                                InvestGoMoney = new_total * 0.5  # ìƒˆë¡œìš´ ì¢…ëª©ì— 50% íˆ¬ì
                                
                                logging.info(f"ê¸°ì¡´ íˆ¬ìê¸ˆ ì ˆë°˜ ë§¤ë„: {GetStockName(NowInvestList[0]['stock_code'], StockDataList)} -> {round(sell_amount,2)}")
                                
                            else:
                                # 2ê°œ ì´ìƒì¸ ê²½ìš°: ë” ì´ìƒ íˆ¬ìí•˜ì§€ ì•ŠìŒ
                                InvestGoMoney = 0
                    
                   
            


                        if InvestGoMoney > 0:


                            BuyAmt = int(InvestGoMoney /  DolPaPrice) #ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ êµ¬í•œë‹¤!

                            NowFee = (BuyAmt*DolPaPrice) * fee



                            #ë§¤ìˆ˜í•´ì•¼ ë˜ëŠ”ë° ë‚¨ì€ëˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ìˆ˜ëŸ‰ì„ í•˜ë‚˜ì”© ê°ì†Œì‹œì¼œ ë§Œì¡±í•  ë•Œ ë§¤ìˆ˜í•œë‹¤!!
                            while (RemainInvestMoney - Kosdaq_sell_money_furture)  < (BuyAmt*DolPaPrice) + NowFee:
                                if (RemainInvestMoney - Kosdaq_sell_money_furture)  > DolPaPrice:
                                    BuyAmt -= 1
                                    NowFee = (BuyAmt*DolPaPrice) * fee
                                else:
                                    break
                            
                            if BuyAmt > 0:



                                RealInvestMoney = (BuyAmt*DolPaPrice) #ì‹¤ì œ ë“¤ì–´ê°„ íˆ¬ìê¸ˆ

                                RemainInvestMoney -= (BuyAmt*DolPaPrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                                RemainInvestMoney -= NowFee


                                InvestData = dict()

                                InvestData['stock_code'] = stock_code
                                InvestData['InvestMoney'] = RealInvestMoney
                                InvestData['FirstMoney'] = RealInvestMoney
                                InvestData['BuyPrice'] = DolPaPrice
                                InvestData['DolPaCheck'] = False
                                InvestData['Date'] = str(date)



                                NowInvestList.append(InvestData)


                                NowInvestMoney = 0
                                for iData in NowInvestList:
                                    NowInvestMoney += iData['InvestMoney']

                                InvestMoney = RemainInvestMoney + NowInvestMoney


                                logging.info(f"{str(date)} {GetStockName(stock_code, StockDataList)} ({stock_code}) {i} >>\n ë§¤ìˆ˜! ,ë§¤ìˆ˜ê¸ˆì•¡:{round(RealInvestMoney,2)} , ëŒíŒŒê°€ê²©:{DolPaPrice}, ì‹œê°€:{stock_data['open'].values[0]}")

             
             

    # =============================================================================
    # ì½”ìŠ¤ë‹¥ ì¢…ëª© ë§¤ìˆ˜ ë¡œì§ (ë³€ë™ì„± ëŒíŒŒ ì „ëµ)
    # =============================================================================
    #ìµœëŒ€ 2ê°œ ì¢…ëª©ë§Œ íˆ¬ì ê°€ëŠ¥í•¨! ì½”ìŠ¤ë‹¥ ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬!
    if len(NowInvestList) < MaxInvestCount and int(date_object.strftime("%Y")) >= StartYear:

        for stock_code in all_stocks.index:

            # =============================================================================
            # ì´ë¯¸ íˆ¬ìì¤‘ì¸ ì¢…ëª©ì¸ì§€ í™•ì¸
            # =============================================================================
            IsAlReadyInvest = False
            for investData in NowInvestList:
                if stock_code == investData['stock_code']: 
                    IsAlReadyInvest = True
                    break    
            
            # =============================================================================
            # ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬ (ì˜¤ëŠ˜ ë§¤ë„ë˜ì§€ ì•Šì•˜ê³ , í˜„ì¬ íˆ¬ìì¤‘ì´ ì•„ë‹Œ ì¢…ëª©)
            # =============================================================================
            if stock_code not in today_sell_code and IsAlReadyInvest == False:

                #ì½”ìŠ¤ë‹¥ ë§¤ë„ê°€ ì¼ì–´ë‚¬ëŠ”ë° í˜„ì¬ ë˜ ì½”ìŠ¤í”¼ì— ë³´ìœ ì¤‘ì¸ ì¢…ëª©ì´ ìˆë‹¤ë©´ ì½”ìŠ¤ë‹¥ ë§¤ë„ëŠ” ì¥ì¤‘ ë§¤ë„ë‹ˆê¹ ì´ë•ŒëŠ” ë§¤ë„í•˜ì§€ ì•ŠìŒ!
                #if Kosdaq_sell_cnt == 1 and len(NowInvestList) == 1:
                #    continue

                # =============================================================================
                # í˜„ì¬ ì¢…ëª© ë°ì´í„° ì¶”ì¶œ
                # =============================================================================
                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]
                
                # =============================================================================
                # ì½”ìŠ¤ë‹¥ ì¢…ëª© ë§¤ìˆ˜ ì „ëµ (ë³€ë™ì„± ëŒíŒŒ ì „ëµ)
                # =============================================================================
                ####!!!!ì½”ìŠ¤ë‹¥ ì „ëµ!!!####
                if stock_code in ["233740","251340"]:
                    

                    # =============================================================================
                    # ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
                    # =============================================================================
                    PrevClosePrice = stock_data['prevClose'].values[0]  # ì „ì¼ ì¢…ê°€

                    # ê¸°ë³¸ ëŒíŒŒ ë¹„ìœ¨ ì„¤ì •
                    DolpaRate = 0.4

                    # =============================================================================
                    # ì¢…ëª©ë³„ ëŒíŒŒ ë¹„ìœ¨ ì„¤ì •
                    # =============================================================================
                    #KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤ (ì¸ë²„ìŠ¤ ì¢…ëª©)
                    if stock_code == "251340":
                        DolpaRate = 0.4  # ê³ ì • 0.4

                    #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€ (ë ˆë²„ë¦¬ì§€ ì¢…ëª©)
                    else: 
                        # 60ì¼ ì´ë™í‰ê·  ê¸°ì¤€ìœ¼ë¡œ ëŒíŒŒ ë¹„ìœ¨ ì¡°ì •
                        if PrevClosePrice > stock_data['ma60_before'].values[0]:
                            DolpaRate = 0.3  # ìƒìŠ¹ì¥ì—ì„œëŠ” 0.3 (ë” ë³´ìˆ˜ì )
                        else:
                            DolpaRate = 0.4  # í•˜ë½ì¥ì—ì„œëŠ” 0.4

                    # =============================================================================
                    # ê°­ ìƒìŠ¹/í•˜ë½ì„ ì´ìš©í•œ ëŒíŒŒê°’ ì¡°ì ˆ
                    # =============================================================================
                    ##########################################################################
                    #ê°­ ìƒìŠ¹ í•˜ë½ì„ ì´ìš©í•œ ëŒíŒŒê°’ ì¡°ì ˆ!
                    # https://blog.naver.com/zacra/223277173514 ì´ í¬ìŠ¤íŒ…ì„ ì²´í¬!!!!
                    ##########################################################################
                    
                    # ê°­ í¬ê¸° ê³„ì‚° (ì‹œê°€ì™€ ì „ì¼ ì¢…ê°€ì˜ ì°¨ì´ìœ¨)
                    Gap = ((abs(stock_data['open'].values[0] - PrevClosePrice) / PrevClosePrice)) * 100.0

                    # ê°­ì— ë”°ë¥¸ ì¡°ì ˆ ë¹„ìœ¨ ê³„ì‚°
                    GapSt = (Gap*0.025)

                    # ì¡°ì ˆ ë¹„ìœ¨ ë²”ìœ„ ì œí•œ
                    if GapSt > 1.0:
                        GapSt = 1.0
                    if GapSt < 0:
                        GapSt = 0.1

                    # ê°­ ìƒìŠ¹ ì‹œ (ì‹œê°€ > ì „ì¼ ì¢…ê°€): ëŒíŒŒ ë¹„ìœ¨ ì¦ê°€
                    if PrevClosePrice > stock_data['open'].values[0] and Gap >= 3.0:
                        DolpaRate *= (1.0 + GapSt)

                    # ê°­ í•˜ë½ ì‹œ (ì‹œê°€ < ì „ì¼ ì¢…ê°€): ëŒíŒŒ ë¹„ìœ¨ ê°ì†Œ
                    if PrevClosePrice < stock_data['open'].values[0] and Gap >= 3.0:
                        DolpaRate *= (1.0 - GapSt)


                    # =============================================================================
                    # ë³€ë™ì„± ëŒíŒŒ ê°€ê²© ê³„ì‚°
                    # =============================================================================
                    #ë³€ë™ì„± ëŒíŒŒ ì‹œê°€ + (ì „ì¼ê³ ê°€-ì „ì¼ì €ê°€)*DolpaRate
                    DolPaPrice = stock_data['open'].values[0] + ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * DolpaRate)

                    # ë§¤ìˆ˜ ì‹¤í–‰ ì—¬ë¶€
                    IsBuyGo = False

                    # ëŒíŒŒ ë¹„ìœ¨ ê³„ì‚° (ë°±ë¶„ìœ¨)
                    DolPaRate = (DolPaPrice - stock_data['open'].values[0]) / stock_data['open'].values[0] * 100

                    # =============================================================================
                    # ëŒíŒŒ í™•ì¸ ë° ë§¤ìˆ˜ ì¡°ê±´ ì²´í¬
                    # =============================================================================
                    #ëŒíŒŒ í–ˆë‹¤ë©´ ë§¤ìˆ˜ ê³ ???
                    # ëŒíŒŒê°€ê°€ í˜„ì¬ ê³ ê°€ë³´ë‹¤ ë‚®ìœ¼ë©´ ëŒíŒŒ ë°œìƒ
                    if DolPaPrice <= stock_data['high'].values[0]  :

                        IsBuyGo = True

                        # =============================================================================
                        # ì¶”ê°€ í•„í„°ë§ ë¡œì§ (ë§¤ìˆ˜ ì¡°ê±´ ë§Œì¡± ì‹œì—ë„ ì¶”ê°€ ê²€ì¦)
                        # =============================================================================
                        #ì¶”ê°€ í•„í„°ë¥¼ ê±°ì³ ì•„ë˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë§¤ìˆ˜í•˜ì§€ ì•ŠëŠ”ë‹¤!

                        # =============================================================================
                        # ì¢…ëª©ë³„ ì¶”ê°€ í•„í„°
                        # =============================================================================
                        #KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤ (ì¸ë²„ìŠ¤ ì¢…ëª©)
                        if stock_code == "251340":
                            # ì „ì¼ ì¢…ê°€ê°€ 20ì¼ ì´ë™í‰ê·  ì´í•˜ë©´ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ
                            if stock_data['prevClose'].values[0] <= stock_data['ma20_before'].values[0]:
                                IsBuyGo = False 
        
                        #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€ (ë ˆë²„ë¦¬ì§€ ì¢…ëª©)
                        else: 
                            # ì „ì¼ ì €ê°€ê°€ ì‹œê°€ë³´ë‹¤ ë†’ê³ , ì „ì¼ ì¢…ê°€ê°€ 10ì¼ ì´ë™í‰ê·  ì´í•˜ë©´ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ
                            if stock_data['prevLow'].values[0] > stock_data['open'].values[0] and stock_data['prevClose'].values[0] < stock_data['ma10_before'].values[0]:
                                IsBuyGo = False 

                        # =============================================================================
                        # ì¶”ê°€ ê°œì„  ë¡œì§ (ì´ë™í‰ê·  ì •ë ¬ ë° ê°€ê²© êµ¬ê°„ í•„í„°)
                        # =============================================================================
                        # ì¶”ê°€ ê°œì„  ë¡œì§ https://blog.naver.com/zacra/223326173552 ì´ í¬ìŠ¤íŒ… ì°¸ê³ !!!!
                        
                        # ì´ë™í‰ê·  ì •ë ¬ í™•ì¸ (ìƒìŠ¹ ì¶”ì„¸)
                        IsJung = False    
                        if stock_data['ma10_before'].values[0] > stock_data['ma20_before'].values[0] > stock_data['ma60_before'].values[0] > stock_data['ma120_before'].values[0]:
                            IsJung = True
                            
                        # ì´ë™í‰ê· ì´ ì •ë ¬ë˜ì§€ ì•Šì€ ê²½ìš° ì¶”ê°€ í•„í„° ì ìš©
                        if IsJung == False:
                            # ìµœê·¼ êµ¬ê°„ì˜ ê³ ê°€/ì €ê°€ ê³„ì‚°
                            high_price = stock_data['high_'+str(gugan_lenth)+'_max'].values[0] 
                            low_price =  stock_data['low_'+str(gugan_lenth)+'_min'].values[0] 
                            
                            # êµ¬ê°„ì„ 4ë“±ë¶„í•˜ì—¬ ìƒìœ„ 25% êµ¬ê°„ ê³„ì‚°
                            Gap = (high_price - low_price) / 4
                            
                            # ìƒìœ„ 25% êµ¬ê°„ì˜ ìµœëŒ€ ê°€ê²©
                            MaximunPrice = low_price + Gap * 3.0
                            
                            # ì‹œê°€ê°€ ìƒìœ„ 25% êµ¬ê°„ì„ ë„˜ìœ¼ë©´ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ (ê³¼ë§¤ìˆ˜ êµ¬ê°„)
                            if stock_data['open'].values[0] > MaximunPrice:
                                IsBuyGo = False
            
                        
                            
                            
                    # =============================================================================
                    # ì½”ìŠ¤ë‹¥ ë§¤ìˆ˜ ì‹¤í–‰ ë° íˆ¬ì ë¹„ì¤‘ ê²°ì •
                    # =============================================================================
                    if IsBuyGo == True :
     
                        # =============================================================================
                        # ê¸°ë³¸ íˆ¬ì ë¹„ìœ¨ ì„¤ì •
                        # =============================================================================
                        Rate = 1.0

                        # =============================================================================
                        # ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ë¥¼ í†µí•œ ë¹„ì¤‘ ì¡°ì ˆ!
                        # =============================================================================
                        #ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ë¥¼ í†µí•œ ë¹„ì¤‘ ì¡°ì ˆ!
                        if len(Kosdaq_Long_Data) == 1 and len(Kosdaq_Short_Data) == 1:
                        
                            # ëª¨ë©˜í…€ ìŠ¤ì½”ì–´ ë¹„êµ (ë ˆë²„ë¦¬ì§€ vs ì¸ë²„ìŠ¤)
                            IsLongStrong = False
                            
                            if Kosdaq_Long_Data['Average_Momentum'].values[0] > Kosdaq_Short_Data['Average_Momentum'].values[0]:
                                IsLongStrong = True
                                
                            # ë³€í™”ìœ¨ ì´ë™í‰ê·  ë¹„êµ
                            IsLongStrong2 = False
                            
                            if Kosdaq_Long_Data['prevChangeMa'].values[0] > Kosdaq_Short_Data['prevChangeMa'].values[0]:
                                IsLongStrong2 = True
                                
                            # =============================================================================
                            # ëª¨ë©˜í…€ ê¸°ë°˜ ë¹„ì¤‘ ì¡°ì ˆ ë¡œì§
                            # =============================================================================
                            # ë ˆë²„ë¦¬ì§€ê°€ ê°•í•  ë•Œ
                            if IsLongStrong == True and IsLongStrong2 == True:
                                
                                if stock_code == "233740":  # ë ˆë²„ë¦¬ì§€ ì¢…ëª©
                                    Rate = 1.3  # ë¹„ì¤‘ ì¦ê°€
                                else:  # ì¸ë²„ìŠ¤ ì¢…ëª©
                                    Rate = 0.7  # ë¹„ì¤‘ ê°ì†Œ
                                    
                            # ì¸ë²„ìŠ¤ê°€ ê°•í•  ë•Œ
                            elif IsLongStrong == False and IsLongStrong2 == False:
                                    
                                if stock_code == "233740":  # ë ˆë²„ë¦¬ì§€ ì¢…ëª©
                                    Rate = 0.7  # ë¹„ì¤‘ ê°ì†Œ
                                else:  # ì¸ë²„ìŠ¤ ì¢…ëª©
                                    Rate = 1.3  # ë¹„ì¤‘ ì¦ê°€
                                    
                        # =============================================================================
                        # íˆ¬ì ê¸ˆì•¡ ê³„ì‚°
                        # =============================================================================
                        #InvestGoMoney = (InvestMoney / len(InvestStockList)) * Rate
                        InvestGoMoney = 0
                        
                        # =============================================================================
                        # ì‹œìŠ¤í…œ ì†ì ˆ ê´€ë ¨ íˆ¬ì ë¹„ìœ¨ ì¡°ì ˆ
                        # =============================================================================
                        #############################################################
                        #ì‹œìŠ¤í…œ ì†ì ˆ(?) ê´€ë ¨
                        # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ… ì²´í¬!!!
                        #############################################################
                        AdjustRate = 1.0

                        # ì—°ì† ì†ì ˆì´ 2íšŒ ì´ìƒ ë°œìƒí•œ ê²½ìš°
                        if IsCut == True and IsCutCnt >= 2:
                            
                            # ì „ì¼ í•˜ë½ì¥ì´ê³  ê³ ê°€ê°€ ìƒìŠ¹í•œ ê²½ìš°
                            if stock_data['prevOpen'].values[0] > stock_data['prevClose'].values[0] and stock_data['prevHigh2'].values[0] > stock_data['prevHigh'].values[0]:
                                
                                # ì—°ì† ì†ì ˆì´ 4íšŒ ì´ìƒì´ë©´ ë” ë³´ìˆ˜ì ìœ¼ë¡œ ì¡°ì ˆ
                                if IsCutCnt >= 4:
                                    AdjustRate = stock_data['Average_Momentum3'].values[0] * 0.5
                                    
                                else:
                                    AdjustRate =  stock_data['Average_Momentum3'].values[0]

                        # =============================================================================
                        # ìƒˆë¡œìš´ íˆ¬ì ë¹„ìœ¨ ì‹œìŠ¤í…œ ì ìš© (ì½”ìŠ¤ë‹¥ ì¢…ëª©)
                        # =============================================================================
                        # íš¡ë³´ì¥ì¸ ê²½ìš°
                        if IsNoWay == True:
                            InvestGoMoney = ((RemainInvestMoney - Kosdaq_sell_money_furture) / len(InvestStockList)) * AdjustRate
                        else:
                            # í˜„ì¬ íˆ¬ìì¤‘ì¸ ì¢…ëª© ìˆ˜ ê³„ì‚°
                            current_invest_count = len(NowInvestList)
                            
                            # ìƒˆë¡œìš´ íˆ¬ì ë¹„ìœ¨ ë¡œì§
                            if current_invest_count == 0:
                                # ì²« ë²ˆì§¸ ì¢…ëª©: 100% íˆ¬ì
                                InvestGoMoney = (RemainInvestMoney - Kosdaq_sell_money_furture) * AdjustRate
                            elif current_invest_count == 1:
                                # ë‘ ë²ˆì§¸ ì¢…ëª©: ê¸°ì¡´ ì¢…ëª© ë§¤ë„ í›„ 50:50 ë¶„ë°°
                                existing_invest = NowInvestList[0]['InvestMoney']
                                sell_amount = existing_invest * 0.5  # ê¸°ì¡´ íˆ¬ìê¸ˆì˜ ì ˆë°˜ ë§¤ë„
                                
                                # ê¸°ì¡´ íˆ¬ìê¸ˆ ì¡°ì •
                                NowInvestList[0]['InvestMoney'] = existing_invest * 0.5
                                RemainInvestMoney += sell_amount * (1.0 - fee)  # ìˆ˜ìˆ˜ë£Œ ì°¨ê° í›„ í˜„ê¸ˆ ì¶”ê°€
                                
                                new_total = (RemainInvestMoney - Kosdaq_sell_money_furture)
                                InvestGoMoney = new_total * 0.5 * AdjustRate  # ìƒˆë¡œìš´ ì¢…ëª©ì— 50% íˆ¬ì
                                
                                logging.info(f"ê¸°ì¡´ íˆ¬ìê¸ˆ ì ˆë°˜ ë§¤ë„: {GetStockName(NowInvestList[0]['stock_code'], StockDataList)} -> {round(sell_amount,2)}")
                                
                            else:
                                # 2ê°œ ì´ìƒì¸ ê²½ìš°: ë” ì´ìƒ íˆ¬ìí•˜ì§€ ì•ŠìŒ
                                InvestGoMoney = 0
                    
                   
                        # =============================================================================
                        # ë§¤ìˆ˜ ì‹¤í–‰ ë° íˆ¬ì ë°ì´í„° ìƒì„±
                        # =============================================================================
                        if InvestGoMoney > 0 and AdjustRate > 0:

                            # =============================================================================
                            # ë§¤ìˆ˜ ìˆ˜ëŸ‰ ê³„ì‚°
                            # =============================================================================
                            BuyAmt = int(InvestGoMoney /  DolPaPrice) #ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ êµ¬í•œë‹¤!

                            NowFee = (BuyAmt*DolPaPrice) * fee

                            # =============================================================================
                            # ìê¸ˆ ë¶€ì¡± ì‹œ ìˆ˜ëŸ‰ ì¡°ì •
                            # =============================================================================
                            #ë§¤ìˆ˜í•´ì•¼ ë˜ëŠ”ë° ë‚¨ì€ëˆì´ ë¶€ì¡±í•˜ë‹¤ë©´ ìˆ˜ëŸ‰ì„ í•˜ë‚˜ì”© ê°ì†Œì‹œì¼œ ë§Œì¡±í•  ë•Œ ë§¤ìˆ˜í•œë‹¤!!
                            while (RemainInvestMoney - Kosdaq_sell_money_furture)  < (BuyAmt*DolPaPrice) + NowFee:
                                if (RemainInvestMoney - Kosdaq_sell_money_furture)  > DolPaPrice:
                                    BuyAmt -= 1
                                    NowFee = (BuyAmt*DolPaPrice) * fee
                                else:
                                    break
                            
                            # =============================================================================
                            # ë§¤ìˆ˜ ì‹¤í–‰ ë° íˆ¬ì ë°ì´í„° ìƒì„±
                            # =============================================================================
                            if BuyAmt > 0:

                                # ì‹¤ì œ íˆ¬ì ê¸ˆì•¡ ê³„ì‚°
                                RealInvestMoney = (BuyAmt*DolPaPrice) #ì‹¤ì œ ë“¤ì–´ê°„ íˆ¬ìê¸ˆ

                                # ë‚¨ì€ íˆ¬ìê¸ˆ ì°¨ê°
                                RemainInvestMoney -= (BuyAmt*DolPaPrice) #ë‚¨ì€ íˆ¬ìê¸ˆ!
                                RemainInvestMoney -= NowFee

                                # =============================================================================
                                # íˆ¬ì ë°ì´í„° ìƒì„±
                                # =============================================================================
                                InvestData = dict()

                                InvestData['stock_code'] = stock_code      # ì¢…ëª© ì½”ë“œ
                                InvestData['InvestMoney'] = RealInvestMoney # í˜„ì¬ íˆ¬ì ê¸ˆì•¡
                                InvestData['FirstMoney'] = RealInvestMoney  # ìµœì´ˆ íˆ¬ì ê¸ˆì•¡
                                InvestData['BuyPrice'] = DolPaPrice        # ë§¤ìˆ˜ ê°€ê²©
                                InvestData['DolPaCheck'] = False           # ì²« ë§¤ë„ ì—¬ë¶€
                                InvestData['Date'] = str(date)             # ë§¤ìˆ˜ ë‚ ì§œ

                                # íˆ¬ì ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                                NowInvestList.append(InvestData)

                                # =============================================================================
                                # ì´ íˆ¬ì ê¸ˆì•¡ ì—…ë°ì´íŠ¸
                                # =============================================================================
                                NowInvestMoney = 0
                                for iData in NowInvestList:
                                    NowInvestMoney += iData['InvestMoney']

                                InvestMoney = RemainInvestMoney + NowInvestMoney

                                # ë§¤ìˆ˜ ë¡œê·¸ ì¶œë ¥
                                logging.info(f"{str(date)} {GetStockName(stock_code, StockDataList)} ({stock_code}) {i} >>\n ë§¤ìˆ˜! ,ë§¤ìˆ˜ê¸ˆì•¡:{round(RealInvestMoney,2)} , ëŒíŒŒê°€ê²©:{DolPaPrice}, ì‹œê°€:{stock_data['open'].values[0]}")

        

       


    
    # =============================================================================
    # ì¼ë³„ í¬íŠ¸í´ë¦¬ì˜¤ ìƒíƒœ ì—…ë°ì´íŠ¸
    # =============================================================================
    # í˜„ì¬ íˆ¬ìì¤‘ì¸ ì¢…ëª©ë“¤ì˜ ì´ íˆ¬ìê¸ˆ ê³„ì‚°
    NowInvestMoney = 0

    for iData in NowInvestList:
        NowInvestMoney += iData['InvestMoney']

    # ì´ ìì‚° ê³„ì‚° (í˜„ê¸ˆ + íˆ¬ìê¸ˆ)
    InvestMoney = RemainInvestMoney + NowInvestMoney

    # =============================================================================
    # íˆ¬ì í˜„í™© ë¡œê·¸ ì¶œë ¥
    # =============================================================================
    InvestCoinListStr = ""
    #print("\n\n------------------------------------")
    for iData in NowInvestList:
        InvestCoinListStr += GetStockName(iData['stock_code'], StockDataList)  + " "

   # print("------------------------------------\n\n")

    # íˆ¬ì í˜„í™© ë¡œê·¸ ì¶œë ¥
    logging.info(f"{InvestCoinListStr} ---> íˆ¬ìê°œìˆ˜ : {len(NowInvestList)}")
    pprint.pprint(NowInvestList)
    logging.info(f"ì”ê³ :{str(InvestMoney)} = {str(RemainInvestMoney)} + {str(NowInvestMoney)}\n" )
    
    # ì¼ë³„ ì´ ìì‚° ë³€í™” ê¸°ë¡
    TotalMoneyList.append(InvestMoney)

    #####################################################
    #####################################################
    #####################################################
    #'''
    
   


# =============================================================================
# ë°±í…ŒìŠ¤íŒ… ê²°ê³¼ ë¶„ì„ ë° ì •ë¦¬
# =============================================================================
#ê²°ê³¼ ì •ë¦¬ ë° ë°ì´í„° ë§Œë“¤ê¸°!!
if len(TotalMoneyList) > 0:

    logging.info(f"TotalMoneyList -> {len(TotalMoneyList)}")

    # =============================================================================
    # ê²°ê³¼ ë°ì´í„° êµ¬ì¡° ìƒì„±
    # =============================================================================
    resultData = dict()

    # Create the result DataFrame with matching shapes
    # ì¼ë³„ ì´ ìì‚° ë³€í™”ë¥¼ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
    result_df = pd.DataFrame({"Total_Money": TotalMoneyList}, index=combined_df.index.unique())

    # =============================================================================
    # ì„±ê³¼ ì§€í‘œ ê³„ì‚°
    # =============================================================================
    result_df['Ror'] = np.nan_to_num(result_df['Total_Money'].pct_change()) + 1        # ì¼ë³„ ìˆ˜ìµë¥ 
    result_df['Cum_Ror'] = result_df['Ror'].cumprod()                                   # ëˆ„ì  ìˆ˜ìµë¥ 
    result_df['Highwatermark'] = result_df['Cum_Ror'].cummax()                          # ìµœê³ ì 
    result_df['Drawdown'] = (result_df['Cum_Ror'] / result_df['Highwatermark']) - 1    # ë“œë¡œìš°ë‹¤ìš´
    result_df['MaxDrawdown'] = result_df['Drawdown'].cummin()                           # ìµœëŒ€ ë“œë¡œìš°ë‹¤ìš´

    logging.info(f">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")
    pprint.pprint(result_df)
    logging.info(f">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>")

    # =============================================================================
    # ìµœì¢… ê²°ê³¼ ë°ì´í„° ì •ë¦¬
    # =============================================================================
    resultData['DateStr'] = str(FirstDateStr) + " ~ " + str(result_df.iloc[-1].name)    # ë°±í…ŒìŠ¤íŒ… ê¸°ê°„

    resultData['OriMoney'] = result_df['Total_Money'].iloc[0]                           # ì´ˆê¸° ìì‚°
    resultData['FinalMoney'] = result_df['Total_Money'].iloc[-1]                        # ìµœì¢… ìì‚°
    resultData['RevenueRate'] = ((result_df['Cum_Ror'].iloc[-1] -1.0)* 100.0)          # ì´ ìˆ˜ìµë¥ 

    resultData['MDD'] = result_df['MaxDrawdown'].min() * 100.0                          # ìµœëŒ€ ë“œë¡œìš°ë‹¤ìš´

    resultData['TryCnt'] = TryCnt                                                        # ì´ ë§¤ë§¤ íšŸìˆ˜
    resultData['SuccesCnt'] = SuccesCnt                                                  # ì„±ê³µ íšŸìˆ˜
    resultData['FailCnt'] = FailCnt                                                      # ì‹¤íŒ¨ íšŸìˆ˜

    
    ResultList.append(resultData)
    
    
    result_df.index = pd.to_datetime(result_df.index)

    #'''
    # charts í´ë” ìƒì„±
    charts_dir = os.path.join(script_dir, "charts")
    if not os.path.exists(charts_dir):
        os.makedirs(charts_dir)
    
    # Create a figure with subplots for the two charts
    fig, axs = plt.subplots(2, 1, figsize=(10, 10))

    # Plot the return chart
    axs[0].plot(result_df['Cum_Ror'] * 100, label='Strategy')
    axs[0].set_ylabel('Cumulative Return (%)')
    axs[0].set_title('Return Comparison Chart')
    axs[0].legend()

    # Plot the MDD and DD chart on the same graph
    axs[1].plot(result_df.index, result_df['MaxDrawdown'] * 100, label='MDD')
    axs[1].plot(result_df.index, result_df['Drawdown'] * 100, label='Drawdown')
    axs[1].set_ylabel('Drawdown (%)')
    axs[1].set_title('Drawdown Comparison Chart')
    axs[1].legend()

    # Save the plot to charts folder (ë®ì–´ì“°ê¸°)
    plt.tight_layout()
    chart_filename = os.path.join(charts_dir, "Kosdaqpi_Test2.png")
    plt.savefig(chart_filename, dpi=300, bbox_inches='tight')
    logging.info(f"ì°¨íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {chart_filename}")
    plt.show()
        
    #'''
    
    


    for idx, row in result_df.iterrows():
        logging.info(f"{idx}  {row['Total_Money']}  {row['Cum_Ror']}")
        



#ë°ì´í„°ë¥¼ ë³´ê¸°ì¢‹ê²Œ í”„ë¦°íŠ¸ í•´ì£¼ëŠ” ë¡œì§!
logging.info("\n\n--------------------")


for result in ResultList:

    logging.info(f"--->>> {result['DateStr'].replace('00:00:00','')} <<<---")

    for stock_data in StockDataList:
        logging.info(f"{stock_data['stock_name']} ({stock_data['stock_code']})")
        if stock_data['try'] > 0:
            logging.info(f"ì„±ê³µ: {stock_data['success']} ì‹¤íŒ¨: {stock_data['fail']}, -> ìŠ¹ë¥ : {round(stock_data['success']/stock_data['try'] * 100.0,2)} %")
            logging.info(f"ë§¤ë§¤ë‹¹ í‰ê·  ìˆ˜ìµë¥ : {round(stock_data['accRev']/ stock_data['try'],2)}")
        logging.info("")

    logging.info("---------- ì´ ê²°ê³¼ ----------")
    logging.info(f"ìµœì´ˆ ê¸ˆì•¡: {format(int(round(TotalMoney,0)), ',')} ìµœì¢… ê¸ˆì•¡: {format(int(round(result['FinalMoney'],0)), ',')} \nìˆ˜ìµë¥ : {round(((round(result['FinalMoney'],2) - round(TotalMoney,2) ) / round(TotalMoney,2) ) * 100,2)}% MDD: {round(result['MDD'],2)}%")
    if result['TryCnt'] > 0:
        logging.info(f"ì„±ê³µ: {result['SuccesCnt']} ì‹¤íŒ¨: {result['FailCnt']}, -> ìŠ¹ë¥ : {round(result['SuccesCnt']/result['TryCnt'] * 100.0,2)} %")

    logging.info("------------------------------")
    logging.info("####################################")
