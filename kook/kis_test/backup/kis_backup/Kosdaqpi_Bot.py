#-*-coding:utf-8 -*-
'''

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
ì½”ë“œ ì°¸ê³  ì˜ìƒ!
https://youtu.be/YdEdM-oC0kc
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$


$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

í•´ë‹¹ ì»¨í…ì¸ ëŠ” ì œê°€ ì§ì ‘ íˆ¬ì í•˜ê¸° ìœ„í•´ ì´ ì „ëµì„ ì¶”ê°€ ê°œì„ í•´ì„œ ë” ì¢‹ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì£¼ëŠ” ê°œì¸ ì „ëµì´ ì¡´ì¬í•©ë‹ˆë‹¤. 

ê²Œë§Œì•„ ì¶”ê°€ ê°œì„  ê°œì¸ ì „ëµë“¤..
https://blog.naver.com/zacra/223196497504

ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ ìœ„ í¬ìŠ¤íŒ…ì„ ì°¸ê³ í•˜ì„¸ìš”!

$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



ê´€ë ¨ í¬ìŠ¤íŒ…

ì½”ìŠ¤ë‹¥ ì½”ìŠ¤í”¼ ì–‘ë°©í–¥ìœ¼ë¡œ íˆ¬ìí•˜ëŠ” ì „ëµ! ì´ˆì „ë„ì²´ LK99ì— ë²„ê¸ˆê°€ëŠ” ë°œê²¬!!
https://blog.naver.com/zacra/223177598281

ìœ„ í¬ìŠ¤íŒ…ì„ ê¼­ ì°¸ê³ í•˜ì„¸ìš”!!!


ğŸ“Œ [ì½”ë“œ ì œê³µ ëª©ì ]

ì´ ì½”ë“œëŠ” í´ë˜ìŠ¤101 ê²Œë§Œì•„ <íŒŒì´ì¬ ìë™ë§¤ë§¤ ë´‡ ë§Œë“¤ê¸°> ê°•ì˜ì˜ ë³´ì¡° ìë£Œë¡œ ì œê³µë˜ë©°,  
ê°•ì˜ ìˆ˜ê°•ìƒì˜ **í•™ìŠµ ë° ì‹¤ìŠµì„ ìœ„í•œ ì°¸ê³ ìš© ì˜ˆì‹œ ì½”ë“œ**ì…ë‹ˆë‹¤.  
**íˆ¬ì ê¶Œìœ , ì¢…ëª© ì¶”ì²œ, ìë¬¸ ë˜ëŠ” ì¼ì„ì„ ìœ„í•œ ëª©ì ì€ ì „í˜€ ì—†ìŠµë‹ˆë‹¤.**

ğŸ“Œ [ê¸°ìˆ  êµ¬í˜„ ê´€ë ¨ ì•ˆë‚´]

- ë³¸ ì½”ë“œëŠ” **ì¦ê¶Œì‚¬ì—ì„œ ê³µì‹ì ìœ¼ë¡œ ì œê³µí•œ API** ë°  
  **ê³µì‹ ê°œë°œì ê°€ì´ë“œ ë¬¸ì„œ**ì— ë”°ë¼ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.
- í•´ë‹¹ APIëŠ” ì¼ë°˜ íˆ¬ìì ëˆ„êµ¬ë‚˜ ì´ìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ì´ë©°,  
  ë³¸ ì½”ë“œëŠ” ê·¸ê²ƒì„ êµ¬í˜„í•œ ì˜ˆì‹œë¥¼ í™œìš©í•´ ì „ëµì„ êµ¬í˜„í•´ë³´ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œ í™œìš©í•œ ê²ƒì…ë‹ˆë‹¤.

ğŸ“Œ [ì „ëµ ì‹¤í–‰ ì¡°ê±´]

- ë³¸ ì½”ë“œëŠ” ìë™ ë°˜ë³µ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ ì‹¤í–‰í•´ì•¼ 1íšŒ ë™ì‘í•©ë‹ˆë‹¤.
- ë°˜ë³µ ì‹¤í–‰ì„ ì›í•  ê²½ìš°, ì‚¬ìš©ìê°€ ë³„ë„ë¡œ ì„œë²„ ë° ìŠ¤ì¼€ì¤„ëŸ¬ êµ¬ì„±ì„ í•´ì•¼ í•©ë‹ˆë‹¤.


- ë³¸ ì½”ë“œì—ëŠ” ì¦ê¶Œì‚¬ ì œê³µ APIë¥¼ í™œìš©í•œ ë§¤ë§¤ ê¸°ëŠ¥ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë‚˜,  
  **ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ì„ ë³€ê²½í•˜ì§€ ì•ŠëŠ” í•œ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
  

- ì „ëµ ì‹¤í–‰ì„ ìœ„í•´ì„œëŠ” ë‹¤ìŒì˜ ê³¼ì •ì„ **ì‚¬ìš©ìê°€ ì§ì ‘** ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤:

  1. `ENABLE_ORDER_EXECUTION` ê°’ì„ `True`ë¡œ ë³€ê²½  
  2. `InvestRate` ë¹„ì¤‘ì„ ì„¤ì • (ê¸°ë³¸ê°’: 0)  
  3. ë§¤ìˆ˜í•  ì¢…ëª©ì„ ëª…ì‹œ (ê¸°ë³¸ê°’: ë¹ˆ ë¦¬ìŠ¤íŠ¸)  
  4. AWS ë˜ëŠ” ê°œì¸ ì„œë²„ êµ¬ì¶• ë° `crontab` ë˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡

- ì œê³µìëŠ” ì„œë²„ êµ¬ì¶•, ì„¤ì •, ì‹¤í–‰ ëŒ€í–‰ ë“±ì„ ì „í˜€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ğŸ“Œ [ë²•ì  ì±…ì„ ê³ ì§€]

- ì œê³µë˜ëŠ” ì½”ë“œëŠ” ê¸°ìˆ  í•™ìŠµ ë° í…ŒìŠ¤íŠ¸ ëª©ì ì˜ ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.  
- **ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì´ë©°, ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

- ë³¸ ì½”ë“œì˜ ì‚¬ìš©, ìˆ˜ì •, ì‹¤í–‰ì— ë”°ë¥¸ ëª¨ë“  ê²°ê³¼ì™€ ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°,  
  **ì œê³µìëŠ” ë²•ì Â·ê¸ˆì „ì  ì±…ì„ì„ ì¼ì ˆ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.**

ğŸ“Œ [ì €ì‘ê¶Œ ì•ˆë‚´]

- ì´ ì½”ë“œëŠ” ì €ì‘ê¶Œë²• ë° ë¶€ì •ê²½ìŸë°©ì§€ë²•ì˜ ë³´í˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.  
- ë¬´ë‹¨ ë³µì œ, ê³µìœ , ì¬íŒë§¤, ë°°í¬ ì‹œ ë¯¼Â·í˜•ì‚¬ìƒ ì±…ì„ì´ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ“Œ [í•™ìŠµ ê¶Œì¥ ì‚¬í•­]

- ë³¸ ì˜ˆì‹œ ì½”ë“œëŠ” ì „ëµ êµ¬í˜„ì„ ì´í•´í•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ì…ë‹ˆë‹¤.  
- ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìì‹ ë§Œì˜ ì „ëµì„ ê°œë°œí•´ë³´ì‹œê¸¸ ê¶Œì¥ë“œë¦½ë‹ˆë‹¤ :)


ì£¼ì‹/ì½”ì¸ ìë™ë§¤ë§¤ FAQ
https://blog.naver.com/zacra/223203988739

FAQë¡œ í•´ê²° ì•ˆë˜ëŠ” ê¸°ìˆ ì ì¸ ë¬¸ì œëŠ” í´ë˜ìŠ¤101 ê°•ì˜ì˜ ëŒ“ê¸€ì´ë‚˜ ìœ„ í¬ìŠ¤íŒ…ì— ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
íŒŒì´ì¬ ì½”ë”©ì— ëŒ€í•œ ë‹µë³€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. í˜„í–‰ë²• ìƒ íˆ¬ì ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ ë¶ˆê°€í•˜ë‹¤ëŠ” ì  ì•Œë ¤ë“œë ¤ìš”!

'''

import KIS_Common as Common
import KIS_API_Helper_KR as KisKR
import time
import pprint
import pandas as pd
import json
import os
import logging
import sys
from datetime import datetime

import sys
PARENT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if PARENT_DIR not in sys.path:
    sys.path.append(PARENT_DIR)
import telegram_sender as telegram
from portfolio_manager import portfolio_manager
# from KIS_KR_SplitTrader import MakeSplitBuyOrder, MakeSplitSellOrder

# ë¡œê¹… ì„¤ì •
script_dir = os.path.dirname(os.path.abspath(__file__))
logs_dir = os.path.join(script_dir, "logs")
os.makedirs(logs_dir, exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(os.path.join(logs_dir, 'Kosdaqpi_Bot.log'), mode='a', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

#ê³„ì¢Œ ì„ íƒ.. "VIRTUAL" ëŠ” ëª¨ì˜ ê³„ì¢Œ!
Common.SetChangeMode("REAL") #REAL or VIRTUAL

#####################################################################################################################################
'''
â€» ì£¼ë¬¸ ì‹¤í–‰ ì—¬ë¶€ ì„¤ì •

ENABLE_ORDER_EXECUTION ê°’ì„ Trueë¡œ ë³€ê²½í•  ê²½ìš°,  
ì „ëµì— ë”°ë¼ ë§¤ë§¤ê°€ ì¼ì–´ë‚©ë‹ˆë‹¤.

âš ï¸ ê¸°ë³¸ê°’ì€ Falseì´ë©°,  
ì‹¤í–‰ ì—¬ë¶€ëŠ” ì‚¬ìš©ì ë³¸ì¸ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
'''

ENABLE_ORDER_EXECUTION = True  # ì£¼ë¬¸ ì‹¤í–‰ ì—¬ë¶€ ì„¤ì • (ê¸°ë³¸ê°’: False)

'''
ğŸ“Œ ë³¸ ì „ëµì€ ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ëŠ” ì˜ˆì‹œ ì½”ë“œì´ë©°,  
ì‹¤ì œ íˆ¬ì ë° ì£¼ë¬¸ ì‹¤í–‰ì€ ì‚¬ìš©ì ë³¸ì¸ì˜ ì˜ì‚¬ì™€ ì±…ì„ í•˜ì— ìˆ˜í–‰ë©ë‹ˆë‹¤.
'''
#####################################################################################################################################

'''
ğŸ“Œ íˆ¬ìí•  ì¢…ëª©ì€ ë³¸ì¸ì˜ ì„ íƒìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”!
'''
#ì‹¤ì œ íˆ¬ì ì¢…ëª©!!!
# 122630 : KODEX ë ˆë²„ë¦¬ì§€
# 252670 : KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X
# 233740 : KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€
# 251340 : KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
InvestStockList = ["122630","252670","233740","251340"]

#####################################################################################################################################

'''
ğŸ“Œ íˆ¬ì ë¹„ì¤‘ ì„¤ì •!
ê¸°ë³¸ì€ 0ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ìš”.
ë³¸ì¸ì˜ íˆ¬ì ë¹„ì¤‘ì„ ì„¤ì •í•˜ì„¸ìš”! 

ì „ëµì—ì„œ í™œìš©í•  ì£¼ë¬¸ì´ 
ì‹œì¥ê°€ ì£¼ë¬¸ì´ë¼ë©´ 0 ~ 0.75 
ì§€ì •ê°€ ì£¼ë¬¸ì´ë¼ë©´ 0 ~ 0.98
ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”! (0.1 = 10% 0.5 = 50%)
'''
# í¬íŠ¸í´ë¦¬ì˜¤ ë§¤ë‹ˆì €ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
InvestRate = portfolio_manager.get_bot_allocation("Kosdaqpi_Bot")  # ì„¤ì • íŒŒì¼ì—ì„œ í• ë‹¹ ë¹„ìœ¨ ê°€ì ¸ì˜¤ê¸°
#####################################################################################################################################

BOT_NAME = Common.GetNowDist() + "autonam_Kospidaq_Bot"

#í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„
PortfolioName = "ì½”ìŠ¤í”¼ë‹¥ ë§¤ë§¤ ì „ëµ!"

#ì‹œê°„ ì •ë³´ë¥¼ ì½ëŠ”ë‹¤
time_info = time.gmtime()

day_n = time_info.tm_mday
day_str = str(time_info.tm_mon) + "-" + str(time_info.tm_mday)

logging.info(f"ë‚ ì§œ: {day_str}")

# ì£¼ë§ ê°€ë“œ: í† (5)/ì¼(6)ì—ëŠ” ì‹¤í–‰í•˜ì§€ ì•Šê³  ì¦‰ì‹œ ì¢…ë£Œ
now = datetime.now()
if now.weekday() >= 5:
    msg = f"{PortfolioName}({now.strftime('%Y-%m-%d')})\nì£¼ë§(í† /ì¼)ì—ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    logging.info(msg)
    sys.exit(0)

###################################################################
###################################################################
#ë¦¬ìŠ¤íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ë¦¬í„´!
def GetKospidaqStrategyData(stock_code,KospidaqStrategyList):
    ResultData = None
    for KospidaqStrategyData in KospidaqStrategyList:
        if KospidaqStrategyData['StockCode'] == stock_code:
            ResultData = KospidaqStrategyData
            break
    return ResultData

#íˆ¬ìê°œìˆ˜
def GetKospidaqInvestCnt(KospidaqStrategyList):
    
    MyStockList = KisKR.GetMyStockList()

    InvestCnt = 0
        
    for KospidaqStrategyData in KospidaqStrategyList:
        stock_code = KospidaqStrategyData['StockCode']
        
        stock_amt = 0
        #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
        for my_stock in MyStockList:
            if my_stock['StockCode'] == stock_code:
                stock_amt = int(my_stock['StockAmt'])
                break
            
        if stock_amt > 0:
            InvestCnt += 1
                  
    return InvestCnt

# ê±°ë˜ ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ë“¤
def save_trade_history(trade_type, stock_code, stock_name, quantity, unit_price, amount, fee=0):
    """ê±°ë˜ ë‚´ì—­ì„ Kosdaqpi_Bot_history.json íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤."""
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        history_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_history.json")
        
        # ê¸°ì¡´ ê±°ë˜ ë‚´ì—­ ì½ê¸°
        trade_history = []
        if os.path.exists(history_file_path):
            try:
                with open(history_file_path, 'r', encoding='utf-8') as f:
                    trade_history = json.load(f)
            except Exception as e:
                logging.error(f"ê±°ë˜ ë‚´ì—­ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {e}")
                trade_history = []
        
        # ìƒˆë¡œìš´ ê±°ë˜ ë‚´ì—­ ì¶”ê°€
        current_time = datetime.now()
        trade_record = {
            "ì¼ì": current_time.strftime("%Y-%m-%d %H:%M:%S"),
            "êµ¬ë¶„": trade_type,  # "êµ¬ë§¤" ë˜ëŠ” "íŒë§¤"
            "ì½”ë“œ": stock_code,
            "ë„¤ì„": stock_name,
            "ìˆ˜ëŸ‰": quantity,
            "ë‹¨ê°€": unit_price,
            "ê¸ˆì•¡": amount,
            "ìˆ˜ìˆ˜ë£Œ": fee
        }
        
        trade_history.append(trade_record)
        
        # íŒŒì¼ì— ì €ì¥
        with open(history_file_path, 'w', encoding='utf-8') as f:
            json.dump(trade_history, f, ensure_ascii=False, indent=4)
        
        logging.info(f"ê±°ë˜ ë‚´ì—­ ì €ì¥ ì™„ë£Œ: {trade_type} - {stock_name}({stock_code}) {quantity}ì£¼ @ {unit_price:,.0f}ì›")
        
    except Exception as e:
        logging.error(f"ê±°ë˜ ë‚´ì—­ ì €ì¥ ì¤‘ ì˜¤ë¥˜: {e}")

def save_buy_history(stock_code, stock_name, quantity, unit_price, amount, fee=0):
    """ë§¤ìˆ˜ ë‚´ì—­ì„ ì €ì¥í•©ë‹ˆë‹¤."""
    save_trade_history("êµ¬ë§¤", stock_code, stock_name, quantity, unit_price, amount, fee)

def save_sell_history(stock_code, stock_name, quantity, unit_price, amount, fee=0):
    """ë§¤ë„ ë‚´ì—­ì„ ì €ì¥í•©ë‹ˆë‹¤."""
    save_trade_history("íŒë§¤", stock_code, stock_name, quantity, unit_price, amount, fee)

def calculate_profit_from_history():
    """ê±°ë˜ ë‚´ì—­ì„ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ìµë¥ ì„ ê³„ì‚°í•©ë‹ˆë‹¤."""
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        history_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_history.json")
        
        if not os.path.exists(history_file_path):
            logging.warning("ê±°ë˜ ë‚´ì—­ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            return 0, 0, 0, 0
        
        with open(history_file_path, 'r', encoding='utf-8') as f:
            trade_history = json.load(f)
        
        # ì¢…ëª©ë³„ ë§¤ìˆ˜/ë§¤ë„ ë‚´ì—­ ì •ë¦¬
        stock_summary = {}
        
        for trade in trade_history:
            stock_code = trade['ì½”ë“œ']
            stock_name = trade['ë„¤ì„']
            trade_type = trade['êµ¬ë¶„']
            quantity = trade['ìˆ˜ëŸ‰']
            unit_price = trade['ë‹¨ê°€']
            amount = trade['ê¸ˆì•¡']
            
            if stock_code not in stock_summary:
                stock_summary[stock_code] = {
                    'name': stock_name,
                    'buy_quantity': 0,
                    'buy_amount': 0,
                    'sell_quantity': 0,
                    'sell_amount': 0,
                    'avg_buy_price': 0
                }
            
            if trade_type == "êµ¬ë§¤":
                stock_summary[stock_code]['buy_quantity'] += quantity
                stock_summary[stock_code]['buy_amount'] += amount
            elif trade_type == "íŒë§¤":
                stock_summary[stock_code]['sell_quantity'] += quantity
                stock_summary[stock_code]['sell_amount'] += amount
        
        # ìˆ˜ìµë¥  ê³„ì‚°
        total_profit = 0
        total_investment = 0
        total_realized_profit = 0
        
        for stock_code, summary in stock_summary.items():
            if summary['buy_quantity'] > 0:
                # í‰ê·  ë§¤ìˆ˜ê°€ ê³„ì‚°
                avg_buy_price = summary['buy_amount'] / summary['buy_quantity']
                summary['avg_buy_price'] = avg_buy_price
                
                # í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰
                current_quantity = summary['buy_quantity'] - summary['sell_quantity']
                
                if current_quantity > 0:
                    # í˜„ì¬ê°€ ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ í•„ìš”)
                    try:
                        current_price = KisKR.GetCurrentPrice(stock_code)
                        current_value = current_quantity * current_price
                        unrealized_profit = current_value - (current_quantity * avg_buy_price)
                        total_profit += unrealized_profit
                        total_investment += current_value
                    except Exception as e:
                        logging.warning(f"í˜„ì¬ê°€ ì¡°íšŒ ì‹¤íŒ¨ ({stock_code}): {e}")
                        # í˜„ì¬ê°€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ëŠ” ê²½ìš° í‰ê·  ë§¤ìˆ˜ê°€ë¡œ ê³„ì‚°
                        total_investment += current_quantity * avg_buy_price
                
                # ì‹¤í˜„ ì†ìµ ê³„ì‚°
                if summary['sell_quantity'] > 0:
                    realized_profit = summary['sell_amount'] - (summary['sell_quantity'] * avg_buy_price)
                    total_realized_profit += realized_profit
        
        # ì „ì²´ ìˆ˜ìµë¥  ê³„ì‚°
        profit_rate = 0
        if total_investment > 0:
            profit_rate = (total_profit / total_investment) * 100
        
        logging.info(f"ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ ê³„ì‚° ì™„ë£Œ:")
        logging.info(f"ì´ íˆ¬ìê¸ˆì•¡: {total_investment:,.0f}ì›")
        logging.info(f"ì´ í‰ê°€ì†ìµ: {total_profit:,.0f}ì›")
        logging.info(f"ì´ ì‹¤í˜„ì†ìµ: {total_realized_profit:,.0f}ì›")
        logging.info(f"ìˆ˜ìµë¥ : {profit_rate:.2f}%")
        
        return total_profit, profit_rate, total_investment, total_realized_profit
        
    except Exception as e:
        logging.error(f"ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ ê³„ì‚° ì¤‘ ì˜¤ë¥˜: {e}")
        return 0, 0, 0, 0

def get_trade_history_summary():
    """ê±°ë˜ ë‚´ì—­ ìš”ì•½ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        history_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_history.json")
        
        if not os.path.exists(history_file_path):
            return "ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."
        
        with open(history_file_path, 'r', encoding='utf-8') as f:
            trade_history = json.load(f)
        
        if not trade_history:
            return "ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."
        
        # ê±°ë˜ í†µê³„ ê³„ì‚°
        total_trades = len(trade_history)
        buy_trades = len([t for t in trade_history if t['êµ¬ë¶„'] == 'êµ¬ë§¤'])
        sell_trades = len([t for t in trade_history if t['êµ¬ë¶„'] == 'íŒë§¤'])
        
        # ì¢…ëª©ë³„ ê±°ë˜ ìš”ì•½
        stock_summary = {}
        for trade in trade_history:
            stock_code = trade['ì½”ë“œ']
            stock_name = trade['ë„¤ì„']
            trade_type = trade['êµ¬ë¶„']
            quantity = trade['ìˆ˜ëŸ‰']
            amount = trade['ê¸ˆì•¡']
            
            if stock_code not in stock_summary:
                stock_summary[stock_code] = {
                    'name': stock_name,
                    'total_buy_quantity': 0,
                    'total_buy_amount': 0,
                    'total_sell_quantity': 0,
                    'total_sell_amount': 0
                }
            
            if trade_type == 'êµ¬ë§¤':
                stock_summary[stock_code]['total_buy_quantity'] += quantity
                stock_summary[stock_code]['total_buy_amount'] += amount
            else:
                stock_summary[stock_code]['total_sell_quantity'] += quantity
                stock_summary[stock_code]['total_sell_amount'] += amount
        
        # ìš”ì•½ ë©”ì‹œì§€ ìƒì„±
        summary = f"ğŸ“Š Kosdaqpi_Bot ê±°ë˜ ë‚´ì—­ ìš”ì•½\n"
        summary += f"ì´ ê±°ë˜ ê±´ìˆ˜: {total_trades}ê±´ (ë§¤ìˆ˜: {buy_trades}ê±´, ë§¤ë„: {sell_trades}ê±´)\n\n"
        
        summary += "ì¢…ëª©ë³„ ê±°ë˜ í˜„í™©:\n"
        for stock_code, data in stock_summary.items():
            summary += f"â€¢ {data['name']} ({stock_code})\n"
            summary += f"  - ë§¤ìˆ˜: {data['total_buy_quantity']}ì£¼ ({data['total_buy_amount']:,.0f}ì›)\n"
            summary += f"  - ë§¤ë„: {data['total_sell_quantity']}ì£¼ ({data['total_sell_amount']:,.0f}ì›)\n"
            summary += f"  - ë³´ìœ : {data['total_buy_quantity'] - data['total_sell_quantity']}ì£¼\n\n"
        
        return summary
        
    except Exception as e:
        logging.error(f"ê±°ë˜ ë‚´ì—­ ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
        return f"ê±°ë˜ ë‚´ì—­ ìš”ì•½ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"

# íŒë§¤ ì‹œ ëˆ„ì  ìˆ˜ìµì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
def update_cumulative_profit_on_sale(stock_code, stock_amt, current_price, avg_price):
    """ì£¼ì‹ íŒë§¤ ì‹œ ëˆ„ì  ìˆ˜ìµì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    try:
        # íŒë§¤ ìˆ˜ìµ ê³„ì‚°
        sale_profit = (current_price - avg_price) * stock_amt
        
        # ì „ì—­ ë³€ìˆ˜ì— ëˆ„ì  ìˆ˜ìµ ì¶”ê°€
        global cumulative_profit
        if 'cumulative_profit' not in globals():
            cumulative_profit = 0
        cumulative_profit += sale_profit
        
        logging.info(f"ëˆ„ì  ìˆ˜ìµ ì—…ë°ì´íŠ¸: {stock_code} - íŒë§¤ ìˆ˜ìµ: {sale_profit:,.0f}ì›, ëˆ„ì : {cumulative_profit:,.0f}ì›")
        
    except Exception as e:
        logging.error(f"ëˆ„ì  ìˆ˜ìµ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}")

def initialize_period_profits():
    """ì¼ë³„, ì›”ë³„, ì—°ë³„ íŒë§¤ìˆ˜ìµ ì´ˆê¸°í™”"""
    try:
        # portfolio_config.json íŒŒì¼ ì½ê¸°
        script_dir = os.path.dirname(os.path.abspath(__file__))
        config_file_path = os.path.join(script_dir, "portfolio_config.json")
        
        with open(config_file_path, 'r', encoding='utf-8') as f:
            config_data = json.load(f)
        
        current_time = datetime.now()
        current_date = current_time.strftime("%Y-%m-%d")
        current_month = current_time.strftime("%Y-%m")
        current_year = current_time.strftime("%Y")
        
        # ë´‡ ì„¤ì •ì—ì„œ ë§ˆì§€ë§‰ ì´ˆê¸°í™” ì •ë³´ í™•ì¸
        bot_config = config_data['bots']['Kosdaqpi_Bot']
        
        last_daily = bot_config.get('last_daily_reset', '')
        last_monthly = bot_config.get('last_monthly_reset', '')
        last_yearly = bot_config.get('last_yearly_reset', '')
        
        # ì¼ë³„ ì´ˆê¸°í™” (ë§¤ì¼)
        if last_daily != current_date:
            bot_config['daily_sold_profit'] = 0
            bot_config['last_daily_reset'] = current_date
            logging.info(f"[{current_date}] ì¼ë³„ íŒë§¤ìˆ˜ìµ ì´ˆê¸°í™” ì™„ë£Œ")
            
        # ì›”ë³„ ì´ˆê¸°í™” (ë§¤ì›”)
        if last_monthly != current_month:
            bot_config['monthly_sold_profit'] = 0
            bot_config['last_monthly_reset'] = current_month
            logging.info(f"[{current_month}] ì›”ë³„ íŒë§¤ìˆ˜ìµ ì´ˆê¸°í™” ì™„ë£Œ")
            
        # ì—°ë³„ ì´ˆê¸°í™” (ë§¤ë…„)
        if last_yearly != current_year:
            bot_config['yearly_sold_profit'] = 0
            bot_config['last_yearly_reset'] = current_year
            logging.info(f"[{current_year}] ì—°ë³„ íŒë§¤ìˆ˜ìµ ì´ˆê¸°í™” ì™„ë£Œ")
            
        # ì„¤ì • ì €ì¥
        with open(config_file_path, 'w', encoding='utf-8') as f:
            json.dump(config_data, f, ensure_ascii=False, indent=4)
            
    except Exception as e:
        logging.error(f"ê¸°ê°„ë³„ ìˆ˜ìµ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")


#####################################################################################################################################

#ê³„ì¢Œ ì”ê³ ë¥¼ ê°€ì§€ê³  ì˜¨ë‹¤!
Balance = KisKR.GetBalance()
#####################################################################################################################################

'''-------í†µí•© ì¦ê±°ê¸ˆ ì‚¬ìš©ìëŠ” ì•„ë˜ ì½”ë“œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! -----------'''
#í†µí•©ì¦ê±°ê¸ˆ ê³„ì¢Œ ì‚¬ìš©ì ë¶„ë“¤ì¤‘ ë§Œì•½ ë¯¸êµ­ê³„ì¢Œë‘ í†µí•©í•´ì„œ ì´ìì‚°ì„ ê³„ì‚° í•˜ê³  í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ì—ë„ ë°˜ì˜í•˜ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´ ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë˜ê³  ë‚˜ë¨¸ì§€ëŠ” ë™ì¼í•©ë‹ˆë‹¤!!!
#Balance = Common.GetBalanceKrwTotal()

'''-----------------------------------------------------------'''
#####################################################################################################################################


logging.info("--------------ë‚´ ë³´ìœ  ì”ê³ ---------------------")

logging.info(f"ì”ê³  ì •ë³´: {Balance}")

logging.info("--------------------------------------------")


##########################################################

logging.info("--------------ë‚´ ë³´ìœ  ì£¼ì‹---------------------")
#ê·¸ë¦¬ê³  í˜„ì¬ ì´ ê³„ì¢Œì—ì„œ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì§€ê³  ì˜µë‹ˆë‹¤!
MyStockList = KisKR.GetMyStockList()
logging.info(f"ë³´ìœ  ì£¼ì‹ ì •ë³´: {MyStockList}")
logging.info("--------------------------------------------")
##########################################################





NowInvestMoney = 0

for stock_code in InvestStockList:
    stock_name = ""
    stock_amt = 0 #ìˆ˜ëŸ‰
    stock_avg_price = 0 #í‰ë‹¨

    #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
    for my_stock in MyStockList:
        if my_stock['StockCode'] == stock_code:
            stock_name = my_stock['StockName']
            stock_amt = int(my_stock['StockAmt'])
            stock_avg_price = float(my_stock['StockAvgPrice'])

            
            NowInvestMoney += (stock_amt*stock_avg_price)
            break



###################################################################
###################################################################
KospidaqStrategyList = list()
#íŒŒì¼ ê²½ë¡œì…ë‹ˆë‹¤.
script_dir = os.path.dirname(os.path.abspath(__file__))
data_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_Stock.json")

try:
    #ì´ ë¶€ë¶„ì´ íŒŒì¼ì„ ì½ì–´ì„œ ë¦¬ìŠ¤íŠ¸ì— ë„£ì–´ì£¼ëŠ” ë¡œì§ì…ë‹ˆë‹¤. 
    with open(data_file_path, 'r') as json_file:
        KospidaqStrategyList = json.load(json_file)

except Exception as e:
    logging.info("Init....")

    for stock_code in InvestStockList:
        KospidaqStrategyData = dict()
        KospidaqStrategyData['StockCode'] = stock_code #ëŒ€ìƒ ì¢…ëª© ì½”ë“œ
        KospidaqStrategyData['StockName'] = KisKR.GetStockName(stock_code) #ì¢…ëª© ì´ë¦„
        KospidaqStrategyData['Status'] = "REST" #ìƒíƒœ READY(ëŒíŒŒë¥¼ì²´í¬í•´ì•¼í•˜ëŠ” ì¤€ë¹„ìƒíƒœ), INVESTING(ëŒíŒŒí•´ì„œ íˆ¬ìì¤‘), INVESTING_TRY(ë§¤ìˆ˜ ì£¼ë¬¸ ë“¤ì–´ê°) REST(ì¡°ê±´ë¶ˆë§Œì¡±,íˆ¬ìì•ˆí•¨,ëŒíŒŒì²´í¬ì•ˆí•¨) 
        KospidaqStrategyData['DayStatus'] = "NONE" #ì˜¤ëŠ˜ ë§¤ìˆ˜(BUY)í•˜ëŠ” ë‚ ì¸ì§€ ë§¤ë„(SELL)í•˜ëŠ” ë‚ ì¸ì§€ ëŒ€ìƒì´ ì•„ë‹Œì§€ (NONE) ì²´í¬
        KospidaqStrategyData['TargetPrice'] = 0 #ëŒíŒŒê°€ê²©
        KospidaqStrategyData['TryBuyCnt'] = 0 #ë§¤ìˆ˜ì‹œë„í•˜ê³ ì í•˜ëŠ” ìˆ˜ëŸ‰!

        KospidaqStrategyList.append(KospidaqStrategyData)

    #íŒŒì¼ì— ì €ì¥
    with open(data_file_path, 'w') as outfile:
        json.dump(KospidaqStrategyList, outfile, indent=4, sort_keys=True, ensure_ascii=False)


###################################################################
###################################################################
DateData = dict()
#íŒŒì¼ ê²½ë¡œì…ë‹ˆë‹¤.
date_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_Date.json")

try:
    #ì´ ë¶€ë¶„ì´ íŒŒì¼ì„ ì½ì–´ì„œ ë¦¬ìŠ¤íŠ¸ì— ë„£ì–´ì£¼ëŠ” ë¡œì§ì…ë‹ˆë‹¤. 
    with open(date_file_path, 'r') as json_file:
        DateData = json.load(json_file)

except Exception as e:
    logging.info("Init....")

    DateData['Date'] = "00" #ì˜¤ëŠ˜ë‚ ì§œ

    #íŒŒì¼ì— ì €ì¥
    with open(date_file_path, 'w') as outfile:
        json.dump(DateData, outfile, indent=4, sort_keys=True, ensure_ascii=False)

###################################################################
###################################################################



###################################################################

#ì˜¤ëŠ˜ ì½”ìŠ¤í”¼ ì‹œê°€ë§¤ë§¤ ë¡œì§ì´ ì§„í–‰ë˜ì—ˆëŠ”ì§€ ë‚ ì§œ ì €ì¥ ê´€ë¦¬ í•˜ëŠ” íŒŒì¼
DateSiGaLogicDoneDict = dict()

#íŒŒì¼ ê²½ë¡œì…ë‹ˆë‹¤.
siga_logic_file_path = os.path.join(script_dir, "Kosdaqpi_Bot_TodaySigaLogicDoneDate.json")
try:
    #ì´ ë¶€ë¶„ì´ íŒŒì¼ì„ ì½ì–´ì„œ ë¦¬ìŠ¤íŠ¸ì— ë„£ì–´ì£¼ëŠ” ë¡œì§ì…ë‹ˆë‹¤. 
    with open(siga_logic_file_path, 'r') as json_file:
        DateSiGaLogicDoneDict = json.load(json_file)

except Exception as e:
    #ì²˜ìŒì—ëŠ” íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„í…Œë‹ˆê¹ ë‹¹ì—°íˆ ì˜ˆì™¸ì²˜ë¦¬ê°€ ë©ë‹ˆë‹¤!
    logging.info("Exception by First")

###################################################################

# í¬íŠ¸í´ë¦¬ì˜¤ ë§¤ë‹ˆì €ì—ì„œ ìµœì´ˆ íˆ¬ìê¸ˆì•¡ê³¼ í• ë‹¹ ë¹„ìœ¨ ê°€ì ¸ì˜¤ê¸°
try:
    # portfolio_config.jsonì—ì„œ allocation_rate ê°€ì ¸ì˜¤ê¸°
    script_dir = os.path.dirname(os.path.abspath(__file__))
    config_file_path = os.path.join(script_dir, "portfolio_config.json")
    
    with open(config_file_path, 'r', encoding='utf-8') as f:
        config_data = json.load(f)
    
    allocation_rate = config_data['bots']['Kosdaqpi_Bot']['allocation_rate']
    
    # ê³„ì¢Œ ì”ê³ ì— í• ë‹¹ ë¹„ìœ¨ì„ ì ìš©í•˜ì—¬ ì´ íˆ¬ìê¸ˆì•¡ ê³„ì‚°
    TotalMoney = float(Balance['TotalMoney']) * allocation_rate

    logging.info(f"ê³„ì¢Œ ì´ì•¡: {format(float(Balance['TotalMoney']), ',')}ì›")
    logging.info(f"í• ë‹¹ ë¹„ìœ¨: {allocation_rate * 100}%")
    logging.info(f"ì „ëµì— íˆ¬ìí•˜ëŠ” ì´ ê¸ˆì•¡: {format(round(TotalMoney), ',')}")

    InvestMoney = TotalMoney
    RemainInvestMoney = TotalMoney - NowInvestMoney

    logging.info(f"í˜„ì¬ ë‚¨ì€ ê¸ˆì•¡! (íˆ¬ìê¸ˆ ì œì™¸): {format(round(RemainInvestMoney), ',')}")
except Exception as e:
    logging.error(f"í¬íŠ¸í´ë¦¬ì˜¤ ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {e}")
    # ê¸°ë³¸ê°’ ì„¤ì •
    TotalMoney = float(Balance['TotalMoney']) * InvestRate  # InvestRate ë³€ìˆ˜ ì‚¬ìš©
    InvestMoney = TotalMoney
    RemainInvestMoney = TotalMoney - NowInvestMoney




DivNum = len(InvestStockList)

if ENABLE_ORDER_EXECUTION == True:

    #ë§ˆì¼“ì´ ì—´ë ¸ëŠ”ì§€ ì—¬ë¶€~!
    IsMarketOpen = KisKR.IsMarketOpen()
    
    # í˜„ì¬ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    current_date = time.strftime("%Y-%m-%d")
    
    # ì¥ ìƒíƒœì— ë”°ë¥¸ ë¡œê·¸ ë©”ì‹œì§€
    if IsMarketOpen == True:
        logging.info(f"ë‚ ì§œ {current_date} : ì¥ì´ ì—´ë ¤ìˆìŠµë‹ˆë‹¤.")
        telegram.send(f"{PortfolioName}({current_date})\nì¥ì´ ì—´ë ¤ìˆìŠµë‹ˆë‹¤.")
    else:
        logging.info(f"ë‚ ì§œ {current_date} : ì¥ì´ ë‹«í˜€ìˆìŠµë‹ˆë‹¤.")
        telegram.send(f"{PortfolioName}({current_date})\nì¥ì´ ë‹«í˜€ìˆìŠµë‹ˆë‹¤.")
        # ì¥ì´ ë‹«í˜€ìˆìœ¼ë©´ ë” ì´ìƒ ë¡œê·¸ë¥¼ ë‚¨ê¸°ì§€ ì•Šê³  ì¢…ë£Œ
        sys.exit(0)

    IsLP_OK = True
    #ì •ê° 9ì‹œ 5ë¶„ ì „ì—ëŠ” LPìœ ë™ì„± ê³µê¸‰ìê°€ ì—†ìœ¼ë‹ˆ ë§¤ë§¤ë¥¼ í”¼í•˜ê³ ì.
    if time_info.tm_hour == 0: #9ì‹œì¸ë°
        if time_info.tm_min < 6: #6ë¶„ë³´ë‹¤ ì ì€ ê°’ì´ë©´ --> 6ë¶„ë¶€í„° LPê°€ í™œë™í•œë‹¤ê³  í•˜ì!
            IsLP_OK = False
            
    #ì¥ì´ ì—´ë ¸ê³  LPê°€ í™œë™í• ë•Œ ë§¤ìˆ˜!!!
    if IsMarketOpen == True and IsLP_OK == True: 


        #í˜¹ì‹œ ì´ ë´‡ì„ ì¥ ì‹œì‘í•˜ì ë§ˆì ëŒë¦°ë‹¤ë©´ 20ì´ˆë¥´ ì‰¬ì–´ì¤€ë‹¤.
        #ê·¸ ì´ìœ ëŠ” 20ì´ˆëŠ” ì§€ë‚˜ì•¼ ì˜¤ëŠ˜ì˜ ì¼ë´‰ ì •ë³´ë¥¼ ì œëŒ€ë¡œ ê°€ì ¸ì˜¤ëŠ”ë°
        #tm_hourê°€ 0ì€ 9ì‹œ, 1ì€ 10ì‹œë¥¼ ëœ»í•œë‹¤. ìˆ˜ëŠ¥ ë“± 10ì‹œì— ì¥ ì‹œì‘í•˜ëŠ” ê²½ìš°ë¥´ ëŒ€ë¹„!
        if time_info.tm_hour in [0,1] and time_info.tm_min in [0,1]:
            time.sleep(20.0)
            

        logging.info("Market Is Open!!!!!!!!!!!")
        #ì˜ìƒì—” ì—†ì§€ë§Œ ë¦¬ë°¸ëŸ°ì‹±ì´ ê°€ëŠ¥í• ë•Œë§Œ ë‚´ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì!



        #ë°ì´í„°ë¥¼ ì¡°í•©í•œë‹¤.
        stock_df_list = []
        
                
        gugan_lenth = 7


        for stock_code in InvestStockList:
            df = Common.GetOhlcv("KR", stock_code,200)

            period = 14

            delta = df["close"].diff()
            up, down = delta.copy(), delta.copy()
            up[up < 0] = 0
            down[down > 0] = 0
            _gain = up.ewm(com=(period - 1), min_periods=period).mean()
            _loss = down.abs().ewm(com=(period - 1), min_periods=period).mean()
            RS = _gain / _loss

            df['RSI'] = pd.Series(100 - (100 / (1 + RS)), name="RSI")

            df['prevRSI'] = df['RSI'].shift(1)
            df['prevRSI2'] = df['RSI'].shift(2)
            
            df['high_'+str(gugan_lenth)+'_max'] = df['high'].rolling(window=gugan_lenth).max().shift(1)
            df['low_'+str(gugan_lenth)+'_min'] = df['low'].rolling(window=gugan_lenth).min().shift(1)


            df['prevVolume'] = df['volume'].shift(1)
            df['prevVolume2'] = df['volume'].shift(2)
            df['prevVolume3'] = df['volume'].shift(3)

            df['prevClose'] = df['close'].shift(1)
            df['prevOpen'] = df['open'].shift(1)

            df['prevHigh'] = df['high'].shift(1)
            df['prevHigh2'] = df['high'].shift(2)

            df['prevLow'] = df['low'].shift(1)
            df['prevLow2'] = df['low'].shift(2)

            df['Disparity20'] = df['prevClose'] / df['prevClose'].rolling(window=20).mean() * 100.0
            
            df['Disparity11'] = df['prevClose'] / df['prevClose'].rolling(window=11).mean() * 100.0


            df['ma3_before'] = df['close'].rolling(3).mean().shift(1)
            df['ma6_before'] = df['close'].rolling(6).mean().shift(1)
            df['ma19_before'] = df['close'].rolling(19).mean().shift(1)


            df['ma10_before'] = df['close'].rolling(10).mean().shift(1)

            df['ma20_before'] = df['close'].rolling(20).mean().shift(1)
            df['ma20_before2'] = df['close'].rolling(20).mean().shift(2)
            df['ma60_before'] = df['close'].rolling(60).mean().shift(1)
            df['ma60_before2'] = df['close'].rolling(60).mean().shift(2)

            df['ma120_before'] = df['close'].rolling(120).mean().shift(1)



            df['prevChangeMa'] = df['change'].shift(1).rolling(window=20).mean()
            

            df['prevChangeMa_S'] = df['change'].shift(1).rolling(window=10).mean()
            

            #10ì¼ë§ˆë‹¤ ì´ 100ì¼ í‰ê· ëª¨ë©˜í…€ìŠ¤ì½”ì–´
            specific_days = list()

            for i in range(1,11):
                st = i * 10
                specific_days.append(st)

            for day in specific_days:
                column_name = f'Momentum_{day}'
                df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)
                
            df['Average_Momentum'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10



            # Define the list of specific trading days to compare
            specific_days = list()

            for i in range(1,11):
                st = i * 3
                specific_days.append(st)



            # Iterate over the specific trading days and compare the current market price with the corresponding closing prices
            for day in specific_days:
                # Create a column name for each specific trading day
                column_name = f'Momentum_{day}'
                
                # Compare current market price with the closing price of the specific trading day
                df[column_name] = (df['prevClose'] > df['close'].shift(day)).astype(int)

            # Calculate the average momentum score
            df['Average_Momentum3'] = df[[f'Momentum_{day}' for day in specific_days]].sum(axis=1) / 10



            df.dropna(inplace=True) #ë°ì´í„° ì—†ëŠ”ê±´ ë‚ ë¦°ë‹¤!


            data_dict = {stock_code: df}
            stock_df_list.append(data_dict)
            logging.info(f"---stock_code--- {stock_code} len {len(df)}")
            pprint.pprint(df)
            
            


            #ì‹œê°€ë§¤ë§¤ ì²´í¬í•œ ê¸°ë¡ì´ ì—†ëŠ” ë§¨ ì²˜ìŒì´ë¼ë©´ 
            if DateSiGaLogicDoneDict.get(stock_code) == None:

                #0ìœ¼ë¡œ ì´ˆê¸°í™”!!!!!
                DateSiGaLogicDoneDict[stock_code] = 0
                #íŒŒì¼ì— ì €ì¥
                with open(siga_logic_file_path, 'w') as outfile:
                    json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)

            #ì‹œê°€ë§¤ë§¤ ì²´í¬í•œ ê¸°ë¡ì´ ì—†ëŠ” ë§¨ ì²˜ìŒì´ë¼ë©´ 
            if DateSiGaLogicDoneDict.get('InvestCnt') == None:
                DateSiGaLogicDoneDict['InvestCnt'] =  GetKospidaqInvestCnt(KospidaqStrategyList) #ì¼ë‹¨ íˆ¬ìì¤‘ ê°œìˆ˜ ì €ì¥!
                #íŒŒì¼ì— ì €ì¥
                with open(siga_logic_file_path, 'w') as outfile:
                    json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)
                    
                    
            if DateSiGaLogicDoneDict.get('IsCut') == None:
                DateSiGaLogicDoneDict['IsCut'] =  False
                DateSiGaLogicDoneDict['IsCutCnt'] =  0
                #íŒŒì¼ì— ì €ì¥
                with open(siga_logic_file_path, 'w') as outfile:
                    json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)



        # Combine the OHLCV data into a single DataFrame
        combined_df = pd.concat([list(data_dict.values())[0].assign(stock_code=stock_code) for data_dict in stock_df_list for stock_code in data_dict])

        # Sort the combined DataFrame by date
        combined_df.sort_index(inplace=True)

        pprint.pprint(combined_df)
        logging.info(f"len(combined_df): {len(combined_df)}")


        date = combined_df.iloc[-1].name

        all_stocks = combined_df.loc[combined_df.index == date].groupby('stock_code')['close'].max().nlargest(DivNum)
        

        #######################################################################################################################################
        # íš¡ë³´ì¥ì„ ì •ì˜í•˜ê¸° ìœ„í•œ ë¡œì§!!
        # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ…ì„ ì •ë…í•˜ì„¸ìš”!!!
        Kosdaq_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "233740")]
        Kosdaq_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "251340")]
        Kospi_Long_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "122630")]
        Kospi_Short_Data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == "252670")]
        
        
        IsNoWay = False
        if  (Kospi_Long_Data['prevChangeMa_S'].values[0] > 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kospi_Long_Data['prevChangeMa_S'].values[0] < 0 and Kospi_Short_Data['prevChangeMa_S'].values[0] < 0)  or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] > 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] > 0) or (Kosdaq_Long_Data['prevChangeMa_S'].values[0] < 0 and Kosdaq_Short_Data['prevChangeMa_S'].values[0] < 0) :
            IsNoWay = True
        #######################################################################################################################################
       

        #ë‚ ì§œê°€ ë‹¤ë¥´ë‹¤ë©´ ë‚ ì´ ë°”ë€ê±°ë‹¤
        if day_str != DateData['Date']:
            # ì¼ë´‰ ì •ë³´ ê°€ì§€ê³  ì˜¤ëŠ” ëª¨ë“ˆì´ ë‹¬ë¼ì§€ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ ì˜ˆì™¸ì²˜ë¦¬
            date_format = "%Y-%m-%d %H:%M:%S"
            date_object = None

            try:
                date_object = datetime.strptime(str(date), date_format)
            
            except Exception as e:
                try:
                    date_format = "%Y%m%d"
                    date_object = datetime.strptime(str(date), date_format)

                except Exception as e2:
                    date_format = "%Y-%m-%d"
                    date_object = datetime.strptime(str(date), date_format)
                    

            # ìš”ì¼ ê°€ì ¸ì˜¤ê¸° (0: ì›”ìš”ì¼, 1: í™”ìš”ì¼,2 ìˆ˜ìš”ì¼ 3 ëª©ìš”ì¼ 4 ê¸ˆìš”ì¼ 5 í† ìš”ì¼ ..., 6: ì¼ìš”ì¼)
            weekday = date_object.weekday()
            logging.info(f"--weekday-- {weekday} {time_info.tm_wday}")





            #ê°€ì¥ ìµœê·¼ ë°ì´í„°ì˜ ë‚ ì§œì˜ ìš”ì¼ê³¼ ë´‡ì´ ì‹¤í–‰ë˜ëŠ” ìš”ì¼ì€ ê°™ì•„ì•¼ í•œë‹¤.
            #ì´ê²Œ ë‹¤ë¥´ë‹¤ë©´ ì•„ì§ ìµœê·¼ ë°ì´í„°ì˜ ë‚ ìê°€ ê°±ì‹  ì•ˆë˜ì—ˆë‹¨ ì´ì•¼ê¸°ì¸ë° ì´ëŠ” 9ì‹œ ì •ê°ì´ë‚˜..(20ì´ˆ ë”œë ˆì´ê°€ í•„ìš”) ìˆ˜ëŠ¥ë“±ìœ¼ë¡œ ì¥ ì˜¤í”ˆì‹œê°„ì´ ì§€ì—°ë˜ì—ˆì„ë•Œ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ê·¸ë•ŒëŠ” ë§¤ë§¤í•˜ë©´ ì•ˆëœë‹¤
            if weekday == time_info.tm_wday:
                
                DateSiGaLogicDoneDict['InvestCnt'] = GetKospidaqInvestCnt(KospidaqStrategyList) #ì¼ë‹¨ íˆ¬ìì¤‘ ê°œìˆ˜ ì €ì¥!
                #íŒŒì¼ì— ì €ì¥
                with open(siga_logic_file_path, 'w') as outfile:
                    json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)
                    
                    

                DateData['Date'] = day_str #ì˜¤ëŠ˜ ë§¨ì²˜ìŒ í• ì¼ (ì¢…ëª© ì„ ì • ë° ëŒíŒŒê°€ê²© ì„¤ì •, ìƒíƒœ ì„¤ì •)ì„ ëëƒˆìœ¼ë‹ˆ ë‚ ì§œë¥¼ ë„£ì–´ ë‹¤ìŒë‚  ë‹¤ì‹œ ì‹¤í–‰ë˜ê²Œ í•œë‹¤.
                with open(date_file_path, 'w') as outfile:
                    json.dump(DateData, outfile, indent=4, sort_keys=True, ensure_ascii=False)

                #ê¸°ë³¸ì ìœ¼ë¡œ ë‚ ì´ ë°”ë€Œì—ˆê¸° ë•Œë¬¸ì— ë°ì´ ì¡°ê±´(BUY_DAY,SELL_DAY)ë¥¼ ëª¨ë‘ ì´ˆê¸°í™” í•œë‹¤!
                for KospidaqStrategyData in KospidaqStrategyList:
                    KospidaqStrategyData['DayStatus'] = "NONE"

                    #ê·¸ë¦¬ê³  íˆ¬ìì¤‘ ìƒíƒœëŠ” SELL_DAYë¡œ ë°”ê¿”ì¤€ë‹¤!!
                    if KospidaqStrategyData['Status'] == "INVESTING":
                        KospidaqStrategyData['DayStatus'] = "SELL_DAY"

                        msg = KospidaqStrategyData['StockName'] + "  íˆ¬ìì¤‘ ìƒíƒœì—ìš”! ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë§¤ë„ë¡œ íŠ¸ë ˆì´ë”© ì¢…ë£Œ í•©ë‹ˆë‹¤.!!"
                        logging.info(msg)
                        #telegram.send(msg)


            
                for stock_code in  all_stocks.index:
                    stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

                    #í•´ë‹¹ ì •ë³´ë¥¼ ì½ëŠ”ë‹¤.
                    KospidaqStrategyData = GetKospidaqStrategyData(stock_code,KospidaqStrategyList)

                    #ë§Œì•½ ì •ë³´ê°€ ì—†ë‹¤ë©´ ìƒˆë¡œ ì¶”ê°€ëœ ì¢…ëª©ì´ë‹ˆ ìƒˆë¡œ ì €ì¥í•œë‹¤!!!
                    if KospidaqStrategyData == None:

                        KospidaqStrategyData = dict()
                        KospidaqStrategyData['StockCode'] = stock_code #ëŒ€ìƒ ì¢…ëª© ì½”ë“œ
                        KospidaqStrategyData['StockName'] = KisKR.GetStockName(stock_code) #ì¢…ëª© ì´ë¦„
                        KospidaqStrategyData['Status'] = "REST" #ìƒíƒœ READY(ëŒíŒŒë¥¼ì²´í¬í•´ì•¼í•˜ëŠ” ì¤€ë¹„ìƒíƒœ), INVESTING(ëŒíŒŒí•´ì„œ íˆ¬ìì¤‘), REST(ì¡°ê±´ë¶ˆë§Œì¡±,íˆ¬ìì•ˆí•¨,ëŒíŒŒì²´í¬ì•ˆí•¨) 
                        KospidaqStrategyData['DayStatus'] = "NONE" #ì˜¤ëŠ˜ ë§¤ìˆ˜í•˜ëŠ” ë‚ ì¸ì§€ ë§¤ë„í•˜ëŠ” ë‚ ì¸ì§€ ì²´í¬
                        KospidaqStrategyData['TargetPrice'] = 0 #ëŒíŒŒê°€ê²©
                        KospidaqStrategyData['TryBuyCnt'] = 0 #ë§¤ìˆ˜ì‹œë„í•˜ê³ ì í•˜ëŠ” ìˆ˜ëŸ‰!

                        KospidaqStrategyList.append(KospidaqStrategyData)

                    #ì½”ìŠ¤ë‹¥ ì „ëµ...ëŒíŒŒ ë§¤ë§¤..
                    if stock_code in ["233740","251340"]:
                        
                            
                        PrevClosePrice = stock_data['prevClose'].values[0] 
                        
                        DolpaRate = 0.4

                        # KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
                        if stock_code == "251340":

                            DolpaRate = 0.4

                        #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€
                        else: 

                            if PrevClosePrice > stock_data['ma60_before'].values[0]:
                                DolpaRate = 0.3
                            else:
                                DolpaRate = 0.4


                        ##########################################################################
                        #ê°­ ìƒìŠ¹ í•˜ë½ì„ ì´ìš©í•œ ëŒíŒŒê°’ ì¡°ì ˆ!
                        # https://blog.naver.com/zacra/223277173514 ì´ í¬ìŠ¤íŒ…ì„ ì²´í¬!!!!
                        ##########################################################################
                        Gap = ((abs(stock_data['open'].values[0] - PrevClosePrice) / PrevClosePrice)) * 100.0

                        GapSt = (Gap*0.025)

                        if GapSt > 1.0:
                            GapSt = 1.0
                        if GapSt < 0:
                            GapSt = 0.1

                        if PrevClosePrice > stock_data['open'].values[0] and Gap >= 3.0:
                            DolpaRate *= (1.0 + GapSt)

                        if PrevClosePrice < stock_data['open'].values[0] and Gap >= 3.0:
                            DolpaRate *= (1.0 - GapSt)

            
                        DolPaPrice = stock_data['open'].values[0] + ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * DolpaRate)


                        #ì–´ì œ ë¬´ìŠ¨ ì´ìœ ì—ì„œê±´ ë§¤ìˆ˜ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì¼ë‹¨ RESTë¡œ!
                        if KospidaqStrategyData['Status'] == "INVESTING_TRY":
                            KospidaqStrategyData['Status'] = "REST"
                            KospidaqStrategyData['DayStatus'] = "NONE"

                        #ì–´ì œ ë¬´ìŠ¨ ì´ìœ ì—ì„œê±´ ë§¤ë„ ì‹¤íŒ¨í–ˆë‹¤ë©´ íˆ¬ìì¤‘ ìƒíƒœë¡œ ë³€ê²½!
                        if KospidaqStrategyData['Status'] == "SELL_DONE_CHECK":
                            KospidaqStrategyData['Status'] = "INVESTING"
                            KospidaqStrategyData['DayStatus'] = "SELL_DAY"



                        
                        if KospidaqStrategyData['Status'] != "INVESTING": #íˆ¬ì ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ì¡°ê±´ì„ ì²´í¬í•˜ì—¬ ë§¤ìˆ˜ì‹œë„í•  ìˆ˜ ìˆë‹¤!
                            
                            IsBuyReady = True #ì¼ë‹¨ ë¬´ì¡°ê±´ True ë§Œì•½ í•„í„°í•˜ê³ ì í•˜ë©´ Falseë¡œ í•˜ê³  ì¡°ê±´ë§Œì¡±ì‹œ Trueë¡œ ë°”ê¾¸ë©´ ëœë‹¤.
                            

                            KospidaqStrategyData['StockCode'] = stock_code #ëŒ€ìƒ ì¢…ëª© ì½”ë“œ
                            KospidaqStrategyData['StockName'] = KisKR.GetStockName(stock_code)


                            if stock_code == "251340":
                                if stock_data['prevClose'].values[0] <= stock_data['ma20_before'].values[0]:
                                    IsBuyReady = False 
            

                            else: #ë ˆë²„ë¦¬ì§€

                                if stock_data['prevLow'].values[0] > stock_data['open'].values[0] and stock_data['prevClose'].values[0] < stock_data['ma10_before'].values[0]:
                                    IsBuyReady = False 
                                    
                            # ì¶”ê°€ ê°œì„  ë¡œì§ https://blog.naver.com/zacra/223326173552 ì´ í¬ìŠ¤íŒ… ì°¸ê³ !!!!
                            IsJung = False    
                            if stock_data['ma10_before'].values[0] > stock_data['ma20_before'].values[0] > stock_data['ma60_before'].values[0] > stock_data['ma120_before'].values[0]:
                                IsJung = True
                                
                            if IsJung == False:
                                
                                        
                                high_price = stock_data['high_'+str(gugan_lenth)+'_max'].values[0] 
                                low_price =  stock_data['low_'+str(gugan_lenth)+'_min'].values[0] 
                                
                                Gap = (high_price - low_price) / 4
                                
                                
                                MaximunPrice = low_price + Gap * 3.0
                                
                                
                                if stock_data['open'].values[0] > MaximunPrice:
                                    IsBuyReady = False
            

                            #ê¸°ë³¸ í•„í„° í†µê³¼!! ëŒíŒŒê°€ê²©ì„ ì •í•˜ê³  READYìƒíƒœë¡œ ë³€ê²½
                            if IsBuyReady == True:
                                logging.info("IS Ready!!!")
                                KospidaqStrategyData['TargetPrice'] = DolPaPrice #ëŒíŒŒê°€ê²©

                                KospidaqStrategyData['Status'] = "READY"
                                KospidaqStrategyData['DayStatus'] = "BUY_DAY"


                                msg = KospidaqStrategyData['StockName'] + " ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜í•©ë‹ˆë‹¤!!!"
                                logging.info(msg)
                                #telegram.send(msg)

                            #ê¸°ë³¸ í•„í„° í†µê³¼ ì‹¤íŒ¨ ë§¤ìˆ˜ ì•ˆí•¨! 
                            else:
                                logging.info("No Ready")
                
                                KospidaqStrategyData['Status'] = "REST"
                                KospidaqStrategyData['DayStatus'] = "NONE"

                                msg = KospidaqStrategyData['StockName'] + "  ì¡°ê±´ì„ ë¶ˆë§Œì¡±í•˜ì—¬ ì˜¤ëŠ˜ ëŒíŒŒë§¤ìˆ˜ëŠ” ì‰½ë‹ˆë‹¤!!!"
                                logging.info(msg)
                                #telegram.send(msg)
                            
                    #ì½”ìŠ¤í”¼ ì „ëµ.... ì‹œê°€ ë§¤ë§¤
                    else:
                        

                        #ì–´ì œ ë¬´ìŠ¨ ì´ìœ ì—ì„œê±´ ë§¤ìˆ˜ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì¼ë‹¨ RESTë¡œ!
                        if KospidaqStrategyData['Status'] == "INVESTING_TRY":
                            KospidaqStrategyData['Status'] = "REST"
                            KospidaqStrategyData['DayStatus'] = "NONE"

                        #ì–´ì œ ë¬´ìŠ¨ ì´ìœ ì—ì„œê±´ ë§¤ë„ ì‹¤íŒ¨í–ˆë‹¤ë©´ íˆ¬ìì¤‘ ìƒíƒœë¡œ ë³€ê²½!
                        if KospidaqStrategyData['Status'] == "SELL_DONE_CHECK":
                            KospidaqStrategyData['Status'] = "INVESTING"
                            KospidaqStrategyData['DayStatus'] = "SELL_DAY"

                        

                        if KospidaqStrategyData['Status'] != "INVESTING": #íˆ¬ì ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ì¡°ê±´ì„ ì²´í¬í•˜ì—¬ ë§¤ìˆ˜ì‹œë„í•  ìˆ˜ ìˆë‹¤!
                            KospidaqStrategyData['StockCode'] = stock_code #ëŒ€ìƒ ì¢…ëª© ì½”ë“œ
                            KospidaqStrategyData['StockName'] = KisKR.GetStockName(stock_code)

                            KospidaqStrategyData['Status'] = "READY"
                            KospidaqStrategyData['DayStatus'] = "BUY_DAY"

                            msg = KospidaqStrategyData['StockName'] + " ì¡°ê±´ì„ ë§Œì¡±í–ˆë‹¤ë©´ ë§¤ìˆ˜í•©ë‹ˆë‹¤!!!"
                            logging.info(msg)
                            #telegram.send(msg)




                    #íŒŒì¼ì— ì €ì¥
                    with open(data_file_path, 'w') as outfile:
                        json.dump(KospidaqStrategyList, outfile, indent=4, sort_keys=True, ensure_ascii=False)
            else:

                if time_info.tm_min == 0 or time_info.tm_min == 30:
                    msg = "ìš”ì¼ì´ ë‹¤ë¥´ê²Œ ë‚˜ì™”ì–´ìš”! ì¢€ ë” ê¸°ë‹¤ë ¤ë´ìš”!"
                    logging.info(msg)
                    try:
                        telegram.send(msg)
                    except Exception as e:
                        logging.error(f"í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {e}")
                    

        if day_str == DateData['Date']: #ì˜¤ëŠ˜ í• ì¼ì„ í•œë‹¤!

            ### ë§¤ë„ íŒŒíŠ¸ ###
            for KospidaqStrategyData in KospidaqStrategyList:
                pprint.pprint(KospidaqStrategyData)

                stock_code = KospidaqStrategyData['StockCode']
                
                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

                if len(stock_data) == 1:
                    
                    NowOpenPrice = stock_data['open'].values[0]
                    PrevOpenPrice = stock_data['prevOpen'].values[0] 
                    PrevClosePrice = stock_data['prevClose'].values[0] 


                    #í˜„ì¬ê°€!
                    CurrentPrice = KisKR.GetCurrentPrice(stock_code)        
                    


                    IsSellAlready = False   
                    #í•´ë‹¹ ETFê°€ ë§¤ë„í•˜ëŠ” ë‚  ìƒíƒœì´ë‹¤!
                    if KospidaqStrategyData['DayStatus'] == "SELL_DAY":

                        #ì œëŒ€ë¡œ ë§¤ë„ë˜ì—ˆëŠ”ì§€ í™•ì¸!
                        if KospidaqStrategyData['Status'] == "SELL_DONE_CHECK":
                            stock_amt = 0 #ìˆ˜ëŸ‰

                            
                            #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
                            for my_stock in MyStockList:
                                if my_stock['StockCode'] == stock_code:
                                    stock_amt = int(my_stock['StockAmt'])
                                    break

                            logging.info(f"stock_amt: {stock_amt}")

                            if stock_amt == 0:
                                KospidaqStrategyData['Status'] = "REST" 
                                KospidaqStrategyData['DayStatus'] = "NONE"

                                msg = KospidaqStrategyData['StockName']  + " ëª¨ë‘ ë§¤ë„ëœ ê²ƒì´ í™•ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤!"
                                logging.info(msg)
                                telegram.send(msg)
                                                
                                #íŒŒì¼ì— ì €ì¥
                                with open(data_file_path, 'w') as outfile:
                                    json.dump(KospidaqStrategyList, outfile, indent=4, sort_keys=True, ensure_ascii=False)

                            else:

                                KisKR.CancelAllOrders(KospidaqStrategyData['StockCode'],"ALL")

                                # ì‹œì¥ê°€ ë§¤ë„ë¡œ ë³€ê²½
                                data = KisKR.MakeSellMarketOrder(KospidaqStrategyData['StockCode'],stock_amt)
                                # ë¶„í• ë§¤ë„ë¡œ ë³€ê²½ (1ë¶„í• , 1ë¶„ ê°„ê²©)
                                #data = MakeSplitSellOrder(KospidaqStrategyData['StockCode'], stock_amt, split_count=1, time_term=1)

                                # ë§¤ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥ (ì¬ì‹œë„ ì‹œì—ë„)
                                try:
                                    save_sell_history(
                                        stock_code=stock_code,
                                        stock_name=stock_name,
                                        quantity=stock_amt,
                                        unit_price=CurrentPrice,
                                        amount=stock_amt * CurrentPrice,
                                        fee=0
                                    )
                                except Exception as e:
                                    logging.error(f"ë§¤ë„ ì¬ì‹œë„ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")

                                # ë§¤ë„ ì‹œ ëˆ„ì  ìˆ˜ìµ ì—…ë°ì´íŠ¸ (ì¬ì‹œë„ ì‹œì—ë„)
                                update_cumulative_profit_on_sale(stock_code, stock_amt, CurrentPrice, stock_avg_price)
                                
                                msg = KospidaqStrategyData['StockName']  + " ëª¨ë‘ ë§¤ë„í•œ ì¤„ ì•Œì•˜ëŠ”ë° ì‹¤íŒ¨í–ˆë‚˜ë´ìš” ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.\n" + str(data)
                                logging.info(msg)
                                telegram.send(msg)


                        #ë§Œì•½ íˆ¬ìì¤‘ì´ë¼ë©´ ì¡°ê±´ì„ ì²´í¬!
                        if KospidaqStrategyData['Status'] == "INVESTING": #íˆ¬ìì¤‘ ìƒíƒœ


                            stock_amt = 0 #ìˆ˜ëŸ‰
                            stock_avg_price = 0 #í‰ë‹¨
                            stock_eval_totalmoney = 0 #ì´í‰ê°€ê¸ˆì•¡!
                            stock_revenue_rate = 0 #ì¢…ëª© ìˆ˜ìµë¥ 
                            stock_revenue_money = 0 #ì¢…ëª© ìˆ˜ìµê¸ˆ

                        
                            
                            #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
                            for my_stock in MyStockList:
                                if my_stock['StockCode'] == stock_code:
                                    stock_name = my_stock['StockName']
                                    stock_amt = int(my_stock['StockAmt'])
                                    stock_avg_price = float(my_stock['StockAvgPrice'])
                                    stock_eval_totalmoney = float(my_stock['StockNowMoney'])
                                    stock_revenue_rate = float(my_stock['StockRevenueRate'])
                                    stock_revenue_money = float(my_stock['StockRevenueMoney'])

                                    break
                                
                            #ì½”ìŠ¤ë‹¥ ì „ëµ...ëŒíŒŒ ë§¤ë§¤..
                            if stock_code in ["233740","251340"]:
                                
                                        
                                if stock_amt > 0:
                                    

                                    CutRate = 0.4

                                    if stock_code == "251340":
                                        CutRate = 0.4

                                    else:

                                        if PrevClosePrice > stock_data['ma60_before'].values[0]:
                                            CutRate = 0.4
                                        else:
                                            CutRate = 0.3


                                    
                                    CutPrice = stock_data['open'].values[0] - ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * CutRate)
                                    
                                    

                                    CurrentPrice = KisKR.GetCurrentPrice(stock_code)  

                                    if CurrentPrice <= CutPrice or stock_data['low'].values[0] <= CutPrice :
                                        
                                        
                                        
                                        # ì‹œì¥ê°€ ë§¤ë„ë¡œ ë³€ê²½
                                        order_result = KisKR.MakeSellMarketOrder(stock_code,stock_amt)
                                        pprint.pprint(order_result)
                                         # ë¶„í• ë§¤ë„ë¡œ ë³€ê²½ (1ë¶„í• , 1ë¶„ ê°„ê²©)
                                        #pprint.pprint(MakeSplitSellOrder(stock_code, stock_amt, split_count=1, time_term=1))
                                        
                                        # ë§¤ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥
                                        try:
                                            save_sell_history(
                                                stock_code=stock_code,
                                                stock_name=stock_name,
                                                quantity=stock_amt,
                                                unit_price=CurrentPrice,
                                                amount=stock_amt * CurrentPrice,
                                                fee=0
                                            )
                                        except Exception as e:
                                            logging.error(f"ë§¤ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")
                                        
                                        KospidaqStrategyData['Status'] = "SELL_DONE_CHECK" 

                                        # ë§¤ë„ ì‹œ ëˆ„ì  ìˆ˜ìµ ì—…ë°ì´íŠ¸
                                        update_cumulative_profit_on_sale(stock_code, stock_amt, CurrentPrice, stock_avg_price)
                                        
                                        msg = KospidaqStrategyData['StockName']  + " ëª¨ë‘ ì‹œì¥ê°€ ë§¤ë„!!! " + str(stock_revenue_money) + " ìˆ˜ìµ í™•ì •!! ìˆ˜ìµë¥ :" + str(stock_revenue_rate) + "%"
                                        logging.info(msg)
                                        telegram.send(msg)

                                        if stock_revenue_rate < 0:
            
                                            DateSiGaLogicDoneDict['IsCut'] = True
                                            DateSiGaLogicDoneDict['IsCutCnt'] += 1
                                            #íŒŒì¼ì— ì €ì¥
                                            with open(siga_logic_file_path, 'w') as outfile:
                                                json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)


                                        else:
                
                                            DateSiGaLogicDoneDict['IsCut'] =  False
                                            DateSiGaLogicDoneDict['IsCutCnt'] -= 1
                                            if DateSiGaLogicDoneDict['IsCutCnt'] < 0:
                                                DateSiGaLogicDoneDict['IsCutCnt'] = 0

                                            #íŒŒì¼ì— ì €ì¥
                                            with open(siga_logic_file_path, 'w') as outfile:
                                                json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)



                                        IsSellAlready = True
                                        
                                        


                                    
                                else:
                                    KospidaqStrategyData['Status'] = "REST" 
                                    KospidaqStrategyData['DayStatus'] = "NONE"


                                    msg = KospidaqStrategyData['StockName']  + " ë§¤ìˆ˜í–ˆë‹¤ê³  ê¸°ë¡ë˜ì—ˆëŠ”ë° ë¬¼ëŸ‰ì´ ì—†ë„¤ìš”? ì•”íŠ¼ ì´ˆê¸°í™” í–ˆì–´ìš” ë‹¤ìŒë‚  ë‹¤ì‹œ ì „ëµ ì‹œì‘í•©ë‹ˆë‹¤!"
                                    logging.info(msg)
                                    telegram.send(msg)
                            #ì½”ìŠ¤í”¼
                            else:
                                
                                if stock_amt > 0:
                                    
                                    IsSellGo = False

                                    if stock_code == "252670":
                                        
                                        if stock_data['Disparity11'].values[0] > 105:
                                            #
                                            if  PrevClosePrice < stock_data['ma3_before'].values[0]: 
                                                IsSellGo = True

                                        else:
                                            #
                                            if PrevClosePrice < stock_data['ma6_before'].values[0] and PrevClosePrice < stock_data['ma19_before'].values[0] : 
                                                IsSellGo = True

                                    else:
                                        logging.info("")
                                        
                            
                                        total_volume = (stock_data['prevVolume'].values[0]+ stock_data['prevVolume2'].values[0] +stock_data['prevVolume3'].values[0]) / 3.0

                                        Disparity = stock_data['Disparity20'].values[0] 

                                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0] or stock_data['prevVolume'].values[0] < total_volume) and (Disparity < 98 or Disparity > 105):
                                            logging.info("hold..")
                                        else:
                                            IsSellGo = True

                        
                                    if IsSellGo == True:
                                        
                                        
                                        DateSiGaLogicDoneDict['InvestCnt'] -= 1 #ì½”ìŠ¤í”¼ ì‹œê°€ ë§¤ë„ ê±¸ë ¸ì„ ë•Œë§Œ íˆ¬ìì¤‘ ì¹´ìš´íŠ¸ë¥¼ ê°ì†Œ!
                                        #íŒŒì¼ì— ì €ì¥
                                        with open(siga_logic_file_path, 'w') as outfile:
                                            json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)
                                            
                    
                                        # ì‹œì¥ê°€ ë§¤ë„ë¡œ ë³€ê²½
                                        order_result = KisKR.MakeSellMarketOrder(stock_code,stock_amt)
                                        pprint.pprint(order_result)
                                        # ë¶„í• ë§¤ë„ë¡œ ë³€ê²½ (1ë¶„í• , 1ë¶„ ê°„ê²©)
                                        #pprint.pprint(MakeSplitSellOrder(stock_code, stock_amt, split_count=1, time_term=1))
                                        
                                        # ë§¤ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥
                                        try:
                                            save_sell_history(
                                                stock_code=stock_code,
                                                stock_name=stock_name,
                                                quantity=stock_amt,
                                                unit_price=CurrentPrice,
                                                amount=stock_amt * CurrentPrice,
                                                fee=0
                                            )
                                        except Exception as e:
                                            logging.error(f"ë§¤ë„ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")
                                        
                                        KospidaqStrategyData['Status'] = "SELL_DONE_CHECK" 

                                        # ë§¤ë„ ì‹œ ëˆ„ì  ìˆ˜ìµ ì—…ë°ì´íŠ¸
                                        update_cumulative_profit_on_sale(stock_code, stock_amt, CurrentPrice, stock_avg_price)
                                        
                                        msg = KospidaqStrategyData['StockName']  + " ë¶„í• ë§¤ë„ ì‹œì‘!!! " + str(stock_revenue_money) + " ìˆ˜ìµ í™•ì •!! ìˆ˜ìµë¥ :" + str(stock_revenue_rate) + "%"
                                        logging.info(msg)
                                        telegram.send(msg)

                                        IsSellAlready = True
                                        


                                        ############## íŒ”ë ¸ë‹¤ë©´ ë‚¨ì€ ê¸ˆì•¡ ê°±ì‹  #######################
                                        time.sleep(5.0)
                                        MyStockList = KisKR.GetMyStockList()
                                        NowInvestMoney = 0

                                        for stock_code in InvestStockList:
                                            stock_name = ""
                                            stock_amt = 0 #ìˆ˜ëŸ‰
                                            stock_avg_price = 0 #í‰ë‹¨

                                            #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
                                            for my_stock in MyStockList:
                                                if my_stock['StockCode'] == stock_code:
                                                    stock_name = my_stock['StockName']
                                                    stock_amt = int(my_stock['StockAmt'])
                                                    stock_avg_price = float(my_stock['StockAvgPrice'])

                                                    
                                                    NowInvestMoney += (stock_amt*stock_avg_price)
                                                    break

                                        RemainInvestMoney = TotalMoney - NowInvestMoney
                                        ###########################################################

                                    
                                else:
                                    KospidaqStrategyData['Status'] = "REST" 
                                    KospidaqStrategyData['DayStatus'] = "NONE"


                                    msg = KospidaqStrategyData['StockName']  + " ë§¤ìˆ˜í–ˆë‹¤ê³  ê¸°ë¡ë˜ì—ˆëŠ”ë° ë¬¼ëŸ‰ì´ ì—†ë„¤ìš”? ì•”íŠ¼ ì´ˆê¸°í™” í–ˆì–´ìš” ë‹¤ìŒë‚  ë‹¤ì‹œ ì „ëµ ì‹œì‘í•©ë‹ˆë‹¤!"
                                    logging.info(msg)
                                    telegram.send(msg)


            ### ë§¤ìˆ˜ íŒŒíŠ¸ ###
            for KospidaqStrategyData in KospidaqStrategyList:
                pprint.pprint(KospidaqStrategyData)

                stock_code = KospidaqStrategyData['StockCode']
                
                stock_data = combined_df[(combined_df.index == date) & (combined_df['stock_code'] == stock_code)]

                if len(stock_data) == 1:
                    
                    NowOpenPrice = stock_data['open'].values[0]
                    PrevOpenPrice = stock_data['prevOpen'].values[0] 
                    PrevClosePrice = stock_data['prevClose'].values[0] 


                    #í˜„ì¬ê°€!
                    CurrentPrice = KisKR.GetCurrentPrice(stock_code)        
                    
                
                    #í•´ë‹¹ ETFê°€ ë§¤ìˆ˜í•˜ëŠ” ë‚  ìƒíƒœì´ë‹¤!
                    if KospidaqStrategyData['DayStatus'] == "BUY_DAY":              
                        
                        #ë§¤ìˆ˜ ì‹œë„ê°€ ì§„í–‰ ë˜ì—ˆë‹¤. ë§¤ìˆ˜ ì™„ë£Œ ë˜ì—ˆëŠ”ì§€ ì²´í¬
                        if KospidaqStrategyData['Status'] == "INVESTING_TRY":
                            
                            MyStockList = KisKR.GetMyStockList()

                            stock_amt = 0 #ìˆ˜ëŸ‰

                            
                            #ë‚´ê°€ ë³´ìœ í•œ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë§¤ìˆ˜ëœ ì”ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
                            for my_stock in MyStockList:
                                if my_stock['StockCode'] == KospidaqStrategyData['StockCode']:
                                    stock_amt = int(my_stock['StockAmt'])
                                    break
                                
                            #ì‹¤ì œë¡œ 1ì£¼ë¼ë„ ë§¤ìˆ˜ê°€ ë˜ì—ˆë‹¤ë©´ íˆ¬ìì¤‘ ìƒíƒœë¡œ ë³€ê²½!!!
                            if stock_amt > 0:
                                KospidaqStrategyData['Status'] = "INVESTING"
                                KospidaqStrategyData['DayStatus'] = "NONE"
                                
                                msg = KospidaqStrategyData['StockName'] + " íˆ¬ìì¤‘ì´ì—ìš”!!"
                                logging.info(msg)
                                telegram.send(msg)

                            #ì•„ë‹ˆë¼ë©´ ì•Œë¦¼ìœ¼ë¡œ ì•Œë ¤ì¤€ë‹¤!!
                            else:
                        
                                msg = KospidaqStrategyData['StockName'] + "  ì¡°ê±´ì„ ë§Œì¡±í•˜ì—¬ ë§¤ìˆ˜ ì‹œë„í–ˆëŠ”ë° ì•„ì§ 1ì£¼ë„ ë§¤ìˆ˜ë˜ì§€ ì•Šì•˜ì–´ìš”! ê°ì‚°í•´ì„œ ë§¤ìˆ˜ì‹œë„ í•©ë‹ˆë‹¤! "
                                logging.info(msg)
                                telegram.send(msg)

                                if KospidaqStrategyData.get('TryBuyCnt') == None:
                                    KospidaqStrategyData['TryBuyCnt'] = 1


                                KospidaqStrategyData['TryBuyCnt'] = int(KospidaqStrategyData['TryBuyCnt'] * 0.7)

                                if KospidaqStrategyData['TryBuyCnt'] > 1:
                                    # ì‹œì¥ê°€ ë§¤ìˆ˜ë¡œ ë³€ê²½
                                    returnData = KisKR.MakeBuyMarketOrder(KospidaqStrategyData['StockCode'],KospidaqStrategyData['TryBuyCnt'],True) #30%ê°ì†Œëœ ìˆ˜ëŸ‰ìœ¼ë¡œ ë§¤ìˆ˜ ì‹œë„!!
                                    # ë¶„í• ë§¤ìˆ˜ë¡œ ë³€ê²½ (1ë¶„í• , 1ë¶„ ê°„ê²©)
                                    #returnData = MakeSplitBuyOrder(KospidaqStrategyData['StockCode'], KospidaqStrategyData['TryBuyCnt'], split_count=1, time_term=1)
                                    
                                    # ë§¤ìˆ˜ ì¬ì‹œë„ ê±°ë˜ ê¸°ë¡ ì €ì¥
                                    try:
                                        save_buy_history(
                                            stock_code=KospidaqStrategyData['StockCode'],
                                            stock_name=KospidaqStrategyData['StockName'],
                                            quantity=KospidaqStrategyData['TryBuyCnt'],
                                            unit_price=CurrentPrice,
                                            amount=KospidaqStrategyData['TryBuyCnt'] * CurrentPrice,
                                            fee=0
                                        )
                                    except Exception as e:
                                        logging.error(f"ë§¤ìˆ˜ ì¬ì‹œë„ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")

                                    msg = KospidaqStrategyData['StockName'] + "  ì‹œì¥ê°€ë§¤ìˆ˜ ì‹œë„!!! " + str(returnData)
                                    logging.info(msg)
                                    telegram.send(msg)

                                else:

                                    KospidaqStrategyData['Status'] = "REST"
                                    KospidaqStrategyData['DayStatus'] = "NONE"
                                    

                                    msg = KospidaqStrategyData['StockName'] + "  ë§¤ìˆ˜ ì‹¤íŒ¨!!! "
                                    logging.info(msg)
                                    telegram.send(msg)


                                
                            
                            
                        #ìƒíƒœë¥¼ ì²´í¬í•´ì„œ READYë¼ë©´ ëŒíŒŒì‹œ ë§¤ìˆ˜í•œë‹¤!
                        if KospidaqStrategyData['Status'] == "READY" and DateSiGaLogicDoneDict['InvestCnt'] < 2:
                            
                            
                            
                            logging.info("ëŒíŒŒ ì²´í¬ì¤‘...")
                            
                            
                            #ì½”ìŠ¤ë‹¥ ì „ëµ...ëŒíŒŒ ë§¤ë§¤..
                            if stock_code in ["233740","251340"]:
                                

                        
                                DolpaRate = 0.4

                                # KODEX ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
                                if stock_code == "251340":

                                    DolpaRate = 0.4

                                #KODEX ì½”ìŠ¤ë‹¥150ë ˆë²„ë¦¬ì§€
                                else: 

                                    if PrevClosePrice > stock_data['ma60_before'].values[0]:
                                        DolpaRate = 0.3
                                    else:
                                        DolpaRate = 0.4


                    
                                ##########################################################################
                                #ê°­ ìƒìŠ¹ í•˜ë½ì„ ì´ìš©í•œ ëŒíŒŒê°’ ì¡°ì ˆ!
                                # https://blog.naver.com/zacra/223277173514 ì´ í¬ìŠ¤íŒ…ì„ ì²´í¬!!!!
                                ##########################################################################
                                Gap = ((abs(stock_data['open'].values[0] - PrevClosePrice) / PrevClosePrice)) * 100.0

                                GapSt = (Gap*0.025)

                                if GapSt > 1.0:
                                    GapSt = 1.0
                                if GapSt < 0:
                                    GapSt = 0.1

                                if PrevClosePrice > stock_data['open'].values[0] and Gap >= 3.0:
                                    DolpaRate *= (1.0 + GapSt)

                                if PrevClosePrice < stock_data['open'].values[0] and Gap >= 3.0:
                                    DolpaRate *= (1.0 - GapSt)


                    
                                DolPaPrice = stock_data['open'].values[0] + ((stock_data['prevHigh'].values[0] - stock_data['prevLow'].values[0]) * DolpaRate)

                                KospidaqStrategyData['TargetPrice'] = DolPaPrice


                                #ëŒíŒŒê°€ê²©ë³´ë‹¤ í˜„ì¬ê°€ê°€ ë†’ë‹¤? ëŒíŒŒí•œê±°ë‹¤ ë§¤ìˆ˜í•œë‹¤!
                                if CurrentPrice >= KospidaqStrategyData['TargetPrice'] or stock_data['high'].values[0] >= KospidaqStrategyData['TargetPrice']  :

                                    Rate = 1.0
                                    if len(Kosdaq_Long_Data) == 1 and len(Kosdaq_Short_Data) == 1:
                                    
                                        IsLongStrong = False
                                        
                                        if Kosdaq_Long_Data['Average_Momentum'].values[0] > Kosdaq_Short_Data['Average_Momentum'].values[0]:
                                            IsLongStrong = True
                                            
                                        IsLongStrong2 = False
                                        
                                        if Kosdaq_Long_Data['prevChangeMa'].values[0] > Kosdaq_Short_Data['prevChangeMa'].values[0]:
                                            IsLongStrong2 = True
                                            
                                            
                                        if IsLongStrong == True and IsLongStrong2 == True:
                                            
                                            if stock_code == "233740":
                                                Rate = 1.3
                                            else:
                                                Rate = 0.7
                                                
                                        elif IsLongStrong == False and IsLongStrong2 == False:
                                                
                                            if stock_code == "233740":
                                                Rate = 0.7
                                            else:
                                                Rate = 1.3
                                                

                                    #############################################################
                                    #ì‹œìŠ¤í…œ ì†ì ˆ(?) ê´€ë ¨
                                    # https://blog.naver.com/zacra/223225906361 ì´ í¬ìŠ¤íŒ… ì²´í¬!!!
                                    #############################################################
                                                
                                    AdjustRate = 1.0

                                    if DateSiGaLogicDoneDict['IsCut'] == True and DateSiGaLogicDoneDict['IsCutCnt'] >= 2:
                                        
                                        if stock_data['prevOpen'].values[0] > stock_data['prevClose'].values[0] and stock_data['prevHigh2'].values[0] > stock_data['prevHigh'].values[0]:

                                            AdjustRate = stock_data['Average_Momentum3'].values[0] 

                                            if DateSiGaLogicDoneDict['IsCutCnt'] >= 4:
                                                AdjustRate = stock_data['Average_Momentum3'].values[0] * 0.5


                                        
                            
                                    InvestMoneyCell = 0

                                    if IsNoWay == True:
                                        
                                        InvestMoneyCell = InvestMoney * 0.25 * Rate * AdjustRate
                                        

                                    else:                                         
                                    
                                        InvestMoneyCell = InvestMoney * 0.5 * Rate * AdjustRate
                                        
                                        #if DateSiGaLogicDoneDict['InvestCnt']  >= 1:
                                        #    InvestMoneyCell = RemainInvestMoney * Rate * AdjustRate

                                    
                                    if Rate > 0 and AdjustRate > 0:
                                        
                                        #í• ë‹¹ëœ íˆ¬ìê¸ˆì´ ë‚¨ì€ëˆë³´ë‹¤ ë§ë‹¤ë©´ ë‚¨ì€ ëˆë§Œí¼ìœ¼ë¡œ ì„¸íŒ…!
                                        if RemainInvestMoney < InvestMoneyCell:
                                            InvestMoneyCell = RemainInvestMoney



                                            
                                        BuyAmt = int(InvestMoneyCell / CurrentPrice)
                                        

                                        #ìµœì†Œ 2ì£¼ëŠ” ì‚´ ìˆ˜ ìˆë„ë¡!
                                        if BuyAmt < 2:
                                            BuyAmt = 2

                                        KospidaqStrategyData['TryBuyCnt'] = BuyAmt #ë§¤ìˆ˜í•  ìˆ˜ëŸ‰ì„..ì €ì¥!

                                        ######## ì‹œì¥ê°€ ì§€ì •ê°€ ë‚˜ëˆ ì„œ ê³ ê³  ##########    
                                        #SliceAmt = int(BuyAmt / 2)

                                        #ì ˆë°˜ì€ ì‹œì¥ê°€ë¡œ ë°”ë¡œê³ !
                                        #KisKR.MakeBuyMarketOrder(KospidaqStrategyData['StockCode'],SliceAmt,True) 
                                        
                                        #ì ˆë°˜ì€ ëŒíŒŒê°€ê²© ì§€ì •ê°€ë¡œ!
                                        #KisKR.MakeBuyLimitOrder(KospidaqStrategyData['StockCode'],SliceAmt,KospidaqStrategyData['TargetPrice'])

                                        
                                        ######## ì‹œì¥ê°€ 1ë²ˆì— ê³ ê³  ##########
                                        #ì‹œì¥ê°€ë¡œ ë°”ë¡œê³ !
                                        order_result = KisKR.MakeBuyMarketOrder(KospidaqStrategyData['StockCode'],BuyAmt,True) 
                                        
                                        # ë§¤ìˆ˜ ê±°ë˜ ê¸°ë¡ ì €ì¥
                                        try:
                                            save_buy_history(
                                                stock_code=KospidaqStrategyData['StockCode'],
                                                stock_name=KospidaqStrategyData['StockName'],
                                                quantity=BuyAmt,
                                                unit_price=CurrentPrice,
                                                amount=BuyAmt * CurrentPrice,
                                                fee=0
                                            )
                                        except Exception as e:
                                            logging.error(f"ë§¤ìˆ˜ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")
                                    
                                    
                                        DateSiGaLogicDoneDict['InvestCnt'] += 1
                                        #íŒŒì¼ì— ì €ì¥
                                        with open(siga_logic_file_path, 'w') as outfile:
                                            json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)
                                            
                                        RemainInvestMoney -= InvestMoneyCell
                                        
                                        KospidaqStrategyData['Status'] = "INVESTING_TRY"

                            


                                        msg = KospidaqStrategyData['StockName'] + "  ì¡°ê±´ì„ ë§Œì¡±í•˜ì—¬ ë§¤ìˆ˜!!! íˆ¬ì ì‹œì‘!! "
                                        logging.info(msg)
                                        telegram.send(msg)
                                    else:


                                        msg = KospidaqStrategyData['StockName'] + "  ëŒíŒŒí–ˆì§€ë§Œ ì¶”ì„¸ê°€ ì•ˆì¢‹ì•„ ë§¤ìˆ˜ ì•ˆí•¨! "
                                        logging.info(msg)
                                        telegram.send(msg)
                    
                                else:
                                    logging.info("ì•„ì§ ëŒíŒŒ ì•ˆí•¨..")
                                
                                
                            #ì½”ìŠ¤í”¼ ì „ëµ...ì‹œê°€ ë§¤ë§¤
                            else:
                                logging.info("")
                                
                                                    
                                                    
                                #ì²´í¬ ë‚ ì§œê°€ ë‹¤ë¥´ë‹¤ë©´ ë§¨ ì²˜ìŒì´ê±°ë‚˜ ë‚ ì´ ë°”ë€ê²ƒì´ë‹¤!!
                                if DateSiGaLogicDoneDict[stock_code] != day_n:
                                            
                                    IsBuyGo = False
                                    if stock_code == "252670":

                                        #ì´ê±°ë³€ê²½
                                        if PrevClosePrice > stock_data['ma3_before'].values[0]  and PrevClosePrice > stock_data['ma6_before'].values[0]  and PrevClosePrice > stock_data['ma19_before'].values[0] and stock_data['prevRSI'].values[0] < 70 and stock_data['prevRSI2'].values[0] < stock_data['prevRSI'].values[0]:
                                            if (stock_data['prevVolume2'].values[0] < stock_data['prevVolume'].values[0]) and (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and PrevClosePrice > stock_data['ma60_before'].values[0] and stock_data['ma60_before2'].values[0] < stock_data['ma60_before'].values[0]  and stock_data['ma3_before'].values[0]  > stock_data['ma6_before'].values[0]  > stock_data['ma19_before'].values[0]  :
                                                IsBuyGo = True

                                    else:

                                        Disparity = stock_data['Disparity20'].values[0] 
                                        
                                        if (stock_data['prevLow2'].values[0] < stock_data['prevLow'].values[0]) and (Disparity < 98 or Disparity > 106) and stock_data['prevRSI'].values[0] < 80 :
                                            IsBuyGo = True
                        
                                        
                                    if IsBuyGo == True:
                                        
                        
                        
                                        Rate = 1.0
                                        
                                        

                                        InvestMoneyCell = 0


                                        if IsNoWay == True:
                                            
                                            InvestMoneyCell = InvestMoney * 0.25 * Rate

                                        else:
                                            

                                            InvestMoneyCell = InvestMoney * 0.5 * Rate

                                            #if DateSiGaLogicDoneDict['InvestCnt']  >= 1:
                                            #    InvestMoneyCell = RemainInvestMoney * Rate * AdjustRate


                                        #í• ë‹¹ëœ íˆ¬ìê¸ˆì´ ë‚¨ì€ëˆë³´ë‹¤ ë§ë‹¤ë©´ ë‚¨ì€ ëˆë§Œí¼ìœ¼ë¡œ ì„¸íŒ…!
                                        if RemainInvestMoney < InvestMoneyCell:
                                            InvestMoneyCell = RemainInvestMoney

                                            
                                        BuyAmt = int(InvestMoneyCell / CurrentPrice)
                                        
                                        

                                        #ìµœì†Œ 2ì£¼ëŠ” ì‚´ ìˆ˜ ìˆë„ë¡!
                                        if BuyAmt < 2:
                                            BuyAmt = 2

                                        KospidaqStrategyData['TryBuyCnt'] = BuyAmt #ë§¤ìˆ˜í•  ìˆ˜ëŸ‰ì„..ì €ì¥!
                                        ######## ë¶„í• ë§¤ìˆ˜ë¡œ ë³€ê²½ ##########    
                                        #SliceAmt = int(BuyAmt / 2)

                                        #ì ˆë°˜ì€ ì‹œì¥ê°€ë¡œ ë°”ë¡œê³ !
                                        #KisKR.MakeBuyMarketOrder(KospidaqStrategyData['StockCode'],SliceAmt,True) 
                                        
                                        #ì ˆë°˜ì€ ëŒíŒŒê°€ê²© ì§€ì •ê°€ë¡œ!
                                        #KisKR.MakeBuyLimitOrder(KospidaqStrategyData['StockCode'],SliceAmt,CurrentPrice)

                                        
                                        ######## ì‹œì¥ê°€ ë§¤ìˆ˜ë¡œ ë³€ê²½ ##########
                                        #ì‹œì¥ê°€ë¡œ ë°”ë¡œê³ !
                                        order_result = KisKR.MakeBuyMarketOrder(KospidaqStrategyData['StockCode'],BuyAmt,True)
                                        
                                        # ë§¤ìˆ˜ ê±°ë˜ ê¸°ë¡ ì €ì¥
                                        try:
                                            save_buy_history(
                                                stock_code=KospidaqStrategyData['StockCode'],
                                                stock_name=KospidaqStrategyData['StockName'],
                                                quantity=BuyAmt,
                                                unit_price=CurrentPrice,
                                                amount=BuyAmt * CurrentPrice,
                                                fee=0
                                            )
                                        except Exception as e:
                                            logging.error(f"ë§¤ìˆ˜ ê±°ë˜ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")

                                        ######## ë¶„í• ë§¤ìˆ˜ë¡œ ë³€ê²½ ##########
                                        #ë¶„í• ë§¤ìˆ˜ë¡œ ì‹¤í–‰ (1ë¶„í• , 1ë¶„ ê°„ê²©)
                                        #MakeSplitBuyOrder(KospidaqStrategyData['StockCode'], BuyAmt, split_count=1, time_term=1)  
                                        
                                            
                                        DateSiGaLogicDoneDict['InvestCnt'] += 1
                                        #íŒŒì¼ì— ì €ì¥
                                        with open(siga_logic_file_path, 'w') as outfile:
                                            json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)
                                            
                                        
                                        
                                        RemainInvestMoney -= InvestMoneyCell
                                        
                                        KospidaqStrategyData['Status'] = "INVESTING_TRY" 
                            


                                        msg = KospidaqStrategyData['StockName'] + "  ì¡°ê±´ì„ ë§Œì¡±í•˜ì—¬ ë§¤ìˆ˜!!! íˆ¬ì ì‹œì‘!! "
                                        logging.info(msg)
                                        telegram.send(msg)



                                    msg = KospidaqStrategyData['StockName'] + " ì˜¤ëŠ˜ ë§¤ìˆ˜ì—¬ë¶€ ì²´í¬ ì™„ë£Œ!"
                                    logging.info(msg)
                                    #telegram.send(msg)


                                    #ì‹œê°€ ë§¤ìˆ˜ ë¡œì§ ì•ˆìœ¼ë¡œ ë“¤ì–´ì™”ë‹¤ë©´ ë‚ ìë¥¼ ë°”ê¿”ì¤€ë‹¤!!
                                    DateSiGaLogicDoneDict[stock_code] = day_n
                                    #íŒŒì¼ì— ì €ì¥
                                    with open(siga_logic_file_path, 'w') as outfile:
                                        json.dump(DateSiGaLogicDoneDict, outfile, indent=4, sort_keys=True, ensure_ascii=False)

            #íŒŒì¼ì— ì €ì¥
            with open(data_file_path, 'w') as outfile:
                json.dump(KospidaqStrategyList, outfile, indent=4, sort_keys=True, ensure_ascii=False)
    else:
        logging.info("Market Is Close!!!!!!!!!!!")


    pprint.pprint(DateData)
    pprint.pprint(KospidaqStrategyList)


else:
    logging.info("ì½”ë“œ ë§¨ ì²« ë¶€ë¶„ì— ENABLE_ORDER_EXECUTION ê°’ì„ Trueë¡œ ë³€ê²½í•´ì•¼ ë§¤ìˆ˜ë§¤ë„ê°€ ì§„í–‰ë©ë‹ˆë‹¤!")

# ì¢…ëª© ìƒíƒœ ìš”ì•½ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
def create_status_summary_message(KospidaqStrategyList, current_date):
    """ëª¨ë“  ì¢…ëª©ì˜ ìƒíƒœë¥¼ ìš”ì•½í•œ í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    status_messages = []
    
    for strategy_data in KospidaqStrategyList:
        stock_name = strategy_data['StockName']
        stock_code = strategy_data['StockCode']
        status = strategy_data['Status']
        
        # ìƒíƒœ ì„¤ëª… ë§¤í•‘
        status_descriptions = {
            "READY": "ëŒíŒŒë¥¼ ì²´í¬í•´ì•¼ í•˜ëŠ” ì¤€ë¹„ìƒíƒœ",
            "INVESTING": "ëŒíŒŒí•´ì„œ íˆ¬ìì¤‘",
            "INVESTING_TRY": "ë§¤ìˆ˜ ì£¼ë¬¸ ë“¤ì–´ê°",
            "SELL_DONE_CHECK": "ë§¤ë„ ì™„ë£Œ ì²´í¬",
            "REST": "ì¡°ê±´ë¶ˆë§Œì¡±, íˆ¬ìì•ˆí•¨, ëŒíŒŒì²´í¬ì•ˆí•¨"
        }
        
        status_desc = status_descriptions.get(status, "ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ")
        status_messages.append(f"{stock_name}:{status}\n({status_desc})")
    
    # ì „ì²´ ë©”ì‹œì§€ ì¡°í•©
    summary_message = f"{PortfolioName}({current_date})\n\nì¢…ëª©ë³„ ìƒíƒœ:\n" + "\n".join(status_messages)
    
    return summary_message

# ìˆ˜ìµ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
def calculate_and_update_profit():
    """í˜„ì¬ ìˆ˜ìµì„ ê³„ì‚°í•˜ê³  í¬íŠ¸í´ë¦¬ì˜¤ ë§¤ë‹ˆì €ì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    try:
        # í˜„ì¬ ë³´ìœ  ì£¼ì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        MyStockList = KisKR.GetMyStockList()
        
        # ì¥ì´ ë‹«í˜€ìˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        if not MyStockList:
            logging.warning("ë³´ìœ  ì£¼ì‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¥ì´ ë‹«í˜€ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            # ê¸°ì¡´ ìˆ˜ìµ ì •ë³´ë¥¼ ìœ ì§€í•˜ê±°ë‚˜ ê¸°ë³¸ê°’ ë°˜í™˜
            return 0, 0, 0
        
        total_profit = 0
        total_investment = 0
        processed_stocks = 0
        
        for stock in MyStockList:
            if stock['StockCode'] in InvestStockList:  # íˆ¬ì ëŒ€ìƒ ì¢…ëª©ë§Œ ê³„ì‚°
                try:
                    stock_profit = float(stock['StockRevenueMoney'])
                    stock_investment = float(stock['StockNowMoney'])
                    
                    total_profit += stock_profit
                    total_investment += stock_investment
                    processed_stocks += 1
                    
                    logging.info(f"ì¢…ëª© ì²˜ë¦¬: {stock['StockName']} - ìˆ˜ìµ: {stock_profit}, íˆ¬ìê¸ˆ: {stock_investment}")
                except (ValueError, KeyError) as e:
                    logging.error(f"ì£¼ì‹ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                    continue
        
        # ì²˜ë¦¬ëœ ì¢…ëª©ì´ ì—†ëŠ” ê²½ìš°
        if processed_stocks == 0:
            logging.warning("ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” íˆ¬ì ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
            return 0, 0, 0
        
        # ì´ˆê¸° íˆ¬ìê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
        initial_investment = portfolio_manager.get_initial_investment() * InvestRate
        
        # ìˆ˜ìµë¥  ê³„ì‚°
        profit_rate = (total_profit / initial_investment * 100) if initial_investment > 0 else 0
        
        # í¬íŠ¸í´ë¦¬ì˜¤ ë§¤ë‹ˆì €ì— ì—…ë°ì´íŠ¸
        portfolio_manager.update_bot_profit("Kosdaqpi_Bot", total_profit, profit_rate)
        
        # ë¡œê·¸ ì¶œë ¥
        logging.info("=== Kosdaqpi_Bot ìˆ˜ìµ í˜„í™© ===")
        logging.info(f"ì´ íˆ¬ìê¸ˆì•¡: {initial_investment:,.0f}ì›")
        logging.info(f"ì´ í‰ê°€ê¸ˆì•¡: {total_investment:,.0f}ì›")
        logging.info(f"ì´ ìˆ˜ìµê¸ˆ: {total_profit:,.0f}ì›")
        logging.info(f"ìˆ˜ìµë¥ : {profit_rate:.2f}%")
        logging.info(f"ì²˜ë¦¬ëœ ì¢…ëª© ìˆ˜: {processed_stocks}ê°œ")
        
        return total_profit, profit_rate, total_investment
        
    except Exception as e:
        logging.error(f"ìˆ˜ìµ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return 0, 0, 0

# ë³´ìœ  ì¢…ëª© ì •ë³´ë¥¼ portfolio_config.jsonì— ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
def update_portfolio_holdings():
    """í˜„ì¬ ë³´ìœ  ì¢…ëª© ì •ë³´ë¥¼ portfolio_config.jsonì— ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."""
    try:
        # í˜„ì¬ ë³´ìœ  ì£¼ì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        MyStockList = KisKR.GetMyStockList()
        
        if not MyStockList:
            logging.warning("ë³´ìœ  ì£¼ì‹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        # portfolio_config.json íŒŒì¼ ì½ê¸°
        script_dir = os.path.dirname(os.path.abspath(__file__))
        config_file_path = os.path.join(script_dir, "portfolio_config.json")
        
        with open(config_file_path, 'r', encoding='utf-8') as f:
            config_data = json.load(f)
        
        # Kosdaqpi_Botì˜ ë³´ìœ  ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸
        holdings = []
        total_holding_value = 0
        cumulative_profit = 0
        
        for stock in MyStockList:
            if stock['StockCode'] in InvestStockList:  # íˆ¬ì ëŒ€ìƒ ì¢…ëª©ë§Œ ì²˜ë¦¬
                try:
                    stock_code = stock['StockCode']
                    stock_name = stock['StockName']
                    stock_amt = int(stock['StockAmt'])
                    stock_avg_price = float(stock['StockAvgPrice'])
                    stock_now_price = float(stock['StockNowPrice'])
                    stock_revenue_money = float(stock['StockRevenueMoney'])
                    stock_revenue_rate = float(stock['StockRevenueRate'])
                    
                    # í˜„ì¬ í‰ê°€ê¸ˆì•¡ ê³„ì‚°
                    current_value = stock_amt * stock_now_price
                    
                    # ë³´ìœ  ì¢…ëª© ì •ë³´ ìƒì„±
                    holding_info = {
                        "stock_code": stock_code,
                        "stock_name": stock_name,
                        "purchase_price": stock_avg_price,
                        "current_price": stock_now_price,
                        "quantity": stock_amt,
                        "profit_rate": stock_revenue_rate,
                        "current_value": current_value,
                        "profit_loss": stock_revenue_money
                    }
                    
                    holdings.append(holding_info)
                    total_holding_value += current_value
                    cumulative_profit += stock_revenue_money
                    
                    logging.info(f"ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸: {stock_name} - ìˆ˜ëŸ‰: {stock_amt}, ìˆ˜ìµë¥ : {stock_revenue_rate:.2f}%")
                    
                except (ValueError, KeyError) as e:
                    logging.error(f"ì¢…ëª© ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
                    continue
        
        # í˜„ì¬ ë¶„ë°°ê¸ˆ ê³„ì‚° (ì´ˆê¸° ë¶„ë°°ê¸ˆ + í‰ê°€ ì†ìµ + ì‹¤í˜„ ì†ìµ ëˆ„ì )
        initial_allocation = config_data['bots']['Kosdaqpi_Bot']['initial_allocation']
        realized_total_profit = config_data['bots']['Kosdaqpi_Bot'].get('total_sold_profit', 0)
        current_allocation = initial_allocation + cumulative_profit + realized_total_profit
        
        # í˜„ê¸ˆ ì”ê³  ê³„ì‚° (í˜„ì¬ ë¶„ë°°ê¸ˆ - ë³´ìœ  ì£¼ì‹ í‰ê°€ê¸ˆì•¡)
        cash_balance = current_allocation - total_holding_value
        
        # portfolio_config.json ì—…ë°ì´íŠ¸
        config_data['bots']['Kosdaqpi_Bot']['current_allocation'] = current_allocation
        config_data['bots']['Kosdaqpi_Bot']['holdings'] = holdings
        config_data['bots']['Kosdaqpi_Bot']['total_holding_value'] = total_holding_value
        config_data['bots']['Kosdaqpi_Bot']['cash_balance'] = cash_balance
        # íŒë§¤ ëˆ„ì  ìˆ˜ìµì€ íŒë§¤ ì‹œì ì—ë§Œ ê°±ì‹ ë˜ë©° ì—¬ê¸°ì„œ ë¦¬ì…‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        config_data['bots']['Kosdaqpi_Bot']['total_sold_profit'] = realized_total_profit
        
        # íŒŒì¼ì— ì €ì¥
        with open(config_file_path, 'w', encoding='utf-8') as f:
            json.dump(config_data, f, ensure_ascii=False, indent=4)
        
        logging.info("í¬íŠ¸í´ë¦¬ì˜¤ ë³´ìœ  ì¢…ëª© ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
        logging.info(f"ì´ ë³´ìœ  ê°€ì¹˜: {total_holding_value:,.0f}ì›")
        logging.info(f"ëˆ„ì  ìˆ˜ìµ: {cumulative_profit:,.0f}ì›")
        logging.info(f"í˜„ê¸ˆ ì”ê³ : {cash_balance:,.0f}ì›")
        
    except Exception as e:
        logging.error(f"í¬íŠ¸í´ë¦¬ì˜¤ ë³´ìœ  ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}")

# ìˆ˜ìµ ì •ë³´ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
def create_profit_summary_message(total_profit, profit_rate, total_investment, current_date):
    """ìˆ˜ìµ ìš”ì•½ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    # portfolio_config.jsonì—ì„œ ë´‡ ì •ë³´ ì½ê¸°
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        config_file_path = os.path.join(script_dir, "portfolio_config.json")
        
        with open(config_file_path, 'r', encoding='utf-8') as f:
            config_data = json.load(f)
        
        initial_allocation = config_data['bots']['Kosdaqpi_Bot']['initial_allocation']
        current_allocation = config_data['bots']['Kosdaqpi_Bot']['current_allocation']
        total_sold_profit = config_data['bots']['Kosdaqpi_Bot']['total_sold_profit']
    except Exception as e:
        logging.error(f"portfolio_config.json ì½ê¸° ì¤‘ ì˜¤ë¥˜: {e}")
        initial_allocation = 0
        current_allocation = 0
        total_sold_profit = 0
    
    # í˜„ì¬ ë³´ìœ  ì£¼ì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    MyStockList = KisKR.GetMyStockList()
    
    # íˆ¬ì ëŒ€ìƒ ì¢…ëª© ì½”ë“œ ë¦¬ìŠ¤íŠ¸ ìƒì„± (InvestStockListëŠ” ì´ë¯¸ ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸)
    invest_stock_codes = InvestStockList
    
    message = f"ğŸ“Š {PortfolioName}\nìƒì„¸ ìˆ˜ìµ í˜„í™© ({current_date})\n"
    message += "=" * 34 + "\n"
    
    # ì¢…ëª©ë³„ ìƒì„¸ ì •ë³´ ì¶”ê°€
    profit_stocks = 0
    loss_stocks = 0
    neutral_stocks = 0
    
    for stock in MyStockList:
        if stock['StockCode'] in invest_stock_codes:
            stock_name = stock['StockName']
            stock_code = stock['StockCode']
            stock_amt = int(stock['StockAmt'])
            stock_avg_price = float(stock['StockAvgPrice'])
            stock_now_price = float(stock['StockNowPrice'])
            stock_revenue_money = float(stock['StockRevenueMoney'])
            stock_revenue_rate = float(stock['StockRevenueRate'])
            
            # ìˆ˜ìµ/ì†ì‹¤ ìƒíƒœ ì¹´ìš´íŠ¸
            if stock_revenue_money > 0:
                profit_stocks += 1
                status_emoji = "âœ…"
            elif stock_revenue_money < 0:
                loss_stocks += 1
                status_emoji = "âŒ"
            else:
                neutral_stocks += 1
                status_emoji = "â–"
            
            # ì´ê¸ˆì•¡ ê³„ì‚°
            total_amount = stock_amt * stock_now_price
            
            # ìˆ˜ìµ/ì†ì‹¤ ê¸°í˜¸ ê²°ì •
            profit_sign = "+" if stock_revenue_money >= 0 else ""
            rate_sign = "+" if stock_revenue_rate >= 0 else ""
            
            message += f"{status_emoji} {stock_name} ({stock_amt}ì£¼)\n"
            message += f"   {total_amount:,.0f}ì›({profit_sign}{stock_revenue_money:,.0f}ì›:{rate_sign}{stock_revenue_rate:.2f}%)\n"
    
    # ì „ì²´ ìš”ì•½ ì •ë³´
    message += "=" * 34 + "\n"
    message += f"ğŸ’° ì´ˆê¸° ë¶„ë°°ê¸ˆ: {initial_allocation:,.0f}ì›\n"
    message += f"ğŸ’° í˜„ì¬ ë¶„ë°°ê¸ˆ: {current_allocation:,.0f}ì›\n"
    message += f"ğŸ’° ì´ íˆ¬ìê¸ˆì•¡: {total_investment:,.0f}ì›\n"
    message += f"ğŸ“ˆ í˜„ì¬ ìˆ˜ìµê¸ˆ: {total_profit:,.0f}ì›({profit_rate:+.2f}%)\n"
    message += f"ğŸ“Š ëˆ„ì  íŒë§¤ ìˆ˜ìµê¸ˆ: {total_sold_profit:,.0f}ì›\n"
    message += f"ğŸ“Š ì¢…ëª©ë³„ í˜„í™©: ìˆ˜ìµ {profit_stocks}ê°œ, ì†ì‹¤ {loss_stocks}ê°œ, ì†ìµì—†ìŒ {neutral_stocks}ê°œ\n"
    
    return message

# ë´‡ ì‹¤í–‰ ì‹œì‘ ì‹œ ê¸°ê°„ë³„ ìˆ˜ìµ ì´ˆê¸°í™”
if ENABLE_ORDER_EXECUTION == True:
    try:
        # ì¼ë³„, ì›”ë³„, ì—°ë³„ íŒë§¤ìˆ˜ìµ ì´ˆê¸°í™”
        initialize_period_profits()
        
        # ìˆ˜ìµ ê³„ì‚° ë° ê²°ê³¼ ë°›ê¸°
        total_profit, profit_rate, total_investment = calculate_and_update_profit()
        
        # ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ ê³„ì‚°
        history_profit, history_profit_rate, history_investment, history_realized_profit = calculate_profit_from_history()
        
        # ë³´ìœ  ì¢…ëª© ì •ë³´ë¥¼ portfolio_config.jsonì— ì—…ë°ì´íŠ¸
        update_portfolio_holdings()
        
        # í˜„ì¬ ë‚ ì§œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        current_date = time.strftime("%Y-%m-%d")
        
        # ìƒíƒœ ìš”ì•½ ë©”ì‹œì§€ì™€ ìˆ˜ìµ ì •ë³´ ë©”ì‹œì§€ ìƒì„±
        status_summary = create_status_summary_message(KospidaqStrategyList, current_date)
        profit_summary = create_profit_summary_message(total_profit, profit_rate, total_investment, current_date)
        
        # ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ ì •ë³´ ì¶”ê°€
        if history_investment > 0:
            history_message = f"\nğŸ“Š ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ í˜„í™©:\n"
            history_message += f"ğŸ’° ì´ íˆ¬ìê¸ˆì•¡: {history_investment:,.0f}ì›\n"
            history_message += f"ğŸ“ˆ í‰ê°€ì†ìµ: {history_profit:,.0f}ì› ({history_profit_rate:+.2f}%)\n"
            history_message += f"ğŸ’° ì‹¤í˜„ì†ìµ: {history_realized_profit:,.0f}ì›\n"
            profit_summary += history_message
        
        # ê±°ë˜ ë‚´ì—­ ìš”ì•½ ì¶”ê°€
        trade_summary = get_trade_history_summary()
        if trade_summary and "ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤" not in trade_summary:
            profit_summary += f"\n{trade_summary}"
        
        # ë‘ ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ë¡œ í•©ì³ì„œ í…”ë ˆê·¸ë¨ ì „ì†¡
        combined_message = status_summary + "\n\n" + profit_summary
        telegram.send(combined_message)
        logging.info("ìƒíƒœ ìš”ì•½ ë©”ì‹œì§€ì™€ ìˆ˜ìµ ì •ë³´ë¥¼ í•˜ë‚˜ì˜ ë©”ì‹œì§€ë¡œ í•©ì³ì„œ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.")
        logging.info(f"ê±°ë˜ ë‚´ì—­ ê¸°ë°˜ ìˆ˜ìµ ê³„ì‚° ì™„ë£Œ: íˆ¬ìê¸ˆ {history_investment:,.0f}ì›, ìˆ˜ìµë¥  {history_profit_rate:.2f}%")

    except Exception as e:
        error_msg = f"ìˆ˜ìµ ê³„ì‚° ì¤‘ ì˜¤ë¥˜: {e}"
        logging.error(error_msg)
        # ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë´‡ì€ ì •ìƒ ì¢…ë£Œë¡œ ì²˜ë¦¬

# ë©”ì¸ ì‹¤í–‰ ë¶€ë¶„ ì¶”ê°€
if __name__ == "__main__":
    try:
        logging.info("Kosdaqpi_Bot ì‹œì‘")
        logging.info("=" * 37)
        
        # ì—¬ê¸°ì— ë´‡ì˜ ë©”ì¸ ë¡œì§ì´ ì‹¤í–‰ë©ë‹ˆë‹¤
        # ìœ„ì˜ ì½”ë“œì—ì„œ ì´ë¯¸ ì‹¤í–‰ë˜ë¯€ë¡œ ì¶”ê°€ ì‹¤í–‰ì€ í•„ìš” ì—†ìŒ
        
        logging.info("=" * 37)
        logging.info("Kosdaqpi_Bot ì •ìƒ ì¢…ë£Œ")
        
    except Exception as e:
        error_msg = f"Kosdaqpi_Bot ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"
        logging.error(error_msg)
        telegram.send(f"âŒ {error_msg}")
        # ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì¢…ë£Œ ì½”ë“œ 0ìœ¼ë¡œ ì²˜ë¦¬ (ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì •ìƒ ì¢…ë£Œë¡œ ì¸ì‹)
        sys.exit(0)