# 스캘핑 최적화 스크립트 - 모듈화 버전

## 📁 파일 구조

```
Scalp_1m_5MA20MA_Optimizer.py  # 기존 파일 (백업됨)
├── config.py                   # 설정 및 상수
├── utils.py                    # 유틸리티 함수들
├── worker.py                   # 워커 프로세스 관련
├── optimizer.py                # 메인 최적화 로직 (배치 처리 지원)
├── optimizer_batch.py          # 🆕 전용 배치 처리 최적화 버전
└── README_모듈화.md           # 이 파일
```

## 🚀 사용법

### 1. 기본 실행 (배치 처리 지원)
```bash
python optimizer.py
```

### 2. 전용 배치 처리 버전
```bash
python optimizer_batch.py
```

### 3. 개별 모듈 테스트
```bash
# 설정 확인
python -c "import config; print(config.DATA_DIR)"

# 유틸리티 함수 테스트
python -c "import utils; print(utils.generate_param_grid()[:5])"
```

## 🔧 모듈별 설명

### config.py
- 파일 경로, 데이터 경로 설정
- 파라미터 그리드 설정 (MA 기간, 손절 비율 등)
- 백테스트 설정 (수수료, 레버리지 등)
- 병렬 처리 설정
- **수익률 양수 결과 파일 경로**

### utils.py
- 진행상태 로드/저장
- 실시간 로깅
- 파라미터 그리드 생성
- 결과 저장 (CSV, JSON)
- **수익률 양수 결과만 별도 저장 및 분석**

### worker.py
- 워커 프로세스 초기화
- 단일 조합 실행 함수
- 백테스트 실행 및 결과 처리

### optimizer.py
- 메인 최적화 로직
- 병렬 처리 관리
- 진행상황 모니터링
- 최종 결과 요약
- **수익률 양수 전략 TOP 5 표시**
- **🆕 배치 처리 및 메모리 최적화**

### optimizer_batch.py (🆕)
- **전용 배치 처리 최적화**
- **메모리 효율적인 대용량 데이터 처리**
- **증분 저장으로 I/O 부하 최소화**

## ⚡ 성능 개선 효과

### 기존 vs 모듈화
- **파일 크기**: 250줄 → 각 모듈 50-100줄
- **로딩 속도**: 전체 파일 로드 → 필요한 모듈만 로드
- **메모리 사용**: 전체 코드 로드 → 모듈별 메모리 관리
- **유지보수**: 단일 파일 → 기능별 분리

### 7800X3D 최적화
- **워커 수**: 자동 감지 (8코어 16스레드)
- **병렬 처리**: 최대 13개 워커 동시 실행
- **메모리 효율**: 모듈별 로딩으로 메모리 사용량 감소

### 🆕 배치 처리 최적화
- **메모리 관리**: 2000개씩 배치 처리로 메모리 사용량 제한
- **I/O 최적화**: 배치 단위 증분 저장으로 파일 I/O 부하 감소
- **가비지 컬렉션**: 주기적 메모리 정리로 성능 안정화
- **진행률 모니터링**: 배치별 진행상황 실시간 표시

## 💰 수익률 양수 결과 분석

### 자동 저장 파일
- `logs/Scalp_Opt_Profitable_Results.csv` - 수익률 양수 결과 (CSV)
- `logs/Scalp_Opt_Profitable_Results.json` - 수익률 양수 결과 + 요약 (JSON)

### 분석 정보
- **수익률 양수 전략 수**: 전체 대비 비율
- **최고 수익률**: 가장 높은 수익률 전략
- **평균 수익률**: 수익률 양수 전략들의 평균
- **TOP 5 전략**: 수익률 기준 상위 5개 전략

### 실시간 출력 예시
```
💰 수익률 양수 결과 분석:
========================================
✅ 수익률 양수 결과 저장 완료: 3,456개
   📊 수익률 비율: 22.7%
   📈 최고 수익률: +45.23%
   📊 평균 수익률: +12.34%

📊 수익률 양수 전략 TOP 5:
 1. +45.23% | tf=1m, f=5, s=25, sl=0.15%, vm=1.20, mfc=06
 2. +38.91% | tf=3m, f=7, s=30, sl=0.20%, vm=1.10, mfc=08
 3. +32.45% | tf=5m, f=3, s=20, sl=0.10%, vm=1.30, mfc=04
 4. +28.76% | tf=1m, f=8, s=35, sl=0.25%, vm=1.15, mfc=10
 5. +25.12% | tf=3m, f=4, s=25, sl=0.18%, vm=1.25, mfc=06
```

## 🆕 배치 처리 최적화 상세

### 메모리 효율성
```
📦 배치 크기: 2,000개 (메모리 최적화)
💾 배치 1 중간 저장 중... (2,000개 완료)
🧹 메모리 정리 중... (현재 결과 수: 2,000개)
✅ 배치 1 완료 | 진행률: 2.5%
```

### 배치 처리 장점
- **메모리 사용량 제한**: 2,000개씩 처리하여 메모리 누적 방지
- **주기적 저장**: 배치마다 중간 결과 저장으로 데이터 손실 방지
- **가비지 컬렉션**: 배치 완료 후 메모리 정리로 성능 안정화
- **진행률 모니터링**: 배치별 상세한 진행상황 표시

### 대용량 데이터 처리
- **81,144개 조합**: 총 41개 배치로 분할 처리
- **메모리 효율**: 각 배치 완료 후 메모리 해제
- **안정성**: 배치별 독립 처리로 오류 격리

## 🛠️ 설정 변경

### 파라미터 조정
`config.py`에서 다음 값들을 수정할 수 있습니다:

```python
# MA 기간 범위
FAST_WINDOWS = list(range(3, 21))        # 3~20
SLOW_WINDOWS = list(range(20, 61, 5))    # 20~60 step=5

# 손절 비율
STOP_LOSSES = [0.0003, 0.0005, 0.0007, 0.0010, 0.0015, 0.0020, 0.0030]

# 거래량 배수
VOL_MULTIPLIERS = [1.0, 1.1, 1.2, 1.3]
```

### 배치 크기 조정
```python
# optimizer.py에서
BATCH_SIZE = 2000  # 2000개씩 처리 (메모리 상황에 따라 조정)

# optimizer_batch.py에서
BATCH_SIZE = 1000  # 1000개씩 처리 (더 보수적인 메모리 관리)
```

### 데이터 경로 변경
```python
# 데이터 파일 경로
DATA_DIR = os.path.join(script_dir, 'data', 'BTC_USDT', '1m')
CSV_PATTERN = '2025-03.csv'  # 필요 시 변경

# 수익률 양수 결과 파일 경로
PROFITABLE_CSV = os.path.join(script_dir, 'logs', 'Scalp_Opt_Profitable_Results.csv')
PROFITABLE_JSON = os.path.join(script_dir, 'logs', 'Scalp_Opt_Profitable_Results.json')
```

## 📊 로그 및 결과

### 로그 파일
- `logs/Scalp_Opt_Progress.json` - 진행상태
- `logs/Scalp_Opt_Realtime.log` - 실시간 로그
- `logs/Scalp_Opt_Results.csv` - 최종 결과 (CSV)
- `logs/Scalp_Opt_Results.json` - 최종 결과 (JSON)
- **`logs/Scalp_Opt_Profitable_Results.csv` - 수익률 양수 결과 (CSV)**
- **`logs/Scalp_Opt_Profitable_Results.json` - 수익률 양수 결과 + 요약 (JSON)**
- **`logs/batch_results/` - 배치별 중간 결과 (배치 처리 버전)**

### 진행상태 저장
- 각 조합 완료 시마다 자동 저장
- 중단 후 재실행 시 이어서 진행
- 백업 파일 자동 생성
- **🆕 배치별 진행상태 추적**

## 🔍 문제 해결

### Import 오류
```bash
# 현재 디렉토리에서 실행
cd kook/binance_test
python optimizer.py
```

### 메모리 부족
- `config.py`에서 `MAX_WORKERS_LIMIT` 값 조정
- 파라미터 그리드 범위 축소
- **🆕 배치 크기 축소 (BATCH_SIZE = 1000)**
- **🆕 전용 배치 처리 버전 사용 (`optimizer_batch.py`)**

### 성능 최적화
- SSD 사용 권장
- 충분한 RAM 확보 (16GB 이상)
- 백그라운드 프로세스 최소화
- **🆕 배치 처리로 메모리 사용량 제한**

## 📈 예상 성능

### 7800X3D 기준
- **총 조합 수**: 약 81,000개
- **예상 소요 시간**: 4-8시간
- **메모리 사용량**: 2-4GB (배치 처리로 제한)
- **CPU 사용률**: 90-95%

### 병렬 처리 효율
- **워커 수**: 13개
- **처리 속도**: 기존 대비 10-15배 향상
- **안정성**: 모듈별 오류 격리
- **🆕 메모리 효율**: 배치 처리로 안정적인 성능 유지**

### 수익률 분석
- **수익률 양수 비율**: 일반적으로 15-30%
- **최고 수익률**: 20-60% 범위
- **평균 수익률**: 5-20% 범위

### 🆕 배치 처리 성능
- **배치 크기**: 1,000-2,000개
- **메모리 사용량**: 배치별 200-500MB
- **저장 주기**: 배치 완료 시마다
- **복구 가능성**: 배치별 독립 저장으로 중단 시 이어서 진행
