# 고도화된 이동평균선 + 머신러닝 자동매매봇

## 개요
단순한 이동평균선 두 개를 기반으로 하되, 머신러닝과 오토튜닝이 포함된 고도화된 자동매매 시스템입니다.

## 핵심 특징

### 1. 이동평균선 기반 신호 트리거
- **단기/장기 이동평균선** 크로스오버 신호
- **현재가가 이평선 위로 돌파** → 매수 신호
- **현재가가 이평선 아래로 돌파** → 매도 신호

### 2. 21가지 보조지표 머신러닝 피처
- **볼린저밴드** (BBANDS)
- **RSI** (Relative Strength Index)
- **스토캐스틱** (Stochastic)
- **MACD** (Moving Average Convergence Divergence)
- **ATR** (Average True Range)
- **ADX** (Average Directional Index)
- **CCI** (Commodity Channel Index)
- **Williams %R**
- **MFI** (Money Flow Index)
- **OBV** (On Balance Volume)
- **ROC** (Rate of Change)
- **Momentum**
- **KAMA** (Kaufman's Adaptive Moving Average)
- **TRIX**
- **Ultimate Oscillator**
- **Aroon**
- **BOP** (Balance of Power)
- **DX** (Directional Movement Index)
- **MINUS_DI, PLUS_DI**
- **PPO** (Percentage Price Oscillator)

### 3. 파라미터 오토튜닝
- **이동평균선 기간** 자동 최적화
- **보조지표 파라미터** 자동 튜닝
- **거래 파라미터** (포지션 크기, 스탑로스, 익절) 자동 조정
- **랜덤 샘플링**으로 과최적화 방지

### 4. 드리프트 모니터링 및 리파인
- **모델 성능 변화** 실시간 모니터링
- **드리프트 감지** 시 자동 모델 재훈련
- **성능 임계값** 기반 리파인 트리거

### 5. 월별 자동 재학습
- **한 달마다** 자동 모델 재훈련
- **최신 데이터**로 파라미터 재최적화
- **드리프트 감지** 시 즉시 재학습

### 6. 슬리피지, 수수료 반영 백테스트
- **슬리피지**: 0.05% 반영
- **펀딩비**: 제거됨 (0%)
- **수수료**: 0.05% (매수/매도 각각, 왕복 0.1%)
- **실제 거래 환경**과 동일한 조건

### 7. 스탑로스 시스템
- **동적 스탑로스**: 2% 기본값
- **동적 익절**: 3% 기본값
- **포지션별** 개별 관리

## 파일 구조

```
advanced_ma_ml_bot.py    # 메인 봇 클래스
run_advanced_bot.py      # 실행 스크립트
README_advanced_bot.md   # 사용법 가이드
```

## 사용법

### 1. 전체 최적화 실행
```bash
python run_advanced_bot.py
```
실행 후 "1" 선택

**실행 과정:**
1. **2023년 데이터**로 파라미터 최적화
2. **머신러닝 모델** 훈련
3. **2024년 데이터**로 백테스트 (월별 재학습 포함)
4. **최종 결과** 출력

### 2. 빠른 테스트
```bash
python run_advanced_bot.py
```
실행 후 "2" 선택

**실행 과정:**
1. **2024년 1월 데이터**만 사용
2. **기본 파라미터**로 빠른 테스트
3. **머신러닝 모델** 훈련
4. **백테스트** 실행

### 3. 직접 사용
```python
from advanced_ma_ml_bot import AdvancedMAMLBot

# 봇 생성
bot = AdvancedMAMLBot(initial_balance=10000, leverage=20)

# 데이터 로드
df = pd.read_csv('data.csv')
df['timestamp'] = pd.to_datetime(df['timestamp'])
df = df.set_index('timestamp')

# 파라미터 오토튜닝
tune_result = bot.auto_tune_parameters(df)

# 머신러닝 모델 훈련
train_result = bot.train_ml_model(df)

# 백테스트 실행
results = bot.run_backtest(df)

# 모델 저장
bot.save_model('my_model.pkl')
```

## 파라미터 설정

### 기본 파라미터
```python
params = {
    # 이동평균선
    'ma_short': 5,           # 단기 이동평균
    'ma_long': 20,           # 장기 이동평균
    
    # 거래 파라미터
    'position_size': 0.1,    # 포지션 크기 (자본의 10%)
    'stop_loss_pct': 0.02,   # 스탑로스 2%
    'take_profit_pct': 0.03, # 익절 3%
    'max_positions': 3,      # 최대 동시 포지션 수
    
    # 보조지표 파라미터
    'bb_period': 20,         # 볼린저밴드 기간
    'bb_std': 2.0,           # 볼린저밴드 표준편차
    'rsi_period': 14,        # RSI 기간
    'stoch_k': 14,           # 스토캐스틱 K
    'stoch_d': 3,            # 스토캐스틱 D
    'macd_fast': 12,         # MACD 빠른 기간
    'macd_slow': 26,         # MACD 느린 기간
    'macd_signal': 9,        # MACD 시그널 기간
    # ... 기타 21가지 보조지표 파라미터
}
```

### 오토튜닝 범위
```python
param_ranges = {
    'ma_short': [3, 5, 7, 10, 12],
    'ma_long': [15, 20, 25, 30, 50],
    'bb_period': [15, 20, 25],
    'bb_std': [1.5, 2.0, 2.5],
    'rsi_period': [10, 14, 18],
    'position_size': [0.05, 0.1, 0.15, 0.2],
    'stop_loss_pct': [0.015, 0.02, 0.025, 0.03],
    'take_profit_pct': [0.025, 0.03, 0.035, 0.04]
}
```

## 머신러닝 모델

### 사용 모델
- **RandomForest**: 기본 모델
- **GradientBoosting**: 부스팅 모델
- **LogisticRegression**: 선형 모델
- **SVM**: 서포트 벡터 머신

### 피처 엔지니어링
- **기본 피처**: 21가지 보조지표
- **파생 피처**: 크로스오버, 과매수/과매도, 변동성 등
- **가격 변화율**: 1일, 5일, 10일 변화율
- **볼륨 변화율**: 1일, 5일 변화율

### 라벨 생성
- **미래 수익률** 기반 라벨
- **1% 이상 수익률** → 매수 신호 (1)
- **1% 미만 수익률** → 매도 신호 (0)

## 드리프트 모니터링

### 감지 방법
- **예측 확률 분포** 변화 모니터링
- **평균/표준편차** 변화 감지
- **임계값 초과** 시 드리프트 감지

### 대응 방법
- **모델 재훈련** 자동 실행
- **파라미터 재최적화** 자동 실행
- **성능 기준값** 재설정

## 월별 재학습

### 재학습 조건
- **30일 경과** 시 자동 재학습
- **드리프트 감지** 시 즉시 재학습
- **성능 저하** 시 재학습

### 재학습 과정
1. **최신 데이터**로 모델 재훈련
2. **파라미터 재최적화**
3. **드리프트 재감지**
4. **성능 기준값 업데이트**

## 백테스트 엔진

### 거래 비용 반영
- **슬리피지**: 0.05% (매수/매도 시)
- **펀딩비**: 제거됨 (0%)
- **수수료**: 0.05% (매수/매도 각각, 왕복 0.1%)

### 포지션 관리
- **최대 포지션 수** 제한
- **스탑로스/익절** 자동 실행
- **리스크 관리** 자동화

### 성과 지표
- **총 수익률**
- **최대 낙폭**
- **샤프 비율**
- **승률**
- **수익 팩터**

## 모델 저장/로드

### 모델 저장
```python
bot.save_model('my_model.pkl')
```

### 모델 로드
```python
bot.load_model('my_model.pkl')
```

### 저장 내용
- **머신러닝 모델**
- **피처 스케일러**
- **최적 파라미터**
- **피처 중요도**
- **성능 기준값**

## 예상 결과

### 최적화 완료 후
- **최적 파라미터** 자동 설정
- **머신러닝 모델** 훈련 완료
- **드리프트 모니터링** 활성화
- **월별 재학습** 스케줄링

### 백테스트 결과
- **2023-2024년** 전체 기간 수익률
- **월별 성과** 분석
- **리스크 지표** 계산
- **거래 통계** 분석

## 주의사항

1. **데이터 경로**: `c:\work\GitHub\py\kook\binance\data\BTC_USDT\1m\` 경로에 월별 CSV 파일 필요

2. **실행 시간**: 전체 최적화는 수 시간 소요 가능

3. **메모리 사용량**: 대용량 데이터 처리 시 충분한 메모리 필요

4. **과최적화**: 드리프트 모니터링으로 완화하지만 완전 배제 불가

5. **실제 거래**: 백테스트 결과가 실제 거래 결과를 보장하지 않음

## 문제 해결

### 데이터 로드 오류
```
파일이 존재하지 않습니다: 2023-01.csv
```
→ 해당 경로에 월별 데이터 파일 확인

### 메모리 부족
```
MemoryError
```
→ 데이터 기간을 줄이거나 메모리 증설

### 모델 훈련 실패
```
훈련 데이터가 부족합니다
```
→ 더 많은 데이터 확보 또는 파라미터 조정

이 시스템을 통해 단순한 이동평균선 전략을 머신러닝으로 고도화하여 더욱 정교한 자동매매 시스템을 구축할 수 있습니다.
